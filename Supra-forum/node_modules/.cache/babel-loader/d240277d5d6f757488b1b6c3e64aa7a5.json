{"remainingRequest":"/Users/a123/Desktop/Supra 2/Supra-forum/node_modules/thread-loader/dist/cjs.js!/Users/a123/Desktop/Supra 2/Supra-forum/node_modules/babel-loader/lib/index.js!/Users/a123/Desktop/Supra 2/Supra-forum/lib/mui/js/mui.js","dependencies":[{"path":"/Users/a123/Desktop/Supra 2/Supra-forum/lib/mui/js/mui.js","mtime":1574179996000},{"path":"/Users/a123/Desktop/Supra 2/Supra-forum/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/a123/Desktop/Supra 2/Supra-forum/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/a123/Desktop/Supra 2/Supra-forum/node_modules/babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:LyohCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqIE11aSB2My43LjIgKGh0dHA6Ly9kZXYuZGNsb3VkLm5ldC5jbi9tdWkpCiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAqLwovKioKICogTVVJ5qC45b+DSlMKICogQHR5cGUgX0w0LiR8RnVuY3Rpb24KICovCnZhciBtdWkgPSAoZnVuY3Rpb24oZG9jdW1lbnQsIHVuZGVmaW5lZCkgewoJdmFyIHJlYWR5UkUgPSAvY29tcGxldGV8bG9hZGVkfGludGVyYWN0aXZlLzsKCXZhciBpZFNlbGVjdG9yUkUgPSAvXiMoW1x3LV0rKSQvOwoJdmFyIGNsYXNzU2VsZWN0b3JSRSA9IC9eXC4oW1x3LV0rKSQvOwoJdmFyIHRhZ1NlbGVjdG9yUkUgPSAvXltcdy1dKyQvOwoJdmFyIHRyYW5zbGF0ZVJFID0gL3RyYW5zbGF0ZSg/OjNkKT9cKCguKz8pXCkvOwoJdmFyIHRyYW5zbGF0ZU1hdHJpeFJFID0gL21hdHJpeCgzZCk/XCgoLis/KVwpLzsKCgl2YXIgJCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgkJaWYgKCFzZWxlY3RvcikKCQkJcmV0dXJuIHdyYXAoKTsKCQlpZiAodHlwZW9mIHNlbGVjdG9yID09PSAnb2JqZWN0JykKCQkJaWYgKCQuaXNBcnJheUxpa2Uoc2VsZWN0b3IpKSB7CgkJCQlyZXR1cm4gd3JhcCgkLnNsaWNlLmNhbGwoc2VsZWN0b3IpLCBudWxsKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiB3cmFwKFtzZWxlY3Rvcl0sIG51bGwpOwoJCQl9CgkJaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJykKCQkJcmV0dXJuICQucmVhZHkoc2VsZWN0b3IpOwoJCWlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlzZWxlY3RvciA9IHNlbGVjdG9yLnRyaW0oKTsKCQkJCWlmIChpZFNlbGVjdG9yUkUudGVzdChzZWxlY3RvcikpIHsKCQkJCQl2YXIgZm91bmQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChSZWdFeHAuJDEpOwoJCQkJCXJldHVybiB3cmFwKGZvdW5kID8gW2ZvdW5kXSA6IFtdKTsKCQkJCX0KCQkJCXJldHVybiB3cmFwKCQucXNhKHNlbGVjdG9yLCBjb250ZXh0KSwgc2VsZWN0b3IpOwoJCQl9IGNhdGNoIChlKSB7fQoJCX0KCQlyZXR1cm4gd3JhcCgpOwoJfTsKCgl2YXIgd3JhcCA9IGZ1bmN0aW9uKGRvbSwgc2VsZWN0b3IpIHsKCQlkb20gPSBkb20gfHwgW107CgkJT2JqZWN0LnNldFByb3RvdHlwZU9mKGRvbSwgJC5mbik7CgkJZG9tLnNlbGVjdG9yID0gc2VsZWN0b3IgfHwgJyc7CgkJcmV0dXJuIGRvbTsKCX07CgoJJC51dWlkID0gMDsKCgkkLmRhdGEgPSB7fTsKCS8qKgoJICogZXh0ZW5kKHNpbXBsZSkKCSAqIEBwYXJhbSB7dHlwZX0gdGFyZ2V0CgkgKiBAcGFyYW0ge3R5cGV9IHNvdXJjZQoJICogQHBhcmFtIHt0eXBlfSBkZWVwCgkgKiBAcmV0dXJucyB7dW5yZXNvbHZlZH0KCSAqLwoJJC5leHRlbmQgPSBmdW5jdGlvbigpIHsgLy9mcm9tIGpxdWVyeTIKCQl2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsCgkJCXRhcmdldCA9IGFyZ3VtZW50c1swXSB8fCB7fSwKCQkJaSA9IDEsCgkJCWxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCgkJCWRlZXAgPSBmYWxzZTsKCgkJaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIikgewoJCQlkZWVwID0gdGFyZ2V0OwoKCQkJdGFyZ2V0ID0gYXJndW1lbnRzW2ldIHx8IHt9OwoJCQlpKys7CgkJfQoKCQlpZiAodHlwZW9mIHRhcmdldCAhPT0gIm9iamVjdCIgJiYgISQuaXNGdW5jdGlvbih0YXJnZXQpKSB7CgkJCXRhcmdldCA9IHt9OwoJCX0KCgkJaWYgKGkgPT09IGxlbmd0aCkgewoJCQl0YXJnZXQgPSB0aGlzOwoJCQlpLS07CgkJfQoKCQlmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJCWlmICgob3B0aW9ucyA9IGFyZ3VtZW50c1tpXSkgIT0gbnVsbCkgewoJCQkJZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKCQkJCQlzcmMgPSB0YXJnZXRbbmFtZV07CgkJCQkJY29weSA9IG9wdGlvbnNbbmFtZV07CgoJCQkJCWlmICh0YXJnZXQgPT09IGNvcHkpIHsKCQkJCQkJY29udGludWU7CgkJCQkJfQoKCQkJCQlpZiAoZGVlcCAmJiBjb3B5ICYmICgkLmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0gJC5pc0FycmF5KGNvcHkpKSkpIHsKCQkJCQkJaWYgKGNvcHlJc0FycmF5KSB7CgkJCQkJCQljb3B5SXNBcnJheSA9IGZhbHNlOwoJCQkJCQkJY2xvbmUgPSBzcmMgJiYgJC5pc0FycmF5KHNyYykgPyBzcmMgOiBbXTsKCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQljbG9uZSA9IHNyYyAmJiAkLmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwoJCQkJCQl9CgoJCQkJCQl0YXJnZXRbbmFtZV0gPSAkLmV4dGVuZChkZWVwLCBjbG9uZSwgY29weSk7CgoJCQkJCX0gZWxzZSBpZiAoY29weSAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJCXRhcmdldFtuYW1lXSA9IGNvcHk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGFyZ2V0OwoJfTsKCS8qKgoJICogbXVpIG5vb3AoZnVuY3Rpb24pCgkgKi8KCSQubm9vcCA9IGZ1bmN0aW9uKCkge307CgkvKioKCSAqIG11aSBzbGljZShhcnJheSkKCSAqLwoJJC5zbGljZSA9IFtdLnNsaWNlOwoJLyoqCgkgKiBtdWkgZmlsdGVyKGFycmF5KQoJICovCgkkLmZpbHRlciA9IFtdLmZpbHRlcjsKCgkkLnR5cGUgPSBmdW5jdGlvbihvYmopIHsKCQlyZXR1cm4gb2JqID09IG51bGwgPyBTdHJpbmcob2JqKSA6IGNsYXNzMnR5cGVbe30udG9TdHJpbmcuY2FsbChvYmopXSB8fCAib2JqZWN0IjsKCX07CgkvKioKCSAqIG11aSBpc0FycmF5CgkgKi8KCSQuaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwKCQlmdW5jdGlvbihvYmplY3QpIHsKCQkJcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIEFycmF5OwoJCX07CgkvKioKCSAqIG11aSBpc0FycmF5TGlrZSAKCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmoKCSAqLwoJJC5pc0FycmF5TGlrZSA9IGZ1bmN0aW9uKG9iaikgewoJCXZhciBsZW5ndGggPSAhIW9iaiAmJiAibGVuZ3RoIiBpbiBvYmogJiYgb2JqLmxlbmd0aDsKCQl2YXIgdHlwZSA9ICQudHlwZShvYmopOwoJCWlmICh0eXBlID09PSAiZnVuY3Rpb24iIHx8ICQuaXNXaW5kb3cob2JqKSkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0eXBlID09PSAiYXJyYXkiIHx8IGxlbmd0aCA9PT0gMCB8fAoJCQl0eXBlb2YgbGVuZ3RoID09PSAibnVtYmVyIiAmJiBsZW5ndGggPiAwICYmIChsZW5ndGggLSAxKSBpbiBvYmo7Cgl9OwoJLyoqCgkgKiBtdWkgaXNXaW5kb3co6ZyA6ICD6JmRb2Jq5Li6dW5kZWZpbmVk55qE5oOF5Ya1KQoJICovCgkkLmlzV2luZG93ID0gZnVuY3Rpb24ob2JqKSB7CgkJcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iaiA9PT0gb2JqLndpbmRvdzsKCX07CgkvKioKCSAqIG11aSBpc09iamVjdAoJICovCgkkLmlzT2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CgkJcmV0dXJuICQudHlwZShvYmopID09PSAib2JqZWN0IjsKCX07CgkvKioKCSAqIG11aSBpc1BsYWluT2JqZWN0CgkgKi8KCSQuaXNQbGFpbk9iamVjdCA9IGZ1bmN0aW9uKG9iaikgewoJCXJldHVybiAkLmlzT2JqZWN0KG9iaikgJiYgISQuaXNXaW5kb3cob2JqKSAmJiBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqKSA9PT0gT2JqZWN0LnByb3RvdHlwZTsKCX07CgkvKioKCSAqIG11aSBpc0VtcHR5T2JqZWN0CgkgKiBAcGFyYW0ge09iamVjdH0gbwoJICovCgkkLmlzRW1wdHlPYmplY3QgPSBmdW5jdGlvbihvKSB7CgkJZm9yICh2YXIgcCBpbiBvKSB7CgkJCWlmIChwICE9PSB1bmRlZmluZWQpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX07CgkvKioKCSAqIG11aSBpc0Z1bmN0aW9uCgkgKi8KCSQuaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJcmV0dXJuICQudHlwZSh2YWx1ZSkgPT09ICJmdW5jdGlvbiI7Cgl9OwoJLyoqCgkgKiBtdWkgcXVlcnlTZWxlY3RvckFsbAoJICogQHBhcmFtIHt0eXBlfSBzZWxlY3RvcgoJICogQHBhcmFtIHt0eXBlfSBjb250ZXh0CgkgKiBAcmV0dXJucyB7QXJyYXl9CgkgKi8KCSQucXNhID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNvbnRleHQpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCQlyZXR1cm4gJC5zbGljZS5jYWxsKGNsYXNzU2VsZWN0b3JSRS50ZXN0KHNlbGVjdG9yKSA/IGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShSZWdFeHAuJDEpIDogdGFnU2VsZWN0b3JSRS50ZXN0KHNlbGVjdG9yKSA/IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoc2VsZWN0b3IpIDogY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSk7Cgl9OwoJLyoqCgkgKiByZWFkeShET01Db250ZW50TG9hZGVkKQoJICogQHBhcmFtIHt0eXBlfSBjYWxsYmFjawoJICogQHJldHVybnMge19MNi4kfQoJICovCgkkLnJlYWR5ID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKCQlpZiAocmVhZHlSRS50ZXN0KGRvY3VtZW50LnJlYWR5U3RhdGUpKSB7CgkJCWNhbGxiYWNrKCQpOwoJCX0gZWxzZSB7CgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpIHsKCQkJCWNhbGxiYWNrKCQpOwoJCQl9LCBmYWxzZSk7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKCS8qKgoJICog5bCGIGZuIOe8k+WtmOS4gOauteaXtumXtOWQjiwg5YaN6KKr6LCD55So5omn6KGMCgkgKiDmraTmlrnms5XkuLrkuobpgb/lhY3lnKggbXMg5q615pe26Ze05YaFLCDmiafooYwgZm4g5aSa5qyhLiDluLjnlKjkuo4gcmVzaXplICwgc2Nyb2xsICwgbW91c2Vtb3ZlIOetiei/nue7reaAp+S6i+S7tuS4rTsKCSAqIOW9kyBtcyDorr7nva7kuLogLTEsIOihqOekuueri+WNs+aJp+ihjCBmbiwg5Y2z5ZKM55u05o6l6LCD55SoIGZuIOS4gOagtzsKCSAqIOiwg+eUqOi/lOWbnuWHveaVsOeahCBzdG9wIOWBnOatouacgOWQjuS4gOasoeeahCBidWZmZXIg5pWI5p6cCgkgKiBAcGFyYW0ge09iamVjdH0gZm4KCSAqIEBwYXJhbSB7T2JqZWN0fSBtcwoJICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHQKCSAqLwoJJC5idWZmZXIgPSBmdW5jdGlvbihmbiwgbXMsIGNvbnRleHQpIHsKCQl2YXIgdGltZXI7CgkJdmFyIGxhc3RTdGFydCA9IDA7CgkJdmFyIGxhc3RFbmQgPSAwOwoJCXZhciBtcyA9IG1zIHx8IDE1MDsKCgkJZnVuY3Rpb24gcnVuKCkgewoJCQlpZiAodGltZXIpIHsKCQkJCXRpbWVyLmNhbmNlbCgpOwoJCQkJdGltZXIgPSAwOwoJCQl9CgkJCWxhc3RTdGFydCA9ICQubm93KCk7CgkJCWZuLmFwcGx5KGNvbnRleHQgfHwgdGhpcywgYXJndW1lbnRzKTsKCQkJbGFzdEVuZCA9ICQubm93KCk7CgkJfQoKCQlyZXR1cm4gJC5leHRlbmQoZnVuY3Rpb24oKSB7CgkJCWlmICgKCQkJCSghbGFzdFN0YXJ0KSB8fCAvLyDku47mnKrov5DooYzov4cKCQkJCShsYXN0RW5kID49IGxhc3RTdGFydCAmJiAkLm5vdygpIC0gbGFzdEVuZCA+IG1zKSB8fCAvLyDkuIrmrKHov5DooYzmiJDlip/lkI7lt7Lnu4/otoXov4dtc+avq+enkgoJCQkJKGxhc3RFbmQgPCBsYXN0U3RhcnQgJiYgJC5ub3coKSAtIGxhc3RTdGFydCA+IG1zICogOCkgLy8g5LiK5qyh6L+Q6KGM5oiW5pyq5a6M5oiQ77yM5ZCOOCptc+avq+enkgoJCQkpIHsKCQkJCXJ1bi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCQl9IGVsc2UgewoJCQkJaWYgKHRpbWVyKSB7CgkJCQkJdGltZXIuY2FuY2VsKCk7CgkJCQl9CgkJCQl0aW1lciA9ICQubGF0ZXIocnVuLCBtcywgbnVsbCwgJC5zbGljZS5jYWxsKGFyZ3VtZW50cykpOwoJCQl9CgkJfSwgewoJCQlzdG9wOiBmdW5jdGlvbigpIHsKCQkJCWlmICh0aW1lcikgewoJCQkJCXRpbWVyLmNhbmNlbCgpOwoJCQkJCXRpbWVyID0gMDsKCQkJCX0KCQkJfQoJCX0pOwoJfTsKCS8qKgoJICogZWFjaAoJICogQHBhcmFtIHt0eXBlfSBlbGVtZW50cwoJICogQHBhcmFtIHt0eXBlfSBjYWxsYmFjawoJICogQHJldHVybnMge19MOC4kfQoJICovCgkkLmVhY2ggPSBmdW5jdGlvbihlbGVtZW50cywgY2FsbGJhY2ssIGhhc093blByb3BlcnR5KSB7CgkJaWYgKCFlbGVtZW50cykgewoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKHR5cGVvZiBlbGVtZW50cy5sZW5ndGggPT09ICdudW1iZXInKSB7CgkJCVtdLmV2ZXJ5LmNhbGwoZWxlbWVudHMsIGZ1bmN0aW9uKGVsLCBpZHgpIHsKCQkJCXJldHVybiBjYWxsYmFjay5jYWxsKGVsLCBpZHgsIGVsKSAhPT0gZmFsc2U7CgkJCX0pOwoJCX0gZWxzZSB7CgkJCWZvciAodmFyIGtleSBpbiBlbGVtZW50cykgewoJCQkJaWYgKGhhc093blByb3BlcnR5KSB7CgkJCQkJaWYgKGVsZW1lbnRzLmhhc093blByb3BlcnR5KGtleSkpIHsKCQkJCQkJaWYgKGNhbGxiYWNrLmNhbGwoZWxlbWVudHNba2V5XSwga2V5LCBlbGVtZW50c1trZXldKSA9PT0gZmFsc2UpIHJldHVybiBlbGVtZW50czsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2tleV0sIGtleSwgZWxlbWVudHNba2V5XSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHM7CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9OwoJJC5mb2N1cyA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCQlpZiAoJC5vcy5pb3MpIHsKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCWVsZW1lbnQuZm9jdXMoKTsKCQkJfSwgMTApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQuZm9jdXMoKTsKCQl9Cgl9OwoJLyoqCgkgKiB0cmlnZ2VyIGV2ZW50CgkgKiBAcGFyYW0ge3R5cGV9IGVsZW1lbnQKCSAqIEBwYXJhbSB7dHlwZX0gZXZlbnRUeXBlCgkgKiBAcGFyYW0ge3R5cGV9IGV2ZW50RGF0YQoJICogQHJldHVybnMge19MOC4kfQoJICovCgkkLnRyaWdnZXIgPSBmdW5jdGlvbihlbGVtZW50LCBldmVudFR5cGUsIGV2ZW50RGF0YSkgewoJCWVsZW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoZXZlbnRUeXBlLCB7CgkJCWRldGFpbDogZXZlbnREYXRhLAoJCQlidWJibGVzOiB0cnVlLAoJCQljYW5jZWxhYmxlOiB0cnVlCgkJfSkpOwoJCXJldHVybiB0aGlzOwoJfTsKCS8qKgoJICogZ2V0U3R5bGVzCgkgKiBAcGFyYW0ge3R5cGV9IGVsZW1lbnQKCSAqIEBwYXJhbSB7dHlwZX0gcHJvcGVydHkKCSAqIEByZXR1cm5zIHtzdHlsZXN9CgkgKi8KCSQuZ2V0U3R5bGVzID0gZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHkpIHsKCQl2YXIgc3R5bGVzID0gZWxlbWVudC5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgbnVsbCk7CgkJaWYgKHByb3BlcnR5KSB7CgkJCXJldHVybiBzdHlsZXMuZ2V0UHJvcGVydHlWYWx1ZShwcm9wZXJ0eSkgfHwgc3R5bGVzW3Byb3BlcnR5XTsKCQl9CgkJcmV0dXJuIHN0eWxlczsKCX07CgkvKioKCSAqIHBhcnNlVHJhbnNsYXRlCgkgKiBAcGFyYW0ge3R5cGV9IHRyYW5zbGF0ZVN0cmluZwoJICogQHBhcmFtIHt0eXBlfSBwb3NpdGlvbgoJICogQHJldHVybnMge09iamVjdH0KCSAqLwoJJC5wYXJzZVRyYW5zbGF0ZSA9IGZ1bmN0aW9uKHRyYW5zbGF0ZVN0cmluZywgcG9zaXRpb24pIHsKCQl2YXIgcmVzdWx0ID0gdHJhbnNsYXRlU3RyaW5nLm1hdGNoKHRyYW5zbGF0ZVJFIHx8ICcnKTsKCQlpZiAoIXJlc3VsdCB8fCAhcmVzdWx0WzFdKSB7CgkJCXJlc3VsdCA9IFsnJywgJzAsMCwwJ107CgkJfQoJCXJlc3VsdCA9IHJlc3VsdFsxXS5zcGxpdCgiLCIpOwoJCXJlc3VsdCA9IHsKCQkJeDogcGFyc2VGbG9hdChyZXN1bHRbMF0pLAoJCQl5OiBwYXJzZUZsb2F0KHJlc3VsdFsxXSksCgkJCXo6IHBhcnNlRmxvYXQocmVzdWx0WzJdKQoJCX07CgkJaWYgKHBvc2l0aW9uICYmIHJlc3VsdC5oYXNPd25Qcm9wZXJ0eShwb3NpdGlvbikpIHsKCQkJcmV0dXJuIHJlc3VsdFtwb3NpdGlvbl07CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoJLyoqCgkgKiBwYXJzZVRyYW5zbGF0ZU1hdHJpeAoJICogQHBhcmFtIHt0eXBlfSB0cmFuc2xhdGVTdHJpbmcKCSAqIEBwYXJhbSB7dHlwZX0gcG9zaXRpb24KCSAqIEByZXR1cm5zIHtPYmplY3R9CgkgKi8KCSQucGFyc2VUcmFuc2xhdGVNYXRyaXggPSBmdW5jdGlvbih0cmFuc2xhdGVTdHJpbmcsIHBvc2l0aW9uKSB7CgkJdmFyIG1hdHJpeCA9IHRyYW5zbGF0ZVN0cmluZy5tYXRjaCh0cmFuc2xhdGVNYXRyaXhSRSk7CgkJdmFyIGlzM0QgPSBtYXRyaXggJiYgbWF0cml4WzFdOwoJCWlmIChtYXRyaXgpIHsKCQkJbWF0cml4ID0gbWF0cml4WzJdLnNwbGl0KCIsIik7CgkJCWlmIChpczNEID09PSAiM2QiKQoJCQkJbWF0cml4ID0gbWF0cml4LnNsaWNlKDEyLCAxNSk7CgkJCWVsc2UgewoJCQkJbWF0cml4LnB1c2goMCk7CgkJCQltYXRyaXggPSBtYXRyaXguc2xpY2UoNCwgNyk7CgkJCX0KCQl9IGVsc2UgewoJCQltYXRyaXggPSBbMCwgMCwgMF07CgkJfQoJCXZhciByZXN1bHQgPSB7CgkJCXg6IHBhcnNlRmxvYXQobWF0cml4WzBdKSwKCQkJeTogcGFyc2VGbG9hdChtYXRyaXhbMV0pLAoJCQl6OiBwYXJzZUZsb2F0KG1hdHJpeFsyXSkKCQl9OwoJCWlmIChwb3NpdGlvbiAmJiByZXN1bHQuaGFzT3duUHJvcGVydHkocG9zaXRpb24pKSB7CgkJCXJldHVybiByZXN1bHRbcG9zaXRpb25dOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCSQuaG9va3MgPSB7fTsKCSQuYWRkQWN0aW9uID0gZnVuY3Rpb24odHlwZSwgaG9vaykgewoJCXZhciBob29rcyA9ICQuaG9va3NbdHlwZV07CgkJaWYgKCFob29rcykgewoJCQlob29rcyA9IFtdOwoJCX0KCQlob29rLmluZGV4ID0gaG9vay5pbmRleCB8fCAxMDAwOwoJCWhvb2tzLnB1c2goaG9vayk7CgkJaG9va3Muc29ydChmdW5jdGlvbihhLCBiKSB7CgkJCXJldHVybiBhLmluZGV4IC0gYi5pbmRleDsKCQl9KTsKCQkkLmhvb2tzW3R5cGVdID0gaG9va3M7CgkJcmV0dXJuICQuaG9va3NbdHlwZV07Cgl9OwoJJC5kb0FjdGlvbiA9IGZ1bmN0aW9uKHR5cGUsIGNhbGxiYWNrKSB7CgkJaWYgKCQuaXNGdW5jdGlvbihjYWxsYmFjaykpIHsgLy/mjIflrprkuoZjYWxsYmFjawoJCQkkLmVhY2goJC5ob29rc1t0eXBlXSwgY2FsbGJhY2spOwoJCX0gZWxzZSB7IC8v5pyq5oyH5a6aY2FsbGJhY2vvvIznm7TmjqXmiafooYwKCQkJJC5lYWNoKCQuaG9va3NbdHlwZV0sIGZ1bmN0aW9uKGluZGV4LCBob29rKSB7CgkJCQlyZXR1cm4gIWhvb2suaGFuZGxlKCk7CgkJCX0pOwoJCX0KCX07CgkvKioKCSAqIHNldFRpbWVvdXTlsIHoo4UKCSAqIEBwYXJhbSB7T2JqZWN0fSBmbgoJICogQHBhcmFtIHtPYmplY3R9IHdoZW4KCSAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0CgkgKiBAcGFyYW0ge09iamVjdH0gZGF0YQoJICovCgkkLmxhdGVyID0gZnVuY3Rpb24oZm4sIHdoZW4sIGNvbnRleHQsIGRhdGEpIHsKCQl3aGVuID0gd2hlbiB8fCAwOwoJCXZhciBtID0gZm47CgkJdmFyIGQgPSBkYXRhOwoJCXZhciBmOwoJCXZhciByOwoKCQlpZiAodHlwZW9mIGZuID09PSAnc3RyaW5nJykgewoJCQltID0gY29udGV4dFtmbl07CgkJfQoKCQlmID0gZnVuY3Rpb24oKSB7CgkJCW0uYXBwbHkoY29udGV4dCwgJC5pc0FycmF5KGQpID8gZCA6IFtkXSk7CgkJfTsKCgkJciA9IHNldFRpbWVvdXQoZiwgd2hlbik7CgoJCXJldHVybiB7CgkJCWlkOiByLAoJCQljYW5jZWw6IGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KHIpOwoJCQl9CgkJfTsKCX07CgkkLm5vdyA9IERhdGUubm93IHx8IGZ1bmN0aW9uKCkgewoJCXJldHVybiArbmV3IERhdGUoKTsKCX07Cgl2YXIgY2xhc3MydHlwZSA9IHt9OwoJJC5lYWNoKFsnQm9vbGVhbicsICdOdW1iZXInLCAnU3RyaW5nJywgJ0Z1bmN0aW9uJywgJ0FycmF5JywgJ0RhdGUnLCAnUmVnRXhwJywgJ09iamVjdCcsICdFcnJvciddLCBmdW5jdGlvbihpLCBuYW1lKSB7CgkJY2xhc3MydHlwZVsiW29iamVjdCAiICsgbmFtZSArICJdIl0gPSBuYW1lLnRvTG93ZXJDYXNlKCk7Cgl9KTsKCWlmICh3aW5kb3cuSlNPTikgewoJCSQucGFyc2VKU09OID0gSlNPTi5wYXJzZTsKCX0KCS8qKgoJICogJC5mbgoJICovCgkkLmZuID0gewoJCWVhY2g6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkJCVtdLmV2ZXJ5LmNhbGwodGhpcywgZnVuY3Rpb24oZWwsIGlkeCkgewoJCQkJcmV0dXJuIGNhbGxiYWNrLmNhbGwoZWwsIGlkeCwgZWwpICE9PSBmYWxzZTsKCQkJfSk7CgkJCXJldHVybiB0aGlzOwoJCX0KCX07CgoJLyoqCgkgKiDlhbzlrrkgQU1EIOaooeWdlwoJICoqLwoJaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewoJCWRlZmluZSgnbXVpJywgW10sIGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJDsKCQl9KTsKCX0KCglyZXR1cm4gJDsKfSkoZG9jdW1lbnQpOwovL3dpbmRvdy5tdWkgPSBtdWk7Ci8vJyQnIGluIHdpbmRvdyB8fCAod2luZG93LiQgPSBtdWkpOwovKioKICogJC5vcwogKiBAcGFyYW0ge3R5cGV9ICQKICogQHJldHVybnMge3VuZGVmaW5lZH0KICovCihmdW5jdGlvbigkLCB3aW5kb3cpIHsKCWZ1bmN0aW9uIGRldGVjdCh1YSkgewoJCXRoaXMub3MgPSB7fTsKCQl2YXIgZnVuY3MgPSBbCgoJCQlmdW5jdGlvbigpIHsgLy93ZWNoYXQKCQkJCXZhciB3ZWNoYXQgPSB1YS5tYXRjaCgvKE1pY3JvTWVzc2VuZ2VyKVwvKFtcZFwuXSspL2kpOwoJCQkJaWYgKHdlY2hhdCkgeyAvL3dlY2hhdAoJCQkJCXRoaXMub3Mud2VjaGF0ID0gewoJCQkJCQl2ZXJzaW9uOiB3ZWNoYXRbMl0ucmVwbGFjZSgvXy9nLCAnLicpCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybiBmYWxzZTsKCQkJfSwKCQkJZnVuY3Rpb24oKSB7IC8vYW5kcm9pZAoJCQkJdmFyIGFuZHJvaWQgPSB1YS5tYXRjaCgvKEFuZHJvaWQpOz9bXHNcL10rKFtcZC5dKyk/Lyk7CgkJCQlpZiAoYW5kcm9pZCkgewoJCQkJCXRoaXMub3MuYW5kcm9pZCA9IHRydWU7CgkJCQkJdGhpcy5vcy52ZXJzaW9uID0gYW5kcm9pZFsyXTsKCgkJCQkJdGhpcy5vcy5pc0JhZEFuZHJvaWQgPSAhKC9DaHJvbWVcL1xkLy50ZXN0KHdpbmRvdy5uYXZpZ2F0b3IuYXBwVmVyc2lvbikpOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXMub3MuYW5kcm9pZCA9PT0gdHJ1ZTsKCQkJfSwKCQkJZnVuY3Rpb24oKSB7IC8vaW9zCgkJCQl2YXIgaXBob25lID0gdWEubWF0Y2goLyhpUGhvbmVcc09TKVxzKFtcZF9dKykvKTsKCQkJCWlmIChpcGhvbmUpIHsgLy9pcGhvbmUKCQkJCQl0aGlzLm9zLmlvcyA9IHRoaXMub3MuaXBob25lID0gdHJ1ZTsKCQkJCQl0aGlzLm9zLnZlcnNpb24gPSBpcGhvbmVbMl0ucmVwbGFjZSgvXy9nLCAnLicpOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgaXBhZCA9IHVhLm1hdGNoKC8oaVBhZCkuKk9TXHMoW1xkX10rKS8pOwoJCQkJCWlmIChpcGFkKSB7IC8vaXBhZAoJCQkJCQl0aGlzLm9zLmlvcyA9IHRoaXMub3MuaXBhZCA9IHRydWU7CgkJCQkJCXRoaXMub3MudmVyc2lvbiA9IGlwYWRbMl0ucmVwbGFjZSgvXy9nLCAnLicpOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzLm9zLmlvcyA9PT0gdHJ1ZTsKCQkJfQoJCV07CgkJW10uZXZlcnkuY2FsbChmdW5jcywgZnVuY3Rpb24oZnVuYykgewoJCQlyZXR1cm4gIWZ1bmMuY2FsbCgkKTsKCQl9KTsKCX0KCWRldGVjdC5jYWxsKCQsIG5hdmlnYXRvci51c2VyQWdlbnQpOwp9KShtdWksIHdpbmRvdyk7Ci8qKgogKiAkLm9zLnBsdXMKICogQHBhcmFtIHt0eXBlfSAkCiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgZG9jdW1lbnQpIHsKCWZ1bmN0aW9uIGRldGVjdCh1YSkgewoJCXRoaXMub3MgPSB0aGlzLm9zIHx8IHt9OwoJCXZhciBwbHVzID0gdWEubWF0Y2goL0h0bWw1UGx1cy9pKTsgLy9UT0RPIDVcK0Jyb3dzZXI/CgkJaWYgKHBsdXMpIHsKCQkJdGhpcy5vcy5wbHVzID0gdHJ1ZTsKCQkJJChmdW5jdGlvbigpIHsKCQkJCWRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnbXVpLXBsdXMnKTsKCQkJfSk7CgkJCWlmICh1YS5tYXRjaCgvU3RyZWFtQXBwL2kpKSB7IC8vVE9ETyDmnIDlpb3mnInmtYHlupTnlKjoh6rlt7HnmoTmoIfor4YKCQkJCXRoaXMub3Muc3RyZWFtID0gdHJ1ZTsKCQkJCSQoZnVuY3Rpb24oKSB7CgkJCQkJZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdtdWktcGx1cy1zdHJlYW0nKTsKCQkJCX0pOwoJCQl9CgkJfQoJfQoJZGV0ZWN0LmNhbGwoJCwgbmF2aWdhdG9yLnVzZXJBZ2VudCk7Cn0pKG11aSwgZG9jdW1lbnQpOwovKioKICog5LuF5o+Q5L6b566A5Y2V55qEb27vvIxvZmYo5LuF5pSv5oyB5LqL5Lu25aeU5omY77yM5LiN5pSv5oyB5b2T5YmN5YWD57Sg57uR5a6a77yM5b2T5YmN5YWD57Sg57uR5a6a6K+355u05o6l5L2/55SoYWRkRXZlbnRMaXN0ZW5lcixyZW1vdmVFdmVudExpc3RlbmVyKQogKiBAcGFyYW0ge09iamVjdH0gJAogKi8KKGZ1bmN0aW9uKCQpIHsKCWlmICgnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3cpIHsKCQkkLmlzVG91Y2hhYmxlID0gdHJ1ZTsKCQkkLkVWRU5UX1NUQVJUID0gJ3RvdWNoc3RhcnQnOwoJCSQuRVZFTlRfTU9WRSA9ICd0b3VjaG1vdmUnOwoJCSQuRVZFTlRfRU5EID0gJ3RvdWNoZW5kJzsKCX0gZWxzZSB7CgkJJC5pc1RvdWNoYWJsZSA9IGZhbHNlOwoJCSQuRVZFTlRfU1RBUlQgPSAnbW91c2Vkb3duJzsKCQkkLkVWRU5UX01PVkUgPSAnbW91c2Vtb3ZlJzsKCQkkLkVWRU5UX0VORCA9ICdtb3VzZXVwJzsKCX0KCSQuRVZFTlRfQ0FOQ0VMID0gJ3RvdWNoY2FuY2VsJzsKCSQuRVZFTlRfQ0xJQ0sgPSAnY2xpY2snOwoKCXZhciBfbWlkID0gMTsKCXZhciBkZWxlZ2F0ZXMgPSB7fTsKCS8v6ZyA6KaBd3JhcOeahOWHveaVsAoJdmFyIGV2ZW50TWV0aG9kcyA9IHsKCQlwcmV2ZW50RGVmYXVsdDogJ2lzRGVmYXVsdFByZXZlbnRlZCcsCgkJc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiAnaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQnLAoJCXN0b3BQcm9wYWdhdGlvbjogJ2lzUHJvcGFnYXRpb25TdG9wcGVkJwoJfTsKCS8v6buY6K6kdHJ1Zei/lOWbnuWHveaVsAoJdmFyIHJldHVyblRydWUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdHJ1ZQoJfTsKCS8v6buY6K6kZmFsc2Xov5Tlm57lh73mlbAKCXZhciByZXR1cm5GYWxzZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZQoJfTsKCS8vd3JhcOa1j+iniOWZqOS6i+S7tgoJdmFyIGNvbXBhdGlibGUgPSBmdW5jdGlvbihldmVudCwgdGFyZ2V0KSB7CgkJaWYgKCFldmVudC5kZXRhaWwpIHsKCQkJZXZlbnQuZGV0YWlsID0gewoJCQkJY3VycmVudFRhcmdldDogdGFyZ2V0CgkJCX07CgkJfSBlbHNlIHsKCQkJZXZlbnQuZGV0YWlsLmN1cnJlbnRUYXJnZXQgPSB0YXJnZXQ7CgkJfQoJCSQuZWFjaChldmVudE1ldGhvZHMsIGZ1bmN0aW9uKG5hbWUsIHByZWRpY2F0ZSkgewoJCQl2YXIgc291cmNlTWV0aG9kID0gZXZlbnRbbmFtZV07CgkJCWV2ZW50W25hbWVdID0gZnVuY3Rpb24oKSB7CgkJCQl0aGlzW3ByZWRpY2F0ZV0gPSByZXR1cm5UcnVlOwoJCQkJcmV0dXJuIHNvdXJjZU1ldGhvZCAmJiBzb3VyY2VNZXRob2QuYXBwbHkoZXZlbnQsIGFyZ3VtZW50cykKCQkJfQoJCQlldmVudFtwcmVkaWNhdGVdID0gcmV0dXJuRmFsc2U7CgkJfSwgdHJ1ZSk7CgkJcmV0dXJuIGV2ZW50OwoJfTsKCS8v566A5Y2V55qEd3JhcOWvueixoV9taWQKCXZhciBtaWQgPSBmdW5jdGlvbihvYmopIHsKCQlyZXR1cm4gb2JqICYmIChvYmouX21pZCB8fCAob2JqLl9taWQgPSBfbWlkKyspKTsKCX07CgkvL+S6i+S7tuWnlOaJmOWvueixoee7keWumueahOS6i+S7tuWbnuiwg+WIl+ihqAoJdmFyIGRlbGVnYXRlRm5zID0ge307CgkvL+i/lOWbnuS6i+S7tuWnlOaJmOeahHdyYXDkuovku7blm57osIMKCXZhciBkZWxlZ2F0ZUZuID0gZnVuY3Rpb24oZWxlbWVudCwgZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjaykgewoJCXJldHVybiBmdW5jdGlvbihlKSB7CgkJCS8vc2FtZSBldmVudAoJCQl2YXIgY2FsbGJhY2tPYmpzID0gZGVsZWdhdGVzW2VsZW1lbnQuX21pZF1bZXZlbnRdOwoJCQl2YXIgaGFuZGxlclF1ZXVlID0gW107CgkJCXZhciB0YXJnZXQgPSBlLnRhcmdldDsKCQkJdmFyIHNlbGVjdG9yQWxscyA9IHt9OwoJCQlmb3IgKDsgdGFyZ2V0ICYmIHRhcmdldCAhPT0gZG9jdW1lbnQ7IHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlKSB7CgkJCQlpZiAodGFyZ2V0ID09PSBlbGVtZW50KSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCQlpZiAoflsnY2xpY2snLCAndGFwJywgJ2RvdWJsZXRhcCcsICdsb25ndGFwJywgJ2hvbGQnXS5pbmRleE9mKGV2ZW50KSAmJiAodGFyZ2V0LmRpc2FibGVkIHx8IHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ211aS1kaXNhYmxlZCcpKSkgewoJCQkJCWJyZWFrOwoJCQkJfQoJCQkJdmFyIG1hdGNoZXMgPSB7fTsKCQkJCSQuZWFjaChjYWxsYmFja09ianMsIGZ1bmN0aW9uKHNlbGVjdG9yLCBjYWxsYmFja3MpIHsgLy9zYW1lIHNlbGVjdG9yCgkJCQkJc2VsZWN0b3JBbGxzW3NlbGVjdG9yXSB8fCAoc2VsZWN0b3JBbGxzW3NlbGVjdG9yXSA9ICQucXNhKHNlbGVjdG9yLCBlbGVtZW50KSk7CgkJCQkJaWYgKHNlbGVjdG9yQWxsc1tzZWxlY3Rvcl0gJiYgfihzZWxlY3RvckFsbHNbc2VsZWN0b3JdKS5pbmRleE9mKHRhcmdldCkpIHsKCQkJCQkJaWYgKCFtYXRjaGVzW3NlbGVjdG9yXSkgewoJCQkJCQkJbWF0Y2hlc1tzZWxlY3Rvcl0gPSBjYWxsYmFja3M7CgkJCQkJCX0KCQkJCQl9CgkJCQl9LCB0cnVlKTsKCQkJCWlmICghJC5pc0VtcHR5T2JqZWN0KG1hdGNoZXMpKSB7CgkJCQkJaGFuZGxlclF1ZXVlLnB1c2goewoJCQkJCQllbGVtZW50OiB0YXJnZXQsCgkJCQkJCWhhbmRsZXJzOiBtYXRjaGVzCgkJCQkJfSk7CgkJCQl9CgkJCX0KCQkJc2VsZWN0b3JBbGxzID0gbnVsbDsKCQkJZSA9IGNvbXBhdGlibGUoZSk7IC8vY29tcGF0aWJsZSBldmVudAoJCQkkLmVhY2goaGFuZGxlclF1ZXVlLCBmdW5jdGlvbihpbmRleCwgaGFuZGxlcikgewoJCQkJdGFyZ2V0ID0gaGFuZGxlci5lbGVtZW50OwoJCQkJdmFyIHRhZ05hbWUgPSB0YXJnZXQudGFnTmFtZTsKCQkJCWlmIChldmVudCA9PT0gJ3RhcCcgJiYgKHRhZ05hbWUgIT09ICdJTlBVVCcgJiYgdGFnTmFtZSAhPT0gJ1RFWFRBUkVBJyAmJiB0YWdOYW1lICE9PSAnU0VMRUNUJykpIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5kZXRhaWwgJiYgZS5kZXRhaWwuZ2VzdHVyZSAmJiBlLmRldGFpbC5nZXN0dXJlLnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCQkkLmVhY2goaGFuZGxlci5oYW5kbGVycywgZnVuY3Rpb24oaW5kZXgsIGhhbmRsZXIpIHsKCQkJCQkkLmVhY2goaGFuZGxlciwgZnVuY3Rpb24oaW5kZXgsIGNhbGxiYWNrKSB7CgkJCQkJCWlmIChjYWxsYmFjay5jYWxsKHRhcmdldCwgZSkgPT09IGZhbHNlKSB7CgkJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQl9CgkJCQkJfSwgdHJ1ZSk7CgkJCQl9LCB0cnVlKQoJCQkJaWYgKGUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSwgdHJ1ZSk7CgkJfTsKCX07Cgl2YXIgZmluZERlbGVnYXRlRm4gPSBmdW5jdGlvbihlbGVtZW50LCBldmVudCkgewoJCXZhciBkZWxlZ2F0ZUNhbGxiYWNrcyA9IGRlbGVnYXRlRm5zW21pZChlbGVtZW50KV07CgkJdmFyIHJlc3VsdCA9IFtdOwoJCWlmIChkZWxlZ2F0ZUNhbGxiYWNrcykgewoJCQlyZXN1bHQgPSBbXTsKCQkJaWYgKGV2ZW50KSB7CgkJCQl2YXIgZmlsdGVyRm4gPSBmdW5jdGlvbihmbikgewoJCQkJCXJldHVybiBmbi50eXBlID09PSBldmVudDsKCQkJCX0KCQkJCXJldHVybiBkZWxlZ2F0ZUNhbGxiYWNrcy5maWx0ZXIoZmlsdGVyRm4pOwoJCQl9IGVsc2UgewoJCQkJcmVzdWx0ID0gZGVsZWdhdGVDYWxsYmFja3M7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07Cgl2YXIgcHJldmVudERlZmF1bHRFeGNlcHRpb24gPSAvXihJTlBVVHxURVhUQVJFQXxCVVRUT058U0VMRUNUKSQvOwoJLyoqCgkgKiBtdWkgZGVsZWdhdGUgZXZlbnRzCgkgKiBAcGFyYW0ge3R5cGV9IGV2ZW50CgkgKiBAcGFyYW0ge3R5cGV9IHNlbGVjdG9yCgkgKiBAcGFyYW0ge3R5cGV9IGNhbGxiYWNrCgkgKiBAcmV0dXJucyB7dW5kZWZpbmVkfQoJICovCgkkLmZuLm9uID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjaykgeyAvL+S7heaUr+aMgeeugOWNleeahOS6i+S7tuWnlOaJmCzkuLvopoHmmK90YXDkuovku7bkvb/nlKjvvIznsbvkvLxtb3VzZSxmb2N1c+S5i+exu+aaguS4jeWwgeijheaUr+aMgQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBlbGVtZW50ID0gdGhpczsKCQkJbWlkKGVsZW1lbnQpOwoJCQltaWQoY2FsbGJhY2spOwoJCQl2YXIgaXNBZGRFdmVudExpc3RlbmVyID0gZmFsc2U7CgkJCXZhciBkZWxlZ2F0ZUV2ZW50cyA9IGRlbGVnYXRlc1tlbGVtZW50Ll9taWRdIHx8IChkZWxlZ2F0ZXNbZWxlbWVudC5fbWlkXSA9IHt9KTsKCQkJdmFyIGRlbGVnYXRlQ2FsbGJhY2tPYmpzID0gZGVsZWdhdGVFdmVudHNbZXZlbnRdIHx8ICgoZGVsZWdhdGVFdmVudHNbZXZlbnRdID0ge30pKTsKCQkJaWYgKCQuaXNFbXB0eU9iamVjdChkZWxlZ2F0ZUNhbGxiYWNrT2JqcykpIHsKCQkJCWlzQWRkRXZlbnRMaXN0ZW5lciA9IHRydWU7CgkJCX0KCQkJdmFyIGRlbGVnYXRlQ2FsbGJhY2tzID0gZGVsZWdhdGVDYWxsYmFja09ianNbc2VsZWN0b3JdIHx8IChkZWxlZ2F0ZUNhbGxiYWNrT2Jqc1tzZWxlY3Rvcl0gPSBbXSk7CgkJCWRlbGVnYXRlQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwoJCQlpZiAoaXNBZGRFdmVudExpc3RlbmVyKSB7CgkJCQl2YXIgZGVsZWdhdGVGbkFycmF5ID0gZGVsZWdhdGVGbnNbbWlkKGVsZW1lbnQpXTsKCQkJCWlmICghZGVsZWdhdGVGbkFycmF5KSB7CgkJCQkJZGVsZWdhdGVGbkFycmF5ID0gW107CgkJCQl9CgkJCQl2YXIgZGVsZWdhdGVDYWxsYmFjayA9IGRlbGVnYXRlRm4oZWxlbWVudCwgZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjayk7CgkJCQlkZWxlZ2F0ZUZuQXJyYXkucHVzaChkZWxlZ2F0ZUNhbGxiYWNrKTsKCQkJCWRlbGVnYXRlQ2FsbGJhY2suaSA9IGRlbGVnYXRlRm5BcnJheS5sZW5ndGggLSAxOwoJCQkJZGVsZWdhdGVDYWxsYmFjay50eXBlID0gZXZlbnQ7CgkJCQlkZWxlZ2F0ZUZuc1ttaWQoZWxlbWVudCldID0gZGVsZWdhdGVGbkFycmF5OwoJCQkJZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBkZWxlZ2F0ZUNhbGxiYWNrKTsKCQkJCWlmIChldmVudCA9PT0gJ3RhcCcpIHsgLy9UT0RPIOmcgOimgeaJvuS4quabtOWlveeahOino+WGs+aWueahiAoJCQkJCWVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbihlKSB7CgkJCQkJCWlmIChlLnRhcmdldCkgewoJCQkJCQkJdmFyIHRhZ05hbWUgPSBlLnRhcmdldC50YWdOYW1lOwoJCQkJCQkJaWYgKCFwcmV2ZW50RGVmYXVsdEV4Y2VwdGlvbi50ZXN0KHRhZ05hbWUpKSB7CgkJCQkJCQkJaWYgKHRhZ05hbWUgPT09ICdBJykgewoJCQkJCQkJCQl2YXIgaHJlZiA9IGUudGFyZ2V0LmhyZWY7CgkJCQkJCQkJCWlmICghKGhyZWYgJiYgfmhyZWYuaW5kZXhPZigndGVsOicpKSkgewoJCQkJCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQkJCQl9CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSk7Cgl9OwoJJC5mbi5vZmYgPSBmdW5jdGlvbihldmVudCwgc2VsZWN0b3IsIGNhbGxiYWNrKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIF9taWQgPSBtaWQodGhpcyk7CgkJCWlmICghZXZlbnQpIHsgLy9tdWkoc2VsZWN0b3IpLm9mZigpOwoJCQkJZGVsZWdhdGVzW19taWRdICYmIGRlbGV0ZSBkZWxlZ2F0ZXNbX21pZF07CgkJCX0gZWxzZSBpZiAoIXNlbGVjdG9yKSB7IC8vbXVpKHNlbGVjdG9yKS5vZmYoZXZlbnQpOwoJCQkJZGVsZWdhdGVzW19taWRdICYmIGRlbGV0ZSBkZWxlZ2F0ZXNbX21pZF1bZXZlbnRdOwoJCQl9IGVsc2UgaWYgKCFjYWxsYmFjaykgeyAvL211aShzZWxlY3Rvcikub2ZmKGV2ZW50LHNlbGVjdG9yKTsKCQkJCWRlbGVnYXRlc1tfbWlkXSAmJiBkZWxlZ2F0ZXNbX21pZF1bZXZlbnRdICYmIGRlbGV0ZSBkZWxlZ2F0ZXNbX21pZF1bZXZlbnRdW3NlbGVjdG9yXTsKCQkJfSBlbHNlIHsgLy9tdWkoc2VsZWN0b3IpLm9mZihldmVudCxzZWxlY3RvcixjYWxsYmFjayk7CgkJCQl2YXIgZGVsZWdhdGVDYWxsYmFja3MgPSBkZWxlZ2F0ZXNbX21pZF0gJiYgZGVsZWdhdGVzW19taWRdW2V2ZW50XSAmJiBkZWxlZ2F0ZXNbX21pZF1bZXZlbnRdW3NlbGVjdG9yXTsKCQkJCSQuZWFjaChkZWxlZ2F0ZUNhbGxiYWNrcywgZnVuY3Rpb24oaW5kZXgsIGRlbGVnYXRlQ2FsbGJhY2spIHsKCQkJCQlpZiAobWlkKGRlbGVnYXRlQ2FsbGJhY2spID09PSBtaWQoY2FsbGJhY2spKSB7CgkJCQkJCWRlbGVnYXRlQ2FsbGJhY2tzLnNwbGljZShpbmRleCwgMSk7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9LCB0cnVlKTsKCQkJfQoJCQlpZiAoZGVsZWdhdGVzW19taWRdKSB7CgkJCQkvL+WmguaenG9mZuaOieS6huaJgOacieW9k+WJjWVsZW1lbnTnmoTmjIflrprnmoRldmVudOS6i+S7tu+8jOWImXJlbW92ZeaOieW9k+WJjWVsZW1lbnTnmoRkZWxlZ2F0ZeWbnuiwgwoJCQkJaWYgKCghZGVsZWdhdGVzW19taWRdW2V2ZW50XSB8fCAkLmlzRW1wdHlPYmplY3QoZGVsZWdhdGVzW19taWRdW2V2ZW50XSkpKSB7CgkJCQkJZmluZERlbGVnYXRlRm4odGhpcywgZXZlbnQpLmZvckVhY2goZnVuY3Rpb24oZm4pIHsKCQkJCQkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKGZuLnR5cGUsIGZuKTsKCQkJCQkJZGVsZXRlIGRlbGVnYXRlRm5zW19taWRdW2ZuLmldOwoJCQkJCX0uYmluZCh0aGlzKSk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQkvL+WmguaenGRlbGVnYXRlc1tfbWlkXeW3suS4jeWtmOWcqO+8jOWIoOmZpOaJgOaciQoJCQkJZmluZERlbGVnYXRlRm4odGhpcykuZm9yRWFjaChmdW5jdGlvbihmbikgewoJCQkJCXRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihmbi50eXBlLCBmbik7CgkJCQkJZGVsZXRlIGRlbGVnYXRlRm5zW19taWRdW2ZuLmldOwoJCQkJfS5iaW5kKHRoaXMpKTsKCQkJfQoJCX0pOwoKCX07Cn0pKG11aSk7Ci8qKgogKiBtdWkgdGFyZ2V0KGFjdGlvbj5wb3BvdmVyPm1vZGFsPnRhYj50b2dnbGUpCiAqLwooZnVuY3Rpb24oJCwgd2luZG93LCBkb2N1bWVudCkgewoJLyoqCgkgKiB0YXJnZXRzCgkgKi8KCSQudGFyZ2V0cyA9IHt9OwoJLyoqCgkgKiB0YXJnZXQgaGFuZGxlcwoJICovCgkkLnRhcmdldEhhbmRsZXMgPSBbXTsKCS8qKgoJICogcmVnaXN0ZXIgdGFyZ2V0CgkgKiBAcGFyYW0ge3R5cGV9IHRhcmdldAoJICogQHJldHVybnMgeyQudGFyZ2V0c30KCSAqLwoJJC5yZWdpc3RlclRhcmdldCA9IGZ1bmN0aW9uKHRhcmdldCkgewoKCQl0YXJnZXQuaW5kZXggPSB0YXJnZXQuaW5kZXggfHwgMTAwMDsKCgkJJC50YXJnZXRIYW5kbGVzLnB1c2godGFyZ2V0KTsKCgkJJC50YXJnZXRIYW5kbGVzLnNvcnQoZnVuY3Rpb24oYSwgYikgewoJCQlyZXR1cm4gYS5pbmRleCAtIGIuaW5kZXg7CgkJfSk7CgoJCXJldHVybiAkLnRhcmdldEhhbmRsZXM7Cgl9OwoJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJC5FVkVOVF9TVEFSVCwgZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCXZhciBmb3VuZHMgPSB7fTsKCQlmb3IgKDsgdGFyZ2V0ICYmIHRhcmdldCAhPT0gZG9jdW1lbnQ7IHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlKSB7CgkJCXZhciBpc0ZvdW5kID0gZmFsc2U7CgkJCSQuZWFjaCgkLnRhcmdldEhhbmRsZXMsIGZ1bmN0aW9uKGluZGV4LCB0YXJnZXRIYW5kbGUpIHsKCQkJCXZhciBuYW1lID0gdGFyZ2V0SGFuZGxlLm5hbWU7CgkJCQlpZiAoIWlzRm91bmQgJiYgIWZvdW5kc1tuYW1lXSAmJiB0YXJnZXRIYW5kbGUuaGFzT3duUHJvcGVydHkoJ2hhbmRsZScpKSB7CgkJCQkJJC50YXJnZXRzW25hbWVdID0gdGFyZ2V0SGFuZGxlLmhhbmRsZShldmVudCwgdGFyZ2V0KTsKCQkJCQlpZiAoJC50YXJnZXRzW25hbWVdKSB7CgkJCQkJCWZvdW5kc1tuYW1lXSA9IHRydWU7CgkJCQkJCWlmICh0YXJnZXRIYW5kbGUuaXNDb250aW51ZSAhPT0gdHJ1ZSkgewoJCQkJCQkJaXNGb3VuZCA9IHRydWU7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWlmICghZm91bmRzW25hbWVdKSB7CgkJCQkJCWlmICh0YXJnZXRIYW5kbGUuaXNSZXNldCAhPT0gZmFsc2UpCgkJCQkJCQkkLnRhcmdldHNbbmFtZV0gPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCQlpZiAoaXNGb3VuZCkgewoJCQkJYnJlYWs7CgkJCX0KCQl9Cgl9KTsKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7IC8v6Kej5YazdG91Y2jkuI5jbGlja+eahHRhcmdldOS4jeS4gOiHtOeahOmXrumimCjmr5TlpoLpk77mjqXovrnnvJjngrnlh7vml7bvvIx0b3VjaOeahHRhcmdldOS4umh0bWzvvIzogIxjbGlja+eahHRhcmdldOS4ukEpCgkJdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQl2YXIgaXNGb3VuZCA9IGZhbHNlOwoJCWZvciAoOyB0YXJnZXQgJiYgdGFyZ2V0ICE9PSBkb2N1bWVudDsgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGUpIHsKCQkJaWYgKHRhcmdldC50YWdOYW1lID09PSAnQScpIHsKCQkJCSQuZWFjaCgkLnRhcmdldEhhbmRsZXMsIGZ1bmN0aW9uKGluZGV4LCB0YXJnZXRIYW5kbGUpIHsKCQkJCQl2YXIgbmFtZSA9IHRhcmdldEhhbmRsZS5uYW1lOwoJCQkJCWlmICh0YXJnZXRIYW5kbGUuaGFzT3duUHJvcGVydHkoJ2hhbmRsZScpKSB7CgkJCQkJCWlmICh0YXJnZXRIYW5kbGUuaGFuZGxlKGV2ZW50LCB0YXJnZXQpKSB7CgkJCQkJCQlpc0ZvdW5kID0gdHJ1ZTsKCQkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQkJCWlmIChpc0ZvdW5kKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKfSkobXVpLCB3aW5kb3csIGRvY3VtZW50KTsKLyoqCiAqIGZpeGVkIHRyaW0KICogQHBhcmFtIHt0eXBlfSB1bmRlZmluZWQKICogQHJldHVybnMge3VuZGVmaW5lZH0KICovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCWlmIChTdHJpbmcucHJvdG90eXBlLnRyaW0gPT09IHVuZGVmaW5lZCkgeyAvLyBmaXggZm9yIGlPUyAzLjIKCQlTdHJpbmcucHJvdG90eXBlLnRyaW0gPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCQl9OwoJfQoJT2JqZWN0LnNldFByb3RvdHlwZU9mID0gT2JqZWN0LnNldFByb3RvdHlwZU9mIHx8IGZ1bmN0aW9uKG9iaiwgcHJvdG8pIHsKCQlvYmpbJ19fcHJvdG9fXyddID0gcHJvdG87CgkJcmV0dXJuIG9iajsKCX07Cgp9KSgpOwovKioKICogZml4ZWQgQ3VzdG9tRXZlbnQKICovCihmdW5jdGlvbigpIHsKCWlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ID09PSAndW5kZWZpbmVkJykgewoJCWZ1bmN0aW9uIEN1c3RvbUV2ZW50KGV2ZW50LCBwYXJhbXMpIHsKCQkJcGFyYW1zID0gcGFyYW1zIHx8IHsKCQkJCWJ1YmJsZXM6IGZhbHNlLAoJCQkJY2FuY2VsYWJsZTogZmFsc2UsCgkJCQlkZXRhaWw6IHVuZGVmaW5lZAoJCQl9OwoJCQl2YXIgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0V2ZW50cycpOwoJCQl2YXIgYnViYmxlcyA9IHRydWU7CgkJCWZvciAodmFyIG5hbWUgaW4gcGFyYW1zKSB7CgkJCQkobmFtZSA9PT0gJ2J1YmJsZXMnKSA/IChidWJibGVzID0gISFwYXJhbXNbbmFtZV0pIDogKGV2dFtuYW1lXSA9IHBhcmFtc1tuYW1lXSk7CgkJCX0KCQkJZXZ0LmluaXRFdmVudChldmVudCwgYnViYmxlcywgdHJ1ZSk7CgkJCXJldHVybiBldnQ7CgkJfQoJCUN1c3RvbUV2ZW50LnByb3RvdHlwZSA9IHdpbmRvdy5FdmVudC5wcm90b3R5cGU7CgkJd2luZG93LkN1c3RvbUV2ZW50ID0gQ3VzdG9tRXZlbnQ7Cgl9Cn0pKCk7Ci8qCglBIHNoaW0gZm9yIG5vbiBFUzUgc3VwcG9ydGluZyBicm93c2Vycy4KCUFkZHMgZnVuY3Rpb24gYmluZCB0byBGdW5jdGlvbiBwcm90b3R5cGUsIHNvIHRoYXQgeW91IGNhbiBkbyBwYXJ0aWFsIGFwcGxpY2F0aW9uLgoJV29ya3MgZXZlbiB3aXRoIHRoZSBuYXN0eSB0aGluZywgd2hlcmUgdGhlIGZpcnN0IHdvcmQgaXMgdGhlIG9wcG9zaXRlIG9mIGV4dHJhbmV0LCB0aGUgc2Vjb25kIG9uZSBpcyB0aGUgcHJvZmVzc2lvbiBvZiBDb2x1bWJ1cywgYW5kIHRoZSB2ZXJzaW9uIG51bWJlciBpcyA5LCBmbGlwcGVkIDE4MCBkZWdyZWVzLgoqLwoKRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPSBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCB8fCBmdW5jdGlvbih0bykgewoJLy8gTWFrZSBhbiBhcnJheSBvZiBvdXIgYXJndW1lbnRzLCBzdGFydGluZyBmcm9tIHNlY29uZCBhcmd1bWVudAoJdmFyIHBhcnRpYWwgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwKCQkvLyBXZSdsbCBuZWVkIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KCQlmbiA9IHRoaXM7Cgl2YXIgYm91bmQgPSBmdW5jdGlvbigpIHsKCQkJLy8gSm9pbiB0aGUgYWxyZWFkeSBhcHBsaWVkIGFyZ3VtZW50cyB0byB0aGUgbm93IGNhbGxlZCBvbmVzIChhZnRlciBjb252ZXJ0aW5nIHRvIGFuIGFycmF5IGFnYWluKS4KCQkJdmFyIGFyZ3MgPSBwYXJ0aWFsLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7CgkJCS8vIElmIG5vdCBiZWluZyBjYWxsZWQgYXMgYSBjb25zdHJ1Y3RvcgoJCQlpZiAoISh0aGlzIGluc3RhbmNlb2YgYm91bmQpKSB7CgkJCQkvLyByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgZnVuY3Rpb24gY2FsbGVkIGJvdW5kIHRvIHRhcmdldCBhbmQgcGFydGlhbGx5IGFwcGxpZWQuCgkJCQlyZXR1cm4gZm4uYXBwbHkodG8sIGFyZ3MpOwoJCQl9CgkJCS8vIElmIGJlaW5nIGNhbGxlZCBhcyBhIGNvbnN0cnVjdG9yLCBhcHBseSB0aGUgZnVuY3Rpb24gYm91bmQgdG8gc2VsZi4KCQkJZm4uYXBwbHkodGhpcywgYXJncyk7CgkJfQoJCS8vIEF0dGFjaCB0aGUgcHJvdG90eXBlIG9mIHRoZSBmdW5jdGlvbiB0byBvdXIgbmV3bHkgY3JlYXRlZCBmdW5jdGlvbi4KCWJvdW5kLnByb3RvdHlwZSA9IGZuLnByb3RvdHlwZTsKCXJldHVybiBib3VuZDsKfTsKLyoqCiAqIG11aSBmaXhlZCBjbGFzc0xpc3QKICogQHBhcmFtIHt0eXBlfSBkb2N1bWVudAogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKGRvY3VtZW50KSB7CiAgICBpZiAoISgiY2xhc3NMaXN0IiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAmJiB0eXBlb2YgSFRNTEVsZW1lbnQgIT09ICd1bmRlZmluZWQnKSB7CgogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShIVE1MRWxlbWVudC5wcm90b3R5cGUsICdjbGFzc0xpc3QnLCB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGUoZm4pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSBzZWxmLmNsYXNzTmFtZS5zcGxpdCgvXHMrLyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBjbGFzc2VzLmluZGV4T2YodmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgZm4oY2xhc3NlcywgaW5kZXgsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oIiAiKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciByZXQgPSB7CiAgICAgICAgICAgICAgICAgICAgYWRkOiB1cGRhdGUoZnVuY3Rpb24oY2xhc3NlcywgaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIH5pbmRleCB8fCBjbGFzc2VzLnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogdXBkYXRlKGZ1bmN0aW9uKGNsYXNzZXMsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIH5pbmRleCAmJiBjbGFzc2VzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlOiB1cGRhdGUoZnVuY3Rpb24oY2xhc3NlcywgaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIH5pbmRleCA/IGNsYXNzZXMuc3BsaWNlKGluZGV4LCAxKSA6IGNsYXNzZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgY29udGFpbnM6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIX5zZWxmLmNsYXNzTmFtZS5zcGxpdCgvXHMrLykuaW5kZXhPZih2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBpdGVtOiBmdW5jdGlvbihpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLmNsYXNzTmFtZS5zcGxpdCgvXHMrLylbaV0gfHwgbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShyZXQsICdsZW5ndGgnLCB7CiAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2xhc3NOYW1lLnNwbGl0KC9ccysvKS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQp9KShkb2N1bWVudCk7CgovKioKICogbXVpIGZpeGVkIHJlcXVlc3RBbmltYXRpb25GcmFtZQogKiBAcGFyYW0ge3R5cGV9IHdpbmRvdwogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKHdpbmRvdykgewoJaWYgKCF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7CgkJdmFyIGxhc3RUaW1lID0gMDsKCQl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCBmdW5jdGlvbihjYWxsYmFjaywgZWxlbWVudCkgewoJCQl2YXIgY3VyclRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCQkJdmFyIHRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCAxNi43IC0gKGN1cnJUaW1lIC0gbGFzdFRpbWUpKTsKCQkJdmFyIGlkID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQljYWxsYmFjayhjdXJyVGltZSArIHRpbWVUb0NhbGwpOwoJCQl9LCB0aW1lVG9DYWxsKTsKCQkJbGFzdFRpbWUgPSBjdXJyVGltZSArIHRpbWVUb0NhbGw7CgkJCXJldHVybiBpZDsKCQl9OwoJCXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSB8fCB3aW5kb3cud2Via2l0Q2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IGZ1bmN0aW9uKGlkKSB7CgkJCWNsZWFyVGltZW91dChpZCk7CgkJfTsKCX0KfSh3aW5kb3cpKTsKLyoqCiAqIGZhc3RjbGljayhvbmx5IGZvciByYWRpbyxjaGVja2JveCkKICovCihmdW5jdGlvbigkLCB3aW5kb3csIG5hbWUpIHsKCWlmICghJC5vcy5hbmRyb2lkICYmICEkLm9zLmlvcykgeyAvL+ebruWJjeS7heivhuWIq2FuZHJvaWTlkoxpb3MKCQlyZXR1cm47Cgl9CglpZiAod2luZG93LkZhc3RDbGljaykgewoJCXJldHVybjsKCX0KCgl2YXIgaGFuZGxlID0gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCkgewoJCWlmICh0YXJnZXQudGFnTmFtZSA9PT0gJ0xBQkVMJykgewoJCQlpZiAodGFyZ2V0LnBhcmVudE5vZGUpIHsKCQkJCXRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0Jyk7CgkJCX0KCQl9CgkJaWYgKHRhcmdldCAmJiAodGFyZ2V0LnR5cGUgPT09ICdyYWRpbycgfHwgdGFyZ2V0LnR5cGUgPT09ICdjaGVja2JveCcpKSB7CgkJCWlmICghdGFyZ2V0LmRpc2FibGVkKSB7IC8vZGlzYWJsZWQKCQkJCXJldHVybiB0YXJnZXQ7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkkLnJlZ2lzdGVyVGFyZ2V0KHsKCQluYW1lOiBuYW1lLAoJCWluZGV4OiA0MCwKCQloYW5kbGU6IGhhbmRsZSwKCQl0YXJnZXQ6IGZhbHNlCgl9KTsKCXZhciBkaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgdGFyZ2V0RWxlbWVudCA9ICQudGFyZ2V0cy5jbGljazsKCQlpZiAodGFyZ2V0RWxlbWVudCkgewoJCQl2YXIgY2xpY2tFdmVudCwgdG91Y2g7CgkJCS8vIE9uIHNvbWUgQW5kcm9pZCBkZXZpY2VzIGFjdGl2ZUVsZW1lbnQgbmVlZHMgdG8gYmUgYmx1cnJlZCBvdGhlcndpc2UgdGhlIHN5bnRoZXRpYyBjbGljayB3aWxsIGhhdmUgbm8gZWZmZWN0CgkJCWlmIChkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgIT09IHRhcmdldEVsZW1lbnQpIHsKCQkJCWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQuYmx1cigpOwoJCQl9CgkJCXRvdWNoID0gZXZlbnQuZGV0YWlsLmdlc3R1cmUuY2hhbmdlZFRvdWNoZXNbMF07CgkJCS8vIFN5bnRoZXNpc2UgYSBjbGljayBldmVudCwgd2l0aCBhbiBleHRyYSBhdHRyaWJ1dGUgc28gaXQgY2FuIGJlIHRyYWNrZWQKCQkJY2xpY2tFdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdNb3VzZUV2ZW50cycpOwoJCQljbGlja0V2ZW50LmluaXRNb3VzZUV2ZW50KCdjbGljaycsIHRydWUsIHRydWUsIHdpbmRvdywgMSwgdG91Y2guc2NyZWVuWCwgdG91Y2guc2NyZWVuWSwgdG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIG51bGwpOwoJCQljbGlja0V2ZW50LmZvcndhcmRlZFRvdWNoRXZlbnQgPSB0cnVlOwoJCQl0YXJnZXRFbGVtZW50LmRpc3BhdGNoRXZlbnQoY2xpY2tFdmVudCk7CgkJCWV2ZW50LmRldGFpbCAmJiBldmVudC5kZXRhaWwuZ2VzdHVyZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX07Cgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndGFwJywgZGlzcGF0Y2hFdmVudCk7Cgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZG91YmxldGFwJywgZGlzcGF0Y2hFdmVudCk7CgkvL+aNleiOtwoJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKCQlpZiAoJC50YXJnZXRzLmNsaWNrKSB7CgkJCWlmICghZXZlbnQuZm9yd2FyZGVkVG91Y2hFdmVudCkgeyAvL3N0b3AgY2xpY2sKCQkJCWlmIChldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24pIHsKCQkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gUGFydCBvZiB0aGUgaGFjayBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IEV2ZW50I3N0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbgoJCQkJCWV2ZW50LnByb3BhZ2F0aW9uU3RvcHBlZCA9IHRydWU7CgkJCQl9CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKCn0pKG11aSwgd2luZG93LCAnY2xpY2snKTsKKGZ1bmN0aW9uKCQsIGRvY3VtZW50KSB7CgkkKGZ1bmN0aW9uKCkgewoJCWlmICghJC5vcy5pb3MpIHsKCQkJcmV0dXJuOwoJCX0KCQl2YXIgQ0xBU1NfRk9DVVNJTiA9ICdtdWktZm9jdXNpbic7CgkJdmFyIENMQVNTX0JBUl9UQUIgPSAnbXVpLWJhci10YWInOwoJCXZhciBDTEFTU19CQVJfRk9PVEVSID0gJ211aS1iYXItZm9vdGVyJzsKCQl2YXIgQ0xBU1NfQkFSX0ZPT1RFUl9TRUNPTkRBUlkgPSAnbXVpLWJhci1mb290ZXItc2Vjb25kYXJ5JzsKCQl2YXIgQ0xBU1NfQkFSX0ZPT1RFUl9TRUNPTkRBUllfVEFCID0gJ211aS1iYXItZm9vdGVyLXNlY29uZGFyeS10YWInOwoJCS8vIHZhciBjb250ZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLicgKyBDTEFTU19DT05URU5UKTsKCQkvLyBpZiAoY29udGVudCkgewoJCS8vIAlkb2N1bWVudC5ib2R5Lmluc2VydEJlZm9yZShjb250ZW50LCBkb2N1bWVudC5ib2R5LmZpcnN0RWxlbWVudENoaWxkKTsKCQkvLyB9CgkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXNpbicsIGZ1bmN0aW9uKGUpIHsKCQkJaWYgKCQub3MucGx1cykgeyAvL+WcqOeItndlYnZpZXfph4zovrnkuI1maXgKCQkJCWlmICh3aW5kb3cucGx1cykgewoJCQkJCWlmIChwbHVzLndlYnZpZXcuY3VycmVudFdlYnZpZXcoKS5jaGlsZHJlbigpLmxlbmd0aCA+IDApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl2YXIgdGFyZ2V0ID0gZS50YXJnZXQ7CgkJCS8vVE9ETyDpnIDogIPomZHmiYDmnInplK7nm5jlvLnotbfnmoTmg4XlhrUKCQkJaWYgKHRhcmdldC50YWdOYW1lICYmICh0YXJnZXQudGFnTmFtZSA9PT0gJ1RFWFRBUkVBJyB8fCAodGFyZ2V0LnRhZ05hbWUgPT09ICdJTlBVVCcgJiYgKHRhcmdldC50eXBlID09PSAndGV4dCcgfHwgdGFyZ2V0LnR5cGUgPT09ICdzZWFyY2gnIHx8IHRhcmdldC50eXBlID09PSAnbnVtYmVyJykpKSkgewoJCQkJaWYgKHRhcmdldC5kaXNhYmxlZCB8fCB0YXJnZXQucmVhZE9ubHkpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoQ0xBU1NfRk9DVVNJTik7CgkJCQl2YXIgaXNGb290ZXIgPSBmYWxzZTsKCQkJCWZvciAoOyB0YXJnZXQgJiYgdGFyZ2V0ICE9PSBkb2N1bWVudDsgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGUpIHsKCQkJCQl2YXIgY2xhc3NMaXN0ID0gdGFyZ2V0LmNsYXNzTGlzdDsKCQkJCQlpZiAoY2xhc3NMaXN0ICYmIGNsYXNzTGlzdC5jb250YWlucyhDTEFTU19CQVJfVEFCKSB8fCBjbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfQkFSX0ZPT1RFUikgfHwgY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0JBUl9GT09URVJfU0VDT05EQVJZKSB8fCBjbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfQkFSX0ZPT1RFUl9TRUNPTkRBUllfVEFCKSkgewoJCQkJCQlpc0Zvb3RlciA9IHRydWU7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChpc0Zvb3RlcikgewoJCQkJCXZhciBzY3JvbGxUb3AgPSBkb2N1bWVudC5ib2R5LnNjcm9sbEhlaWdodDsKCQkJCQl2YXIgc2Nyb2xsTGVmdCA9IGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdDsKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQl3aW5kb3cuc2Nyb2xsVG8oc2Nyb2xsTGVmdCwgc2Nyb2xsVG9wKTsKCQkJCQl9LCAyMCk7CgkJCQl9CgkJCX0KCQl9KTsKCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdmb2N1c291dCcsIGZ1bmN0aW9uKGUpIHsKCQkJdmFyIGNsYXNzTGlzdCA9IGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0OwoJCQlpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0ZPQ1VTSU4pKSB7CgkJCQljbGFzc0xpc3QucmVtb3ZlKENMQVNTX0ZPQ1VTSU4pOwoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQl3aW5kb3cuc2Nyb2xsVG8oZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0LCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCk7CgkJCQl9LCAyMCk7CgkJCX0KCQl9KTsKCX0pOwp9KShtdWksIGRvY3VtZW50KTsKLyoqCiAqIG11aSBuYW1lc3BhY2Uob3B0aW1pemF0aW9uKQogKiBAcGFyYW0ge3R5cGV9ICQKICogQHJldHVybnMge3VuZGVmaW5lZH0KICovCihmdW5jdGlvbigkKSB7CgkkLm5hbWVzcGFjZSA9ICdtdWknOwoJJC5jbGFzc05hbWVQcmVmaXggPSAkLm5hbWVzcGFjZSArICctJzsKCSQuY2xhc3NTZWxlY3RvclByZWZpeCA9ICcuJyArICQuY2xhc3NOYW1lUHJlZml4OwoJLyoqCgkgKiDov5Tlm57mraPnoa7nmoRjbGFzc05hbWUKCSAqIEBwYXJhbSB7dHlwZX0gY2xhc3NOYW1lCgkgKiBAcmV0dXJucyB7U3RyaW5nfQoJICovCgkkLmNsYXNzTmFtZSA9IGZ1bmN0aW9uKGNsYXNzTmFtZSkgewoJCXJldHVybiAkLmNsYXNzTmFtZVByZWZpeCArIGNsYXNzTmFtZTsKCX07CgkvKioKCSAqIOi/lOWbnuato+ehrueahGNsYXNzU2VsZWN0b3IKCSAqIEBwYXJhbSB7dHlwZX0gY2xhc3NTZWxlY3RvcgoJICogQHJldHVybnMge1N0cmluZ30KCSAqLwoJJC5jbGFzc1NlbGVjdG9yID0gZnVuY3Rpb24oY2xhc3NTZWxlY3RvcikgewoJCXJldHVybiBjbGFzc1NlbGVjdG9yLnJlcGxhY2UoL1wuL2csICQuY2xhc3NTZWxlY3RvclByZWZpeCk7Cgl9OwoJLyoqCiAgICAgICAgICog6L+U5Zue5q2j56Gu55qEZXZlbnROYW1lCiAgICAgICAgICogQHBhcmFtIHt0eXBlfSBldmVudAogICAgICAgICAqIEBwYXJhbSB7dHlwZX0gbW9kdWxlCiAgICAgICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAgICAgKi8KCSQuZXZlbnROYW1lID0gZnVuY3Rpb24oZXZlbnQsIG1vZHVsZSkgewoJCXJldHVybiBldmVudCArICgkLm5hbWVzcGFjZSA/ICgnLicgKyAkLm5hbWVzcGFjZSkgOiAnJykgKyAoIG1vZHVsZSA/ICgnLicgKyBtb2R1bGUpIDogJycpOwoJfTsKfSkobXVpKTsKCi8qKgogKiBtdWkgZ2VzdHVyZXMKICogQHBhcmFtIHt0eXBlfSAkCiAqIEBwYXJhbSB7dHlwZX0gd2luZG93CiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgd2luZG93KSB7CgkkLmdlc3R1cmVzID0gewoJCXNlc3Npb246IHt9Cgl9OwoJLyoqCgkgKiBHZXN0dXJlIHByZXZlbnREZWZhdWx0CgkgKiBAcGFyYW0ge3R5cGV9IGUKCSAqIEByZXR1cm5zIHt1bmRlZmluZWR9CgkgKi8KCSQucHJldmVudERlZmF1bHQgPSBmdW5jdGlvbihlKSB7CgkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJfTsKCS8qKgoJICogR2VzdHVyZSBzdG9wUHJvcGFnYXRpb24KCSAqIEBwYXJhbSB7dHlwZX0gZQoJICogQHJldHVybnMge3VuZGVmaW5lZH0KCSAqLwoJJC5zdG9wUHJvcGFnYXRpb24gPSBmdW5jdGlvbihlKSB7CgkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCX07CgoJLyoqCgkgKiByZWdpc3RlciBnZXN0dXJlCgkgKiBAcGFyYW0ge3R5cGV9IGdlc3R1cmUKCSAqIEByZXR1cm5zIHskLmdlc3R1cmVzfQoJICovCgkkLmFkZEdlc3R1cmUgPSBmdW5jdGlvbihnZXN0dXJlKSB7CgkJcmV0dXJuICQuYWRkQWN0aW9uKCdnZXN0dXJlcycsIGdlc3R1cmUpOwoKCX07CgoJdmFyIHJvdW5kID0gTWF0aC5yb3VuZDsKCXZhciBhYnMgPSBNYXRoLmFiczsKCXZhciBzcXJ0ID0gTWF0aC5zcXJ0OwoJdmFyIGF0YW4gPSBNYXRoLmF0YW47Cgl2YXIgYXRhbjIgPSBNYXRoLmF0YW4yOwoJLyoqCgkgKiBkaXN0YW5jZQoJICogQHBhcmFtIHt0eXBlfSBwMQoJICogQHBhcmFtIHt0eXBlfSBwMgoJICogQHJldHVybnMge051bWJlcn0KCSAqLwoJdmFyIGdldERpc3RhbmNlID0gZnVuY3Rpb24ocDEsIHAyLCBwcm9wcykgewoJCWlmKCFwcm9wcykgewoJCQlwcm9wcyA9IFsneCcsICd5J107CgkJfQoJCXZhciB4ID0gcDJbcHJvcHNbMF1dIC0gcDFbcHJvcHNbMF1dOwoJCXZhciB5ID0gcDJbcHJvcHNbMV1dIC0gcDFbcHJvcHNbMV1dOwoJCXJldHVybiBzcXJ0KCh4ICogeCkgKyAoeSAqIHkpKTsKCX07CgkvKioKCSAqIHNjYWxlCgkgKiBAcGFyYW0ge09iamVjdH0gc3RhcnRzCgkgKiBAcGFyYW0ge09iamVjdH0gbW92ZXMKCSAqLwoJdmFyIGdldFNjYWxlID0gZnVuY3Rpb24oc3RhcnRzLCBtb3ZlcykgewoJCWlmKHN0YXJ0cy5sZW5ndGggPj0gMiAmJiBtb3Zlcy5sZW5ndGggPj0gMikgewoJCQl2YXIgcHJvcHMgPSBbJ3BhZ2VYJywgJ3BhZ2VZJ107CgkJCXJldHVybiBnZXREaXN0YW5jZShtb3Zlc1sxXSwgbW92ZXNbMF0sIHByb3BzKSAvIGdldERpc3RhbmNlKHN0YXJ0c1sxXSwgc3RhcnRzWzBdLCBwcm9wcyk7CgkJfQoJCXJldHVybiAxOwoJfTsKCS8qKgoJICogYW5nbGUKCSAqIEBwYXJhbSB7dHlwZX0gcDEKCSAqIEBwYXJhbSB7dHlwZX0gcDIKCSAqIEByZXR1cm5zIHtOdW1iZXJ9CgkgKi8KCXZhciBnZXRBbmdsZSA9IGZ1bmN0aW9uKHAxLCBwMiwgcHJvcHMpIHsKCQlpZighcHJvcHMpIHsKCQkJcHJvcHMgPSBbJ3gnLCAneSddOwoJCX0KCQl2YXIgeCA9IHAyW3Byb3BzWzBdXSAtIHAxW3Byb3BzWzBdXTsKCQl2YXIgeSA9IHAyW3Byb3BzWzFdXSAtIHAxW3Byb3BzWzFdXTsKCQlyZXR1cm4gYXRhbjIoeSwgeCkgKiAxODAgLyBNYXRoLlBJOwoJfTsKCS8qKgoJICogZGlyZWN0aW9uCgkgKiBAcGFyYW0ge09iamVjdH0geAoJICogQHBhcmFtIHtPYmplY3R9IHkKCSAqLwoJdmFyIGdldERpcmVjdGlvbiA9IGZ1bmN0aW9uKHgsIHkpIHsKCQlpZih4ID09PSB5KSB7CgkJCXJldHVybiAnJzsKCQl9CgkJaWYoYWJzKHgpID49IGFicyh5KSkgewoJCQlyZXR1cm4geCA+IDAgPyAnbGVmdCcgOiAncmlnaHQnOwoJCX0KCQlyZXR1cm4geSA+IDAgPyAndXAnIDogJ2Rvd24nOwoJfTsKCS8qKgoJICogcm90YXRpb24KCSAqIEBwYXJhbSB7T2JqZWN0fSBzdGFydAoJICogQHBhcmFtIHtPYmplY3R9IGVuZAoJICovCgl2YXIgZ2V0Um90YXRpb24gPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CgkJdmFyIHByb3BzID0gWydwYWdlWCcsICdwYWdlWSddOwoJCXJldHVybiBnZXRBbmdsZShlbmRbMV0sIGVuZFswXSwgcHJvcHMpIC0gZ2V0QW5nbGUoc3RhcnRbMV0sIHN0YXJ0WzBdLCBwcm9wcyk7Cgl9OwoJLyoqCgkgKiBweCBwZXIgbXMKCSAqIEBwYXJhbSB7T2JqZWN0fSBkZWx0YVRpbWUKCSAqIEBwYXJhbSB7T2JqZWN0fSB4CgkgKiBAcGFyYW0ge09iamVjdH0geQoJICovCgl2YXIgZ2V0VmVsb2NpdHkgPSBmdW5jdGlvbihkZWx0YVRpbWUsIHgsIHkpIHsKCQlyZXR1cm4gewoJCQl4OiB4IC8gZGVsdGFUaW1lIHx8IDAsCgkJCXk6IHkgLyBkZWx0YVRpbWUgfHwgMAoJCX07Cgl9OwoJLyoqCgkgKiBkZXRlY3QgZ2VzdHVyZXMKCSAqIEBwYXJhbSB7dHlwZX0gZXZlbnQKCSAqIEBwYXJhbSB7dHlwZX0gdG91Y2gKCSAqIEByZXR1cm5zIHt1bmRlZmluZWR9CgkgKi8KCXZhciBkZXRlY3QgPSBmdW5jdGlvbihldmVudCwgdG91Y2gpIHsKCQlpZigkLmdlc3R1cmVzLnN0b3BlZCkgewoJCQlyZXR1cm47CgkJfQoJCSQuZG9BY3Rpb24oJ2dlc3R1cmVzJywgZnVuY3Rpb24oaW5kZXgsIGdlc3R1cmUpIHsKCQkJaWYoISQuZ2VzdHVyZXMuc3RvcGVkKSB7CgkJCQlpZigkLm9wdGlvbnMuZ2VzdHVyZUNvbmZpZ1tnZXN0dXJlLm5hbWVdICE9PSBmYWxzZSkgewoJCQkJCWdlc3R1cmUuaGFuZGxlKGV2ZW50LCB0b3VjaCk7CgkJCQl9CgkJCX0KCQl9KTsKCX07CgkvKioKCSAqIOaaguaXtuaXoOeUqAoJICogQHBhcmFtIHtPYmplY3R9IG5vZGUKCSAqIEBwYXJhbSB7T2JqZWN0fSBwYXJlbnQKCSAqLwoJdmFyIGhhc1BhcmVudCA9IGZ1bmN0aW9uKG5vZGUsIHBhcmVudCkgewoJCXdoaWxlKG5vZGUpIHsKCQkJaWYobm9kZSA9PSBwYXJlbnQpIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCW5vZGUgPSBub2RlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX07CgoJdmFyIHVuaXF1ZUFycmF5ID0gZnVuY3Rpb24oc3JjLCBrZXksIHNvcnQpIHsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCXZhciB2YWx1ZXMgPSBbXTsKCQl2YXIgaSA9IDA7CgoJCXdoaWxlKGkgPCBzcmMubGVuZ3RoKSB7CgkJCXZhciB2YWwgPSBrZXkgPyBzcmNbaV1ba2V5XSA6IHNyY1tpXTsKCQkJaWYodmFsdWVzLmluZGV4T2YodmFsKSA8IDApIHsKCQkJCXJlc3VsdHMucHVzaChzcmNbaV0pOwoJCQl9CgkJCXZhbHVlc1tpXSA9IHZhbDsKCQkJaSsrOwoJCX0KCgkJaWYoc29ydCkgewoJCQlpZigha2V5KSB7CgkJCQlyZXN1bHRzID0gcmVzdWx0cy5zb3J0KCk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHRzID0gcmVzdWx0cy5zb3J0KGZ1bmN0aW9uIHNvcnRVbmlxdWVBcnJheShhLCBiKSB7CgkJCQkJcmV0dXJuIGFba2V5XSA+IGJba2V5XTsKCQkJCX0pOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmVzdWx0czsKCX07Cgl2YXIgZ2V0TXVsdGlDZW50ZXIgPSBmdW5jdGlvbih0b3VjaGVzKSB7CgkJdmFyIHRvdWNoZXNMZW5ndGggPSB0b3VjaGVzLmxlbmd0aDsKCQlpZih0b3VjaGVzTGVuZ3RoID09PSAxKSB7CgkJCXJldHVybiB7CgkJCQl4OiByb3VuZCh0b3VjaGVzWzBdLnBhZ2VYKSwKCQkJCXk6IHJvdW5kKHRvdWNoZXNbMF0ucGFnZVkpCgkJCX07CgkJfQoKCQl2YXIgeCA9IDA7CgkJdmFyIHkgPSAwOwoJCXZhciBpID0gMDsKCQl3aGlsZShpIDwgdG91Y2hlc0xlbmd0aCkgewoJCQl4ICs9IHRvdWNoZXNbaV0ucGFnZVg7CgkJCXkgKz0gdG91Y2hlc1tpXS5wYWdlWTsKCQkJaSsrOwoJCX0KCgkJcmV0dXJuIHsKCQkJeDogcm91bmQoeCAvIHRvdWNoZXNMZW5ndGgpLAoJCQl5OiByb3VuZCh5IC8gdG91Y2hlc0xlbmd0aCkKCQl9OwoJfTsKCXZhciBtdWx0aVRvdWNoID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQub3B0aW9ucy5nZXN0dXJlQ29uZmlnLnBpbmNoOwoJfTsKCXZhciBjb3B5U2ltcGxlVG91Y2hEYXRhID0gZnVuY3Rpb24odG91Y2gpIHsKCQl2YXIgdG91Y2hlcyA9IFtdOwoJCXZhciBpID0gMDsKCQl3aGlsZShpIDwgdG91Y2gudG91Y2hlcy5sZW5ndGgpIHsKCQkJdG91Y2hlc1tpXSA9IHsKCQkJCXBhZ2VYOiByb3VuZCh0b3VjaC50b3VjaGVzW2ldLnBhZ2VYKSwKCQkJCXBhZ2VZOiByb3VuZCh0b3VjaC50b3VjaGVzW2ldLnBhZ2VZKQoJCQl9OwoJCQlpKys7CgkJfQoJCXJldHVybiB7CgkJCXRpbWVzdGFtcDogJC5ub3coKSwKCQkJZ2VzdHVyZTogdG91Y2guZ2VzdHVyZSwKCQkJdG91Y2hlczogdG91Y2hlcywKCQkJY2VudGVyOiBnZXRNdWx0aUNlbnRlcih0b3VjaC50b3VjaGVzKSwKCQkJZGVsdGFYOiB0b3VjaC5kZWx0YVgsCgkJCWRlbHRhWTogdG91Y2guZGVsdGFZCgkJfTsKCX07CgoJdmFyIGNhbERlbHRhID0gZnVuY3Rpb24odG91Y2gpIHsKCQl2YXIgc2Vzc2lvbiA9ICQuZ2VzdHVyZXMuc2Vzc2lvbjsKCQl2YXIgY2VudGVyID0gdG91Y2guY2VudGVyOwoJCXZhciBvZmZzZXQgPSBzZXNzaW9uLm9mZnNldERlbHRhIHx8IHt9OwoJCXZhciBwcmV2RGVsdGEgPSBzZXNzaW9uLnByZXZEZWx0YSB8fCB7fTsKCQl2YXIgcHJldlRvdWNoID0gc2Vzc2lvbi5wcmV2VG91Y2ggfHwge307CgoJCWlmKHRvdWNoLmdlc3R1cmUudHlwZSA9PT0gJC5FVkVOVF9TVEFSVCB8fCB0b3VjaC5nZXN0dXJlLnR5cGUgPT09ICQuRVZFTlRfRU5EKSB7CgkJCXByZXZEZWx0YSA9IHNlc3Npb24ucHJldkRlbHRhID0gewoJCQkJeDogcHJldlRvdWNoLmRlbHRhWCB8fCAwLAoJCQkJeTogcHJldlRvdWNoLmRlbHRhWSB8fCAwCgkJCX07CgoJCQlvZmZzZXQgPSBzZXNzaW9uLm9mZnNldERlbHRhID0gewoJCQkJeDogY2VudGVyLngsCgkJCQl5OiBjZW50ZXIueQoJCQl9OwoJCX0KCQl0b3VjaC5kZWx0YVggPSBwcmV2RGVsdGEueCArIChjZW50ZXIueCAtIG9mZnNldC54KTsKCQl0b3VjaC5kZWx0YVkgPSBwcmV2RGVsdGEueSArIChjZW50ZXIueSAtIG9mZnNldC55KTsKCX07Cgl2YXIgY2FsVG91Y2hEYXRhID0gZnVuY3Rpb24odG91Y2gpIHsKCQl2YXIgc2Vzc2lvbiA9ICQuZ2VzdHVyZXMuc2Vzc2lvbjsKCQl2YXIgdG91Y2hlcyA9IHRvdWNoLnRvdWNoZXM7CgkJdmFyIHRvdWNoZXNMZW5ndGggPSB0b3VjaGVzLmxlbmd0aDsKCgkJaWYoIXNlc3Npb24uZmlyc3RUb3VjaCkgewoJCQlzZXNzaW9uLmZpcnN0VG91Y2ggPSBjb3B5U2ltcGxlVG91Y2hEYXRhKHRvdWNoKTsKCQl9CgoJCWlmKG11bHRpVG91Y2goKSAmJiB0b3VjaGVzTGVuZ3RoID4gMSAmJiAhc2Vzc2lvbi5maXJzdE11bHRpVG91Y2gpIHsKCQkJc2Vzc2lvbi5maXJzdE11bHRpVG91Y2ggPSBjb3B5U2ltcGxlVG91Y2hEYXRhKHRvdWNoKTsKCQl9IGVsc2UgaWYodG91Y2hlc0xlbmd0aCA9PT0gMSkgewoJCQlzZXNzaW9uLmZpcnN0TXVsdGlUb3VjaCA9IGZhbHNlOwoJCX0KCgkJdmFyIGZpcnN0VG91Y2ggPSBzZXNzaW9uLmZpcnN0VG91Y2g7CgkJdmFyIGZpcnN0TXVsdGlUb3VjaCA9IHNlc3Npb24uZmlyc3RNdWx0aVRvdWNoOwoJCXZhciBvZmZzZXRDZW50ZXIgPSBmaXJzdE11bHRpVG91Y2ggPyBmaXJzdE11bHRpVG91Y2guY2VudGVyIDogZmlyc3RUb3VjaC5jZW50ZXI7CgoJCXZhciBjZW50ZXIgPSB0b3VjaC5jZW50ZXIgPSBnZXRNdWx0aUNlbnRlcih0b3VjaGVzKTsKCQl0b3VjaC50aW1lc3RhbXAgPSAkLm5vdygpOwoJCXRvdWNoLmRlbHRhVGltZSA9IHRvdWNoLnRpbWVzdGFtcCAtIGZpcnN0VG91Y2gudGltZXN0YW1wOwoKCQl0b3VjaC5hbmdsZSA9IGdldEFuZ2xlKG9mZnNldENlbnRlciwgY2VudGVyKTsKCQl0b3VjaC5kaXN0YW5jZSA9IGdldERpc3RhbmNlKG9mZnNldENlbnRlciwgY2VudGVyKTsKCgkJY2FsRGVsdGEodG91Y2gpOwoKCQl0b3VjaC5vZmZzZXREaXJlY3Rpb24gPSBnZXREaXJlY3Rpb24odG91Y2guZGVsdGFYLCB0b3VjaC5kZWx0YVkpOwoKCQl0b3VjaC5zY2FsZSA9IGZpcnN0TXVsdGlUb3VjaCA/IGdldFNjYWxlKGZpcnN0TXVsdGlUb3VjaC50b3VjaGVzLCB0b3VjaGVzKSA6IDE7CgkJdG91Y2gucm90YXRpb24gPSBmaXJzdE11bHRpVG91Y2ggPyBnZXRSb3RhdGlvbihmaXJzdE11bHRpVG91Y2gudG91Y2hlcywgdG91Y2hlcykgOiAwOwoKCQljYWxJbnRlcnZhbFRvdWNoRGF0YSh0b3VjaCk7CgoJfTsKCXZhciBDQUxfSU5URVJWQUwgPSAyNTsKCXZhciBjYWxJbnRlcnZhbFRvdWNoRGF0YSA9IGZ1bmN0aW9uKHRvdWNoKSB7CgkJdmFyIHNlc3Npb24gPSAkLmdlc3R1cmVzLnNlc3Npb247CgkJdmFyIGxhc3QgPSBzZXNzaW9uLmxhc3RJbnRlcnZhbCB8fCB0b3VjaDsKCQl2YXIgZGVsdGFUaW1lID0gdG91Y2gudGltZXN0YW1wIC0gbGFzdC50aW1lc3RhbXA7CgkJdmFyIHZlbG9jaXR5OwoJCXZhciB2ZWxvY2l0eVg7CgkJdmFyIHZlbG9jaXR5WTsKCQl2YXIgZGlyZWN0aW9uOwoKCQlpZih0b3VjaC5nZXN0dXJlLnR5cGUgIT0gJC5FVkVOVF9DQU5DRUwgJiYgKGRlbHRhVGltZSA+IENBTF9JTlRFUlZBTCB8fCBsYXN0LnZlbG9jaXR5ID09PSB1bmRlZmluZWQpKSB7CgkJCXZhciBkZWx0YVggPSBsYXN0LmRlbHRhWCAtIHRvdWNoLmRlbHRhWDsKCQkJdmFyIGRlbHRhWSA9IGxhc3QuZGVsdGFZIC0gdG91Y2guZGVsdGFZOwoKCQkJdmFyIHYgPSBnZXRWZWxvY2l0eShkZWx0YVRpbWUsIGRlbHRhWCwgZGVsdGFZKTsKCQkJdmVsb2NpdHlYID0gdi54OwoJCQl2ZWxvY2l0eVkgPSB2Lnk7CgkJCXZlbG9jaXR5ID0gKGFicyh2LngpID4gYWJzKHYueSkpID8gdi54IDogdi55OwoJCQlkaXJlY3Rpb24gPSBnZXREaXJlY3Rpb24oZGVsdGFYLCBkZWx0YVkpIHx8IGxhc3QuZGlyZWN0aW9uOwoKCQkJc2Vzc2lvbi5sYXN0SW50ZXJ2YWwgPSB0b3VjaDsKCQl9IGVsc2UgewoJCQl2ZWxvY2l0eSA9IGxhc3QudmVsb2NpdHk7CgkJCXZlbG9jaXR5WCA9IGxhc3QudmVsb2NpdHlYOwoJCQl2ZWxvY2l0eVkgPSBsYXN0LnZlbG9jaXR5WTsKCQkJZGlyZWN0aW9uID0gbGFzdC5kaXJlY3Rpb247CgkJfQoKCQl0b3VjaC52ZWxvY2l0eSA9IHZlbG9jaXR5OwoJCXRvdWNoLnZlbG9jaXR5WCA9IHZlbG9jaXR5WDsKCQl0b3VjaC52ZWxvY2l0eVkgPSB2ZWxvY2l0eVk7CgkJdG91Y2guZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJfTsKCXZhciB0YXJnZXRJZHMgPSB7fTsKCXZhciBjb252ZXJ0VG91Y2hlcyA9IGZ1bmN0aW9uKHRvdWNoZXMpIHsKCQlmb3IodmFyIGkgPSAwOyBpIDwgdG91Y2hlcy5sZW5ndGg7IGkrKykgewoJCQkhdG91Y2hlc1snaWRlbnRpZmllciddICYmICh0b3VjaGVzWydpZGVudGlmaWVyJ10gPSAwKTsKCQl9CgkJcmV0dXJuIHRvdWNoZXM7Cgl9OwoJdmFyIGdldFRvdWNoZXMgPSBmdW5jdGlvbihldmVudCwgdG91Y2gpIHsKCQl2YXIgYWxsVG91Y2hlcyA9IGNvbnZlcnRUb3VjaGVzKCQuc2xpY2UuY2FsbChldmVudC50b3VjaGVzIHx8IFtldmVudF0pKTsKCgkJdmFyIHR5cGUgPSBldmVudC50eXBlOwoKCQl2YXIgdGFyZ2V0VG91Y2hlcyA9IFtdOwoJCXZhciBjaGFuZ2VkVGFyZ2V0VG91Y2hlcyA9IFtdOwoKCQkvL+W9k3RvdWNoc3RhcnTmiJZ0b3VjaG1vdmXkuJR0b3VjaGVz6ZW/5bqm5Li6Me+8jOebtOaOpeiOt+W+l2FsbOWSjGNoYW5nZWQKCQlpZigodHlwZSA9PT0gJC5FVkVOVF9TVEFSVCB8fCB0eXBlID09PSAkLkVWRU5UX01PVkUpICYmIGFsbFRvdWNoZXMubGVuZ3RoID09PSAxKSB7CgkJCXRhcmdldElkc1thbGxUb3VjaGVzWzBdLmlkZW50aWZpZXJdID0gdHJ1ZTsKCQkJdGFyZ2V0VG91Y2hlcyA9IGFsbFRvdWNoZXM7CgkJCWNoYW5nZWRUYXJnZXRUb3VjaGVzID0gYWxsVG91Y2hlczsKCQkJdG91Y2gudGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCX0gZWxzZSB7CgkJCXZhciBpID0gMDsKCQkJdmFyIHRhcmdldFRvdWNoZXMgPSBbXTsKCQkJdmFyIGNoYW5nZWRUYXJnZXRUb3VjaGVzID0gW107CgkJCXZhciBjaGFuZ2VkVG91Y2hlcyA9IGNvbnZlcnRUb3VjaGVzKCQuc2xpY2UuY2FsbChldmVudC5jaGFuZ2VkVG91Y2hlcyB8fCBbZXZlbnRdKSk7CgoJCQl0b3VjaC50YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJCXZhciBzZXNzaW9uVGFyZ2V0ID0gJC5nZXN0dXJlcy5zZXNzaW9uLnRhcmdldCB8fCBldmVudC50YXJnZXQ7CgkJCXRhcmdldFRvdWNoZXMgPSBhbGxUb3VjaGVzLmZpbHRlcihmdW5jdGlvbih0b3VjaCkgewoJCQkJcmV0dXJuIGhhc1BhcmVudCh0b3VjaC50YXJnZXQsIHNlc3Npb25UYXJnZXQpOwoJCQl9KTsKCgkJCWlmKHR5cGUgPT09ICQuRVZFTlRfU1RBUlQpIHsKCQkJCWkgPSAwOwoJCQkJd2hpbGUoaSA8IHRhcmdldFRvdWNoZXMubGVuZ3RoKSB7CgkJCQkJdGFyZ2V0SWRzW3RhcmdldFRvdWNoZXNbaV0uaWRlbnRpZmllcl0gPSB0cnVlOwoJCQkJCWkrKzsKCQkJCX0KCQkJfQoKCQkJaSA9IDA7CgkJCXdoaWxlKGkgPCBjaGFuZ2VkVG91Y2hlcy5sZW5ndGgpIHsKCQkJCWlmKHRhcmdldElkc1tjaGFuZ2VkVG91Y2hlc1tpXS5pZGVudGlmaWVyXSkgewoJCQkJCWNoYW5nZWRUYXJnZXRUb3VjaGVzLnB1c2goY2hhbmdlZFRvdWNoZXNbaV0pOwoJCQkJfQoJCQkJaWYodHlwZSA9PT0gJC5FVkVOVF9FTkQgfHwgdHlwZSA9PT0gJC5FVkVOVF9DQU5DRUwpIHsKCQkJCQlkZWxldGUgdGFyZ2V0SWRzW2NoYW5nZWRUb3VjaGVzW2ldLmlkZW50aWZpZXJdOwoJCQkJfQoJCQkJaSsrOwoJCQl9CgoJCQlpZighY2hhbmdlZFRhcmdldFRvdWNoZXMubGVuZ3RoKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgkJdGFyZ2V0VG91Y2hlcyA9IHVuaXF1ZUFycmF5KHRhcmdldFRvdWNoZXMuY29uY2F0KGNoYW5nZWRUYXJnZXRUb3VjaGVzKSwgJ2lkZW50aWZpZXInLCB0cnVlKTsKCQl2YXIgdG91Y2hlc0xlbmd0aCA9IHRhcmdldFRvdWNoZXMubGVuZ3RoOwoJCXZhciBjaGFuZ2VkVG91Y2hlc0xlbmd0aCA9IGNoYW5nZWRUYXJnZXRUb3VjaGVzLmxlbmd0aDsKCQlpZih0eXBlID09PSAkLkVWRU5UX1NUQVJUICYmIHRvdWNoZXNMZW5ndGggLSBjaGFuZ2VkVG91Y2hlc0xlbmd0aCA9PT0gMCkgeyAvL2ZpcnN0CgkJCXRvdWNoLmlzRmlyc3QgPSB0cnVlOwoJCQkkLmdlc3R1cmVzLnRvdWNoID0gJC5nZXN0dXJlcy5zZXNzaW9uID0gewoJCQkJdGFyZ2V0OiBldmVudC50YXJnZXQKCQkJfTsKCQl9CgkJdG91Y2guaXNGaW5hbCA9ICgodHlwZSA9PT0gJC5FVkVOVF9FTkQgfHwgdHlwZSA9PT0gJC5FVkVOVF9DQU5DRUwpICYmICh0b3VjaGVzTGVuZ3RoIC0gY2hhbmdlZFRvdWNoZXNMZW5ndGggPT09IDApKTsKCgkJdG91Y2gudG91Y2hlcyA9IHRhcmdldFRvdWNoZXM7CgkJdG91Y2guY2hhbmdlZFRvdWNoZXMgPSBjaGFuZ2VkVGFyZ2V0VG91Y2hlczsKCQlyZXR1cm4gdHJ1ZTsKCgl9OwoJdmFyIGhhbmRsZVRvdWNoRXZlbnQgPSBmdW5jdGlvbihldmVudCkgewoJCXZhciB0b3VjaCA9IHsKCQkJZ2VzdHVyZTogZXZlbnQKCQl9OwoJCXZhciB0b3VjaGVzID0gZ2V0VG91Y2hlcyhldmVudCwgdG91Y2gpOwoJCWlmKCF0b3VjaGVzKSB7CgkJCXJldHVybjsKCQl9CgkJY2FsVG91Y2hEYXRhKHRvdWNoKTsKCQlkZXRlY3QoZXZlbnQsIHRvdWNoKTsKCQkkLmdlc3R1cmVzLnNlc3Npb24ucHJldlRvdWNoID0gdG91Y2g7CgkJaWYoZXZlbnQudHlwZSA9PT0gJC5FVkVOVF9FTkQgJiYgISQuaXNUb3VjaGFibGUpIHsKCQkJJC5nZXN0dXJlcy50b3VjaCA9ICQuZ2VzdHVyZXMuc2Vzc2lvbiA9IHt9OwoJCX0KCX07Cgl2YXIgc3VwcG9ydHNQYXNzaXZlID0gKGZ1bmN0aW9uIGNoZWNrUGFzc2l2ZUxpc3RlbmVyKCkgewoJCXZhciBzdXBwb3J0c1Bhc3NpdmUgPSBmYWxzZTsKCQl0cnkgewoJCQl2YXIgb3B0cyA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh7fSwgJ3Bhc3NpdmUnLCB7CgkJCQlnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKCQkJCQlzdXBwb3J0c1Bhc3NpdmUgPSB0cnVlOwoJCQkJfSwKCQkJfSk7CgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0ZXN0UGFzc2l2ZUxpc3RlbmVyJywgbnVsbCwgb3B0cyk7CgkJfSBjYXRjaChlKSB7CgkJCS8vIE5vIHN1cHBvcnQKCQl9CgkJcmV0dXJuIHN1cHBvcnRzUGFzc2l2ZTsKCX0oKSkKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCQuRVZFTlRfU1RBUlQsIGhhbmRsZVRvdWNoRXZlbnQpOwoJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJC5FVkVOVF9NT1ZFLCBoYW5kbGVUb3VjaEV2ZW50LCBzdXBwb3J0c1Bhc3NpdmUgPyB7CgkJcGFzc2l2ZTogZmFsc2UsCgkJY2FwdHVyZTogZmFsc2UKCX0gOiBmYWxzZSk7Cgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigkLkVWRU5UX0VORCwgaGFuZGxlVG91Y2hFdmVudCk7Cgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigkLkVWRU5UX0NBTkNFTCwgaGFuZGxlVG91Y2hFdmVudCk7CgkvL2ZpeGVkIGhhc2hjaGFuZ2UoYW5kcm9pZCkKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCQuRVZFTlRfQ0xJQ0ssIGZ1bmN0aW9uKGUpIHsKCQkvL1RPRE8g5bqU6K+l5Yik5pat5b2T5YmNdGFyZ2V05piv5LiN5piv5ZyodGFyZ2V0cy5wb3BvdmVy5YaF6YOo77yM6ICM5LiN5piv6Z2e6KaB55u4562JCgkJaWYoKCQub3MuYW5kcm9pZCB8fCAkLm9zLmlvcykgJiYgKCgkLnRhcmdldHMucG9wb3ZlciAmJiBlLnRhcmdldCA9PT0gJC50YXJnZXRzLnBvcG92ZXIpIHx8ICgkLnRhcmdldHMudGFiKSB8fCAkLnRhcmdldHMub2ZmY2FudmFzIHx8ICQudGFyZ2V0cy5tb2RhbCkpIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sIHRydWUpOwoKCS8v5aKe5Yqg5Y6f55Sf5rua5Yqo6K+G5YirCgkkLmlzU2Nyb2xsaW5nID0gZmFsc2U7Cgl2YXIgc2Nyb2xsaW5nVGltZW91dCA9IG51bGw7Cgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgZnVuY3Rpb24oKSB7CgkJJC5pc1Njcm9sbGluZyA9IHRydWU7CgkJc2Nyb2xsaW5nVGltZW91dCAmJiBjbGVhclRpbWVvdXQoc2Nyb2xsaW5nVGltZW91dCk7CgkJc2Nyb2xsaW5nVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCSQuaXNTY3JvbGxpbmcgPSBmYWxzZTsKCQl9LCAyNTApOwoJfSk7Cn0pKG11aSwgd2luZG93KTsKLyoqCiAqIG11aSBnZXN0dXJlIGZsaWNrW2xlZnR8cmlnaHR8dXB8ZG93bl0KICogQHBhcmFtIHt0eXBlfSAkCiAqIEBwYXJhbSB7dHlwZX0gbmFtZQogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQsIG5hbWUpIHsKCXZhciBmbGlja1N0YXJ0VGltZSA9IDA7Cgl2YXIgaGFuZGxlID0gZnVuY3Rpb24oZXZlbnQsIHRvdWNoKSB7CgkJdmFyIHNlc3Npb24gPSAkLmdlc3R1cmVzLnNlc3Npb247CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgkJdmFyIG5vdyA9ICQubm93KCk7CgkJc3dpdGNoIChldmVudC50eXBlKSB7CgkJCWNhc2UgJC5FVkVOVF9NT1ZFOgoJCQkJaWYgKG5vdyAtIGZsaWNrU3RhcnRUaW1lID4gMzAwKSB7CgkJCQkJZmxpY2tTdGFydFRpbWUgPSBub3c7CgkJCQkJc2Vzc2lvbi5mbGlja1N0YXJ0ID0gdG91Y2guY2VudGVyOwoJCQkJfQoJCQkJYnJlYWs7CgkJCWNhc2UgJC5FVkVOVF9FTkQ6CgkJCWNhc2UgJC5FVkVOVF9DQU5DRUw6CgkJCQl0b3VjaC5mbGljayA9IGZhbHNlOwoJCQkJaWYgKHNlc3Npb24uZmxpY2tTdGFydCAmJiBvcHRpb25zLmZsaWNrTWF4VGltZSA+IChub3cgLSBmbGlja1N0YXJ0VGltZSkgJiYgdG91Y2guZGlzdGFuY2UgPiBvcHRpb25zLmZsaWNrTWluRGlzdGluY2UpIHsKCQkJCQl0b3VjaC5mbGljayA9IHRydWU7CgkJCQkJdG91Y2guZmxpY2tUaW1lID0gbm93IC0gZmxpY2tTdGFydFRpbWU7CgkJCQkJdG91Y2guZmxpY2tEaXN0YW5jZVggPSB0b3VjaC5jZW50ZXIueCAtIHNlc3Npb24uZmxpY2tTdGFydC54OwoJCQkJCXRvdWNoLmZsaWNrRGlzdGFuY2VZID0gdG91Y2guY2VudGVyLnkgLSBzZXNzaW9uLmZsaWNrU3RhcnQueTsKCQkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUsIHRvdWNoKTsKCQkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUgKyB0b3VjaC5kaXJlY3Rpb24sIHRvdWNoKTsKCQkJCX0KCQkJCWJyZWFrOwoJCX0KCgl9OwoJLyoqCgkgKiBtdWkgZ2VzdHVyZSBmbGljawoJICovCgkkLmFkZEdlc3R1cmUoewoJCW5hbWU6IG5hbWUsCgkJaW5kZXg6IDUsCgkJaGFuZGxlOiBoYW5kbGUsCgkJb3B0aW9uczogewoJCQlmbGlja01heFRpbWU6IDIwMCwKCQkJZmxpY2tNaW5EaXN0aW5jZTogMTAKCQl9Cgl9KTsKfSkobXVpLCAnZmxpY2snKTsKLyoqCiAqIG11aSBnZXN0dXJlIHN3aXBlW2xlZnR8cmlnaHR8dXB8ZG93bl0KICogQHBhcmFtIHt0eXBlfSAkCiAqIEBwYXJhbSB7dHlwZX0gbmFtZQogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQsIG5hbWUpIHsKCXZhciBoYW5kbGUgPSBmdW5jdGlvbihldmVudCwgdG91Y2gpIHsKCQl2YXIgc2Vzc2lvbiA9ICQuZ2VzdHVyZXMuc2Vzc2lvbjsKCQlpZiAoZXZlbnQudHlwZSA9PT0gJC5FVkVOVF9FTkQgfHwgZXZlbnQudHlwZSA9PT0gJC5FVkVOVF9DQU5DRUwpIHsKCQkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgkJCXRvdWNoLnN3aXBlID0gZmFsc2U7CgkJCS8vVE9ETyDlkI7nu63moLnmja52ZWxvY2l0eeiuoeeulwoJCQlpZiAodG91Y2guZGlyZWN0aW9uICYmIG9wdGlvbnMuc3dpcGVNYXhUaW1lID4gdG91Y2guZGVsdGFUaW1lICYmIHRvdWNoLmRpc3RhbmNlID4gb3B0aW9ucy5zd2lwZU1pbkRpc3RpbmNlKSB7CgkJCQl0b3VjaC5zd2lwZSA9IHRydWU7CgkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUsIHRvdWNoKTsKCQkJCSQudHJpZ2dlcihzZXNzaW9uLnRhcmdldCwgbmFtZSArIHRvdWNoLmRpcmVjdGlvbiwgdG91Y2gpOwoJCQl9CgkJfQoJfTsKCS8qKgoJICogbXVpIGdlc3R1cmUgc3dpcGUKCSAqLwoJJC5hZGRHZXN0dXJlKHsKCQluYW1lOiBuYW1lLAoJCWluZGV4OiAxMCwKCQloYW5kbGU6IGhhbmRsZSwKCQlvcHRpb25zOiB7CgkJCXN3aXBlTWF4VGltZTogMzAwLAoJCQlzd2lwZU1pbkRpc3RpbmNlOiAxOAoJCX0KCX0pOwp9KShtdWksICdzd2lwZScpOwovKioKICogbXVpIGdlc3R1cmUgZHJhZ1tzdGFydHxsZWZ0fHJpZ2h0fHVwfGRvd258ZW5kXQogKiBAcGFyYW0ge3R5cGV9ICQKICogQHBhcmFtIHt0eXBlfSBuYW1lCiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgbmFtZSkgewoJdmFyIGhhbmRsZSA9IGZ1bmN0aW9uKGV2ZW50LCB0b3VjaCkgewoJCXZhciBzZXNzaW9uID0gJC5nZXN0dXJlcy5zZXNzaW9uOwoJCXN3aXRjaCAoZXZlbnQudHlwZSkgewoJCQljYXNlICQuRVZFTlRfU1RBUlQ6CgkJCQlicmVhazsKCQkJY2FzZSAkLkVWRU5UX01PVkU6CgkJCQlpZiAoIXRvdWNoLmRpcmVjdGlvbiB8fCAhc2Vzc2lvbi50YXJnZXQpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkvL+S/ruato2RpcmVjdGlvbizlj6/lnKhzZXNzaW9u5pyf6Ze06Ieq6KGM6ZSB5a6a5ouW5ou95pa55ZCR77yM5pa55L6/5byA5Y+Rc2Nyb2xs57G75LiN5ZCM5pa55ZCR5ouW5ou95o+S5Lu25bWM5aWXCgkJCQlpZiAoc2Vzc2lvbi5sb2NrRGlyZWN0aW9uICYmIHNlc3Npb24uc3RhcnREaXJlY3Rpb24pIHsKCQkJCQlpZiAoc2Vzc2lvbi5zdGFydERpcmVjdGlvbiAmJiBzZXNzaW9uLnN0YXJ0RGlyZWN0aW9uICE9PSB0b3VjaC5kaXJlY3Rpb24pIHsKCQkJCQkJaWYgKHNlc3Npb24uc3RhcnREaXJlY3Rpb24gPT09ICd1cCcgfHwgc2Vzc2lvbi5zdGFydERpcmVjdGlvbiA9PT0gJ2Rvd24nKSB7CgkJCQkJCQl0b3VjaC5kaXJlY3Rpb24gPSB0b3VjaC5kZWx0YVkgPCAwID8gJ3VwJyA6ICdkb3duJzsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXRvdWNoLmRpcmVjdGlvbiA9IHRvdWNoLmRlbHRhWCA8IDAgPyAnbGVmdCcgOiAncmlnaHQnOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCWlmICghc2Vzc2lvbi5kcmFnKSB7CgkJCQkJc2Vzc2lvbi5kcmFnID0gdHJ1ZTsKCQkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUgKyAnc3RhcnQnLCB0b3VjaCk7CgkJCQl9CgkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUsIHRvdWNoKTsKCQkJCSQudHJpZ2dlcihzZXNzaW9uLnRhcmdldCwgbmFtZSArIHRvdWNoLmRpcmVjdGlvbiwgdG91Y2gpOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5FVkVOVF9FTkQ6CgkJCWNhc2UgJC5FVkVOVF9DQU5DRUw6CgkJCQlpZiAoc2Vzc2lvbi5kcmFnICYmIHRvdWNoLmlzRmluYWwpIHsKCQkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUgKyAnZW5kJywgdG91Y2gpOwoJCQkJfQoJCQkJYnJlYWs7CgkJfQoJfTsKCS8qKgoJICogbXVpIGdlc3R1cmUgZHJhZwoJICovCgkkLmFkZEdlc3R1cmUoewoJCW5hbWU6IG5hbWUsCgkJaW5kZXg6IDIwLAoJCWhhbmRsZTogaGFuZGxlLAoJCW9wdGlvbnM6IHsKCQkJZmluZ2VyczogMQoJCX0KCX0pOwp9KShtdWksICdkcmFnJyk7Ci8qKgogKiBtdWkgZ2VzdHVyZSB0YXAgYW5kIGRvdWJsZVRhcAogKiBAcGFyYW0ge3R5cGV9ICQKICogQHBhcmFtIHt0eXBlfSBuYW1lCiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgbmFtZSkgewoJdmFyIGxhc3RUYXJnZXQ7Cgl2YXIgbGFzdFRhcFRpbWU7Cgl2YXIgaGFuZGxlID0gZnVuY3Rpb24oZXZlbnQsIHRvdWNoKSB7CgkJdmFyIHNlc3Npb24gPSAkLmdlc3R1cmVzLnNlc3Npb247CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgkJc3dpdGNoIChldmVudC50eXBlKSB7CgkJCWNhc2UgJC5FVkVOVF9FTkQ6CgkJCQlpZiAoIXRvdWNoLmlzRmluYWwpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQl2YXIgdGFyZ2V0ID0gc2Vzc2lvbi50YXJnZXQ7CgkJCQlpZiAoIXRhcmdldCB8fCAodGFyZ2V0LmRpc2FibGVkIHx8ICh0YXJnZXQuY2xhc3NMaXN0ICYmIHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ211aS1kaXNhYmxlZCcpKSkpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAodG91Y2guZGlzdGFuY2UgPCBvcHRpb25zLnRhcE1heERpc3RhbmNlICYmIHRvdWNoLmRlbHRhVGltZSA8IG9wdGlvbnMudGFwTWF4VGltZSkgewoJCQkJCWlmICgkLm9wdGlvbnMuZ2VzdHVyZUNvbmZpZy5kb3VibGV0YXAgJiYgbGFzdFRhcmdldCAmJiAobGFzdFRhcmdldCA9PT0gdGFyZ2V0KSkgeyAvL3NhbWUgdGFyZ2V0CgkJCQkJCWlmIChsYXN0VGFwVGltZSAmJiAodG91Y2gudGltZXN0YW1wIC0gbGFzdFRhcFRpbWUpIDwgb3B0aW9ucy50YXBNYXhJbnRlcnZhbCkgewoJCQkJCQkJJC50cmlnZ2VyKHRhcmdldCwgJ2RvdWJsZXRhcCcsIHRvdWNoKTsKCQkJCQkJCWxhc3RUYXBUaW1lID0gJC5ub3coKTsKCQkJCQkJCWxhc3RUYXJnZXQgPSB0YXJnZXQ7CgkJCQkJCQlyZXR1cm47CgkJCQkJCX0KCQkJCQl9CgkJCQkJJC50cmlnZ2VyKHRhcmdldCwgbmFtZSwgdG91Y2gpOwoJCQkJCWxhc3RUYXBUaW1lID0gJC5ub3coKTsKCQkJCQlsYXN0VGFyZ2V0ID0gdGFyZ2V0OwoJCQkJfQoJCQkJYnJlYWs7CgkJfQoJfTsKCS8qKgoJICogbXVpIGdlc3R1cmUgdGFwCgkgKi8KCSQuYWRkR2VzdHVyZSh7CgkJbmFtZTogbmFtZSwKCQlpbmRleDogMzAsCgkJaGFuZGxlOiBoYW5kbGUsCgkJb3B0aW9uczogewoJCQlmaW5nZXJzOiAxLAoJCQl0YXBNYXhJbnRlcnZhbDogMzAwLAoJCQl0YXBNYXhEaXN0YW5jZTogNSwKCQkJdGFwTWF4VGltZTogMjUwCgkJfQoJfSk7Cn0pKG11aSwgJ3RhcCcpOwovKioKICogbXVpIGdlc3R1cmUgbG9uZ3RhcAogKiBAcGFyYW0ge3R5cGV9ICQKICogQHBhcmFtIHt0eXBlfSBuYW1lCiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgbmFtZSkgewoJdmFyIHRpbWVyOwoJdmFyIGhhbmRsZSA9IGZ1bmN0aW9uKGV2ZW50LCB0b3VjaCkgewoJCXZhciBzZXNzaW9uID0gJC5nZXN0dXJlcy5zZXNzaW9uOwoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoJCXN3aXRjaCAoZXZlbnQudHlwZSkgewoJCQljYXNlICQuRVZFTlRfU1RBUlQ6CgkJCQljbGVhclRpbWVvdXQodGltZXIpOwoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQudHJpZ2dlcihzZXNzaW9uLnRhcmdldCwgbmFtZSwgdG91Y2gpOwoJCQkJfSwgb3B0aW9ucy5ob2xkVGltZW91dCk7CgkJCQlicmVhazsKCQkJY2FzZSAkLkVWRU5UX01PVkU6CgkJCQlpZiAodG91Y2guZGlzdGFuY2UgPiBvcHRpb25zLmhvbGRUaHJlc2hvbGQpIHsKCQkJCQljbGVhclRpbWVvdXQodGltZXIpOwoJCQkJfQoJCQkJYnJlYWs7CgkJCWNhc2UgJC5FVkVOVF9FTkQ6CgkJCWNhc2UgJC5FVkVOVF9DQU5DRUw6CgkJCQljbGVhclRpbWVvdXQodGltZXIpOwoJCQkJYnJlYWs7CgkJfQoJfTsKCS8qKgoJICogbXVpIGdlc3R1cmUgbG9uZ3RhcAoJICovCgkkLmFkZEdlc3R1cmUoewoJCW5hbWU6IG5hbWUsCgkJaW5kZXg6IDEwLAoJCWhhbmRsZTogaGFuZGxlLAoJCW9wdGlvbnM6IHsKCQkJZmluZ2VyczogMSwKCQkJaG9sZFRpbWVvdXQ6IDUwMCwKCQkJaG9sZFRocmVzaG9sZDogMgoJCX0KCX0pOwp9KShtdWksICdsb25ndGFwJyk7Ci8qKgogKiBtdWkgZ2VzdHVyZSBob2xkCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcGFyYW0ge3R5cGV9IG5hbWUKICogQHJldHVybnMge3VuZGVmaW5lZH0KICovCihmdW5jdGlvbigkLCBuYW1lKSB7Cgl2YXIgdGltZXI7Cgl2YXIgaGFuZGxlID0gZnVuY3Rpb24oZXZlbnQsIHRvdWNoKSB7CgkJdmFyIHNlc3Npb24gPSAkLmdlc3R1cmVzLnNlc3Npb247CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgkJc3dpdGNoIChldmVudC50eXBlKSB7CgkJCWNhc2UgJC5FVkVOVF9TVEFSVDoKCQkJCWlmICgkLm9wdGlvbnMuZ2VzdHVyZUNvbmZpZy5ob2xkKSB7CgkJCQkJdGltZXIgJiYgY2xlYXJUaW1lb3V0KHRpbWVyKTsKCQkJCQl0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCXRvdWNoLmhvbGQgPSB0cnVlOwoJCQkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUsIHRvdWNoKTsKCQkJCQl9LCBvcHRpb25zLmhvbGRUaW1lb3V0KTsKCQkJCX0KCQkJCWJyZWFrOwoJCQljYXNlICQuRVZFTlRfTU9WRToKCQkJCWJyZWFrOwoJCQljYXNlICQuRVZFTlRfRU5EOgoJCQljYXNlICQuRVZFTlRfQ0FOQ0VMOgoJCQkJaWYgKHRpbWVyKSB7CgkJCQkJY2xlYXJUaW1lb3V0KHRpbWVyKSAmJiAodGltZXIgPSBudWxsKTsKCQkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsICdyZWxlYXNlJywgdG91Y2gpOwoJCQkJfQoJCQkJYnJlYWs7CgkJfQoJfTsKCS8qKgoJICogbXVpIGdlc3R1cmUgaG9sZAoJICovCgkkLmFkZEdlc3R1cmUoewoJCW5hbWU6IG5hbWUsCgkJaW5kZXg6IDEwLAoJCWhhbmRsZTogaGFuZGxlLAoJCW9wdGlvbnM6IHsKCQkJZmluZ2VyczogMSwKCQkJaG9sZFRpbWVvdXQ6IDAKCQl9Cgl9KTsKfSkobXVpLCAnaG9sZCcpOwovKioKICogbXVpIGdlc3R1cmUgcGluY2gKICogQHBhcmFtIHt0eXBlfSAkCiAqIEBwYXJhbSB7dHlwZX0gbmFtZQogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQsIG5hbWUpIHsKCXZhciBoYW5kbGUgPSBmdW5jdGlvbihldmVudCwgdG91Y2gpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCQl2YXIgc2Vzc2lvbiA9ICQuZ2VzdHVyZXMuc2Vzc2lvbjsKCQlzd2l0Y2ggKGV2ZW50LnR5cGUpIHsKCQkJY2FzZSAkLkVWRU5UX1NUQVJUOgoJCQkJYnJlYWs7CgkJCWNhc2UgJC5FVkVOVF9NT1ZFOgoJCQkJaWYgKCQub3B0aW9ucy5nZXN0dXJlQ29uZmlnLnBpbmNoKSB7CgkJCQkJaWYgKHRvdWNoLnRvdWNoZXMubGVuZ3RoIDwgMikgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCWlmICghc2Vzc2lvbi5waW5jaCkgeyAvL3N0YXJ0CgkJCQkJCXNlc3Npb24ucGluY2ggPSB0cnVlOwoJCQkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUgKyAnc3RhcnQnLCB0b3VjaCk7CgkJCQkJfQoJCQkJCSQudHJpZ2dlcihzZXNzaW9uLnRhcmdldCwgbmFtZSwgdG91Y2gpOwoJCQkJCXZhciBzY2FsZSA9IHRvdWNoLnNjYWxlOwoJCQkJCXZhciByb3RhdGlvbiA9IHRvdWNoLnJvdGF0aW9uOwoJCQkJCXZhciBsYXN0U2NhbGUgPSB0eXBlb2YgdG91Y2gubGFzdFNjYWxlID09PSAndW5kZWZpbmVkJyA/IDEgOiB0b3VjaC5sYXN0U2NhbGU7CgkJCQkJdmFyIHNjYWxlRGlmZiA9IDAuMDAwMDAwMDAwMDAxOyAvL+mYsuatonNjYWxl5LiObGFzdFNjYWxl55u4562J77yM5LiN6Kem5Y+R5LqL5Lu255qE5oOF5Ya144CCCgkJCQkJaWYgKHNjYWxlID4gbGFzdFNjYWxlKSB7IC8vb3V0CgkJCQkJCWxhc3RTY2FsZSA9IHNjYWxlIC0gc2NhbGVEaWZmOwoJCQkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUgKyAnb3V0JywgdG91Y2gpOwoJCQkJCX0gLy9pbgoJCQkJCWVsc2UgaWYgKHNjYWxlIDwgbGFzdFNjYWxlKSB7CgkJCQkJCWxhc3RTY2FsZSA9IHNjYWxlICsgc2NhbGVEaWZmOwoJCQkJCQkkLnRyaWdnZXIoc2Vzc2lvbi50YXJnZXQsIG5hbWUgKyAnaW4nLCB0b3VjaCk7CgkJCQkJfQoJCQkJCWlmIChNYXRoLmFicyhyb3RhdGlvbikgPiBvcHRpb25zLm1pblJvdGF0aW9uQW5nbGUpIHsKCQkJCQkJJC50cmlnZ2VyKHNlc3Npb24udGFyZ2V0LCAncm90YXRlJywgdG91Y2gpOwoJCQkJCX0KCQkJCX0KCQkJCWJyZWFrOwoJCQljYXNlICQuRVZFTlRfRU5EOgoJCQljYXNlICQuRVZFTlRfQ0FOQ0VMOgoJCQkJaWYgKCQub3B0aW9ucy5nZXN0dXJlQ29uZmlnLnBpbmNoICYmIHNlc3Npb24ucGluY2ggJiYgdG91Y2gudG91Y2hlcy5sZW5ndGggPT09IDIpIHsKCQkJCQlzZXNzaW9uLnBpbmNoID0gZmFsc2U7CgkJCQkJJC50cmlnZ2VyKHNlc3Npb24udGFyZ2V0LCBuYW1lICsgJ2VuZCcsIHRvdWNoKTsKCQkJCX0KCQkJCWJyZWFrOwoJCX0KCX07CgkvKioKCSAqIG11aSBnZXN0dXJlIHBpbmNoCgkgKi8KCSQuYWRkR2VzdHVyZSh7CgkJbmFtZTogbmFtZSwKCQlpbmRleDogMTAsCgkJaGFuZGxlOiBoYW5kbGUsCgkJb3B0aW9uczogewoJCQltaW5Sb3RhdGlvbkFuZ2xlOiAwCgkJfQoJfSk7Cn0pKG11aSwgJ3BpbmNoJyk7Ci8qKgogKiBtdWkuaW5pdAogKiBAcGFyYW0ge3R5cGV9ICQKICogQHJldHVybnMge3VuZGVmaW5lZH0KICovCihmdW5jdGlvbigkKSB7CgkkLmdsb2JhbCA9ICQub3B0aW9ucyA9IHsKCQlnZXN0dXJlQ29uZmlnOiB7CgkJCXRhcDogdHJ1ZSwKCQkJZG91YmxldGFwOiBmYWxzZSwKCQkJbG9uZ3RhcDogZmFsc2UsCgkJCWhvbGQ6IGZhbHNlLAoJCQlmbGljazogdHJ1ZSwKCQkJc3dpcGU6IHRydWUsCgkJCWRyYWc6IHRydWUsCgkJCXBpbmNoOiBmYWxzZQoJCX0KCX07CgkvKioKCSAqCgkgKiBAcGFyYW0ge3R5cGV9IG9wdGlvbnMKCSAqIEByZXR1cm5zIHt1bmRlZmluZWR9CgkgKi8KCSQuaW5pdEdsb2JhbCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkkLm9wdGlvbnMgPSAkLmV4dGVuZCh0cnVlLCAkLmdsb2JhbCwgb3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoJdmFyIGluaXRzID0ge307CgoJLyoqCgkgKiDljZXpobXphY3nva4g5Yid5aeL5YyWCgkgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucwoJICovCgkkLmluaXQgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkJJC5vcHRpb25zID0gJC5leHRlbmQodHJ1ZSwgJC5nbG9iYWwsIG9wdGlvbnMgfHwge30pOwoJCSQucmVhZHkoZnVuY3Rpb24oKSB7CgkJCSQuZG9BY3Rpb24oJ2luaXRzJywgZnVuY3Rpb24oaW5kZXgsIGluaXQpIHsKCQkJCXZhciBpc0luaXQgPSAhISghaW5pdHNbaW5pdC5uYW1lXSB8fCBpbml0LnJlcGVhdCk7CgkJCQlpZiAoaXNJbml0KSB7CgkJCQkJaW5pdC5oYW5kbGUuY2FsbCgkKTsKCQkJCQlpbml0c1tpbml0Lm5hbWVdID0gdHJ1ZTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICog5aKe5Yqg5Yid5aeL5YyW5omn6KGM5rWB56iLCgkgKiBAcGFyYW0ge2Z1bmN0aW9ufSBpbml0CgkgKi8KCSQuYWRkSW5pdCA9IGZ1bmN0aW9uKGluaXQpIHsKCQlyZXR1cm4gJC5hZGRBY3Rpb24oJ2luaXRzJywgaW5pdCk7Cgl9OwoJLyoqCgkgKiDlpITnkIZodG1sNeeJiOacrHN1YnBhZ2VzIAoJICovCgkkLmFkZEluaXQoewoJCW5hbWU6ICdpZnJhbWUnLAoJCWluZGV4OiAxMDAsCgkJaGFuZGxlOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9wdGlvbnMgPSAkLm9wdGlvbnM7CgkJCXZhciBzdWJwYWdlcyA9IG9wdGlvbnMuc3VicGFnZXMgfHwgW107CgkJCWlmICghJC5vcy5wbHVzICYmIHN1YnBhZ2VzLmxlbmd0aCkgewoJCQkJLy/mmoLml7blj6rlpITnkIbljZXkuKpzdWJwYWdl44CC5ZCO57ut5Y+v5Lul6ICD6JmR5pSv5oyB5aSa5Liqc3VicGFnZQoJCQkJY3JlYXRlSWZyYW1lKHN1YnBhZ2VzWzBdKTsKCQkJfQoJCX0KCX0pOwoJdmFyIGNyZWF0ZUlmcmFtZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCXdyYXBwZXIuY2xhc3NOYW1lID0gJ211aS1pZnJhbWUtd3JhcHBlcic7CgkJdmFyIHN0eWxlcyA9IG9wdGlvbnMuc3R5bGVzIHx8IHt9OwoJCWlmICh0eXBlb2Ygc3R5bGVzLnRvcCAhPT0gJ3N0cmluZycpIHsKCQkJc3R5bGVzLnRvcCA9ICcwcHgnOwoJCX0KCQlpZiAodHlwZW9mIHN0eWxlcy5ib3R0b20gIT09ICdzdHJpbmcnKSB7CgkJCXN0eWxlcy5ib3R0b20gPSAnMHB4JzsKCQl9CgkJd3JhcHBlci5zdHlsZS50b3AgPSBzdHlsZXMudG9wOwoJCXdyYXBwZXIuc3R5bGUuYm90dG9tID0gc3R5bGVzLmJvdHRvbTsKCQl2YXIgaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CgkJaWZyYW1lLnNyYyA9IG9wdGlvbnMudXJsOwoJCWlmcmFtZS5pZCA9IG9wdGlvbnMuaWQgfHwgb3B0aW9ucy51cmw7CgkJaWZyYW1lLm5hbWUgPSBpZnJhbWUuaWQ7CgkJd3JhcHBlci5hcHBlbmRDaGlsZChpZnJhbWUpOwoJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQod3JhcHBlcik7CgkJLy/nm67liY3ku4XlpITnkIblvq7kv6EKCQkkLm9zLndlY2hhdCAmJiBoYW5kbGVTY3JvbGwod3JhcHBlciwgaWZyYW1lKTsKCX07CgoJZnVuY3Rpb24gaGFuZGxlU2Nyb2xsKHdyYXBwZXIsIGlmcmFtZSkgewoJCXZhciBrZXkgPSAnTVVJX1NDUk9MTF9QT1NJVElPTl8nICsgZG9jdW1lbnQubG9jYXRpb24uaHJlZiArICdfJyArIGlmcmFtZS5zcmM7CgkJdmFyIHNjcm9sbFRvcCA9IChwYXJzZUZsb2F0KGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSkpIHx8IDApOwoJCWlmIChzY3JvbGxUb3ApIHsKCQkJKGZ1bmN0aW9uKHkpIHsKCQkJCWlmcmFtZS5vbmxvYWQgPSBmdW5jdGlvbigpIHsKCQkJCQl3aW5kb3cuc2Nyb2xsVG8oMCwgeSk7CgkJCQl9OwoJCQl9KShzY3JvbGxUb3ApOwoJCX0KCQlzZXRJbnRlcnZhbChmdW5jdGlvbigpIHsKCQkJdmFyIF9zY3JvbGxUb3AgPSB3aW5kb3cuc2Nyb2xsWTsKCQkJaWYgKHNjcm9sbFRvcCAhPT0gX3Njcm9sbFRvcCkgewoJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCBfc2Nyb2xsVG9wICsgJycpOwoJCQkJc2Nyb2xsVG9wID0gX3Njcm9sbFRvcDsKCQkJfQoJCX0sIDEwMCk7Cgl9CgkkKGZ1bmN0aW9uKCkgewoJCXZhciBjbGFzc0xpc3QgPSBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdDsKCQl2YXIgb3MgPSBbXTsKCQlpZiAoJC5vcy5pb3MpIHsKCQkJb3MucHVzaCh7CgkJCQlvczogJ2lvcycsCgkJCQl2ZXJzaW9uOiAkLm9zLnZlcnNpb24KCQkJfSk7CgkJCWNsYXNzTGlzdC5hZGQoJ211aS1pb3MnKTsKCQl9IGVsc2UgaWYgKCQub3MuYW5kcm9pZCkgewoJCQlvcy5wdXNoKHsKCQkJCW9zOiAnYW5kcm9pZCcsCgkJCQl2ZXJzaW9uOiAkLm9zLnZlcnNpb24KCQkJfSk7CgkJCWNsYXNzTGlzdC5hZGQoJ211aS1hbmRyb2lkJyk7CgkJfQoJCWlmICgkLm9zLndlY2hhdCkgewoJCQlvcy5wdXNoKHsKCQkJCW9zOiAnd2VjaGF0JywKCQkJCXZlcnNpb246ICQub3Mud2VjaGF0LnZlcnNpb24KCQkJfSk7CgkJCWNsYXNzTGlzdC5hZGQoJ211aS13ZWNoYXQnKTsKCQl9CgkJaWYgKG9zLmxlbmd0aCkgewoJCQkkLmVhY2gob3MsIGZ1bmN0aW9uKGluZGV4LCBvc09iaikgewoJCQkJdmFyIHZlcnNpb24gPSAnJzsKCQkJCXZhciBjbGFzc0FycmF5ID0gW107CgkJCQlpZiAob3NPYmoudmVyc2lvbikgewoJCQkJCSQuZWFjaChvc09iai52ZXJzaW9uLnNwbGl0KCcuJyksIGZ1bmN0aW9uKGksIHYpIHsKCQkJCQkJdmVyc2lvbiA9IHZlcnNpb24gKyAodmVyc2lvbiA/ICctJyA6ICcnKSArIHY7CgkJCQkJCWNsYXNzTGlzdC5hZGQoJC5jbGFzc05hbWUob3NPYmoub3MgKyAnLScgKyB2ZXJzaW9uKSk7CgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0pOwp9KShtdWkpOwovKioKICogbXVpLmluaXQgNSsKICogQHBhcmFtIHt0eXBlfSAkCiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCkgewoJdmFyIGRlZmF1bHRPcHRpb25zID0gewoJCXN3aXBlQmFjazogZmFsc2UsCgkJcHJlbG9hZFBhZ2VzOiBbXSwgLy81KyBsYXp5TG9hZCB3ZWJ2aWV3CgkJcHJlbG9hZExpbWl0OiAxMCwgLy/pooTliqDovb3nqpflj6PnmoTmlbDph4/pmZDliLYo5LiA5pem6LaF5Ye677yM5YWI6L+b5YWI5Ye6KQoJCWtleUV2ZW50QmluZDogewoJCQliYWNrYnV0dG9uOiB0cnVlLAoJCQltZW51YnV0dG9uOiB0cnVlCgkJfSwKCQl0aXRsZUNvbmZpZzogewoJCQloZWlnaHQ6ICI0NHB4IiwKCQkJYmFja2dyb3VuZENvbG9yOiAiI2Y3ZjdmNyIsIC8v5a+86Iiq5qCP6IOM5pmv6ImyCgkJCWJvdHRvbUJvcmRlckNvbG9yOiAiI2NjY2NjYyIsIC8v5bqV6YOo6L6557q/6aKc6ImyCgkJCXRpdGxlOiB7IC8v5qCH6aKY6YWN572uCgkJCQl0ZXh0OiAiIiwgLy/moIfpopjmloflrZcKCQkJCXBvc2l0aW9uOiB7CgkJCQkJdG9wOiAwLAoJCQkJCWxlZnQ6IDAsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQloZWlnaHQ6ICIxMDAlIgoJCQkJfSwKCQkJCXN0eWxlczogewoJCQkJCWNvbG9yOiAiIzAwMDAwMCIsCgkJCQkJYWxpZ246ICJjZW50ZXIiLAoJCQkJCWZhbWlseTogIidIZWx2ZXRpY2EgTmV1ZScsSGVsdmV0aWNhLHNhbnMtc2VyaWYiLAoJCQkJCXNpemU6ICIxN3B4IiwKCQkJCQlzdHlsZTogIm5vcm1hbCIsCgkJCQkJd2VpZ2h0OiAibm9ybWFsIiwKCQkJCQlmb250U3JjOiAiIgoJCQkJfQoJCQl9LAoJCQliYWNrOiB7CgkJCQlpbWFnZTogewoJCQkJCWJhc2U2NERhdGE6ICcnLAoJCQkJCWltZ1NyYzogJycsCgkJCQkJc3ByaXRlOiB7CgkJCQkJCXRvcDogJzBweCcsCgkJCQkJCWxlZnQ6ICcwcHgnLAoJCQkJCQl3aWR0aDogJzEwMCUnLAoJCQkJCQloZWlnaHQ6ICcxMDAlJwoJCQkJCX0sCgkJCQkJcG9zaXRpb246IHsKCQkJCQkJdG9wOiAiMTBweCIsCgkJCQkJCWxlZnQ6ICIxMHB4IiwKCQkJCQkJd2lkdGg6ICIyNHB4IiwKCQkJCQkJaGVpZ2h0OiAiMjRweCIKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9OwoKCS8v6buY6K6k6aG16Z2i5Yqo55S7Cgl2YXIgZGVmYXVsdFNob3cgPSB7CgkJZXZlbnQ6InRpdGxlVXBkYXRlIiwKCQlhdXRvU2hvdzogdHJ1ZSwKCQlkdXJhdGlvbjogMzAwLAoJCWFuaVNob3c6ICdzbGlkZS1pbi1yaWdodCcsCgkJZXh0cmFzOnt9Cgl9OwoJLy/oi6XmiafooYzkuobmmL7npLrliqjnlLvliJ3lp4vljJbmk43kvZzvvIzliJnopoHopobnm5bpu5jorqTphY3nva4KCWlmKCQub3B0aW9ucy5zaG93KSB7CgkJZGVmYXVsdFNob3cgPSAkLmV4dGVuZCh0cnVlLCBkZWZhdWx0U2hvdywgJC5vcHRpb25zLnNob3cpOwoJfQoKCSQuY3VycmVudFdlYnZpZXcgPSBudWxsOwoKCSQuZXh0ZW5kKHRydWUsICQuZ2xvYmFsLCBkZWZhdWx0T3B0aW9ucyk7CgkkLmV4dGVuZCh0cnVlLCAkLm9wdGlvbnMsIGRlZmF1bHRPcHRpb25zKTsKCS8qKgoJICog562J5b6F5Yqo55S76YWN572uCgkgKiBAcGFyYW0ge3R5cGV9IG9wdGlvbnMKCSAqIEByZXR1cm5zIHtPYmplY3R9CgkgKi8KCSQud2FpdGluZ09wdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkJcmV0dXJuICQuZXh0ZW5kKHRydWUsIHt9LCB7CgkJCWF1dG9TaG93OiB0cnVlLAoJCQl0aXRsZTogJycsCgkJCW1vZGFsOiBmYWxzZQoJCX0sIG9wdGlvbnMpOwoJfTsKCS8qKgoJICog56qX5Y+j5pi+56S66YWN572uCgkgKiBAcGFyYW0ge3R5cGV9IG9wdGlvbnMKCSAqIEByZXR1cm5zIHtPYmplY3R9CgkgKi8KCSQuc2hvd09wdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkJcmV0dXJuICQuZXh0ZW5kKHRydWUsIHt9LCBkZWZhdWx0U2hvdywgb3B0aW9ucyk7Cgl9OwoJLyoqCgkgKiDnqpflj6Ppu5jorqTphY3nva4KCSAqIEBwYXJhbSB7dHlwZX0gb3B0aW9ucwoJICogQHJldHVybnMge09iamVjdH0KCSAqLwoJJC53aW5kb3dPcHRpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCXJldHVybiAkLmV4dGVuZCh7CgkJCXNjYWxhYmxlOiBmYWxzZSwKCQkJYm91bmNlOiAiIiAvL3ZlcnRpY2FsCgkJfSwgb3B0aW9ucyk7Cgl9OwoJLyoqCgkgKiBwbHVzUmVhZHkKCSAqIEBwYXJhbSB7dHlwZX0gY2FsbGJhY2sKCSAqIEByZXR1cm5zIHtfTDYuJH0KCSAqLwoJJC5wbHVzUmVhZHkgPSBmdW5jdGlvbihjYWxsYmFjaykgewoJCWlmKHdpbmRvdy5wbHVzKSB7CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IC8v6Kej5YazY2FsbGJhY2vkuI5wbHVzcmVhZHnkuovku7bnmoTmiafooYzml7bmnLrpl67popgo5YW45Z6L5qGI5L6LOnNob3dXYWl0aW5nLGNsb3NlV2FpdGluZykKCQkJCWNhbGxiYWNrKCk7CgkJCX0sIDApOwoJCX0gZWxzZSB7CgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInBsdXNyZWFkeSIsIGZ1bmN0aW9uKCkgewoJCQkJY2FsbGJhY2soKTsKCQkJfSwgZmFsc2UpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX07CgkvKioKCSAqIDUrIGV2ZW50KDUr5rKh5o+Q5L6b5LmL5YmN5oiR6Ieq5bex5a6e546wKQoJICogQHBhcmFtIHt0eXBlfSB3ZWJ2aWV3CgkgKiBAcGFyYW0ge3R5cGV9IGV2ZW50VHlwZQoJICogQHBhcmFtIHt0eXBlfSBkYXRhCgkgKiBAcmV0dXJucyB7dW5kZWZpbmVkfQoJICovCgkkLmZpcmUgPSBmdW5jdGlvbih3ZWJ2aWV3LCBldmVudFR5cGUsIGRhdGEpIHsKCQlpZih3ZWJ2aWV3KSB7CgkJCWlmKHR5cGVvZiBkYXRhID09PSAndW5kZWZpbmVkJykgewoJCQkJZGF0YSA9ICcnOwoJCQl9IGVsc2UgaWYodHlwZW9mIGRhdGEgPT09ICdib29sZWFuJyB8fCB0eXBlb2YgZGF0YSA9PT0gJ251bWJlcicpIHsKCQkJCXdlYnZpZXcuZXZhbEpTKCJ0eXBlb2YgbXVpIT09J3VuZGVmaW5lZCcmJm11aS5yZWNlaXZlKCciICsgZXZlbnRUeXBlICsgIicsIiArIGRhdGEgKyAiKSIpOwoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYoJC5pc1BsYWluT2JqZWN0KGRhdGEpIHx8ICQuaXNBcnJheShkYXRhKSkgewoJCQkJZGF0YSA9IEpTT04uc3RyaW5naWZ5KGRhdGEgfHwge30pLnJlcGxhY2UoL1wnL2csICJcXHUwMDI3IikucmVwbGFjZSgvXFwvZywgIlxcdTAwNWMiKTsKCQkJfQoJCQl3ZWJ2aWV3LmV2YWxKUygidHlwZW9mIG11aSE9PSd1bmRlZmluZWQnJiZtdWkucmVjZWl2ZSgnIiArIGV2ZW50VHlwZSArICInLCciICsgZGF0YSArICInKSIpOwoJCX0KCX07CgkvKioKCSAqIDUrIGV2ZW50KDUr5rKh5o+Q5L6b5LmL5YmN5oiR6Ieq5bex5a6e546wKQoJICogQHBhcmFtIHt0eXBlfSBldmVudFR5cGUKCSAqIEBwYXJhbSB7dHlwZX0gZGF0YQoJICogQHJldHVybnMge3VuZGVmaW5lZH0KCSAqLwoJJC5yZWNlaXZlID0gZnVuY3Rpb24oZXZlbnRUeXBlLCBkYXRhKSB7CgkJaWYoZXZlbnRUeXBlKSB7CgkJCXRyeSB7CgkJCQlpZihkYXRhICYmIHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewoJCQkJCWRhdGEgPSBKU09OLnBhcnNlKGRhdGEpOwoJCQkJfQoJCQl9IGNhdGNoKGUpIHt9CgkJCSQudHJpZ2dlcihkb2N1bWVudCwgZXZlbnRUeXBlLCBkYXRhKTsKCQl9Cgl9OwoJdmFyIHRyaWdnZXJQcmVsb2FkID0gZnVuY3Rpb24od2VidmlldykgewoJCWlmKCF3ZWJ2aWV3LnByZWxvYWRlZCkgeyAvL+S/neivgeS7heinpuWPkeS4gOasoQoJCQkkLmZpcmUod2VidmlldywgJ3ByZWxvYWQnKTsKCQkJdmFyIGxpc3QgPSB3ZWJ2aWV3LmNoaWxkcmVuKCk7CgkJCWZvcih2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CgkJCQkkLmZpcmUobGlzdFtpXSwgJ3ByZWxvYWQnKTsKCQkJfQoJCQl3ZWJ2aWV3LnByZWxvYWRlZCA9IHRydWU7CgkJfQoJfTsKCXZhciB0cmlnZ2VyID0gZnVuY3Rpb24od2VidmlldywgZXZlbnRUeXBlLCB0aW1lQ2hlY2tlZCkgewoJCWlmKHRpbWVDaGVja2VkKSB7CgkJCWlmKCF3ZWJ2aWV3W2V2ZW50VHlwZSArICdlZCddKSB7CgkJCQkkLmZpcmUod2VidmlldywgZXZlbnRUeXBlKTsKCQkJCXZhciBsaXN0ID0gd2Vidmlldy5jaGlsZHJlbigpOwoJCQkJZm9yKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKCQkJCQkkLmZpcmUobGlzdFtpXSwgZXZlbnRUeXBlKTsKCQkJCX0KCQkJCXdlYnZpZXdbZXZlbnRUeXBlICsgJ2VkJ10gPSB0cnVlOwoJCQl9CgkJfSBlbHNlIHsKCQkJJC5maXJlKHdlYnZpZXcsIGV2ZW50VHlwZSk7CgkJCXZhciBsaXN0ID0gd2Vidmlldy5jaGlsZHJlbigpOwoJCQlmb3IodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewoJCQkJJC5maXJlKGxpc3RbaV0sIGV2ZW50VHlwZSk7CgkJCX0KCQl9CgoJfTsKCS8qKgoJICog5omT5byA5paw56qX5Y+jCgkgKiBAcGFyYW0ge3N0cmluZ30gdXJsIOimgeaJk+W8gOeahOmhtemdouWcsOWdgAoJICogQHBhcmFtIHtzdHJpbmd9IGlkIOaMh+WumumhtemdoklECgkgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyDlj6/pgIk65Y+C5pWwLOetieW+hSznqpflj6Ms5pi+56S66YWN572ue3BhcmFtczp7fSx3YWl0aW5nOnt9LHN0eWxlczp7fSxzaG93Ont9fQoJICovCgkkLm9wZW5XaW5kb3cgPSBmdW5jdGlvbih1cmwsIGlkLCBvcHRpb25zKSB7CgkJaWYodHlwZW9mIHVybCA9PT0gJ29iamVjdCcpIHsKCQkJb3B0aW9ucyA9IHVybDsKCQkJdXJsID0gb3B0aW9ucy51cmw7CgkJCWlkID0gb3B0aW9ucy5pZCB8fCB1cmw7CgkJfSBlbHNlIHsKCQkJaWYodHlwZW9mIGlkID09PSAnb2JqZWN0JykgewoJCQkJb3B0aW9ucyA9IGlkOwoJCQkJaWQgPSBvcHRpb25zLmlkIHx8IHVybDsKCQkJfSBlbHNlIHsKCQkJCWlkID0gaWQgfHwgdXJsOwoJCQl9CgkJfQoJCWlmKCEkLm9zLnBsdXMpIHsKCQkJLy9UT0RPIOWFiOS4tOaXtui/meS5iOWkhOeQhu+8muaJi+acuuS4iumhtuWxgui3s++8jFBD5LiKcGFyZW506LezCgkJCWlmKCQub3MuaW9zIHx8ICQub3MuYW5kcm9pZCkgewoJCQkJd2luZG93LnRvcC5sb2NhdGlvbi5ocmVmID0gdXJsOwoJCQl9IGVsc2UgewoJCQkJd2luZG93LnBhcmVudC5sb2NhdGlvbi5ocmVmID0gdXJsOwoJCQl9CgkJCXJldHVybjsKCQl9CgkJaWYoIXdpbmRvdy5wbHVzKSB7CgkJCXJldHVybjsKCQl9CgoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXZhciBwYXJhbXMgPSBvcHRpb25zLnBhcmFtcyB8fCB7fTsKCQl2YXIgd2VidmlldyA9IG51bGwsCgkJCXdlYnZpZXdDYWNoZSA9IG51bGwsCgkJCW5TaG93LCBuV2FpdGluZzsKCgkJaWYoJC53ZWJ2aWV3c1tpZF0pIHsKCQkJd2Vidmlld0NhY2hlID0gJC53ZWJ2aWV3c1tpZF07CgkJCS8vd2Vidmlld+ecn+WunuWtmOWcqO+8jOaJjeiDveiOt+WPlgoJCQlpZihwbHVzLndlYnZpZXcuZ2V0V2Vidmlld0J5SWQoaWQpKSB7CgkJCQl3ZWJ2aWV3ID0gd2Vidmlld0NhY2hlLndlYnZpZXc7CgkJCX0KCQl9IGVsc2UgaWYob3B0aW9ucy5jcmVhdGVOZXcgIT09IHRydWUpIHsKCQkJd2VidmlldyA9IHBsdXMud2Vidmlldy5nZXRXZWJ2aWV3QnlJZChpZCk7CgkJfQoKCQlpZih3ZWJ2aWV3KSB7IC8v5bey57yT5a2YCgkJCS8v5q+P5qyhc2hvd+mDvemcgOimgeS8oOmAkuWKqOeUu+WPguaVsO+8mwoJCQkvL+mihOWKoOi9veeahOWKqOeUu+WPguaVsOS8mOWFiOe6p++8mm9wZW5XaW5kb3fphY3nva4+cHJlbG9hZFBhZ2Vz6YWN572uPm11aem7mOiupOmFjee9ru+8mwoJCQluU2hvdyA9IHdlYnZpZXdDYWNoZSA/IHdlYnZpZXdDYWNoZS5zaG93IDogZGVmYXVsdFNob3c7CgkJCW5TaG93ID0gb3B0aW9ucy5zaG93ID8gJC5leHRlbmQoblNob3csIG9wdGlvbnMuc2hvdykgOiBuU2hvdzsKCQkJblNob3cuYXV0b1Nob3cgJiYgd2Vidmlldy5zaG93KG5TaG93LmFuaVNob3csIG5TaG93LmR1cmF0aW9uLCBmdW5jdGlvbigpIHsKCQkJCXRyaWdnZXJQcmVsb2FkKHdlYnZpZXcpOwoJCQkJdHJpZ2dlcih3ZWJ2aWV3LCAncGFnZWJlZm9yZXNob3cnLCBmYWxzZSk7CgkJCX0pOwoJCQlpZih3ZWJ2aWV3Q2FjaGUpIHsKCQkJCXdlYnZpZXdDYWNoZS5hZnRlclNob3dNZXRob2ROYW1lICYmIHdlYnZpZXcuZXZhbEpTKHdlYnZpZXdDYWNoZS5hZnRlclNob3dNZXRob2ROYW1lICsgJyhcJycgKyBKU09OLnN0cmluZ2lmeShwYXJhbXMpICsgJ1wnKScpOwoJCQl9CgkJCXJldHVybiB3ZWJ2aWV3OwoJCX0gZWxzZSB7IC8v5paw56qX5Y+jCgkJCWlmKCF1cmwpIHsKCQkJCXRocm93IG5ldyBFcnJvcignd2Vidmlld1snICsgaWQgKyAnXSBkb2VzIG5vdCBleGlzdCcpOwoJCQl9CgoJCQkvL+aYvuekundhaXRpbmcKCQkJdmFyIHdhaXRpbmdDb25maWcgPSAkLndhaXRpbmdPcHRpb25zKG9wdGlvbnMud2FpdGluZyk7CgkJCWlmKHdhaXRpbmdDb25maWcuYXV0b1Nob3cpIHsKCQkJCW5XYWl0aW5nID0gcGx1cy5uYXRpdmVVSS5zaG93V2FpdGluZyh3YWl0aW5nQ29uZmlnLnRpdGxlLCB3YWl0aW5nQ29uZmlnLm9wdGlvbnMpOwoJCQl9CgoJCQkvL+WIm+W7uumhtemdogoJCQlvcHRpb25zID0gJC5leHRlbmQob3B0aW9ucywgewoJCQkJaWQ6IGlkLAoJCQkJdXJsOiB1cmwKCQkJfSk7CgoJCQl3ZWJ2aWV3ID0gJC5jcmVhdGVXaW5kb3cob3B0aW9ucyk7CgoJCQkvL+aYvuekugoJCQluU2hvdyA9ICQuc2hvd09wdGlvbnMob3B0aW9ucy5zaG93KTsKCQkJaWYoblNob3cuYXV0b1Nob3cpIHsKCQkJCXZhciBzaG93V2VidmlldyA9IGZ1bmN0aW9uKCkgewoJCQkJCS8v5YWz6Zet562J5b6F5qGGCgkJCQkJaWYobldhaXRpbmcpIHsKCQkJCQkJbldhaXRpbmcuY2xvc2UoKTsKCQkJCQl9CgkJCQkJLy/mmL7npLrpobXpnaIKCQkJCQl3ZWJ2aWV3LnNob3coblNob3cuYW5pU2hvdywgblNob3cuZHVyYXRpb24sIGZ1bmN0aW9uKCkge30sblNob3cuZXh0cmFzKTsKCQkJCQlvcHRpb25zLmFmdGVyU2hvd01ldGhvZE5hbWUgJiYgd2Vidmlldy5ldmFsSlMob3B0aW9ucy5hZnRlclNob3dNZXRob2ROYW1lICsgJyhcJycgKyBKU09OLnN0cmluZ2lmeShwYXJhbXMpICsgJ1wnKScpOwoJCQkJfTsKCQkJCS8vdGl0bGVVcGRhdGXop6blj5Hml7bmnLrml6nkuo5sb2FkZWTvvIzmm7TmjaLkuLp0aXRsZVVwZGF0ZeWQju+8jOWPr+S7peabtOaXqeeahOaYvuekundlYnZpZXcKCQkJCXdlYnZpZXcuYWRkRXZlbnRMaXN0ZW5lcihuU2hvdy5ldmVudCwgc2hvd1dlYnZpZXcsIGZhbHNlKTsKCQkJCS8vbG9hZGVk5LqL5Lu25Y+R55Sf5ZCO77yM6Kem5Y+R6aKE5Yqg6L295ZKMcGFnZWJlZm9yZXNob3fkuovku7YKCQkJCXdlYnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigibG9hZGVkIiwgZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlclByZWxvYWQod2Vidmlldyk7CgkJCQkJdHJpZ2dlcih3ZWJ2aWV3LCAncGFnZWJlZm9yZXNob3cnLCBmYWxzZSk7CgkJCQl9LCBmYWxzZSk7CgkJCX0KCQl9CgkJcmV0dXJuIHdlYnZpZXc7Cgl9OwoKCSQub3BlbldpbmRvd1dpdGhUaXRsZSA9IGZ1bmN0aW9uKG9wdGlvbnMsIHRpdGxlQ29uZmlnKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJdmFyIHVybCA9IG9wdGlvbnMudXJsOwoJCXZhciBpZCA9IG9wdGlvbnMuaWQgfHwgdXJsOwoKCQlpZighJC5vcy5wbHVzKSB7CgkJCS8vVE9ETyDlhYjkuLTml7bov5nkuYjlpITnkIbvvJrmiYvmnLrkuIrpobblsYLot7PvvIxQQ+S4inBhcmVudOi3swoJCQlpZigkLm9zLmlvcyB8fCAkLm9zLmFuZHJvaWQpIHsKCQkJCXdpbmRvdy50b3AubG9jYXRpb24uaHJlZiA9IHVybDsKCQkJfSBlbHNlIHsKCQkJCXdpbmRvdy5wYXJlbnQubG9jYXRpb24uaHJlZiA9IHVybDsKCQkJfQoJCQlyZXR1cm47CgkJfQoJCWlmKCF3aW5kb3cucGx1cykgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgcGFyYW1zID0gb3B0aW9ucy5wYXJhbXMgfHwge307CgkJdmFyIHdlYnZpZXcgPSBudWxsLAoJCQl3ZWJ2aWV3Q2FjaGUgPSBudWxsLAoJCQluU2hvdywgbldhaXRpbmc7CgoJCWlmKCQud2Vidmlld3NbaWRdKSB7CgkJCXdlYnZpZXdDYWNoZSA9ICQud2Vidmlld3NbaWRdOwoJCQkvL3dlYnZpZXfnnJ/lrp7lrZjlnKjvvIzmiY3og73ojrflj5YKCQkJaWYocGx1cy53ZWJ2aWV3LmdldFdlYnZpZXdCeUlkKGlkKSkgewoJCQkJd2VidmlldyA9IHdlYnZpZXdDYWNoZS53ZWJ2aWV3OwoJCQl9CgkJfSBlbHNlIGlmKG9wdGlvbnMuY3JlYXRlTmV3ICE9PSB0cnVlKSB7CgkJCXdlYnZpZXcgPSBwbHVzLndlYnZpZXcuZ2V0V2Vidmlld0J5SWQoaWQpOwoJCX0KCgkJaWYod2VidmlldykgeyAvL+W3sue8k+WtmAoJCQkvL+avj+asoXNob3fpg73pnIDopoHkvKDpgJLliqjnlLvlj4LmlbDvvJsKCQkJLy/pooTliqDovb3nmoTliqjnlLvlj4LmlbDkvJjlhYjnuqfvvJpvcGVuV2luZG936YWN572uPnByZWxvYWRQYWdlc+mFjee9rj5tdWnpu5jorqTphY3nva7vvJsKCQkJblNob3cgPSB3ZWJ2aWV3Q2FjaGUgPyB3ZWJ2aWV3Q2FjaGUuc2hvdyA6IGRlZmF1bHRTaG93OwoJCQluU2hvdyA9IG9wdGlvbnMuc2hvdyA/ICQuZXh0ZW5kKG5TaG93LCBvcHRpb25zLnNob3cpIDogblNob3c7CgkJCW5TaG93LmF1dG9TaG93ICYmIHdlYnZpZXcuc2hvdyhuU2hvdy5hbmlTaG93LCBuU2hvdy5kdXJhdGlvbiwgZnVuY3Rpb24oKSB7CgkJCQl0cmlnZ2VyUHJlbG9hZCh3ZWJ2aWV3KTsKCQkJCXRyaWdnZXIod2VidmlldywgJ3BhZ2ViZWZvcmVzaG93JywgZmFsc2UpOwoJCQl9KTsKCQkJaWYod2Vidmlld0NhY2hlKSB7CgkJCQl3ZWJ2aWV3Q2FjaGUuYWZ0ZXJTaG93TWV0aG9kTmFtZSAmJiB3ZWJ2aWV3LmV2YWxKUyh3ZWJ2aWV3Q2FjaGUuYWZ0ZXJTaG93TWV0aG9kTmFtZSArICcoXCcnICsgSlNPTi5zdHJpbmdpZnkocGFyYW1zKSArICdcJyknKTsKCQkJfQoJCQlyZXR1cm4gd2VidmlldzsKCQl9IGVsc2UgeyAvL+aWsOeql+WPowoJCQlpZighdXJsKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoJ3dlYnZpZXdbJyArIGlkICsgJ10gZG9lcyBub3QgZXhpc3QnKTsKCQkJfQoKCQkJLy/mmL7npLp3YWl0aW5nCgkJCXZhciB3YWl0aW5nQ29uZmlnID0gJC53YWl0aW5nT3B0aW9ucyhvcHRpb25zLndhaXRpbmcpOwoJCQlpZih3YWl0aW5nQ29uZmlnLmF1dG9TaG93KSB7CgkJCQluV2FpdGluZyA9IHBsdXMubmF0aXZlVUkuc2hvd1dhaXRpbmcod2FpdGluZ0NvbmZpZy50aXRsZSwgd2FpdGluZ0NvbmZpZy5vcHRpb25zKTsKCQkJfQoKCQkJLy/liJvlu7rpobXpnaIKCQkJb3B0aW9ucyA9ICQuZXh0ZW5kKG9wdGlvbnMsIHsKCQkJCWlkOiBpZCwKCQkJCXVybDogdXJsCgkJCX0pOwoKCQkJd2VidmlldyA9ICQuY3JlYXRlV2luZG93KG9wdGlvbnMpOwoKCQkJaWYodGl0bGVDb25maWcpIHsgLy/lpITnkIbljp/nlJ/lpLQKCQkJCSQuZXh0ZW5kKHRydWUsICQub3B0aW9ucy50aXRsZUNvbmZpZywgdGl0bGVDb25maWcpOwoJCQkJdmFyIHRpZCA9ICQub3B0aW9ucy50aXRsZUNvbmZpZy5pZCA/ICQub3B0aW9ucy50aXRsZUNvbmZpZy5pZCA6IGlkICsgIl90aXRsZSI7CgkJCQl2YXIgdmlldyA9IG5ldyBwbHVzLm5hdGl2ZU9iai5WaWV3KHRpZCwgewoJCQkJCXRvcDogMCwKCQkJCQloZWlnaHQ6ICQub3B0aW9ucy50aXRsZUNvbmZpZy5oZWlnaHQsCgkJCQkJd2lkdGg6ICIxMDAlIiwKCQkJCQlkb2NrOiAidG9wIiwKCQkJCQlwb3NpdGlvbjogImRvY2siCgkJCQl9KTsKCQkJCXZpZXcuZHJhd1JlY3QoJC5vcHRpb25zLnRpdGxlQ29uZmlnLmJhY2tncm91bmRDb2xvcik7IC8v57uY5Yi26IOM5pmv6ImyCgkJCQl2YXIgX2IgPSBwYXJzZUludCgkLm9wdGlvbnMudGl0bGVDb25maWcuaGVpZ2h0KSAtIDE7CgkJCQl2aWV3LmRyYXdSZWN0KCQub3B0aW9ucy50aXRsZUNvbmZpZy5ib3R0b21Cb3JkZXJDb2xvciwgewoJCQkJCXRvcDogX2IgKyAicHgiLAoJCQkJCWxlZnQ6ICIwcHgiCgkJCQl9KTsgLy/nu5jliLblupXpg6jovrnnur8KCgkJCQkvL+e7mOWItuaWh+WtlwoJCQkJaWYoJC5vcHRpb25zLnRpdGxlQ29uZmlnLnRpdGxlLnRleHQpewoJCQkJCXZhciBfdGl0bGUgPSAkLm9wdGlvbnMudGl0bGVDb25maWcudGl0bGU7CgkJCQkJdmlldy5kcmF3VGV4dChfdGl0bGUudGV4dCxfdGl0bGUucG9zaXRpb24gLCBfdGl0bGUuc3R5bGVzKTsKCQkJCX0KCQkJCQoJCQkJLy/ov5Tlm57lm77moIfnu5jliLYKCQkJCXZhciBfYmFjayA9ICQub3B0aW9ucy50aXRsZUNvbmZpZy5iYWNrOwoJCQkJdmFyIGJhY2tDbGljayA9IG51bGw7CgkJCQkvL+S8mOWFiOWtl+S9kwoKCQkJCS8v5YW25qyh5piv5Zu+54mHCgkJCQl2YXIgX2JhY2tJbWFnZSA9IF9iYWNrLmltYWdlOwoJCQkJaWYoX2JhY2tJbWFnZS5iYXNlNjREYXRhIHx8IF9iYWNrSW1hZ2UuaW1nU3JjKSB7CgkJCQkJLy9UT0RPIOatpOWkhOmcgOimgeWkhOeQhueZvuWIhuavlOeahOaDheWGtQoJCQkJCWJhY2tDbGljayA9IHsKCQkJCQkJbGVmdDpwYXJzZUludChfYmFja0ltYWdlLnBvc2l0aW9uLmxlZnQpLAoJCQkJCQlyaWdodDpwYXJzZUludChfYmFja0ltYWdlLnBvc2l0aW9uLmxlZnQpICsgcGFyc2VJbnQoX2JhY2tJbWFnZS5wb3NpdGlvbi53aWR0aCkKCQkJCQl9OwoJCQkJCXZhciBiaXRtYXAgPSBuZXcgcGx1cy5uYXRpdmVPYmouQml0bWFwKGlkICsgIl9iYWNrIik7CgkJCQkJaWYoX2JhY2tJbWFnZS5iYXNlNjREYXRhKSB7IC8v5LyY5YWIYmFzZTY057yW56CB5a2X56ym5LiyCgkJCQkJCWJpdG1hcC5sb2FkQmFzZTY0RGF0YShfYmFja0ltYWdlLmJhc2U2NERhdGEpOwoJCQkJCX0gZWxzZSB7IC8v5YW25qyh5Yqg6L295Zu+54mH5paH5Lu2CgkJCQkJCWJpdG1hcC5sb2FkKF9iYWNrSW1hZ2UuaW1nU3JjKTsKCQkJCQl9CgkJCQkJdmlldy5kcmF3Qml0bWFwKGJpdG1hcCxfYmFja0ltYWdlLnNwcml0ZSAsIF9iYWNrSW1hZ2UucG9zaXRpb24pOwoJCQkJfQoKCQkJCS8v5aSE55CG54K55Ye75LqL5Lu2CgkJCQl2aWV3LnNldFRvdWNoRXZlbnRSZWN0KHsKCQkJCQl0b3A6ICIwcHgiLAoJCQkJCWxlZnQ6ICIwcHgiLAoJCQkJCXdpZHRoOiAiMTAwJSIsCgkJCQkJaGVpZ2h0OiAiMTAwJSIKCQkJCX0pOwoJCQkJdmlldy5pbnRlcmNlcHRUb3VjaEV2ZW50KHRydWUpOwoJCQkJdmlldy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uKGUpIHsKCQkJCQl2YXIgeCA9IGUuY2xpZW50WDsKCQkJCQkKCQkJCQkvL+i/lOWbnuaMiemSrueCueWHuwoJCQkJCWlmKGJhY2tDbGljayYmIHggPiBiYWNrQ2xpY2subGVmdCAmJiB4IDwgYmFja0NsaWNrLnJpZ2h0KXsKCQkJCQkJaWYoIF9iYWNrLmNsaWNrICYmICQuaXNGdW5jdGlvbihfYmFjay5jbGljaykpewoJCQkJCQkJX2JhY2suY2xpY2soKTsKCQkJCQkJfWVsc2V7CgkJCQkJCQl3ZWJ2aWV3LmV2YWxKUygid2luZG93Lm11aSYmbXVpLmJhY2soKTsiKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIGZhbHNlKTsKCQkJCXdlYnZpZXcuYXBwZW5kKHZpZXcpOwoKCQkJfQoKCQkJLy/mmL7npLoKCQkJblNob3cgPSAkLnNob3dPcHRpb25zKG9wdGlvbnMuc2hvdyk7CgkJCWlmKG5TaG93LmF1dG9TaG93KSB7CgkJCQkvL3RpdGxlVXBkYXRl6Kem5Y+R5pe25py65pep5LqObG9hZGVk77yM5pu05o2i5Li6dGl0bGVVcGRhdGXlkI7vvIzlj6/ku6Xmm7Tml6nnmoTmmL7npLp3ZWJ2aWV3CgkJCQl3ZWJ2aWV3LmFkZEV2ZW50TGlzdGVuZXIoblNob3cuZXZlbnQsIGZ1bmN0aW9uICgpIHsKCQkJCQkvL+WFs+mXreetieW+heahhgoJCQkJCWlmKG5XYWl0aW5nKSB7CgkJCQkJCW5XYWl0aW5nLmNsb3NlKCk7CgkJCQkJfQoJCQkJCS8v5pi+56S66aG16Z2iCgkJCQkJd2Vidmlldy5zaG93KG5TaG93LmFuaVNob3csIG5TaG93LmR1cmF0aW9uLCBmdW5jdGlvbigpIHt9LG5TaG93LmV4dHJhcyk7CgkJCQl9LCBmYWxzZSk7CgkJCX0KCQl9CgkJcmV0dXJuIHdlYnZpZXc7Cgl9OwoKCS8qKgoJICog5qC55o2u6YWN572u5L+h5oGv5Yib5bu65LiA5Liqd2VidmlldwoJICogQHBhcmFtIHt0eXBlfSBvcHRpb25zCgkgKiBAcGFyYW0ge3R5cGV9IGlzQ3JlYXRlCgkgKiBAcmV0dXJucyB7d2Vidmlld30KCSAqLwoJJC5jcmVhdGVXaW5kb3cgPSBmdW5jdGlvbihvcHRpb25zLCBpc0NyZWF0ZSkgewoJCWlmKCF3aW5kb3cucGx1cykgewoJCQlyZXR1cm47CgkJfQoJCXZhciBpZCA9IG9wdGlvbnMuaWQgfHwgb3B0aW9ucy51cmw7CgkJdmFyIHdlYnZpZXc7CgkJaWYob3B0aW9ucy5wcmVsb2FkKSB7CgkJCWlmKCQud2Vidmlld3NbaWRdICYmICQud2Vidmlld3NbaWRdLndlYnZpZXcuZ2V0VVJMKCkpIHsgLy/lt7Lnu49jYWNoZQoJCQkJd2VidmlldyA9ICQud2Vidmlld3NbaWRdLndlYnZpZXc7CgkJCX0gZWxzZSB7IC8v5paw5aKe6aKE5Yqg6L2956qX5Y+jCgkJCQkvL+WIpOaWreaYr+WQpuaQuuW4pmNyZWF0ZU5ld+WPguaVsO+8jOm7mOiupOS4umZhbHNlCgkJCQlpZihvcHRpb25zLmNyZWF0ZU5ldyAhPT0gdHJ1ZSkgewoJCQkJCXdlYnZpZXcgPSBwbHVzLndlYnZpZXcuZ2V0V2Vidmlld0J5SWQoaWQpOwoJCQkJfQoKCQkJCS8v5LmL5YmN5rKh5pyJ77yM6YKj5bCx5paw5Yib5bu6CQoJCQkJaWYoIXdlYnZpZXcpIHsKCQkJCQl3ZWJ2aWV3ID0gcGx1cy53ZWJ2aWV3LmNyZWF0ZShvcHRpb25zLnVybCwgaWQsICQud2luZG93T3B0aW9ucyhvcHRpb25zLnN0eWxlcyksICQuZXh0ZW5kKHsKCQkJCQkJcHJlbG9hZDogdHJ1ZQoJCQkJCX0sIG9wdGlvbnMuZXh0cmFzKSk7CgkJCQkJaWYob3B0aW9ucy5zdWJwYWdlcykgewoJCQkJCQkkLmVhY2gob3B0aW9ucy5zdWJwYWdlcywgZnVuY3Rpb24oaW5kZXgsIHN1YnBhZ2UpIHsKCQkJCQkJCXZhciBzdWJwYWdlSWQgPSBzdWJwYWdlLmlkIHx8IHN1YnBhZ2UudXJsOwoJCQkJCQkJaWYoc3VicGFnZUlkKSB7IC8v6L+H5ruk56m65a+56LGhCgkJCQkJCQkJdmFyIHN1YldlYnZpZXcgPSBwbHVzLndlYnZpZXcuZ2V0V2Vidmlld0J5SWQoc3VicGFnZUlkKTsKCQkJCQkJCQlpZighc3ViV2VidmlldykgeyAvL+WmguaenOivpXdlYnZpZXfkuI3lrZjlnKjvvIzliJnliJvlu7oKCQkJCQkJCQkJc3ViV2VidmlldyA9IHBsdXMud2Vidmlldy5jcmVhdGUoc3VicGFnZS51cmwsIHN1YnBhZ2VJZCwgJC53aW5kb3dPcHRpb25zKHN1YnBhZ2Uuc3R5bGVzKSwgJC5leHRlbmQoewoJCQkJCQkJCQkJcHJlbG9hZDogdHJ1ZQoJCQkJCQkJCQl9LCBzdWJwYWdlLmV4dHJhcykpOwoJCQkJCQkJCX0KCQkJCQkJCQl3ZWJ2aWV3LmFwcGVuZChzdWJXZWJ2aWV3KTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvL1RPRE8g55CG6K665LiK77yM5a2Qd2Vidmlld+S5n+W6lOivpeiuoeeul+WIsOmihOWKoOi9vemYn+WIl+S4re+8jOS9hui/meagt+Wwsem6u+eDpuS6hu+8jOimgemAgOW/hemhu+mAgOaVtOS9k++8jOWQpuWImeWPr+iDveWHuueOsOmXrumimO+8mwoJCQkkLndlYnZpZXdzW2lkXSA9IHsKCQkJCXdlYnZpZXc6IHdlYnZpZXcsIC8v55uu5YmN5LuFcHJlbG9hZOeahOe8k+WtmHdlYnZpZXcKCQkJCXByZWxvYWQ6IHRydWUsCgkJCQlzaG93OiAkLnNob3dPcHRpb25zKG9wdGlvbnMuc2hvdyksCgkJCQlhZnRlclNob3dNZXRob2ROYW1lOiBvcHRpb25zLmFmdGVyU2hvd01ldGhvZE5hbWUgLy/lsLHkuI3lupTor6XnlKhldmFsSlPjgILlupTor6XmmK/pgJrov4fkuovku7bmtojmga/pgJrorq8KCQkJfTsKCQkJLy/ntKLlvJXor6XpooTliqDovb3nqpflj6MKCQkJdmFyIHByZWxvYWRzID0gJC5kYXRhLnByZWxvYWRzOwoJCQl2YXIgaW5kZXggPSBwcmVsb2Fkcy5pbmRleE9mKGlkKTsKCQkJaWYofmluZGV4KSB7IC8v5Yig6Zmk5bey5a2Y5Zyo55qEKOWPmOebuOiwg+aVtOaPkuWFpeS9jee9rikKCQkJCXByZWxvYWRzLnNwbGljZShpbmRleCwgMSk7CgkJCX0KCQkJcHJlbG9hZHMucHVzaChpZCk7CgkJCWlmKHByZWxvYWRzLmxlbmd0aCA+ICQub3B0aW9ucy5wcmVsb2FkTGltaXQpIHsKCQkJCS8v5YWI6L+b5YWI5Ye6CgkJCQl2YXIgZmlyc3QgPSAkLmRhdGEucHJlbG9hZHMuc2hpZnQoKTsKCQkJCXZhciB3ZWJ2aWV3Q2FjaGUgPSAkLndlYnZpZXdzW2ZpcnN0XTsKCQkJCWlmKHdlYnZpZXdDYWNoZSAmJiB3ZWJ2aWV3Q2FjaGUud2VidmlldykgewoJCQkJCS8v6ZyA6KaB5bCG6Ieq5bex5omT5byA55qE5omA5pyJ6aG16Z2i77yM5YWo6YOoY2xvc2XvvJsKCQkJCQkvL+WFs+mXreivpemihOWKoOi9vXdlYnZpZXcJCgkJCQkJJC5jbG9zZUFsbCh3ZWJ2aWV3Q2FjaGUud2Vidmlldyk7CgkJCQl9CgkJCQkvL+WIoOmZpOe8k+WtmAoJCQkJZGVsZXRlICQud2Vidmlld3NbZmlyc3RdOwoJCQl9CgkJfSBlbHNlIHsKCQkJaWYoaXNDcmVhdGUgIT09IGZhbHNlKSB7IC8v55u05o6l5Yib5bu66Z2e6aKE5Yqg6L2956qX5Y+jCgkJCQl3ZWJ2aWV3ID0gcGx1cy53ZWJ2aWV3LmNyZWF0ZShvcHRpb25zLnVybCwgaWQsICQud2luZG93T3B0aW9ucyhvcHRpb25zLnN0eWxlcyksIG9wdGlvbnMuZXh0cmFzKTsKCQkJCWlmKG9wdGlvbnMuc3VicGFnZXMpIHsKCQkJCQkkLmVhY2gob3B0aW9ucy5zdWJwYWdlcywgZnVuY3Rpb24oaW5kZXgsIHN1YnBhZ2UpIHsKCQkJCQkJdmFyIHN1YnBhZ2VJZCA9IHN1YnBhZ2UuaWQgfHwgc3VicGFnZS51cmw7CgkJCQkJCXZhciBzdWJXZWJ2aWV3ID0gcGx1cy53ZWJ2aWV3LmdldFdlYnZpZXdCeUlkKHN1YnBhZ2VJZCk7CgkJCQkJCWlmKCFzdWJXZWJ2aWV3KSB7CgkJCQkJCQlzdWJXZWJ2aWV3ID0gcGx1cy53ZWJ2aWV3LmNyZWF0ZShzdWJwYWdlLnVybCwgc3VicGFnZUlkLCAkLndpbmRvd09wdGlvbnMoc3VicGFnZS5zdHlsZXMpLCBzdWJwYWdlLmV4dHJhcyk7CgkJCQkJCX0KCQkJCQkJd2Vidmlldy5hcHBlbmQoc3ViV2Vidmlldyk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIHdlYnZpZXc7Cgl9OwoKCS8qKgoJICog6aKE5Yqg6L29CgkgKi8KCSQucHJlbG9hZCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCQkvL+iwg+eUqOmihOWKoOi9veWHveaVsO+8jOS4jeeuoeaYr+WQpuS8oOmAknByZWxvYWTlj4LmlbDvvIzlvLrliLblj5jkuLp0cnVlCgkJaWYoIW9wdGlvbnMucHJlbG9hZCkgewoJCQlvcHRpb25zLnByZWxvYWQgPSB0cnVlOwoJCX0KCQlyZXR1cm4gJC5jcmVhdGVXaW5kb3cob3B0aW9ucyk7Cgl9OwoKCS8qKgoJICrlhbPpl63lvZPliY13ZWJ2aWV35omT5byA55qE5omA5pyJd2Vidmlld++8mwoJICovCgkkLmNsb3NlT3BlbmVkID0gZnVuY3Rpb24od2VidmlldykgewoJCXZhciBvcGVuZWQgPSB3ZWJ2aWV3Lm9wZW5lZCgpOwoJCWlmKG9wZW5lZCkgewoJCQlmb3IodmFyIGkgPSAwLCBsZW4gPSBvcGVuZWQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCXZhciBvcGVuZWRXZWJ2aWV3ID0gb3BlbmVkW2ldOwoJCQkJdmFyIG9wZW5fb3BlbiA9IG9wZW5lZFdlYnZpZXcub3BlbmVkKCk7CgkJCQlpZihvcGVuX29wZW4gJiYgb3Blbl9vcGVuLmxlbmd0aCA+IDApIHsKCQkJCQkvL+WFs+mXreaJk+W8gOeahHdlYnZpZXcKCQkJCQkkLmNsb3NlT3BlbmVkKG9wZW5lZFdlYnZpZXcpOwoJCQkJCS8v5YWz6Zet6Ieq5bexCgkJCQkJb3BlbmVkV2Vidmlldy5jbG9zZSgibm9uZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQkvL+WmguaenOebtOaOpeWtqeWtkOiKgueCue+8jOWwseS4jeeUqOWFs+mXreS6hu+8jOWboOS4uueItuWFs+mXreeahOaXtuWAme+8jOS8muiHquWKqOWFs+mXreWtkO+8mwoJCQkJCWlmKG9wZW5lZFdlYnZpZXcucGFyZW50KCkgIT09IHdlYnZpZXcpIHsKCQkJCQkJb3BlbmVkV2Vidmlldy5jbG9zZSgnbm9uZScpOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX07CgkkLmNsb3NlQWxsID0gZnVuY3Rpb24od2VidmlldywgYW5pU2hvdykgewoJCSQuY2xvc2VPcGVuZWQod2Vidmlldyk7CgkJaWYoYW5pU2hvdykgewoJCQl3ZWJ2aWV3LmNsb3NlKGFuaVNob3cpOwoJCX0gZWxzZSB7CgkJCXdlYnZpZXcuY2xvc2UoKTsKCQl9Cgl9OwoKCS8qKgoJICog5om56YeP5Yib5bu6d2VidmlldwoJICogQHBhcmFtIHt0eXBlfSBvcHRpb25zCgkgKiBAcmV0dXJucyB7dW5kZWZpbmVkfQoJICovCgkkLmNyZWF0ZVdpbmRvd3MgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkJJC5lYWNoKG9wdGlvbnMsIGZ1bmN0aW9uKGluZGV4LCBvcHRpb24pIHsKCQkJLy/liJ3lp4vljJbpooTliqDovb3nqpflj6Mo5Yib5bu6KeWSjOmdnumihOWKoOi9veeql+WPoyjku4XphY3nva7vvIzkuI3liJvlu7opCgkJCSQuY3JlYXRlV2luZG93KG9wdGlvbiwgZmFsc2UpOwoJCX0pOwoJfTsKCS8qKgoJICog5Yib5bu65b2T5YmN6aG16Z2i55qE5a2Qd2VidmlldwoJICogQHBhcmFtIHt0eXBlfSBvcHRpb25zCgkgKiBAcmV0dXJucyB7d2Vidmlld30KCSAqLwoJJC5hcHBlbmRXZWJ2aWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCWlmKCF3aW5kb3cucGx1cykgewoJCQlyZXR1cm47CgkJfQoJCXZhciBpZCA9IG9wdGlvbnMuaWQgfHwgb3B0aW9ucy51cmw7CgkJdmFyIHdlYnZpZXc7CgkJaWYoISQud2Vidmlld3NbaWRdKSB7IC8v5L+d6K+B5omn6KGM5LiA6YGNCgkJCS8vVE9ETyDov5nph4zkuZ/mnInpmpDmgqPvvIzmr5TlpoLmn5DkuKp3ZWJ2aWV35LiN5piv5L2c5Li6c3VicGFnZeWIm+W7uueahO+8jOiAjOaYr+S9nOS4unRhcmdldCB3ZWJ2aWV355qE6K+d77ybCgkJCWlmKCFwbHVzLndlYnZpZXcuZ2V0V2Vidmlld0J5SWQoaWQpKSB7CgkJCQl3ZWJ2aWV3ID0gcGx1cy53ZWJ2aWV3LmNyZWF0ZShvcHRpb25zLnVybCwgaWQsIG9wdGlvbnMuc3R5bGVzLCBvcHRpb25zLmV4dHJhcyk7CgkJCX0KCQkJLy/kuYvliY3nmoTlrp7njrDmlrnmoYjvvJrlrZDnqpflj6Nsb2FkZWTkuYvlkI7lho1hcHBlbmTliLDniLbnqpflj6PkuK3vvJsKCQkJLy/pl67popjvvJrpg6jliIblrZDnqpflj6Nsb2FkZWTkuovku7blj5HnlJ/ovoPmmZrvvIzmraTml7bmiafooYzniLbnqpflj6PnmoRjaGlsZHJlbuaWueazleS8mui/lOWbnuepuu+8jOWvvOiHtOeItuWtkOmAmuiur+Wksei0pe+8mwoJCQkvLyAgICAg5q+U5aaC54i26aG16Z2i5omn6KGM5a6McHJlbG9hZOS6i+S7tuWQju+8jOmcgOinpuWPkeWtkOmhtemdoueahHByZWxvYWTkuovku7bvvIzmraTml7bmnKphcHBlbmTnmoTor53vvIzlsLHml6Dms5Xop6blj5HvvJsKCQkJLy/kv67mlLnmlrnlvI/vvJrkuI3lho3nm5Hmjqdsb2FkZWTkuovku7bvvIznm7TmjqVhcHBlbmQKCQkJLy9ieSBjaGJAMjAxNTA1MjEKCQkJLy8gd2Vidmlldy5hZGRFdmVudExpc3RlbmVyKCdsb2FkZWQnLCBmdW5jdGlvbigpIHsKCQkJcGx1cy53ZWJ2aWV3LmN1cnJlbnRXZWJ2aWV3KCkuYXBwZW5kKHdlYnZpZXcpOwoJCQkvLyB9KTsKCQkJJC53ZWJ2aWV3c1tpZF0gPSBvcHRpb25zOwoKCQl9CgkJcmV0dXJuIHdlYnZpZXc7Cgl9OwoKCS8v5YWo5bGAd2Vidmlld3MKCSQud2Vidmlld3MgPSB7fTsKCS8v6aKE5Yqg6L2956qX5Y+j57Si5byVCgkkLmRhdGEucHJlbG9hZHMgPSBbXTsKCS8vJC5jdXJyZW50V2VidmlldwoJJC5wbHVzUmVhZHkoZnVuY3Rpb24oKSB7CgkJJC5jdXJyZW50V2VidmlldyA9IHBsdXMud2Vidmlldy5jdXJyZW50V2VidmlldygpOwoJfSk7CgkkLmFkZEluaXQoewoJCW5hbWU6ICc1KycsCgkJaW5kZXg6IDEwMCwKCQloYW5kbGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgb3B0aW9ucyA9ICQub3B0aW9uczsKCQkJdmFyIHN1YnBhZ2VzID0gb3B0aW9ucy5zdWJwYWdlcyB8fCBbXTsKCQkJaWYoJC5vcy5wbHVzKSB7CgkJCQkkLnBsdXNSZWFkeShmdW5jdGlvbigpIHsKCQkJCQkvL1RPRE8gIOi/memHjOmcgOimgeWIpOaWreS4gOS4i++8jOacgOWlveetieWtkOeql+WPo+WKoOi9veWujOavleWQju+8jOWGjeiwg+eUqOS4u+eql+WPo+eahHNob3fmlrnms5XvvJsKCQkJCQkvL+aIluiAhe+8muWcqG9wZW53aW5kb3fmlrnms5XkuK3vvIznm5HlkKzlrp7njrDvvJsKCQkJCQkkLmVhY2goc3VicGFnZXMsIGZ1bmN0aW9uKGluZGV4LCBzdWJwYWdlKSB7CgkJCQkJCSQuYXBwZW5kV2VidmlldyhzdWJwYWdlKTsKCQkJCQl9KTsKCQkJCQkvL+WIpOaWreaYr+WQpummlumhtQoJCQkJCWlmKHBsdXMud2Vidmlldy5jdXJyZW50V2VidmlldygpID09PSBwbHVzLndlYnZpZXcuZ2V0V2Vidmlld0J5SWQocGx1cy5ydW50aW1lLmFwcGlkKSkgewoJCQkJCQkvL+mmlumhtemcgOimgeiHquW3sea/gOa0u+mihOWKoOi9ve+8mwoJCQkJCQkvL3RpbWVvdXTlm6DkuLrlrZDpobXpnaJsb2FkZWTkuYvlkI7miY1hcHBlbmTnmoTvvIzpmLLmraLlrZDpobXpnaLlsJrmnKphcHBlbmTjgIHku47ogIzlr7zoh7TlhbZwcmVsb2Fk5pyq6Kem5Y+R55qE6Zeu6aKY77ybCgkJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCQl0cmlnZ2VyUHJlbG9hZChwbHVzLndlYnZpZXcuY3VycmVudFdlYnZpZXcoKSk7CgkJCQkJCX0sIDMwMCk7CgkJCQkJfQoJCQkJCS8v6K6+572uaW9z6aG26YOo54q25oCB5qCP6aKc6Imy77ybCgkJCQkJaWYoJC5vcy5pb3MgJiYgJC5vcHRpb25zLnN0YXR1c0JhckJhY2tncm91bmQpIHsKCQkJCQkJcGx1cy5uYXZpZ2F0b3Iuc2V0U3RhdHVzQmFyQmFja2dyb3VuZCgkLm9wdGlvbnMuc3RhdHVzQmFyQmFja2dyb3VuZCk7CgkJCQkJfQoJCQkJCWlmKCQub3MuYW5kcm9pZCAmJiBwYXJzZUZsb2F0KCQub3MudmVyc2lvbikgPCA0LjQpIHsKCQkJCQkJLy/op6PlhrNBbmRyb2lk5bmz5Y+wNC4054mI5pys5Lul5LiL77yMcmVzdW1l5ZCO77yM54i256qX5L2T5qCH6aKY5bu26L+f5riy5p+T55qE6Zeu6aKY77ybCgkJCQkJCWlmKHBsdXMud2Vidmlldy5jdXJyZW50V2VidmlldygpLnBhcmVudCgpID09IG51bGwpIHsKCQkJCQkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInJlc3VtZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXZhciBib2R5ID0gZG9jdW1lbnQuYm9keTsKCQkJCQkJCQlib2R5LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgkJCQkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJCQkJYm9keS5zdHlsZS5kaXNwbGF5ID0gJyc7CgkJCQkJCQkJfSwgMTApOwoJCQkJCQkJfSk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCS8v5bey5pSv5oyBaWZyYW1l5bWM5YWlCgkJCQkvLwkJCQlpZiAoc3VicGFnZXMubGVuZ3RoID4gMCkgewoJCQkJLy8JCQkJCXZhciBlcnIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCS8vCQkJCQllcnIuY2xhc3NOYW1lID0gJ211aS1lcnJvcic7CgkJCQkvLwkJCQkJLy/mloflrZfmj4/ov7AKCQkJCS8vCQkJCQl2YXIgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKCQkJCS8vCQkJCQlzcGFuLmlubmVySFRNTCA9ICflnKjor6XmtY/op4jlmajkuIvvvIzkuI3mlK/mjIHliJvlu7rlrZDpobXpnaLvvIzlhbfkvZPlj4LogIMnOwoJCQkJLy8JCQkJCWVyci5hcHBlbmRDaGlsZChzcGFuKTsKCQkJCS8vCQkJCQl2YXIgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKCQkJCS8vCQkJCQlhLmlubmVySFRNTCA9ICcibXVp5qGG5p626YCC55So5Zy65pmvIic7CgkJCQkvLwkJCQkJYS5ocmVmID0gJ2h0dHA6Ly9hc2suZGNsb3VkLm5ldC5jbi9hcnRpY2xlLzExMyc7CgkJCQkvLwkJCQkJZXJyLmFwcGVuZENoaWxkKGEpOwoJCQkJLy8JCQkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZXJyKTsKCQkJCS8vCQkJCQljb25zb2xlLmxvZygn5Zyo6K+l5rWP6KeI5Zmo5LiL77yM5LiN5pSv5oyB5Yib5bu65a2Q6aG16Z2iJyk7CgkJCQkvLwkJCQl9CgoJCQl9CgoJCX0KCX0pOwoJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3ByZWxvYWQnLCBmdW5jdGlvbigpIHsKCQkvL+WkhOeQhumihOWKoOi9vemDqOWIhgoJCXZhciB3ZWJ2aWV3cyA9ICQub3B0aW9ucy5wcmVsb2FkUGFnZXMgfHwgW107CgkJJC5wbHVzUmVhZHkoZnVuY3Rpb24oKSB7CgkJCSQuZWFjaCh3ZWJ2aWV3cywgZnVuY3Rpb24oaW5kZXgsIHdlYnZpZXcpIHsKCQkJCSQuY3JlYXRlV2luZG93KCQuZXh0ZW5kKHdlYnZpZXcsIHsKCQkJCQlwcmVsb2FkOiB0cnVlCgkJCQl9KSk7CgkJCX0pOwoKCQl9KTsKCX0pOwoJJC5zdXBwb3J0U3RhdHVzYmFyT2Zmc2V0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQub3MucGx1cyAmJiAkLm9zLmlvcyAmJiBwYXJzZUZsb2F0KCQub3MudmVyc2lvbikgPj0gNzsKCX07CgkkLnJlYWR5KGZ1bmN0aW9uKCkgewoJCS8v5qCH6K+G5b2T5YmN546v5aKD5pSv5oyBc3RhdHVzYmFyCgkJaWYoJC5zdXBwb3J0U3RhdHVzYmFyT2Zmc2V0KCkpIHsKCQkJZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdtdWktc3RhdHVzYmFyJyk7CgkJfQoJfSk7Cn0pKG11aSk7CgovKioKICogbXVpIGJhY2sKICogQHBhcmFtIHt0eXBlfSAkCiAqIEBwYXJhbSB7dHlwZX0gd2luZG93CiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgd2luZG93KSB7CgkvKioKCSAqIHJlZ2lzdGVyIGJhY2sKCSAqIEBwYXJhbSB7dHlwZX0gYmFjawoJICogQHJldHVybnMgeyQuZ2VzdHVyZXN9CgkgKi8KCSQuYWRkQmFjayA9IGZ1bmN0aW9uKGJhY2spIHsKCQlyZXR1cm4gJC5hZGRBY3Rpb24oJ2JhY2tzJywgYmFjayk7Cgl9OwoJLyoqCgkgKiBkZWZhdWx0CgkgKi8KCSQuYWRkQmFjayh7CgkJbmFtZTogJ2Jyb3dzZXInLAoJCWluZGV4OiAxMDAsCgkJaGFuZGxlOiBmdW5jdGlvbigpIHsKCQkJaWYgKHdpbmRvdy5oaXN0b3J5Lmxlbmd0aCA+IDEpIHsKCQkJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9KTsKCS8qKgoJICog5ZCO6YCACgkgKi8KCSQuYmFjayA9IGZ1bmN0aW9uKCkgewoJCWlmICh0eXBlb2YgJC5vcHRpb25zLmJlZm9yZWJhY2sgPT09ICdmdW5jdGlvbicpIHsKCQkJaWYgKCQub3B0aW9ucy5iZWZvcmViYWNrKCkgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJJC5kb0FjdGlvbignYmFja3MnKTsKCX07Cgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndGFwJywgZnVuY3Rpb24oZSkgewoJCXZhciBhY3Rpb24gPSAkLnRhcmdldHMuYWN0aW9uOwoJCWlmIChhY3Rpb24gJiYgYWN0aW9uLmNsYXNzTGlzdC5jb250YWlucygnbXVpLWFjdGlvbi1iYWNrJykpIHsKCQkJJC5iYWNrKCk7CgkJCSQudGFyZ2V0cy5hY3Rpb24gPSBmYWxzZTsKCQl9Cgl9KTsKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzd2lwZXJpZ2h0JywgZnVuY3Rpb24oZSkgewoJCXZhciBkZXRhaWwgPSBlLmRldGFpbDsKCQlpZiAoJC5vcHRpb25zLnN3aXBlQmFjayA9PT0gdHJ1ZSAmJiBNYXRoLmFicyhkZXRhaWwuYW5nbGUpIDwgMykgewoJCQkkLmJhY2soKTsKCQl9Cgl9KTsKCn0pKG11aSwgd2luZG93KTsKLyoqCiAqIG11aSBiYWNrIDUrCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcGFyYW0ge3R5cGV9IHdpbmRvdwogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQsIHdpbmRvdykgewoJaWYgKCQub3MucGx1cyAmJiAkLm9zLmFuZHJvaWQpIHsKCQkkLmFkZEJhY2soewoJCQluYW1lOiAnbXVpJywKCQkJaW5kZXg6IDUsCgkJCWhhbmRsZTogZnVuY3Rpb24oKSB7CgkJCQkvL+WQjue7remHjeaWsOiuvuiuoeatpOWkhO+8jOWwhmJhY2vmlL7liLDlkITkuKrnqbrpl7TlhoXpg6jlrp7njrAKCQkJCS8vcG9wb3ZlcgoJCQkJaWYgKCQudGFyZ2V0cy5fcG9wb3ZlciAmJiAkLnRhcmdldHMuX3BvcG92ZXIuY2xhc3NMaXN0LmNvbnRhaW5zKCdtdWktYWN0aXZlJykpIHsKCQkJCQkkKCQudGFyZ2V0cy5fcG9wb3ZlcikucG9wb3ZlcignaGlkZScpOwoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQkJLy9vZmZjYW52YXMKCQkJCXZhciBvZmZDYW52YXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcubXVpLW9mZi1jYW52YXMtd3JhcC5tdWktYWN0aXZlJyk7CgkJCQlpZiAob2ZmQ2FudmFzKSB7CgkJCQkJJChvZmZDYW52YXMpLm9mZkNhbnZhcygnY2xvc2UnKTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJCXZhciBwcmV2aWV3SW1hZ2UgPSAkLmlzRnVuY3Rpb24oJC5nZXRQcmV2aWV3SW1hZ2UpICYmICQuZ2V0UHJldmlld0ltYWdlKCk7CgkJCQlpZiAocHJldmlld0ltYWdlICYmIHByZXZpZXdJbWFnZS5pc1Nob3duKCkpIHsKCQkJCQlwcmV2aWV3SW1hZ2UuY2xvc2UoKTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJCS8vcG9wdXAKCQkJCXJldHVybiAkLmNsb3NlUG9wdXAoKTsKCQkJfQoJCX0pOwoJfQoJLy/pppbmrKHmjInkuItiYWNr5oyJ6ZSu55qE5pe26Ze0CgkkLl9fYmFja19fZmlyc3QgPSBudWxsOwoJLyoqCgkgKiA1KyBiYWNrCgkgKi8KCSQuYWRkQmFjayh7CgkJbmFtZTogJzUrJywKCQlpbmRleDogMTAsCgkJaGFuZGxlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCF3aW5kb3cucGx1cykgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCXZhciB3b2JqID0gcGx1cy53ZWJ2aWV3LmN1cnJlbnRXZWJ2aWV3KCk7CgkJCXZhciBwYXJlbnQgPSB3b2JqLnBhcmVudCgpOwoJCQlpZiAocGFyZW50KSB7CgkJCQlwYXJlbnQuZXZhbEpTKCdtdWkmJm11aS5iYWNrKCk7Jyk7CgkJCX0gZWxzZSB7CgkJCQl3b2JqLmNhbkJhY2soZnVuY3Rpb24oZSkgewoJCQkJCS8vYnkgY2hiIOaaguaXtuazqOmHiu+8jOWcqOeisOWIsOexu+S8vHBvcG92ZXLkuYvnsbvnmoTplJrngrnnmoTml7blgJnvvIzpnIDlpJrmrKHngrnlh7vmiY3og73ov5Tlm57vvJsKCQkJCQlpZiAoZS5jYW5CYWNrKSB7IC8vd2VidmlldyBoaXN0b3J5IGJhY2sKCQkJCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCQkJCX0gZWxzZSB7IC8vd2VidmlldyBjbG9zZSBvciBoaWRlCgkJCQkJCS8vZml4ZWQgYnkgZnh5IOatpOWkhOS4jeW6lOivpeeUqG9wZW5lcuWIpOaWre+8jOWboOS4uueUqOaIt+acieWPr+iDveiHquW3sWNsb3Nl5o6J5b2T5YmN56qX5Y+j55qEb3BlbmVy44CC6L+Z5qC355qE6K+d44CCb3BlbmVy5bCx5Li656m65LqG77yM5a+86Ie05LiN6IO95omn6KGMY2xvc2UKCQkJCQkJaWYgKHdvYmouaWQgPT09IHBsdXMucnVudGltZS5hcHBpZCkgeyAvL+mmlumhtQoJCQkJCQkJLy/pppbpobXkuI3lrZjlnKhvcGVuZXLnmoTmg4XlhrXkuIvvvIzlkI7pgIDlrp7pmYXkuIrlupTor6XmmK/pgIDlh7rlupTnlKjvvJsKCQkJCQkJCS8v6aaW5qyh5oyJ6ZSu77yM5o+Q56S64oCY5YaN5oyJ5LiA5qyh6YCA5Ye65bqU55So4oCZCgkJCQkJCQlpZiAoISQuX19iYWNrX19maXJzdCkgewoJCQkJCQkJCSQuX19iYWNrX19maXJzdCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoJCQkJCQkJCW11aS50b2FzdCgn5YaN5oyJ5LiA5qyh6YCA5Ye65bqU55SoJyk7CgkJCQkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJCQkJJC5fX2JhY2tfX2ZpcnN0ID0gbnVsbDsKCQkJCQkJCQl9LCAyMDAwKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gJC5fX2JhY2tfX2ZpcnN0IDwgMjAwMCkgewoJCQkJCQkJCQlwbHVzLnJ1bnRpbWUucXVpdCgpOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsgLy/lhbbku5bpobXpnaLvvIwKCQkJCQkJCWlmICh3b2JqLnByZWxvYWQpIHsKCQkJCQkJCQl3b2JqLmhpZGUoImF1dG8iKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJLy/lhbPpl63pobXpnaLml7bvvIzpnIDopoHlsIblhbbmiZPlvIDnmoTmiYDmnInlrZDpobXpnaLlhajpg6jlhbPpl63vvJsKCQkJCQkJCQkkLmNsb3NlQWxsKHdvYmopOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfQoJfSk7CgoKCSQubWVudSA9IGZ1bmN0aW9uKCkgewoJCXZhciBtZW51ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm11aS1hY3Rpb24tbWVudScpOwoJCWlmIChtZW51KSB7CgkJCSQudHJpZ2dlcihtZW51LCAkLkVWRU5UX1NUQVJUKTsgLy/kuLTml7blpITnkIZtZW515pegdG91Y2hzdGFydOeahOivne+8jOaJvuS4jeWIsOW9k+WJjXRhcmdldHPnmoTpl67popgKCQkJJC50cmlnZ2VyKG1lbnUsICd0YXAnKTsKCQl9IGVsc2UgeyAvL+aJp+ihjOeItueql+WPo+eahG1lbnUKCQkJaWYgKHdpbmRvdy5wbHVzKSB7CgkJCQl2YXIgd29iaiA9ICQuY3VycmVudFdlYnZpZXc7CgkJCQl2YXIgcGFyZW50ID0gd29iai5wYXJlbnQoKTsKCQkJCWlmIChwYXJlbnQpIHsgLy/lj4jlvpdldmFsSlMKCQkJCQlwYXJlbnQuZXZhbEpTKCdtdWkmJm11aS5tZW51KCk7Jyk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoJdmFyIF9fYmFjayA9IGZ1bmN0aW9uKCkgewoJCSQuYmFjaygpOwoJfTsKCXZhciBfX21lbnUgPSBmdW5jdGlvbigpIHsKCQkkLm1lbnUoKTsKCX07CgkvL+m7mOiupOebkeWQrAoJJC5wbHVzUmVhZHkoZnVuY3Rpb24oKSB7CgkJaWYgKCQub3B0aW9ucy5rZXlFdmVudEJpbmQuYmFja2J1dHRvbikgewoJCQlwbHVzLmtleS5hZGRFdmVudExpc3RlbmVyKCdiYWNrYnV0dG9uJywgX19iYWNrLCBmYWxzZSk7CgkJfQoJCWlmICgkLm9wdGlvbnMua2V5RXZlbnRCaW5kLm1lbnVidXR0b24pIHsKCQkJcGx1cy5rZXkuYWRkRXZlbnRMaXN0ZW5lcignbWVudWJ1dHRvbicsIF9fbWVudSwgZmFsc2UpOwoJCX0KCX0pOwoJLy/lpITnkIbmjInplK7nm5HlkKzkuovku7YKCSQuYWRkSW5pdCh7CgkJbmFtZTogJ2tleUV2ZW50QmluZCcsCgkJaW5kZXg6IDEwMDAsCgkJaGFuZGxlOiBmdW5jdGlvbigpIHsKCQkJJC5wbHVzUmVhZHkoZnVuY3Rpb24oKSB7CgkJCQkvL+WmguaenOS4jeS4unRydWXvvIzliJnnp7vpmaTpu5jorqTnm5HlkKwKCQkJCWlmICghJC5vcHRpb25zLmtleUV2ZW50QmluZC5iYWNrYnV0dG9uKSB7CgkJCQkJcGx1cy5rZXkucmVtb3ZlRXZlbnRMaXN0ZW5lcignYmFja2J1dHRvbicsIF9fYmFjayk7CgkJCQl9CgkJCQlpZiAoISQub3B0aW9ucy5rZXlFdmVudEJpbmQubWVudWJ1dHRvbikgewoJCQkJCXBsdXMua2V5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lbnVidXR0b24nLCBfX21lbnUpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9KTsKfSkobXVpLCB3aW5kb3cpOwovKioKICogbXVpLmluaXQgcHVsbGRvd25SZWZyZXNoCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQpIHsKCSQuYWRkSW5pdCh7CgkJbmFtZTogJ3B1bGxyZWZyZXNoJywKCQlpbmRleDogMTAwMCwKCQloYW5kbGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgb3B0aW9ucyA9ICQub3B0aW9uczsKCQkJdmFyIHB1bGxSZWZyZXNoT3B0aW9ucyA9IG9wdGlvbnMucHVsbFJlZnJlc2ggfHwge307CgkJCXZhciBoYXNQdWxsZG93biA9IHB1bGxSZWZyZXNoT3B0aW9ucy5kb3duICYmIHB1bGxSZWZyZXNoT3B0aW9ucy5kb3duLmhhc093blByb3BlcnR5KCdjYWxsYmFjaycpOwoJCQl2YXIgaGFzUHVsbHVwID0gcHVsbFJlZnJlc2hPcHRpb25zLnVwICYmIHB1bGxSZWZyZXNoT3B0aW9ucy51cC5oYXNPd25Qcm9wZXJ0eSgnY2FsbGJhY2snKTsKCQkJaWYoaGFzUHVsbGRvd24gfHwgaGFzUHVsbHVwKSB7CgkJCQl2YXIgY29udGFpbmVyID0gcHVsbFJlZnJlc2hPcHRpb25zLmNvbnRhaW5lcjsKCQkJCWlmKGNvbnRhaW5lcikgewoJCQkJCXZhciAkY29udGFpbmVyID0gJChjb250YWluZXIpOwoJCQkJCWlmKCRjb250YWluZXIubGVuZ3RoID09PSAxKSB7CgkJCQkJCWlmKCQub3MucGx1cykgeyAvLzUr546v5aKDCgkJCQkJCQlpZihoYXNQdWxsZG93biAmJiBwdWxsUmVmcmVzaE9wdGlvbnMuZG93bi5zdHlsZSA9PSAiY2lyY2xlIikgeyAvL+WOn+eUn+i9rOWciAoJCQkJCQkJCSQucGx1c1JlYWR5KGZ1bmN0aW9uKCkgewoJCQkJCQkJCQkvL+i/memHjOaUueWGmSQuZm4ucHVsbFJlZnJlc2gKCQkJCQkJCQkJJC5mbi5wdWxsUmVmcmVzaCA9ICQuZm4ucHVsbFJlZnJlc2hfbmF0aXZlOwoJCQkJCQkJCQkkY29udGFpbmVyLnB1bGxSZWZyZXNoKHB1bGxSZWZyZXNoT3B0aW9ucyk7CgkJCQkJCQkJfSk7CgoJCQkJCQkJfSBlbHNlIGlmKCQub3MuYW5kcm9pZCkgeyAvL+mdnuWOn+eUn+i9rOWciO+8jOS9huaYr0FuZHJvaWTnjq/looMKCQkJCQkJCQkkLnBsdXNSZWFkeShmdW5jdGlvbigpIHsKCQkJCQkJCQkJLy/ov5nph4zmlLnlhpkkLmZuLnB1bGxSZWZyZXNoCgkJCQkJCQkJCSQuZm4ucHVsbFJlZnJlc2ggPSAkLmZuLnB1bGxSZWZyZXNoX25hdGl2ZQoJCQkJCQkJCQl2YXIgd2VidmlldyA9IHBsdXMud2Vidmlldy5jdXJyZW50V2VidmlldygpOwoJCQkJCQkJCQlpZih3aW5kb3cuX19OV2luX0VuYWJsZV9fID09PSBmYWxzZSkgeyAvL+S4jeaUr+aMgeWkmndlYnZpZXcKCQkJCQkJCQkJCSRjb250YWluZXIucHVsbFJlZnJlc2gocHVsbFJlZnJlc2hPcHRpb25zKTsKCQkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJCWlmKGhhc1B1bGx1cCkgewoJCQkJCQkJCQkJCS8v5b2T5YmN6aG16Z2i5Yid5aeL5YyWcHVsbHVwCgkJCQkJCQkJCQkJdmFyIHVwT3B0aW9ucyA9IHt9OwoJCQkJCQkJCQkJCXVwT3B0aW9ucy51cCA9IHB1bGxSZWZyZXNoT3B0aW9ucy51cDsKCQkJCQkJCQkJCQl1cE9wdGlvbnMud2Vidmlld0lkID0gd2Vidmlldy5pZCB8fCB3ZWJ2aWV3LmdldFVSTCgpOwoJCQkJCQkJCQkJCSRjb250YWluZXIucHVsbFJlZnJlc2godXBPcHRpb25zKTsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJCWlmKGhhc1B1bGxkb3duKSB7CgkJCQkJCQkJCQkJdmFyIHBhcmVudCA9IHdlYnZpZXcucGFyZW50KCk7CgkJCQkJCQkJCQkJdmFyIGlkID0gd2Vidmlldy5pZCB8fCB3ZWJ2aWV3LmdldFVSTCgpOwoJCQkJCQkJCQkJCWlmKHBhcmVudCkgewoJCQkJCQkJCQkJCQlpZighaGFzUHVsbHVwKSB7IC8v5aaC5p6c5rKh5pyJ5LiK5ouJ5Yqg6L2977yM6ZyA6KaB5omL5Yqo5Yid5aeL5YyW5LiA5Liq6buY6K6k55qEcHVsbFJlZnJlc2jvvIzku6Xkvr/lvZPliY3pobXpnaLlrrnlmajlj6/ku6XosIPnlKhlbmRQdWxsZG93blRvUmVmcmVzaOetieaWueazlQoJCQkJCQkJCQkJCQkJJGNvbnRhaW5lci5wdWxsUmVmcmVzaCh7CgkJCQkJCQkJCQkJCQkJd2Vidmlld0lkOiBpZAoJCQkJCQkJCQkJCQkJfSk7CgkJCQkJCQkJCQkJCX0KCQkJCQkJCQkJCQkJdmFyIGRvd25PcHRpb25zID0gewoJCQkJCQkJCQkJCQkJd2Vidmlld0lkOiBpZC8v5a2Q6aG16Z2iaWQKCQkJCQkJCQkJCQkJfTsKCQkJCQkJCQkJCQkJZG93bk9wdGlvbnMuZG93biA9ICQuZXh0ZW5kKHt9LCBwdWxsUmVmcmVzaE9wdGlvbnMuZG93bik7CgkJCQkJCQkJCQkJCWRvd25PcHRpb25zLmRvd24uY2FsbGJhY2sgPSAnX0NBTExCQUNLJzsKCQkJCQkJCQkJCQkJLy/mlLnlhpnniLbpobXpnaLnmoQkLmZuLnB1bGxSZWZyZXNoCgkJCQkJCQkJCQkJCXBhcmVudC5ldmFsSlMoIm11aS5mbi5wdWxsUmVmcmVzaD1tdWkuZm4ucHVsbFJlZnJlc2hfbmF0aXZlIik7CgkJCQkJCQkJCQkJCS8v54i26aG16Z2i5Yid5aeL5YyWcHVsbGRvd24KCQkJCQkJCQkJCQkJcGFyZW50LmV2YWxKUygibXVpJiZtdWkoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm11aS1jb250ZW50JykpLnB1bGxSZWZyZXNoKCciICsgSlNPTi5zdHJpbmdpZnkoZG93bk9wdGlvbnMpICsgIicpIik7CgkJCQkJCQkJCQkJfQoJCQkJCQkJCQkJfQoJCQkJCQkJCQl9CgkJCQkJCQkJfSk7CgkJCQkJCQl9IGVsc2UgeyAvL+mdnuWOn+eUn+i9rOWciO+8jGlPU+eOr+WigwoJCQkJCQkJCSRjb250YWluZXIucHVsbFJlZnJlc2gocHVsbFJlZnJlc2hPcHRpb25zKTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCSRjb250YWluZXIucHVsbFJlZnJlc2gocHVsbFJlZnJlc2hPcHRpb25zKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0pOwp9KShtdWkpOwovKioKICogbXVpIGFqYXgKICogQHBhcmFtIHt0eXBlfSAkCiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgd2luZG93LCB1bmRlZmluZWQpIHsKCgl2YXIganNvblR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7Cgl2YXIgaHRtbFR5cGUgPSAndGV4dC9odG1sJzsKCXZhciByc2NyaXB0ID0gLzxzY3JpcHRcYltePF0qKD86KD8hPFwvc2NyaXB0Pik8W148XSopKjxcL3NjcmlwdD4vZ2k7Cgl2YXIgc2NyaXB0VHlwZVJFID0gL14oPzp0ZXh0fGFwcGxpY2F0aW9uKVwvamF2YXNjcmlwdC9pOwoJdmFyIHhtbFR5cGVSRSA9IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL3htbC9pOwoJdmFyIGJsYW5rUkUgPSAvXlxzKiQvOwoKCSQuYWpheFNldHRpbmdzID0gewoJCXR5cGU6ICdHRVQnLAoJCWJlZm9yZVNlbmQ6ICQubm9vcCwKCQlzdWNjZXNzOiAkLm5vb3AsCgkJZXJyb3I6ICQubm9vcCwKCQljb21wbGV0ZTogJC5ub29wLAoJCWNvbnRleHQ6IG51bGwsCgkJeGhyOiBmdW5jdGlvbihwcm90b2NvbCkgewoJCQlyZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOwoJCX0sCgkJYWNjZXB0czogewoJCQlzY3JpcHQ6ICd0ZXh0L2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQsIGFwcGxpY2F0aW9uL3gtamF2YXNjcmlwdCcsCgkJCWpzb246IGpzb25UeXBlLAoJCQl4bWw6ICdhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sJywKCQkJaHRtbDogaHRtbFR5cGUsCgkJCXRleHQ6ICd0ZXh0L3BsYWluJwoJCX0sCgkJdGltZW91dDogMCwKCQlwcm9jZXNzRGF0YTogdHJ1ZSwKCQljYWNoZTogdHJ1ZQoJfTsKCXZhciBhamF4QmVmb3JlU2VuZCA9IGZ1bmN0aW9uKHhociwgc2V0dGluZ3MpIHsKCQl2YXIgY29udGV4dCA9IHNldHRpbmdzLmNvbnRleHQKCQlpZihzZXR0aW5ncy5iZWZvcmVTZW5kLmNhbGwoY29udGV4dCwgeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9OwoJdmFyIGFqYXhTdWNjZXNzID0gZnVuY3Rpb24oZGF0YSwgeGhyLCBzZXR0aW5ncykgewoJCXNldHRpbmdzLnN1Y2Nlc3MuY2FsbChzZXR0aW5ncy5jb250ZXh0LCBkYXRhLCAnc3VjY2VzcycsIHhocik7CgkJYWpheENvbXBsZXRlKCdzdWNjZXNzJywgeGhyLCBzZXR0aW5ncyk7Cgl9OwoJLy8gdHlwZTogInRpbWVvdXQiLCAiZXJyb3IiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCgl2YXIgYWpheEVycm9yID0gZnVuY3Rpb24oZXJyb3IsIHR5cGUsIHhociwgc2V0dGluZ3MpIHsKCQlzZXR0aW5ncy5lcnJvci5jYWxsKHNldHRpbmdzLmNvbnRleHQsIHhociwgdHlwZSwgZXJyb3IpOwoJCWFqYXhDb21wbGV0ZSh0eXBlLCB4aHIsIHNldHRpbmdzKTsKCX07CgkvLyBzdGF0dXM6ICJzdWNjZXNzIiwgIm5vdG1vZGlmaWVkIiwgImVycm9yIiwgInRpbWVvdXQiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCgl2YXIgYWpheENvbXBsZXRlID0gZnVuY3Rpb24oc3RhdHVzLCB4aHIsIHNldHRpbmdzKSB7CgkJc2V0dGluZ3MuY29tcGxldGUuY2FsbChzZXR0aW5ncy5jb250ZXh0LCB4aHIsIHN0YXR1cyk7Cgl9OwoKCXZhciBzZXJpYWxpemUgPSBmdW5jdGlvbihwYXJhbXMsIG9iaiwgdHJhZGl0aW9uYWwsIHNjb3BlKSB7CgkJdmFyIHR5cGUsIGFycmF5ID0gJC5pc0FycmF5KG9iaiksCgkJCWhhc2ggPSAkLmlzUGxhaW5PYmplY3Qob2JqKTsKCQkkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkJCXR5cGUgPSAkLnR5cGUodmFsdWUpOwoJCQlpZihzY29wZSkgewoJCQkJa2V5ID0gdHJhZGl0aW9uYWwgPyBzY29wZSA6CgkJCQkJc2NvcGUgKyAnWycgKyAoaGFzaCB8fCB0eXBlID09PSAnb2JqZWN0JyB8fCB0eXBlID09PSAnYXJyYXknID8ga2V5IDogJycpICsgJ10nOwoJCQl9CgkJCS8vIGhhbmRsZSBkYXRhIGluIHNlcmlhbGl6ZUFycmF5KCkgZm9ybWF0CgkJCWlmKCFzY29wZSAmJiBhcnJheSkgewoJCQkJcGFyYW1zLmFkZCh2YWx1ZS5uYW1lLCB2YWx1ZS52YWx1ZSk7CgkJCX0KCQkJLy8gcmVjdXJzZSBpbnRvIG5lc3RlZCBvYmplY3RzCgkJCWVsc2UgaWYodHlwZSA9PT0gImFycmF5IiB8fCAoIXRyYWRpdGlvbmFsICYmIHR5cGUgPT09ICJvYmplY3QiKSkgewoJCQkJc2VyaWFsaXplKHBhcmFtcywgdmFsdWUsIHRyYWRpdGlvbmFsLCBrZXkpOwoJCQl9IGVsc2UgewoJCQkJcGFyYW1zLmFkZChrZXksIHZhbHVlKTsKCQkJfQoJCX0pOwoJfTsKCXZhciBzZXJpYWxpemVEYXRhID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCWlmKG9wdGlvbnMucHJvY2Vzc0RhdGEgJiYgb3B0aW9ucy5kYXRhICYmIHR5cGVvZiBvcHRpb25zLmRhdGEgIT09ICJzdHJpbmciKSB7CgkJCXZhciBjb250ZW50VHlwZSA9IG9wdGlvbnMuY29udGVudFR5cGU7CgkJCWlmKCFjb250ZW50VHlwZSAmJiBvcHRpb25zLmhlYWRlcnMpIHsKCQkJCWNvbnRlbnRUeXBlID0gb3B0aW9ucy5oZWFkZXJzWydDb250ZW50LVR5cGUnXTsKCQkJfQoJCQlpZihjb250ZW50VHlwZSAmJiB+Y29udGVudFR5cGUuaW5kZXhPZihqc29uVHlwZSkpIHsgLy9hcHBsaWNhdGlvbi9qc29uCgkJCQlvcHRpb25zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmRhdGEpOwoJCQl9IGVsc2UgewoJCQkJb3B0aW9ucy5kYXRhID0gJC5wYXJhbShvcHRpb25zLmRhdGEsIG9wdGlvbnMudHJhZGl0aW9uYWwpOwoJCQl9CgkJfQoJCWlmKG9wdGlvbnMuZGF0YSAmJiAoIW9wdGlvbnMudHlwZSB8fCBvcHRpb25zLnR5cGUudG9VcHBlckNhc2UoKSA9PT0gJ0dFVCcpKSB7CgkJCW9wdGlvbnMudXJsID0gYXBwZW5kUXVlcnkob3B0aW9ucy51cmwsIG9wdGlvbnMuZGF0YSk7CgkJCW9wdGlvbnMuZGF0YSA9IHVuZGVmaW5lZDsKCQl9Cgl9OwoJdmFyIGFwcGVuZFF1ZXJ5ID0gZnVuY3Rpb24odXJsLCBxdWVyeSkgewoJCWlmKHF1ZXJ5ID09PSAnJykgewoJCQlyZXR1cm4gdXJsOwoJCX0KCQlyZXR1cm4odXJsICsgJyYnICsgcXVlcnkpLnJlcGxhY2UoL1smP117MSwyfS8sICc/Jyk7Cgl9OwoJdmFyIG1pbWVUb0RhdGFUeXBlID0gZnVuY3Rpb24obWltZSkgewoJCWlmKG1pbWUpIHsKCQkJbWltZSA9IG1pbWUuc3BsaXQoJzsnLCAyKVswXTsKCQl9CgkJcmV0dXJuIG1pbWUgJiYgKG1pbWUgPT09IGh0bWxUeXBlID8gJ2h0bWwnIDoKCQkJbWltZSA9PT0ganNvblR5cGUgPyAnanNvbicgOgoJCQlzY3JpcHRUeXBlUkUudGVzdChtaW1lKSA/ICdzY3JpcHQnIDoKCQkJeG1sVHlwZVJFLnRlc3QobWltZSkgJiYgJ3htbCcpIHx8ICd0ZXh0JzsKCX07Cgl2YXIgcGFyc2VBcmd1bWVudHMgPSBmdW5jdGlvbih1cmwsIGRhdGEsIHN1Y2Nlc3MsIGRhdGFUeXBlKSB7CgkJaWYoJC5pc0Z1bmN0aW9uKGRhdGEpKSB7CgkJCWRhdGFUeXBlID0gc3VjY2Vzcywgc3VjY2VzcyA9IGRhdGEsIGRhdGEgPSB1bmRlZmluZWQ7CgkJfQoJCWlmKCEkLmlzRnVuY3Rpb24oc3VjY2VzcykpIHsKCQkJZGF0YVR5cGUgPSBzdWNjZXNzLCBzdWNjZXNzID0gdW5kZWZpbmVkOwoJCX0KCQlyZXR1cm4gewoJCQl1cmw6IHVybCwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2Vzczogc3VjY2VzcywKCQkJZGF0YVR5cGU6IGRhdGFUeXBlCgkJfTsKCX07CgkkLmFqYXggPSBmdW5jdGlvbih1cmwsIG9wdGlvbnMpIHsKCQlpZih0eXBlb2YgdXJsID09PSAib2JqZWN0IikgewoJCQlvcHRpb25zID0gdXJsOwoJCQl1cmwgPSB1bmRlZmluZWQ7CgkJfQoJCXZhciBzZXR0aW5ncyA9IG9wdGlvbnMgfHwge307CgkJc2V0dGluZ3MudXJsID0gdXJsIHx8IHNldHRpbmdzLnVybDsKCQlmb3IodmFyIGtleSBpbiAkLmFqYXhTZXR0aW5ncykgewoJCQlpZihzZXR0aW5nc1trZXldID09PSB1bmRlZmluZWQpIHsKCQkJCXNldHRpbmdzW2tleV0gPSAkLmFqYXhTZXR0aW5nc1trZXldOwoJCQl9CgkJfQoJCXNlcmlhbGl6ZURhdGEoc2V0dGluZ3MpOwoJCXZhciBkYXRhVHlwZSA9IHNldHRpbmdzLmRhdGFUeXBlOwoKCQlpZihzZXR0aW5ncy5jYWNoZSA9PT0gZmFsc2UgfHwgKCghb3B0aW9ucyB8fCBvcHRpb25zLmNhY2hlICE9PSB0cnVlKSAmJiAoJ3NjcmlwdCcgPT09IGRhdGFUeXBlKSkpIHsKCQkJc2V0dGluZ3MudXJsID0gYXBwZW5kUXVlcnkoc2V0dGluZ3MudXJsLCAnXz0nICsgJC5ub3coKSk7CgkJfQoJCXZhciBtaW1lID0gc2V0dGluZ3MuYWNjZXB0c1tkYXRhVHlwZSAmJiBkYXRhVHlwZS50b0xvd2VyQ2FzZSgpXTsKCQl2YXIgaGVhZGVycyA9IHt9OwoJCXZhciBzZXRIZWFkZXIgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewoJCQloZWFkZXJzW25hbWUudG9Mb3dlckNhc2UoKV0gPSBbbmFtZSwgdmFsdWVdOwoJCX07CgkJdmFyIHByb3RvY29sID0gL14oW1x3LV0rOilcL1wvLy50ZXN0KHNldHRpbmdzLnVybCkgPyBSZWdFeHAuJDEgOiB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CgkJdmFyIHhociA9IHNldHRpbmdzLnhocihzZXR0aW5ncyk7CgkJdmFyIG5hdGl2ZVNldEhlYWRlciA9IHhoci5zZXRSZXF1ZXN0SGVhZGVyOwoJCXZhciBhYm9ydFRpbWVvdXQ7CgoJCXNldEhlYWRlcignWC1SZXF1ZXN0ZWQtV2l0aCcsICdYTUxIdHRwUmVxdWVzdCcpOwoJCXNldEhlYWRlcignQWNjZXB0JywgbWltZSB8fCAnKi8qJyk7CgkJaWYobWltZSA9IHNldHRpbmdzLm1pbWVUeXBlIHx8IG1pbWUpIHsKCQkJaWYobWltZS5pbmRleE9mKCcsJykgPiAtMSkgewoJCQkJbWltZSA9IG1pbWUuc3BsaXQoJywnLCAyKVswXTsKCQkJfQoJCQl4aHIub3ZlcnJpZGVNaW1lVHlwZSAmJiB4aHIub3ZlcnJpZGVNaW1lVHlwZShtaW1lKTsKCQl9CgkJaWYoc2V0dGluZ3MuY29udGVudFR5cGUgfHwgKHNldHRpbmdzLmNvbnRlbnRUeXBlICE9PSBmYWxzZSAmJiBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUudG9VcHBlckNhc2UoKSAhPT0gJ0dFVCcpKSB7CgkJCXNldEhlYWRlcignQ29udGVudC1UeXBlJywgc2V0dGluZ3MuY29udGVudFR5cGUgfHwgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpOwoJCX0KCQlpZihzZXR0aW5ncy5oZWFkZXJzKSB7CgkJCWZvcih2YXIgbmFtZSBpbiBzZXR0aW5ncy5oZWFkZXJzKQoJCQkJc2V0SGVhZGVyKG5hbWUsIHNldHRpbmdzLmhlYWRlcnNbbmFtZV0pOwoJCX0KCQl4aHIuc2V0UmVxdWVzdEhlYWRlciA9IHNldEhlYWRlcjsKCgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQlpZih4aHIucmVhZHlTdGF0ZSA9PT0gNCkgewoJCQkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9ICQubm9vcDsKCQkJCWNsZWFyVGltZW91dChhYm9ydFRpbWVvdXQpOwoJCQkJdmFyIHJlc3VsdCwgZXJyb3IgPSBmYWxzZTsKCQkJCXZhciBpc0xvY2FsID0gcHJvdG9jb2wgPT09ICdmaWxlOic7CgkJCQlpZigoeGhyLnN0YXR1cyA+PSAyMDAgJiYgeGhyLnN0YXR1cyA8IDMwMCkgfHwgeGhyLnN0YXR1cyA9PT0gMzA0IHx8ICh4aHIuc3RhdHVzID09PSAwICYmIGlzTG9jYWwgJiYgeGhyLnJlc3BvbnNlVGV4dCkpIHsKCQkJCQlkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG1pbWVUb0RhdGFUeXBlKHNldHRpbmdzLm1pbWVUeXBlIHx8IHhoci5nZXRSZXNwb25zZUhlYWRlcignY29udGVudC10eXBlJykpOwoJCQkJCXJlc3VsdCA9IHhoci5yZXNwb25zZVRleHQ7CgkJCQkJdHJ5IHsKCQkJCQkJLy8gaHR0cDovL3BlcmZlY3Rpb25raWxscy5jb20vZ2xvYmFsLWV2YWwtd2hhdC1hcmUtdGhlLW9wdGlvbnMvCgkJCQkJCWlmKGRhdGFUeXBlID09PSAnc2NyaXB0JykgewoJCQkJCQkJKDEsIGV2YWwpKHJlc3VsdCk7CgkJCQkJCX0gZWxzZSBpZihkYXRhVHlwZSA9PT0gJ3htbCcpIHsKCQkJCQkJCXJlc3VsdCA9IHhoci5yZXNwb25zZVhNTDsKCQkJCQkJfSBlbHNlIGlmKGRhdGFUeXBlID09PSAnanNvbicpIHsKCQkJCQkJCXJlc3VsdCA9IGJsYW5rUkUudGVzdChyZXN1bHQpID8gbnVsbCA6ICQucGFyc2VKU09OKHJlc3VsdCk7CgkJCQkJCX0KCQkJCQl9IGNhdGNoKGUpIHsKCQkJCQkJZXJyb3IgPSBlOwoJCQkJCX0KCgkJCQkJaWYoZXJyb3IpIHsKCQkJCQkJYWpheEVycm9yKGVycm9yLCAncGFyc2VyZXJyb3InLCB4aHIsIHNldHRpbmdzKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlhamF4U3VjY2VzcyhyZXN1bHQsIHhociwgc2V0dGluZ3MpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIHN0YXR1cyA9IHhoci5zdGF0dXMgPyAnZXJyb3InIDogJ2Fib3J0JzsKCQkJCQl2YXIgc3RhdHVzVGV4dCA9IHhoci5zdGF0dXNUZXh0IHx8IG51bGw7CgkJCQkJaWYoaXNMb2NhbCkgewoJCQkJCQlzdGF0dXMgPSAnZXJyb3InOwoJCQkJCQlzdGF0dXNUZXh0ID0gJzQwNCc7CgkJCQkJfQoJCQkJCWFqYXhFcnJvcihzdGF0dXNUZXh0LCBzdGF0dXMsIHhociwgc2V0dGluZ3MpOwoJCQkJfQoJCQl9CgkJfTsKCQlpZihhamF4QmVmb3JlU2VuZCh4aHIsIHNldHRpbmdzKSA9PT0gZmFsc2UpIHsKCQkJeGhyLmFib3J0KCk7CgkJCWFqYXhFcnJvcihudWxsLCAnYWJvcnQnLCB4aHIsIHNldHRpbmdzKTsKCQkJcmV0dXJuIHhocjsKCQl9CgoJCWlmKHNldHRpbmdzLnhockZpZWxkcykgewoJCQlmb3IodmFyIG5hbWUgaW4gc2V0dGluZ3MueGhyRmllbGRzKSB7CgkJCQl4aHJbbmFtZV0gPSBzZXR0aW5ncy54aHJGaWVsZHNbbmFtZV07CgkJCX0KCQl9CgoJCXZhciBhc3luYyA9ICdhc3luYycgaW4gc2V0dGluZ3MgPyBzZXR0aW5ncy5hc3luYyA6IHRydWU7CgoJCXhoci5vcGVuKHNldHRpbmdzLnR5cGUudG9VcHBlckNhc2UoKSwgc2V0dGluZ3MudXJsLCBhc3luYywgc2V0dGluZ3MudXNlcm5hbWUsIHNldHRpbmdzLnBhc3N3b3JkKTsKCgkJZm9yKHZhciBuYW1lIGluIGhlYWRlcnMpIHsKCQkJaWYoaGVhZGVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewoJCQkJbmF0aXZlU2V0SGVhZGVyLmFwcGx5KHhociwgaGVhZGVyc1tuYW1lXSk7CgkJCX0KCQl9CgkJaWYoc2V0dGluZ3MudGltZW91dCA+IDApIHsKCQkJYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSAkLm5vb3A7CgkJCQl4aHIuYWJvcnQoKTsKCQkJCWFqYXhFcnJvcihudWxsLCAndGltZW91dCcsIHhociwgc2V0dGluZ3MpOwoJCQl9LCBzZXR0aW5ncy50aW1lb3V0KTsKCQl9CgkJeGhyLnNlbmQoc2V0dGluZ3MuZGF0YSA/IHNldHRpbmdzLmRhdGEgOiBudWxsKTsKCQlyZXR1cm4geGhyOwoJfTsKCgkkLnBhcmFtID0gZnVuY3Rpb24ob2JqLCB0cmFkaXRpb25hbCkgewoJCXZhciBwYXJhbXMgPSBbXTsKCQlwYXJhbXMuYWRkID0gZnVuY3Rpb24oaywgdikgewoJCQl0aGlzLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGspICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHYpKTsKCQl9OwoJCXNlcmlhbGl6ZShwYXJhbXMsIG9iaiwgdHJhZGl0aW9uYWwpOwoJCXJldHVybiBwYXJhbXMuam9pbignJicpLnJlcGxhY2UoLyUyMC9nLCAnKycpOwoJfTsKCSQuZ2V0ID0gZnVuY3Rpb24oIC8qIHVybCwgZGF0YSwgc3VjY2VzcywgZGF0YVR5cGUgKi8gKSB7CgkJcmV0dXJuICQuYWpheChwYXJzZUFyZ3VtZW50cy5hcHBseShudWxsLCBhcmd1bWVudHMpKTsKCX07CgoJJC5wb3N0ID0gZnVuY3Rpb24oIC8qIHVybCwgZGF0YSwgc3VjY2VzcywgZGF0YVR5cGUgKi8gKSB7CgkJdmFyIG9wdGlvbnMgPSBwYXJzZUFyZ3VtZW50cy5hcHBseShudWxsLCBhcmd1bWVudHMpOwoJCW9wdGlvbnMudHlwZSA9ICdQT1NUJzsKCQlyZXR1cm4gJC5hamF4KG9wdGlvbnMpOwoJfTsKCgkkLmdldEpTT04gPSBmdW5jdGlvbiggLyogdXJsLCBkYXRhLCBzdWNjZXNzICovICkgewoJCXZhciBvcHRpb25zID0gcGFyc2VBcmd1bWVudHMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKCQlvcHRpb25zLmRhdGFUeXBlID0gJ2pzb24nOwoJCXJldHVybiAkLmFqYXgob3B0aW9ucyk7Cgl9OwoKCSQuZm4ubG9hZCA9IGZ1bmN0aW9uKHVybCwgZGF0YSwgc3VjY2VzcykgewoJCWlmKCF0aGlzLmxlbmd0aCkKCQkJcmV0dXJuIHRoaXM7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYXJ0cyA9IHVybC5zcGxpdCgvXHMvKSwKCQkJc2VsZWN0b3IsCgkJCW9wdGlvbnMgPSBwYXJzZUFyZ3VtZW50cyh1cmwsIGRhdGEsIHN1Y2Nlc3MpLAoJCQljYWxsYmFjayA9IG9wdGlvbnMuc3VjY2VzczsKCQlpZihwYXJ0cy5sZW5ndGggPiAxKQoJCQlvcHRpb25zLnVybCA9IHBhcnRzWzBdLCBzZWxlY3RvciA9IHBhcnRzWzFdOwoJCW9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CgkJCWlmKHNlbGVjdG9yKSB7CgkJCQl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQlkaXYuaW5uZXJIVE1MID0gcmVzcG9uc2UucmVwbGFjZShyc2NyaXB0LCAiIik7CgkJCQl2YXIgc2VsZWN0b3JEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCXZhciBjaGlsZHMgPSBkaXYucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CgkJCQlpZihjaGlsZHMgJiYgY2hpbGRzLmxlbmd0aCA+IDApIHsKCQkJCQlmb3IodmFyIGkgPSAwLCBsZW4gPSBjaGlsZHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQkJc2VsZWN0b3JEaXYuYXBwZW5kQ2hpbGQoY2hpbGRzW2ldKTsKCQkJCQl9CgkJCQl9CgkJCQlzZWxmWzBdLmlubmVySFRNTCA9IHNlbGVjdG9yRGl2LmlubmVySFRNTDsKCQkJfSBlbHNlIHsKCQkJCXNlbGZbMF0uaW5uZXJIVE1MID0gcmVzcG9uc2U7CgkJCX0KCQkJY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKCQl9OwoJCSQuYWpheChvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX07Cgp9KShtdWksIHdpbmRvdyk7Ci8qKgogKiA1KyBhamF4CiAqLwooZnVuY3Rpb24oJCkgewoJdmFyIG9yaWdpbkFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKCW9yaWdpbkFuY2hvci5ocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CgkkLnBsdXNSZWFkeShmdW5jdGlvbigpIHsKCQkkLmFqYXhTZXR0aW5ncyA9ICQuZXh0ZW5kKCQuYWpheFNldHRpbmdzLCB7CgkJCXhocjogZnVuY3Rpb24oc2V0dGluZ3MpIHsKCQkJCWlmIChzZXR0aW5ncy5jcm9zc0RvbWFpbikgeyAvL+W8uuWItuS9v+eUqHBsdXPot6jln58KCQkJCQlyZXR1cm4gbmV3IHBsdXMubmV0LlhNTEh0dHBSZXF1ZXN0KCk7CgkJCQl9CgkJCQkvL+S7heWcqHdlYnZpZXfnmoR1cmzkuLrov5znqIvmlofku7bvvIzkuJRhamF46K+35rGC55qE6LWE5rqQ5LiN5ZCM5rqQ5LiL5L2/55SocGx1cy5uZXQuWE1MSHR0cFJlcXVlc3QKCQkJCWlmIChvcmlnaW5BbmNob3IucHJvdG9jb2wgIT09ICdmaWxlOicpIHsKCQkJCQl2YXIgdXJsQW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwoJCQkJCXVybEFuY2hvci5ocmVmID0gc2V0dGluZ3MudXJsOwoJCQkJCXVybEFuY2hvci5ocmVmID0gdXJsQW5jaG9yLmhyZWY7CgkJCQkJc2V0dGluZ3MuY3Jvc3NEb21haW4gPSAob3JpZ2luQW5jaG9yLnByb3RvY29sICsgJy8vJyArIG9yaWdpbkFuY2hvci5ob3N0KSAhPT0gKHVybEFuY2hvci5wcm90b2NvbCArICcvLycgKyB1cmxBbmNob3IuaG9zdCk7CgkJCQkJaWYgKHNldHRpbmdzLmNyb3NzRG9tYWluKSB7CgkJCQkJCXJldHVybiBuZXcgcGx1cy5uZXQuWE1MSHR0cFJlcXVlc3QoKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoJC5vcy5pb3MgJiYgd2luZG93LndlYmtpdCAmJiB3aW5kb3cud2Via2l0Lm1lc3NhZ2VIYW5kbGVycykgeyAvL3drd2Vidmlld+S4i+WQjOagt+S9v+eUqDUrIHhocgogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgcGx1cy5uZXQuWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgICAgIH0KCQkJCXJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7CgkJCX0KCQl9KTsKCX0pOwp9KShtdWkpOwovKioKICogbXVpIGxheW91dChvZmZzZXRbLHBvc2l0aW9uLHdpZHRoLGhlaWdodC4uLl0pCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcGFyYW0ge3R5cGV9IHdpbmRvdwogKiBAcGFyYW0ge3R5cGV9IHVuZGVmaW5lZAogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQsIHdpbmRvdywgdW5kZWZpbmVkKSB7CgkkLm9mZnNldCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCQl2YXIgYm94ID0gewoJCQl0b3AgOiAwLAoJCQlsZWZ0IDogMAoJCX07CgkJaWYgKCB0eXBlb2YgZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QgIT09IHVuZGVmaW5lZCkgewoJCQlib3ggPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoJCX0KCQlyZXR1cm4gewoJCQl0b3AgOiBib3gudG9wICsgd2luZG93LnBhZ2VZT2Zmc2V0IC0gZWxlbWVudC5jbGllbnRUb3AsCgkJCWxlZnQgOiBib3gubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldCAtIGVsZW1lbnQuY2xpZW50TGVmdAoJCX07Cgl9Owp9KShtdWksIHdpbmRvdyk7IAovKioKICogbXVpIGFuaW1hdGlvbgogKi8KKGZ1bmN0aW9uKCQsIHdpbmRvdykgewoJLyoqCgkgKiBzY3JvbGxUbwoJICovCgkkLnNjcm9sbFRvID0gZnVuY3Rpb24oc2Nyb2xsVG9wLCBkdXJhdGlvbiwgY2FsbGJhY2spIHsKCQlkdXJhdGlvbiA9IGR1cmF0aW9uIHx8IDEwMDA7CgkJdmFyIHNjcm9sbCA9IGZ1bmN0aW9uKGR1cmF0aW9uKSB7CgkJCWlmIChkdXJhdGlvbiA8PSAwKSB7CgkJCQl3aW5kb3cuc2Nyb2xsVG8oMCwgc2Nyb2xsVG9wKTsKCQkJCWNhbGxiYWNrICYmIGNhbGxiYWNrKCk7CgkJCQlyZXR1cm47CgkJCX0KCQkJdmFyIGRpc3RhaW5jZSA9IHNjcm9sbFRvcCAtIHdpbmRvdy5zY3JvbGxZOwoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKDAsIHdpbmRvdy5zY3JvbGxZICsgZGlzdGFpbmNlIC8gZHVyYXRpb24gKiAxMCk7CgkJCQlzY3JvbGwoZHVyYXRpb24gLSAxMCk7CgkJCX0sIDE2LjcpOwoJCX07CgkJc2Nyb2xsKGR1cmF0aW9uKTsKCX07CgkkLmFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oY2IpIHsKCQl2YXIgYXJncywgaXNRdWV1ZWQsIGNvbnRleHQ7CgkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQlhcmdzID0gYXJndW1lbnRzOwoJCQljb250ZXh0ID0gdGhpczsKCQkJaWYgKCFpc1F1ZXVlZCkgewoJCQkJaXNRdWV1ZWQgPSB0cnVlOwoJCQkJcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewoJCQkJCWNiLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwoJCQkJCWlzUXVldWVkID0gZmFsc2U7CgkJCQl9KTsKCQkJfQoJCX07Cgl9OwoKfSkobXVpLCB3aW5kb3cpOwooZnVuY3Rpb24oJCkgewoJdmFyIGluaXRpYWxpemluZyA9IGZhbHNlLAoJCWZuVGVzdCA9IC94eXovLnRlc3QoZnVuY3Rpb24oKSB7CgkJCXh5ejsKCQl9KSA/IC9cYl9zdXBlclxiLyA6IC8uKi87CgoJdmFyIENsYXNzID0gZnVuY3Rpb24oKSB7fTsKCUNsYXNzLmV4dGVuZCA9IGZ1bmN0aW9uKHByb3ApIHsKCQl2YXIgX3N1cGVyID0gdGhpcy5wcm90b3R5cGU7CgkJaW5pdGlhbGl6aW5nID0gdHJ1ZTsKCQl2YXIgcHJvdG90eXBlID0gbmV3IHRoaXMoKTsKCQlpbml0aWFsaXppbmcgPSBmYWxzZTsKCQlmb3IgKHZhciBuYW1lIGluIHByb3ApIHsKCQkJcHJvdG90eXBlW25hbWVdID0gdHlwZW9mIHByb3BbbmFtZV0gPT0gImZ1bmN0aW9uIiAmJgoJCQkJdHlwZW9mIF9zdXBlcltuYW1lXSA9PSAiZnVuY3Rpb24iICYmIGZuVGVzdC50ZXN0KHByb3BbbmFtZV0pID8KCQkJCShmdW5jdGlvbihuYW1lLCBmbikgewoJCQkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIHRtcCA9IHRoaXMuX3N1cGVyOwoKCQkJCQkJdGhpcy5fc3VwZXIgPSBfc3VwZXJbbmFtZV07CgoJCQkJCQl2YXIgcmV0ID0gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkJCQkJdGhpcy5fc3VwZXIgPSB0bXA7CgoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX07CgkJCQl9KShuYW1lLCBwcm9wW25hbWVdKSA6CgkJCQlwcm9wW25hbWVdOwoJCX0KCQlmdW5jdGlvbiBDbGFzcygpIHsKCQkJaWYgKCFpbml0aWFsaXppbmcgJiYgdGhpcy5pbml0KQoJCQkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJfQoJCUNsYXNzLnByb3RvdHlwZSA9IHByb3RvdHlwZTsKCQlDbGFzcy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDbGFzczsKCQlDbGFzcy5leHRlbmQgPSBhcmd1bWVudHMuY2FsbGVlOwoJCXJldHVybiBDbGFzczsKCX07CgkkLkNsYXNzID0gQ2xhc3M7Cn0pKG11aSk7CihmdW5jdGlvbigkLCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7CiAgICB2YXIgQ0xBU1NfUFVMTF9UT1BfUE9DS0VUID0gJ211aS1wdWxsLXRvcC1wb2NrZXQnOwogICAgdmFyIENMQVNTX1BVTExfQk9UVE9NX1BPQ0tFVCA9ICdtdWktcHVsbC1ib3R0b20tcG9ja2V0JzsKICAgIHZhciBDTEFTU19QVUxMID0gJ211aS1wdWxsJzsKICAgIHZhciBDTEFTU19QVUxMX0xPQURJTkcgPSAnbXVpLXB1bGwtbG9hZGluZyc7CiAgICB2YXIgQ0xBU1NfUFVMTF9DQVBUSU9OID0gJ211aS1wdWxsLWNhcHRpb24nOwogICAgdmFyIENMQVNTX1BVTExfQ0FQVElPTl9ET1dOID0gJ211aS1wdWxsLWNhcHRpb24tZG93bic7CiAgICB2YXIgQ0xBU1NfUFVMTF9DQVBUSU9OX1JFRlJFU0ggPSAnbXVpLXB1bGwtY2FwdGlvbi1yZWZyZXNoJzsKICAgIHZhciBDTEFTU19QVUxMX0NBUFRJT05fTk9NT1JFID0gJ211aS1wdWxsLWNhcHRpb24tbm9tb3JlJzsKCiAgICB2YXIgQ0xBU1NfSUNPTiA9ICdtdWktaWNvbic7CiAgICB2YXIgQ0xBU1NfU1BJTk5FUiA9ICdtdWktc3Bpbm5lcic7CiAgICB2YXIgQ0xBU1NfSUNPTl9QVUxMRE9XTiA9ICdtdWktaWNvbi1wdWxsZG93bic7CgogICAgdmFyIENMQVNTX0JMT0NLID0gJ211aS1ibG9jayc7CiAgICB2YXIgQ0xBU1NfSElEREVOID0gJ211aS1oaWRkZW4nOwogICAgdmFyIENMQVNTX1ZJU0lCSUxJVFkgPSAnbXVpLXZpc2liaWxpdHknOwoKICAgIHZhciBDTEFTU19MT0FESU5HX1VQID0gQ0xBU1NfUFVMTF9MT0FESU5HICsgJyAnICsgQ0xBU1NfSUNPTiArICcgJyArIENMQVNTX0lDT05fUFVMTERPV047CiAgICB2YXIgQ0xBU1NfTE9BRElOR19ET1dOID0gQ0xBU1NfUFVMTF9MT0FESU5HICsgJyAnICsgQ0xBU1NfSUNPTiArICcgJyArIENMQVNTX0lDT05fUFVMTERPV047CiAgICB2YXIgQ0xBU1NfTE9BRElORyA9IENMQVNTX1BVTExfTE9BRElORyArICcgJyArIENMQVNTX0lDT04gKyAnICcgKyBDTEFTU19TUElOTkVSOwoKICAgIHZhciBwb2NrZXRIdG1sID0gWyc8ZGl2IGNsYXNzPSInICsgQ0xBU1NfUFVMTCArICciPicsICc8ZGl2IGNsYXNzPSJ7aWNvbn0iPjwvZGl2PicsICc8ZGl2IGNsYXNzPSInICsgQ0xBU1NfUFVMTF9DQVBUSU9OICsgJyI+e2NvbnRlbnRyZWZyZXNofTwvZGl2PicsICc8L2Rpdj4nXS5qb2luKCcnKTsKCiAgICB2YXIgUHVsbFJlZnJlc2ggPSB7CiAgICAgICAgaW5pdDogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogICAgICAgICAgICB0aGlzLl9zdXBlcihlbGVtZW50LCAkLmV4dGVuZCh0cnVlLCB7CiAgICAgICAgICAgICAgICBzY3JvbGxZOiB0cnVlLAogICAgICAgICAgICAgICAgc2Nyb2xsWDogZmFsc2UsCiAgICAgICAgICAgICAgICBpbmRpY2F0b3JzOiB0cnVlLAogICAgICAgICAgICAgICAgZGVjZWxlcmF0aW9uOiAwLjAwMywKICAgICAgICAgICAgICAgIGRvd246IHsKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDUwLAogICAgICAgICAgICAgICAgICAgIGNvbnRlbnRpbml0OiAn5LiL5ouJ5Y+v5Lul5Yi35pawJywKICAgICAgICAgICAgICAgICAgICBjb250ZW50ZG93bjogJ+S4i+aLieWPr+S7peWIt+aWsCcsCiAgICAgICAgICAgICAgICAgICAgY29udGVudG92ZXI6ICfph4rmlL7nq4vljbPliLfmlrAnLAogICAgICAgICAgICAgICAgICAgIGNvbnRlbnRyZWZyZXNoOiAn5q2j5Zyo5Yi35pawLi4uJwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHVwOiB7CiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiA1MCwKICAgICAgICAgICAgICAgICAgICBhdXRvOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjb250ZW50aW5pdDogJ+S4iuaLieaYvuekuuabtOWkmicsCiAgICAgICAgICAgICAgICAgICAgY29udGVudGRvd246ICfkuIrmi4nmmL7npLrmm7TlpJonLAogICAgICAgICAgICAgICAgICAgIGNvbnRlbnRyZWZyZXNoOiAn5q2j5Zyo5Yqg6L29Li4uJywKICAgICAgICAgICAgICAgICAgICBjb250ZW50bm9tb3JlOiAn5rKh5pyJ5pu05aSa5pWw5o2u5LqGJywKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMzAwCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIG9wdGlvbnMpKTsKICAgICAgICB9LAogICAgICAgIF9pbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5fc3VwZXIoKTsKICAgICAgICAgICAgdGhpcy5faW5pdFBvY2tldCgpOwogICAgICAgIH0sCiAgICAgICAgX2luaXRQdWxsZG93blJlZnJlc2g6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnB1bGxkb3duID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMudG9wUG9ja2V0KSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1bGxQb2NrZXQgPSB0aGlzLnRvcFBvY2tldDsKICAgICAgICAgICAgICAgIHRoaXMucHVsbFBvY2tldC5jbGFzc0xpc3QuYWRkKENMQVNTX0JMT0NLKTsKICAgICAgICAgICAgICAgIHRoaXMucHVsbFBvY2tldC5jbGFzc0xpc3QuYWRkKENMQVNTX1ZJU0lCSUxJVFkpOwogICAgICAgICAgICAgICAgdGhpcy5wdWxsQ2FwdGlvbiA9IHRoaXMudG9wQ2FwdGlvbjsKICAgICAgICAgICAgICAgIHRoaXMucHVsbExvYWRpbmcgPSB0aGlzLnRvcExvYWRpbmc7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIF9pbml0UHVsbHVwUmVmcmVzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMucHVsbGRvd24gPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMuYm90dG9tUG9ja2V0KSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1bGxQb2NrZXQgPSB0aGlzLmJvdHRvbVBvY2tldDsKICAgICAgICAgICAgICAgIHRoaXMucHVsbFBvY2tldC5jbGFzc0xpc3QuYWRkKENMQVNTX0JMT0NLKTsKICAgICAgICAgICAgICAgIHRoaXMucHVsbFBvY2tldC5jbGFzc0xpc3QuYWRkKENMQVNTX1ZJU0lCSUxJVFkpOwogICAgICAgICAgICAgICAgdGhpcy5wdWxsQ2FwdGlvbiA9IHRoaXMuYm90dG9tQ2FwdGlvbjsKICAgICAgICAgICAgICAgIHRoaXMucHVsbExvYWRpbmcgPSB0aGlzLmJvdHRvbUxvYWRpbmc7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIF9pbml0UG9ja2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmRvd24gJiYgb3B0aW9ucy5kb3duLmhhc093blByb3BlcnR5KCdjYWxsYmFjaycpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRvcFBvY2tldCA9IHRoaXMuc2Nyb2xsZXIucXVlcnlTZWxlY3RvcignLicgKyBDTEFTU19QVUxMX1RPUF9QT0NLRVQpOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnRvcFBvY2tldCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudG9wUG9ja2V0ID0gdGhpcy5fY3JlYXRlUG9ja2V0KENMQVNTX1BVTExfVE9QX1BPQ0tFVCwgb3B0aW9ucy5kb3duLCBDTEFTU19MT0FESU5HX0RPV04pOwogICAgICAgICAgICAgICAgICAgIHRoaXMud3JhcHBlci5pbnNlcnRCZWZvcmUodGhpcy50b3BQb2NrZXQsIHRoaXMud3JhcHBlci5maXJzdENoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMudG9wTG9hZGluZyA9IHRoaXMudG9wUG9ja2V0LnF1ZXJ5U2VsZWN0b3IoJy4nICsgQ0xBU1NfUFVMTF9MT0FESU5HKTsKICAgICAgICAgICAgICAgIHRoaXMudG9wQ2FwdGlvbiA9IHRoaXMudG9wUG9ja2V0LnF1ZXJ5U2VsZWN0b3IoJy4nICsgQ0xBU1NfUFVMTF9DQVBUSU9OKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy51cCAmJiBvcHRpb25zLnVwLmhhc093blByb3BlcnR5KCdjYWxsYmFjaycpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJvdHRvbVBvY2tldCA9IHRoaXMuc2Nyb2xsZXIucXVlcnlTZWxlY3RvcignLicgKyBDTEFTU19QVUxMX0JPVFRPTV9QT0NLRVQpOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmJvdHRvbVBvY2tldCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYm90dG9tUG9ja2V0ID0gdGhpcy5fY3JlYXRlUG9ja2V0KENMQVNTX1BVTExfQk9UVE9NX1BPQ0tFVCwgb3B0aW9ucy51cCwgQ0xBU1NfTE9BRElORyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxlci5hcHBlbmRDaGlsZCh0aGlzLmJvdHRvbVBvY2tldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmJvdHRvbUxvYWRpbmcgPSB0aGlzLmJvdHRvbVBvY2tldC5xdWVyeVNlbGVjdG9yKCcuJyArIENMQVNTX1BVTExfTE9BRElORyk7CiAgICAgICAgICAgICAgICB0aGlzLmJvdHRvbUNhcHRpb24gPSB0aGlzLmJvdHRvbVBvY2tldC5xdWVyeVNlbGVjdG9yKCcuJyArIENMQVNTX1BVTExfQ0FQVElPTik7CiAgICAgICAgICAgICAgICAvL1RPRE8gb25seSBmb3IgaDUKICAgICAgICAgICAgICAgIHRoaXMud3JhcHBlci5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGxib3R0b20nLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgX2NyZWF0ZVBvY2tldDogZnVuY3Rpb24oY2xhenosIG9wdGlvbnMsIGljb25DbGFzcykgewogICAgICAgICAgICB2YXIgcG9ja2V0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHBvY2tldC5jbGFzc05hbWUgPSBjbGF6ejsKICAgICAgICAgICAgcG9ja2V0LmlubmVySFRNTCA9IHBvY2tldEh0bWwucmVwbGFjZSgne2NvbnRlbnRyZWZyZXNofScsIG9wdGlvbnMuY29udGVudGluaXQpLnJlcGxhY2UoJ3tpY29ufScsIGljb25DbGFzcyk7CiAgICAgICAgICAgIHJldHVybiBwb2NrZXQ7CiAgICAgICAgfSwKICAgICAgICBfcmVzZXRQdWxsRG93bkxvYWRpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbG9hZGluZyA9IHRoaXMucHVsbExvYWRpbmc7CiAgICAgICAgICAgIGlmIChsb2FkaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1bGxDYXB0aW9uLmlubmVySFRNTCA9IHRoaXMub3B0aW9ucy5kb3duLmNvbnRlbnRkb3duOwogICAgICAgICAgICAgICAgbG9hZGluZy5zdHlsZS53ZWJraXRUcmFuc2l0aW9uID0gIiI7CiAgICAgICAgICAgICAgICBsb2FkaW5nLnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICIiOwogICAgICAgICAgICAgICAgbG9hZGluZy5zdHlsZS53ZWJraXRBbmltYXRpb24gPSAiIjsKICAgICAgICAgICAgICAgIGxvYWRpbmcuY2xhc3NOYW1lID0gQ0xBU1NfTE9BRElOR19ET1dOOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBfc2V0Q2FwdGlvbkNsYXNzOiBmdW5jdGlvbihpc1B1bGxkb3duLCBjYXB0aW9uLCB0aXRsZSkgewogICAgICAgICAgICBpZiAoIWlzUHVsbGRvd24pIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAodGl0bGUpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIHRoaXMub3B0aW9ucy51cC5jb250ZW50ZG93bjoKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGlvbi5jbGFzc05hbWUgPSBDTEFTU19QVUxMX0NBUFRJT04gKyAnICcgKyBDTEFTU19QVUxMX0NBUFRJT05fRE9XTjsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSB0aGlzLm9wdGlvbnMudXAuY29udGVudHJlZnJlc2g6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb24uY2xhc3NOYW1lID0gQ0xBU1NfUFVMTF9DQVBUSU9OICsgJyAnICsgQ0xBU1NfUFVMTF9DQVBUSU9OX1JFRlJFU0gKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSB0aGlzLm9wdGlvbnMudXAuY29udGVudG5vbW9yZToKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGlvbi5jbGFzc05hbWUgPSBDTEFTU19QVUxMX0NBUFRJT04gKyAnICcgKyBDTEFTU19QVUxMX0NBUFRJT05fTk9NT1JFOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgX3NldENhcHRpb246IGZ1bmN0aW9uKHRpdGxlLCByZXNldCkgewogICAgICAgICAgICBpZiAodGhpcy5sb2FkaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgICAgICAgIHZhciBwb2NrZXQgPSB0aGlzLnB1bGxQb2NrZXQ7CiAgICAgICAgICAgIHZhciBjYXB0aW9uID0gdGhpcy5wdWxsQ2FwdGlvbjsKICAgICAgICAgICAgdmFyIGxvYWRpbmcgPSB0aGlzLnB1bGxMb2FkaW5nOwogICAgICAgICAgICB2YXIgaXNQdWxsZG93biA9IHRoaXMucHVsbGRvd247CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgaWYgKHBvY2tldCkgewogICAgICAgICAgICAgICAgaWYgKHJlc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGlvbi5pbm5lckhUTUwgPSBzZWxmLmxhc3RUaXRsZSA9IHRpdGxlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNQdWxsZG93bikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGluZy5jbGFzc05hbWUgPSBDTEFTU19MT0FESU5HX0RPV047CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRDYXB0aW9uQ2xhc3MoZmFsc2UsIGNhcHRpb24sIHRpdGxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcuY2xhc3NOYW1lID0gQ0xBU1NfTE9BRElORzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nLnN0eWxlLndlYmtpdEFuaW1hdGlvbiA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nLnN0eWxlLndlYmtpdFRyYW5zaXRpb24gPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGluZy5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSAiIjsKICAgICAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGl0bGUgIT09IHRoaXMubGFzdFRpdGxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb24uaW5uZXJIVE1MID0gdGl0bGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1B1bGxkb3duKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGl0bGUgPT09IG9wdGlvbnMuZG93bi5jb250ZW50cmVmcmVzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcuY2xhc3NOYW1lID0gQ0xBU1NfTE9BRElORzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nLnN0eWxlLndlYmtpdEFuaW1hdGlvbiA9ICJzcGlubmVyLXNwaW4gMXMgc3RlcC1lbmQgaW5maW5pdGUiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aXRsZSA9PT0gb3B0aW9ucy5kb3duLmNvbnRlbnRvdmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGluZy5jbGFzc05hbWUgPSBDTEFTU19MT0FESU5HX1VQOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcuc3R5bGUud2Via2l0VHJhbnNpdGlvbiA9ICItd2Via2l0LXRyYW5zZm9ybSAwLjNzIGVhc2UtaW4iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gInJvdGF0ZSgxODBkZWcpIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGl0bGUgPT09IG9wdGlvbnMuZG93bi5jb250ZW50ZG93bikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcuY2xhc3NOYW1lID0gQ0xBU1NfTE9BRElOR19ET1dOOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcuc3R5bGUud2Via2l0VHJhbnNpdGlvbiA9ICItd2Via2l0LXRyYW5zZm9ybSAwLjNzIGVhc2UtaW4iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gInJvdGF0ZSgwZGVnKSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGl0bGUgPT09IG9wdGlvbnMudXAuY29udGVudHJlZnJlc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nLmNsYXNzTmFtZSA9IENMQVNTX0xPQURJTkcgKyAnICcgKyBDTEFTU19WSVNJQklMSVRZOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nLmNsYXNzTmFtZSA9IENMQVNTX0xPQURJTkcgKyAnICcgKyBDTEFTU19ISURERU47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRDYXB0aW9uQ2xhc3MoZmFsc2UsIGNhcHRpb24sIHRpdGxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RUaXRsZSA9IHRpdGxlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgJC5QdWxsUmVmcmVzaCA9IFB1bGxSZWZyZXNoOwp9KShtdWksIGRvY3VtZW50KTsKKGZ1bmN0aW9uKCQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgewoJdmFyIENMQVNTX1NDUk9MTCA9ICdtdWktc2Nyb2xsJzsKCXZhciBDTEFTU19TQ1JPTExCQVIgPSAnbXVpLXNjcm9sbGJhcic7Cgl2YXIgQ0xBU1NfSU5ESUNBVE9SID0gJ211aS1zY3JvbGxiYXItaW5kaWNhdG9yJzsKCXZhciBDTEFTU19TQ1JPTExCQVJfVkVSVElDQUwgPSBDTEFTU19TQ1JPTExCQVIgKyAnLXZlcnRpY2FsJzsKCXZhciBDTEFTU19TQ1JPTExCQVJfSE9SSVpPTlRBTCA9IENMQVNTX1NDUk9MTEJBUiArICctaG9yaXpvbnRhbCc7CgoJdmFyIENMQVNTX0FDVElWRSA9ICdtdWktYWN0aXZlJzsKCgl2YXIgZWFzZSA9IHsKCQlxdWFkcmF0aWM6IHsKCQkJc3R5bGU6ICdjdWJpYy1iZXppZXIoMC4yNSwgMC40NiwgMC40NSwgMC45NCknLAoJCQlmbjogZnVuY3Rpb24oaykgewoJCQkJcmV0dXJuIGsgKiAoMiAtIGspOwoJCQl9CgkJfSwKCQljaXJjdWxhcjogewoJCQlzdHlsZTogJ2N1YmljLWJlemllcigwLjEsIDAuNTcsIDAuMSwgMSknLAoJCQlmbjogZnVuY3Rpb24oaykgewoJCQkJcmV0dXJuIE1hdGguc3FydCgxIC0gKC0tayAqIGspKTsKCQkJfQoJCX0sCgkJb3V0Q2lyYzogewoJCQlzdHlsZTogJ2N1YmljLWJlemllcigwLjA3NSwgMC44MiwgMC4xNjUsIDEpJwoJCX0sCgkJb3V0Q3ViaWM6IHsKCQkJc3R5bGU6ICdjdWJpYy1iZXppZXIoMC4xNjUsIDAuODQsIDAuNDQsIDEpJwoJCX0KCX0KCXZhciBTY3JvbGwgPSAkLkNsYXNzLmV4dGVuZCh7CgkJaW5pdDogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewoJCQl0aGlzLndyYXBwZXIgPSB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwoJCQl0aGlzLnNjcm9sbGVyID0gdGhpcy53cmFwcGVyLmNoaWxkcmVuWzBdOwoJCQl0aGlzLnNjcm9sbGVyU3R5bGUgPSB0aGlzLnNjcm9sbGVyICYmIHRoaXMuc2Nyb2xsZXIuc3R5bGU7CgkJCXRoaXMuc3RvcHBlZCA9IGZhbHNlOwoKCQkJdGhpcy5vcHRpb25zID0gJC5leHRlbmQodHJ1ZSwgewoJCQkJc2Nyb2xsWTogdHJ1ZSwgLy/mmK/lkKbnq5blkJHmu5rliqgKCQkJCXNjcm9sbFg6IGZhbHNlLCAvL+aYr+WQpuaoquWQkea7muWKqAoJCQkJc3RhcnRYOiAwLCAvL+WIneWni+WMluaXtua7muWKqOiHs3gKCQkJCXN0YXJ0WTogMCwgLy/liJ3lp4vljJbml7bmu5rliqjoh7N5CgoJCQkJaW5kaWNhdG9yczogdHJ1ZSwgLy/mmK/lkKbmmL7npLrmu5rliqjmnaEKCQkJCXN0b3BQcm9wYWdhdGlvbjogZmFsc2UsCgkJCQloYXJkd2FyZUFjY2VsZXJhdGVkOiB0cnVlLAoJCQkJZml4ZWRCYWRBbmRvcmlkOiBmYWxzZSwKCQkJCXByZXZlbnREZWZhdWx0RXhjZXB0aW9uOiB7CgkJCQkJdGFnTmFtZTogL14oSU5QVVR8VEVYVEFSRUF8QlVUVE9OfFNFTEVDVHxWSURFTykkLwoJCQkJfSwKCQkJCW1vbWVudHVtOiB0cnVlLAoKCQkJCXNuYXBYOiAwLjUsIC8v5qiq5ZCR5YiH5o2i6Led56a7KOS7peW9k+WJjeWuueWZqOWuveW6puS4uuWfuuWHhikKCQkJCXNuYXA6IGZhbHNlLCAvL+WbvueJh+i9ruaSre+8jOaLluaLveW8j+mAiemhueWNoQoKCQkJCWJvdW5jZTogdHJ1ZSwgLy/mmK/lkKblkK/nlKjlm57lvLkKCQkJCWJvdW5jZVRpbWU6IDUwMCwgLy/lm57lvLnliqjnlLvml7bpl7QKCQkJCWJvdW5jZUVhc2luZzogZWFzZS5vdXRDaXJjLCAvL+WbnuW8ueWKqOeUu+absue6vwoKCQkJCXNjcm9sbFRpbWU6IDUwMCwKCQkJCXNjcm9sbEVhc2luZzogZWFzZS5vdXRDdWJpYywgLy/ova7mkq3liqjnlLvmm7Lnur8KCgkJCQlkaXJlY3Rpb25Mb2NrVGhyZXNob2xkOiA1LAoKCQkJCXBhcmFsbGF4RWxlbWVudDogZmFsc2UsIC8v6KeG5beu5YWD57SgCgkJCQlwYXJhbGxheFJhdGlvOiAwLjUKCQkJfSwgb3B0aW9ucyk7CgoJCQl0aGlzLnggPSAwOwoJCQl0aGlzLnkgPSAwOwoJCQl0aGlzLnRyYW5zbGF0ZVogPSB0aGlzLm9wdGlvbnMuaGFyZHdhcmVBY2NlbGVyYXRlZCA/ICcgdHJhbnNsYXRlWigwKScgOiAnJzsKCgkJCXRoaXMuX2luaXQoKTsKCQkJaWYgKHRoaXMuc2Nyb2xsZXIpIHsKCQkJCXRoaXMucmVmcmVzaCgpOwoJCQkJLy8JCQkJaWYgKHRoaXMub3B0aW9ucy5zdGFydFggIT09IDAgfHwgdGhpcy5vcHRpb25zLnN0YXJ0WSAhPT0gMCkgeyAvL+mcgOimgeWIpOaWreWQl++8n+WQjue7reagueaNruWunumZheaDheWGteWGjeeci+eciwoJCQkJdGhpcy5zY3JvbGxUbyh0aGlzLm9wdGlvbnMuc3RhcnRYLCB0aGlzLm9wdGlvbnMuc3RhcnRZKTsKCQkJCS8vCQkJCX0KCQkJfQoJCX0sCgkJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9pbml0UGFyYWxsYXgoKTsKCQkJdGhpcy5faW5pdEluZGljYXRvcnMoKTsKCQkJdGhpcy5faW5pdEV2ZW50KCk7CgkJfSwKCQlfaW5pdFBhcmFsbGF4OiBmdW5jdGlvbigpIHsKCQkJaWYgKHRoaXMub3B0aW9ucy5wYXJhbGxheEVsZW1lbnQpIHsKCQkJCXRoaXMucGFyYWxsYXhFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0aGlzLm9wdGlvbnMucGFyYWxsYXhFbGVtZW50KTsKCQkJCXRoaXMucGFyYWxsYXhTdHlsZSA9IHRoaXMucGFyYWxsYXhFbGVtZW50LnN0eWxlOwoJCQkJdGhpcy5wYXJhbGxheEhlaWdodCA9IHRoaXMucGFyYWxsYXhFbGVtZW50Lm9mZnNldEhlaWdodDsKCQkJCXRoaXMucGFyYWxsYXhJbWdTdHlsZSA9IHRoaXMucGFyYWxsYXhFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2ltZycpLnN0eWxlOwoJCQl9CgkJfSwKCQlfaW5pdEluZGljYXRvcnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCXNlbGYuaW5kaWNhdG9ycyA9IFtdOwoJCQlpZiAoIXRoaXMub3B0aW9ucy5pbmRpY2F0b3JzKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJdmFyIGluZGljYXRvcnMgPSBbXSwKCQkJCWluZGljYXRvcjsKCgkJCS8vIFZlcnRpY2FsIHNjcm9sbGJhcgoJCQlpZiAoc2VsZi5vcHRpb25zLnNjcm9sbFkpIHsKCQkJCWluZGljYXRvciA9IHsKCQkJCQllbDogdGhpcy5fY3JlYXRlU2Nyb2xsQmFyKENMQVNTX1NDUk9MTEJBUl9WRVJUSUNBTCksCgkJCQkJbGlzdGVuWDogZmFsc2UKCQkJCX07CgoJCQkJdGhpcy53cmFwcGVyLmFwcGVuZENoaWxkKGluZGljYXRvci5lbCk7CgkJCQlpbmRpY2F0b3JzLnB1c2goaW5kaWNhdG9yKTsKCQkJfQoKCQkJLy8gSG9yaXpvbnRhbCBzY3JvbGxiYXIKCQkJaWYgKHRoaXMub3B0aW9ucy5zY3JvbGxYKSB7CgkJCQlpbmRpY2F0b3IgPSB7CgkJCQkJZWw6IHRoaXMuX2NyZWF0ZVNjcm9sbEJhcihDTEFTU19TQ1JPTExCQVJfSE9SSVpPTlRBTCksCgkJCQkJbGlzdGVuWTogZmFsc2UKCQkJCX07CgoJCQkJdGhpcy53cmFwcGVyLmFwcGVuZENoaWxkKGluZGljYXRvci5lbCk7CgkJCQlpbmRpY2F0b3JzLnB1c2goaW5kaWNhdG9yKTsKCQkJfQoKCQkJZm9yICh2YXIgaSA9IGluZGljYXRvcnMubGVuZ3RoOyBpLS07KSB7CgkJCQl0aGlzLmluZGljYXRvcnMucHVzaChuZXcgSW5kaWNhdG9yKHRoaXMsIGluZGljYXRvcnNbaV0pKTsKCQkJfQoKCQl9LAoJCV9pbml0U25hcDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuY3VycmVudFBhZ2UgPSB7fTsKCQkJdGhpcy5wYWdlcyA9IFtdOwoJCQl2YXIgc25hcHMgPSB0aGlzLnNuYXBzOwoJCQl2YXIgbGVuZ3RoID0gc25hcHMubGVuZ3RoOwoJCQl2YXIgbSA9IDA7CgkJCXZhciBuID0gLTE7CgkJCXZhciB4ID0gMDsKCQkJdmFyIGxlZnRYID0gMDsKCQkJdmFyIHJpZ2h0WCA9IDA7CgkJCXZhciBzbmFwWCA9IDA7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCQkJCXZhciBzbmFwID0gc25hcHNbaV07CgkJCQl2YXIgb2Zmc2V0TGVmdCA9IHNuYXAub2Zmc2V0TGVmdDsKCQkJCXZhciBvZmZzZXRXaWR0aCA9IHNuYXAub2Zmc2V0V2lkdGg7CgkJCQlpZiAoaSA9PT0gMCB8fCBvZmZzZXRMZWZ0IDw9IHNuYXBzW2kgLSAxXS5vZmZzZXRMZWZ0KSB7CgkJCQkJbSA9IDA7CgkJCQkJbisrOwoJCQkJfQoJCQkJaWYgKCF0aGlzLnBhZ2VzW21dKSB7CgkJCQkJdGhpcy5wYWdlc1ttXSA9IFtdOwoJCQkJfQoJCQkJeCA9IHRoaXMuX2dldFNuYXBYKG9mZnNldExlZnQpOwoJCQkJc25hcFggPSBNYXRoLnJvdW5kKChvZmZzZXRXaWR0aCkgKiB0aGlzLm9wdGlvbnMuc25hcFgpOwoJCQkJbGVmdFggPSB4IC0gc25hcFg7CgkJCQlyaWdodFggPSB4IC0gb2Zmc2V0V2lkdGggKyBzbmFwWDsKCQkJCXRoaXMucGFnZXNbbV1bbl0gPSB7CgkJCQkJeDogeCwKCQkJCQlsZWZ0WDogbGVmdFgsCgkJCQkJcmlnaHRYOiByaWdodFgsCgkJCQkJcGFnZVg6IG0sCgkJCQkJZWxlbWVudDogc25hcAoJCQkJfQoJCQkJaWYgKHNuYXAuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkpIHsKCQkJCQl0aGlzLmN1cnJlbnRQYWdlID0gdGhpcy5wYWdlc1ttXVswXTsKCQkJCX0KCQkJCWlmICh4ID49IHRoaXMubWF4U2Nyb2xsWCkgewoJCQkJCW0rKzsKCQkJCX0KCQkJfQoJCQl0aGlzLm9wdGlvbnMuc3RhcnRYID0gdGhpcy5jdXJyZW50UGFnZS54IHx8IDA7CgkJfSwKCQlfZ2V0U25hcFg6IGZ1bmN0aW9uKG9mZnNldExlZnQpIHsKCQkJcmV0dXJuIE1hdGgubWF4KE1hdGgubWluKDAsIC1vZmZzZXRMZWZ0ICsgKHRoaXMud3JhcHBlcldpZHRoIC8gMikpLCB0aGlzLm1heFNjcm9sbFgpOwoJCX0sCgkJX2dvdG9QYWdlOiBmdW5jdGlvbihpbmRleCkgewoJCQl0aGlzLmN1cnJlbnRQYWdlID0gdGhpcy5wYWdlc1tNYXRoLm1pbihpbmRleCwgdGhpcy5wYWdlcy5sZW5ndGggLSAxKV1bMF07CgkJCWZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLnNuYXBzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CgkJCQlpZiAoaSA9PT0gaW5kZXgpIHsKCQkJCQl0aGlzLnNuYXBzW2ldLmNsYXNzTGlzdC5hZGQoQ0xBU1NfQUNUSVZFKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5zbmFwc1tpXS5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0FDVElWRSk7CgkJCQl9CgkJCX0KCQkJdGhpcy5zY3JvbGxUbyh0aGlzLmN1cnJlbnRQYWdlLngsIDAsIHRoaXMub3B0aW9ucy5zY3JvbGxUaW1lKTsKCQl9LAoJCV9uZWFyZXN0U25hcDogZnVuY3Rpb24oeCkgewoJCQlpZiAoIXRoaXMucGFnZXMubGVuZ3RoKSB7CgkJCQlyZXR1cm4gewoJCQkJCXg6IDAsCgkJCQkJcGFnZVg6IDAKCQkJCX07CgkJCX0KCQkJdmFyIGkgPSAwOwoJCQl2YXIgbGVuZ3RoID0gdGhpcy5wYWdlcy5sZW5ndGg7CgkJCWlmICh4ID4gMCkgewoJCQkJeCA9IDA7CgkJCX0gZWxzZSBpZiAoeCA8IHRoaXMubWF4U2Nyb2xsWCkgewoJCQkJeCA9IHRoaXMubWF4U2Nyb2xsWDsKCQkJfQoJCQlmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJCQl2YXIgbmVhcmVzdFggPSB0aGlzLmRpcmVjdGlvbiA9PT0gJ2xlZnQnID8gdGhpcy5wYWdlc1tpXVswXS5sZWZ0WCA6IHRoaXMucGFnZXNbaV1bMF0ucmlnaHRYOwoJCQkJaWYgKHggPj0gbmVhcmVzdFgpIHsKCQkJCQlyZXR1cm4gdGhpcy5wYWdlc1tpXVswXTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gewoJCQkJeDogMCwKCQkJCXBhZ2VYOiAwCgkJCX07CgkJfSwKCQlfaW5pdEV2ZW50OiBmdW5jdGlvbihkZXRhY2gpIHsKCQkJdmFyIGFjdGlvbiA9IGRldGFjaCA/ICdyZW1vdmVFdmVudExpc3RlbmVyJyA6ICdhZGRFdmVudExpc3RlbmVyJzsKCQkJd2luZG93W2FjdGlvbl0oJ29yaWVudGF0aW9uY2hhbmdlJywgdGhpcyk7CgkJCXdpbmRvd1thY3Rpb25dKCdyZXNpemUnLCB0aGlzKTsKCgkJCXRoaXMuc2Nyb2xsZXJbYWN0aW9uXSgnd2Via2l0VHJhbnNpdGlvbkVuZCcsIHRoaXMpOwoKCQkJdGhpcy53cmFwcGVyW2FjdGlvbl0oJC5FVkVOVF9TVEFSVCwgdGhpcyk7CgkJCXRoaXMud3JhcHBlclthY3Rpb25dKCQuRVZFTlRfQ0FOQ0VMLCB0aGlzKTsKCQkJdGhpcy53cmFwcGVyW2FjdGlvbl0oJC5FVkVOVF9FTkQsIHRoaXMpOwoJCQl0aGlzLndyYXBwZXJbYWN0aW9uXSgnZHJhZycsIHRoaXMpOwoJCQl0aGlzLndyYXBwZXJbYWN0aW9uXSgnZHJhZ2VuZCcsIHRoaXMpOwoJCQl0aGlzLndyYXBwZXJbYWN0aW9uXSgnZmxpY2snLCB0aGlzKTsKCQkJdGhpcy53cmFwcGVyW2FjdGlvbl0oJ3Njcm9sbGVuZCcsIHRoaXMpOwoJCQlpZiAodGhpcy5vcHRpb25zLnNjcm9sbFgpIHsKCQkJCXRoaXMud3JhcHBlclthY3Rpb25dKCdzd2lwZXJpZ2h0JywgdGhpcyk7CgkJCX0KCQkJdmFyIHNlZ21lbnRlZENvbnRyb2wgPSB0aGlzLndyYXBwZXIucXVlcnlTZWxlY3RvcignLm11aS1zZWdtZW50ZWQtY29udHJvbCcpOwoJCQlpZiAoc2VnbWVudGVkQ29udHJvbCkgeyAvL+mdoO+8jOi/meS4qmJ1Z+aOkuafpeS6huS4gOS4i+WNiO+8jOmYu+atomhhc2jot7PovazvvIzkuIDml6ZoYXNo6Lez6L2s5Lya5a+86Ie05Y+v5ouW5ou96YCJ6aG55Y2h55qEdGFi5LiN6KeBCgkJCQltdWkoc2VnbWVudGVkQ29udHJvbClbZGV0YWNoID8gJ29mZicgOiAnb24nXSgnY2xpY2snLCAnYScsICQucHJldmVudERlZmF1bHQpOwoJCQl9CgoJCQl0aGlzLndyYXBwZXJbYWN0aW9uXSgnc2Nyb2xsc3RhcnQnLCB0aGlzKTsKCQkJdGhpcy53cmFwcGVyW2FjdGlvbl0oJ3JlZnJlc2gnLCB0aGlzKTsKCQl9LAoJCV9oYW5kbGVJbmRpY2F0b3JTY3JvbGxlbmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmluZGljYXRvcnMubWFwKGZ1bmN0aW9uKGluZGljYXRvcikgewoJCQkJaW5kaWNhdG9yLmZhZGUoKTsKCQkJfSk7CgkJfSwKCQlfaGFuZGxlSW5kaWNhdG9yU2Nyb2xsc3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmluZGljYXRvcnMubWFwKGZ1bmN0aW9uKGluZGljYXRvcikgewoJCQkJaW5kaWNhdG9yLmZhZGUoMSk7CgkJCX0pOwoJCX0sCgkJX2hhbmRsZUluZGljYXRvclJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmluZGljYXRvcnMubWFwKGZ1bmN0aW9uKGluZGljYXRvcikgewoJCQkJaW5kaWNhdG9yLnJlZnJlc2goKTsKCQkJfSk7CgkJfSwKCQloYW5kbGVFdmVudDogZnVuY3Rpb24oZSkgewoJCQlpZiAodGhpcy5zdG9wcGVkKSB7CgkJCQl0aGlzLnJlc2V0UG9zaXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJc3dpdGNoIChlLnR5cGUpIHsKCQkJCWNhc2UgJC5FVkVOVF9TVEFSVDoKCQkJCQl0aGlzLl9zdGFydChlKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgJ2RyYWcnOgoJCQkJCXRoaXMub3B0aW9ucy5zdG9wUHJvcGFnYXRpb24gJiYgZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQl0aGlzLl9kcmFnKGUpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAnZHJhZ2VuZCc6CgkJCQljYXNlICdmbGljayc6CgkJCQkJdGhpcy5vcHRpb25zLnN0b3BQcm9wYWdhdGlvbiAmJiBlLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCXRoaXMuX2ZsaWNrKGUpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAkLkVWRU5UX0NBTkNFTDoKCQkJCWNhc2UgJC5FVkVOVF9FTkQ6CgkJCQkJdGhpcy5fZW5kKGUpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAnd2Via2l0VHJhbnNpdGlvbkVuZCc6CgkJCQkJdGhpcy50cmFuc2l0aW9uVGltZXIgJiYgdGhpcy50cmFuc2l0aW9uVGltZXIuY2FuY2VsKCk7CgkJCQkJdGhpcy5fdHJhbnNpdGlvbkVuZChlKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgJ3Njcm9sbHN0YXJ0JzoKCQkJCQl0aGlzLl9oYW5kbGVJbmRpY2F0b3JTY3JvbGxzdGFydChlKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgJ3Njcm9sbGVuZCc6CgkJCQkJdGhpcy5faGFuZGxlSW5kaWNhdG9yU2Nyb2xsZW5kKGUpOwoJCQkJCXRoaXMuX3Njcm9sbGVuZChlKTsKCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAnb3JpZW50YXRpb25jaGFuZ2UnOgoJCQkJY2FzZSAncmVzaXplJzoKCQkJCQl0aGlzLl9yZXNpemUoKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgJ3N3aXBlcmlnaHQnOgoJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJYnJlYWs7CgkJCQljYXNlICdyZWZyZXNoJzoKCQkJCQl0aGlzLl9oYW5kbGVJbmRpY2F0b3JSZWZyZXNoKGUpOwoJCQkJCWJyZWFrOwoKCQkJfQoJCX0sCgkJX3N0YXJ0OiBmdW5jdGlvbihlKSB7CgkJCXRoaXMubW92ZWQgPSB0aGlzLm5lZWRSZXNldCA9IGZhbHNlOwoJCQl0aGlzLl90cmFuc2l0aW9uVGltZSgpOwoJCQlpZiAodGhpcy5pc0luVHJhbnNpdGlvbikgewoJCQkJdGhpcy5uZWVkUmVzZXQgPSB0cnVlOwoJCQkJdGhpcy5pc0luVHJhbnNpdGlvbiA9IGZhbHNlOwoJCQkJdmFyIHBvcyA9ICQucGFyc2VUcmFuc2xhdGVNYXRyaXgoJC5nZXRTdHlsZXModGhpcy5zY3JvbGxlciwgJ3dlYmtpdFRyYW5zZm9ybScpKTsKCQkJCXRoaXMuc2V0VHJhbnNsYXRlKE1hdGgucm91bmQocG9zLngpLCBNYXRoLnJvdW5kKHBvcy55KSk7CgkJCQkvLwkJCQl0aGlzLnJlc2V0UG9zaXRpb24oKTsgLy9yZXNldAoJCQkJJC50cmlnZ2VyKHRoaXMuc2Nyb2xsZXIsICdzY3JvbGxlbmQnLCB0aGlzKTsKCQkJCS8vCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJdGhpcy5yZUxheW91dCgpOwoJCQkkLnRyaWdnZXIodGhpcy5zY3JvbGxlciwgJ2JlZm9yZXNjcm9sbHN0YXJ0JywgdGhpcyk7CgkJfSwKCQlfZ2V0RGlyZWN0aW9uQnlBbmdsZTogZnVuY3Rpb24oYW5nbGUpIHsKCQkJaWYgKGFuZ2xlIDwgLTgwICYmIGFuZ2xlID4gLTEwMCkgewoJCQkJcmV0dXJuICd1cCc7CgkJCX0gZWxzZSBpZiAoYW5nbGUgPj0gODAgJiYgYW5nbGUgPCAxMDApIHsKCQkJCXJldHVybiAnZG93bic7CgkJCX0gZWxzZSBpZiAoYW5nbGUgPj0gMTcwIHx8IGFuZ2xlIDw9IC0xNzApIHsKCQkJCXJldHVybiAnbGVmdCc7CgkJCX0gZWxzZSBpZiAoYW5nbGUgPj0gLTM1ICYmIGFuZ2xlIDw9IDEwKSB7CgkJCQlyZXR1cm4gJ3JpZ2h0JzsKCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9LAoJCV9kcmFnOiBmdW5jdGlvbihlKSB7CgkJCS8vCQkJaWYgKHRoaXMubmVlZFJlc2V0KSB7CgkJCS8vCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7IC8vZGlzYWJsZSBwYXJlbnQgZHJhZyhuZXN0ZWQgc2Nyb2xsZXIpCgkJCS8vCQkJCXJldHVybjsKCQkJLy8JCQl9CgkJCXZhciBkZXRhaWwgPSBlLmRldGFpbDsKCQkJaWYgKHRoaXMub3B0aW9ucy5zY3JvbGxZIHx8IGRldGFpbC5kaXJlY3Rpb24gPT09ICd1cCcgfHwgZGV0YWlsLmRpcmVjdGlvbiA9PT0gJ2Rvd24nKSB7IC8v5aaC5p6c5piv56uW5ZCR5rua5Yqo5oiW5omL5Yq/5pa55ZCR5piv5LiK5oiW5LiLCgkJCQkvL2lvczggaGFjawoJCQkJaWYgKCQub3MuaW9zICYmIHBhcnNlRmxvYXQoJC5vcy52ZXJzaW9uKSA+PSA4KSB7IC8v5aSad2Vidmlld+aXtu+8jOemu+W8gOW9k+WJjXdlYnZpZXfkvJrlr7zoh7TlkI7nu610b3VjaOS6i+S7tuS4jeinpuWPkQoJCQkJCXZhciBjbGllbnRZID0gZGV0YWlsLmdlc3R1cmUudG91Y2hlc1swXS5jbGllbnRZOwoJCQkJCS8v5LiL5ouJ5Yi35pawIG9yIOS4iuaLieWKoOi9vQoJCQkJCWlmICgoY2xpZW50WSArIDEwKSA+IHdpbmRvdy5pbm5lckhlaWdodCB8fCBjbGllbnRZIDwgMTApIHsKCQkJCQkJdGhpcy5yZXNldFBvc2l0aW9uKHRoaXMub3B0aW9ucy5ib3VuY2VUaW1lKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl2YXIgaXNQcmV2ZW50RGVmYXVsdCA9IGlzUmV0dXJuID0gZmFsc2U7CgkJCXZhciBkaXJlY3Rpb24gPSB0aGlzLl9nZXREaXJlY3Rpb25CeUFuZ2xlKGRldGFpbC5hbmdsZSk7CgkJCWlmIChkZXRhaWwuZGlyZWN0aW9uID09PSAnbGVmdCcgfHwgZGV0YWlsLmRpcmVjdGlvbiA9PT0gJ3JpZ2h0JykgewoJCQkJaWYgKHRoaXMub3B0aW9ucy5zY3JvbGxYKSB7CgkJCQkJaXNQcmV2ZW50RGVmYXVsdCA9IHRydWU7CgkJCQkJaWYgKCF0aGlzLm1vdmVkKSB7IC8v6K+G5Yir6KeS5bqmKOivpeinkuW6puWvvOiHtOi9ruaSreS4jeeBteaVjykKCQkJCQkJLy8JCQkJCQlpZiAoZGlyZWN0aW9uICE9PSAnbGVmdCcgJiYgZGlyZWN0aW9uICE9PSAncmlnaHQnKSB7CgkJCQkJCS8vCQkJCQkJCWlzUmV0dXJuID0gdHJ1ZTsKCQkJCQkJLy8JCQkJCQl9IGVsc2UgewoJCQkJCQkkLmdlc3R1cmVzLnNlc3Npb24ubG9ja0RpcmVjdGlvbiA9IHRydWU7IC8v6ZSB5a6a5pa55ZCRCgkJCQkJCSQuZ2VzdHVyZXMuc2Vzc2lvbi5zdGFydERpcmVjdGlvbiA9IGRldGFpbC5kaXJlY3Rpb247CgkJCQkJCS8vCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSBpZiAodGhpcy5vcHRpb25zLnNjcm9sbFkgJiYgIXRoaXMubW92ZWQpIHsKCQkJCQlpc1JldHVybiA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoZGV0YWlsLmRpcmVjdGlvbiA9PT0gJ3VwJyB8fCBkZXRhaWwuZGlyZWN0aW9uID09PSAnZG93bicpIHsKCQkJCWlmICh0aGlzLm9wdGlvbnMuc2Nyb2xsWSkgewoJCQkJCWlzUHJldmVudERlZmF1bHQgPSB0cnVlOwoJCQkJCS8vCQkJCQlpZiAoIXRoaXMubW92ZWQpIHsgLy/or4bliKvop5LluqYs56uW5ZCR5rua5Yqo5Ly85LmO5rKh5b+F6KaB6L+b6KGM5bCP6KeS5bqm6aqM6K+BCgkJCQkJLy8JCQkJCQlpZiAoZGlyZWN0aW9uICE9PSAndXAnICYmIGRpcmVjdGlvbiAhPT0gJ2Rvd24nKSB7CgkJCQkJLy8JCQkJCQkJaXNSZXR1cm4gPSB0cnVlOwoJCQkJCS8vCQkJCQkJfQoJCQkJCS8vCQkJCQl9CgkJCQkJaWYgKCF0aGlzLm1vdmVkKSB7CgkJCQkJCSQuZ2VzdHVyZXMuc2Vzc2lvbi5sb2NrRGlyZWN0aW9uID0gdHJ1ZTsgLy/plIHlrprmlrnlkJEKCQkJCQkJJC5nZXN0dXJlcy5zZXNzaW9uLnN0YXJ0RGlyZWN0aW9uID0gZGV0YWlsLmRpcmVjdGlvbjsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKHRoaXMub3B0aW9ucy5zY3JvbGxYICYmICF0aGlzLm1vdmVkKSB7CgkJCQkJaXNSZXR1cm4gPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJaXNSZXR1cm4gPSB0cnVlOwoJCQl9CgkJCWlmICh0aGlzLm1vdmVkIHx8IGlzUHJldmVudERlZmF1bHQpIHsKCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7IC8v6Zi75q2i5YaS5rOhKHNjcm9sbOexu+W1jOWllykKCQkJCWRldGFpbC5nZXN0dXJlICYmIGRldGFpbC5nZXN0dXJlLnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKGlzUmV0dXJuKSB7IC8v56aB5q2i6Z2e5rOV5pa55ZCR5rua5YqoCgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCF0aGlzLm1vdmVkKSB7CgkJCQkkLnRyaWdnZXIodGhpcy5zY3JvbGxlciwgJ3Njcm9sbHN0YXJ0JywgdGhpcyk7CgkJCX0gZWxzZSB7CgkJCQllLnN0b3BQcm9wYWdhdGlvbigpOyAvL21vdmXmnJ/pl7TpmLvmraLlhpLms6Eoc2Nyb2xs5bWM5aWXKQoJCQl9CgkJCXZhciBkZWx0YVggPSAwOwoJCQl2YXIgZGVsdGFZID0gMDsKCQkJaWYgKCF0aGlzLm1vdmVkKSB7IC8vc3RhcnQKCQkJCWRlbHRhWCA9IGRldGFpbC5kZWx0YVg7CgkJCQlkZWx0YVkgPSBkZXRhaWwuZGVsdGFZOwoJCQl9IGVsc2UgeyAvL21vdmUKCQkJCWRlbHRhWCA9IGRldGFpbC5kZWx0YVggLSAkLmdlc3R1cmVzLnNlc3Npb24ucHJldlRvdWNoLmRlbHRhWDsKCQkJCWRlbHRhWSA9IGRldGFpbC5kZWx0YVkgLSAkLmdlc3R1cmVzLnNlc3Npb24ucHJldlRvdWNoLmRlbHRhWTsKCQkJfQoJCQl2YXIgYWJzRGVsdGFYID0gTWF0aC5hYnMoZGV0YWlsLmRlbHRhWCk7CgkJCXZhciBhYnNEZWx0YVkgPSBNYXRoLmFicyhkZXRhaWwuZGVsdGFZKTsKCQkJaWYgKGFic0RlbHRhWCA+IGFic0RlbHRhWSArIHRoaXMub3B0aW9ucy5kaXJlY3Rpb25Mb2NrVGhyZXNob2xkKSB7CgkJCQlkZWx0YVkgPSAwOwoJCQl9IGVsc2UgaWYgKGFic0RlbHRhWSA+PSBhYnNEZWx0YVggKyB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uTG9ja1RocmVzaG9sZCkgewoJCQkJZGVsdGFYID0gMDsKCQkJfQoKCQkJZGVsdGFYID0gdGhpcy5oYXNIb3Jpem9udGFsU2Nyb2xsID8gZGVsdGFYIDogMDsKCQkJZGVsdGFZID0gdGhpcy5oYXNWZXJ0aWNhbFNjcm9sbCA/IGRlbHRhWSA6IDA7CgkJCXZhciBuZXdYID0gdGhpcy54ICsgZGVsdGFYOwoJCQl2YXIgbmV3WSA9IHRoaXMueSArIGRlbHRhWTsKCQkJLy8gU2xvdyBkb3duIGlmIG91dHNpZGUgb2YgdGhlIGJvdW5kYXJpZXMKCQkJaWYgKG5ld1ggPiAwIHx8IG5ld1ggPCB0aGlzLm1heFNjcm9sbFgpIHsKCQkJCW5ld1ggPSB0aGlzLm9wdGlvbnMuYm91bmNlID8gdGhpcy54ICsgZGVsdGFYIC8gMyA6IG5ld1ggPiAwID8gMCA6IHRoaXMubWF4U2Nyb2xsWDsKCQkJfQoJCQlpZiAobmV3WSA+IDAgfHwgbmV3WSA8IHRoaXMubWF4U2Nyb2xsWSkgewoJCQkJbmV3WSA9IHRoaXMub3B0aW9ucy5ib3VuY2UgPyB0aGlzLnkgKyBkZWx0YVkgLyAzIDogbmV3WSA+IDAgPyAwIDogdGhpcy5tYXhTY3JvbGxZOwoJCQl9CgoJCQlpZiAoIXRoaXMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7CgkJCQl0aGlzLl91cGRhdGVUcmFuc2xhdGUoKTsKCQkJfQoJCQl0aGlzLmRpcmVjdGlvbiA9IGRldGFpbC5kZWx0YVggPiAwID8gJ3JpZ2h0JyA6ICdsZWZ0JzsKCQkJdGhpcy5tb3ZlZCA9IHRydWU7CgkJCXRoaXMueCA9IG5ld1g7CgkJCXRoaXMueSA9IG5ld1k7CgkJCSQudHJpZ2dlcih0aGlzLnNjcm9sbGVyLCAnc2Nyb2xsJywgdGhpcyk7CgkJfSwKCQlfZmxpY2s6IGZ1bmN0aW9uKGUpIHsKCQkJLy8JCQlpZiAoIXRoaXMubW92ZWQgfHwgdGhpcy5uZWVkUmVzZXQpIHsKCQkJLy8JCQkJcmV0dXJuOwoJCQkvLwkJCX0KCQkJaWYgKCF0aGlzLm1vdmVkKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJdmFyIGRldGFpbCA9IGUuZGV0YWlsOwoJCQl0aGlzLl9jbGVhclJlcXVlc3RBbmltYXRpb25GcmFtZSgpOwoJCQlpZiAoZS50eXBlID09PSAnZHJhZ2VuZCcgJiYgZGV0YWlsLmZsaWNrKSB7IC8vZHJhZ2VuZAoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbmV3WCA9IE1hdGgucm91bmQodGhpcy54KTsKCQkJdmFyIG5ld1kgPSBNYXRoLnJvdW5kKHRoaXMueSk7CgoJCQl0aGlzLmlzSW5UcmFuc2l0aW9uID0gZmFsc2U7CgkJCS8vIHJlc2V0IGlmIHdlIGFyZSBvdXRzaWRlIG9mIHRoZSBib3VuZGFyaWVzCgkJCWlmICh0aGlzLnJlc2V0UG9zaXRpb24odGhpcy5vcHRpb25zLmJvdW5jZVRpbWUpKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRoaXMuc2Nyb2xsVG8obmV3WCwgbmV3WSk7IC8vIGVuc3VyZXMgdGhhdCB0aGUgbGFzdCBwb3NpdGlvbiBpcyByb3VuZGVkCgoJCQlpZiAoZS50eXBlID09PSAnZHJhZ2VuZCcpIHsgLy9kcmFnZW5kCgkJCQkkLnRyaWdnZXIodGhpcy5zY3JvbGxlciwgJ3Njcm9sbGVuZCcsIHRoaXMpOwoJCQkJcmV0dXJuOwoJCQl9CgkJCXZhciB0aW1lID0gMDsKCQkJdmFyIGVhc2luZyA9ICcnOwoJCQkvLyBzdGFydCBtb21lbnR1bSBhbmltYXRpb24gaWYgbmVlZGVkCgkJCWlmICh0aGlzLm9wdGlvbnMubW9tZW50dW0gJiYgZGV0YWlsLmZsaWNrVGltZSA8IDMwMCkgewoJCQkJbW9tZW50dW1YID0gdGhpcy5oYXNIb3Jpem9udGFsU2Nyb2xsID8gdGhpcy5fbW9tZW50dW0odGhpcy54LCBkZXRhaWwuZmxpY2tEaXN0YW5jZVgsIGRldGFpbC5mbGlja1RpbWUsIHRoaXMubWF4U2Nyb2xsWCwgdGhpcy5vcHRpb25zLmJvdW5jZSA/IHRoaXMud3JhcHBlcldpZHRoIDogMCwgdGhpcy5vcHRpb25zLmRlY2VsZXJhdGlvbikgOiB7CgkJCQkJZGVzdGluYXRpb246IG5ld1gsCgkJCQkJZHVyYXRpb246IDAKCQkJCX07CgkJCQltb21lbnR1bVkgPSB0aGlzLmhhc1ZlcnRpY2FsU2Nyb2xsID8gdGhpcy5fbW9tZW50dW0odGhpcy55LCBkZXRhaWwuZmxpY2tEaXN0YW5jZVksIGRldGFpbC5mbGlja1RpbWUsIHRoaXMubWF4U2Nyb2xsWSwgdGhpcy5vcHRpb25zLmJvdW5jZSA/IHRoaXMud3JhcHBlckhlaWdodCA6IDAsIHRoaXMub3B0aW9ucy5kZWNlbGVyYXRpb24pIDogewoJCQkJCWRlc3RpbmF0aW9uOiBuZXdZLAoJCQkJCWR1cmF0aW9uOiAwCgkJCQl9OwoJCQkJbmV3WCA9IG1vbWVudHVtWC5kZXN0aW5hdGlvbjsKCQkJCW5ld1kgPSBtb21lbnR1bVkuZGVzdGluYXRpb247CgkJCQl0aW1lID0gTWF0aC5tYXgobW9tZW50dW1YLmR1cmF0aW9uLCBtb21lbnR1bVkuZHVyYXRpb24pOwoJCQkJdGhpcy5pc0luVHJhbnNpdGlvbiA9IHRydWU7CgkJCX0KCgkJCWlmIChuZXdYICE9IHRoaXMueCB8fCBuZXdZICE9IHRoaXMueSkgewoJCQkJaWYgKG5ld1ggPiAwIHx8IG5ld1ggPCB0aGlzLm1heFNjcm9sbFggfHwgbmV3WSA+IDAgfHwgbmV3WSA8IHRoaXMubWF4U2Nyb2xsWSkgewoJCQkJCWVhc2luZyA9IGVhc2UucXVhZHJhdGljOwoJCQkJfQoJCQkJdGhpcy5zY3JvbGxUbyhuZXdYLCBuZXdZLCB0aW1lLCBlYXNpbmcpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkkLnRyaWdnZXIodGhpcy5zY3JvbGxlciwgJ3Njcm9sbGVuZCcsIHRoaXMpOwoJCQkvLwkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfSwKCQlfZW5kOiBmdW5jdGlvbihlKSB7CgkJCXRoaXMubmVlZFJlc2V0ID0gZmFsc2U7CgkJCWlmICgoIXRoaXMubW92ZWQgJiYgdGhpcy5uZWVkUmVzZXQpIHx8IGUudHlwZSA9PT0gJC5FVkVOVF9DQU5DRUwpIHsKCQkJCXRoaXMucmVzZXRQb3NpdGlvbigpOwoJCQl9CgkJfSwKCQlfdHJhbnNpdGlvbkVuZDogZnVuY3Rpb24oZSkgewoJCQlpZiAoZS50YXJnZXQgIT0gdGhpcy5zY3JvbGxlciB8fCAhdGhpcy5pc0luVHJhbnNpdGlvbikgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXRoaXMuX3RyYW5zaXRpb25UaW1lKCk7CgkJCWlmICghdGhpcy5yZXNldFBvc2l0aW9uKHRoaXMub3B0aW9ucy5ib3VuY2VUaW1lKSkgewoJCQkJdGhpcy5pc0luVHJhbnNpdGlvbiA9IGZhbHNlOwoJCQkJJC50cmlnZ2VyKHRoaXMuc2Nyb2xsZXIsICdzY3JvbGxlbmQnLCB0aGlzKTsKCQkJfQoJCX0sCgkJX3Njcm9sbGVuZDogZnVuY3Rpb24oZSkgewoJCQlpZiAoKHRoaXMueSA9PT0gMCAmJiB0aGlzLm1heFNjcm9sbFkgPT09IDApIHx8IChNYXRoLmFicyh0aGlzLnkpID4gMCAmJiB0aGlzLnkgPD0gdGhpcy5tYXhTY3JvbGxZKSkgewoJCQkJJC50cmlnZ2VyKHRoaXMuc2Nyb2xsZXIsICdzY3JvbGxib3R0b20nLCB0aGlzKTsKCQkJfQoJCX0sCgkJX3Jlc2l6ZTogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGF0ID0gdGhpczsKCQkJY2xlYXJUaW1lb3V0KHRoYXQucmVzaXplVGltZW91dCk7CgkJCXRoYXQucmVzaXplVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQl0aGF0LnJlZnJlc2goKTsKCQkJfSwgdGhhdC5vcHRpb25zLnJlc2l6ZVBvbGxpbmcpOwoJCX0sCgkJX3RyYW5zaXRpb25UaW1lOiBmdW5jdGlvbih0aW1lKSB7CgkJCXRpbWUgPSB0aW1lIHx8IDA7CgkJCXRoaXMuc2Nyb2xsZXJTdHlsZVsnd2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uJ10gPSB0aW1lICsgJ21zJzsKCQkJaWYgKHRoaXMucGFyYWxsYXhFbGVtZW50ICYmIHRoaXMub3B0aW9ucy5zY3JvbGxZKSB7IC8v55uu5YmN5LuF5pSv5oyB56uW5ZCR6KeG5beu5pWI5p6cCgkJCQl0aGlzLnBhcmFsbGF4U3R5bGVbJ3dlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiddID0gdGltZSArICdtcyc7CgkJCX0KCQkJaWYgKHRoaXMub3B0aW9ucy5maXhlZEJhZEFuZG9yaWQgJiYgIXRpbWUgJiYgJC5vcy5pc0JhZEFuZHJvaWQpIHsKCQkJCXRoaXMuc2Nyb2xsZXJTdHlsZVsnd2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uJ10gPSAnMC4wMDFzJzsKCQkJCWlmICh0aGlzLnBhcmFsbGF4RWxlbWVudCAmJiB0aGlzLm9wdGlvbnMuc2Nyb2xsWSkgeyAvL+ebruWJjeS7heaUr+aMgeerluWQkeinhuW3ruaViOaenAoJCQkJCXRoaXMucGFyYWxsYXhTdHlsZVsnd2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uJ10gPSAnMC4wMDFzJzsKCQkJCX0KCQkJfQoJCQlpZiAodGhpcy5pbmRpY2F0b3JzKSB7CgkJCQlmb3IgKHZhciBpID0gdGhpcy5pbmRpY2F0b3JzLmxlbmd0aDsgaS0tOykgewoJCQkJCXRoaXMuaW5kaWNhdG9yc1tpXS50cmFuc2l0aW9uVGltZSh0aW1lKTsKCQkJCX0KCQkJfQoJCQlpZiAodGltZSkgeyAvL+iHquWumuS5iXRpbWVy77yM5L+d6K+Bd2Via2l0VHJhbnNpdGlvbkVuZOWni+e7iOinpuWPkQoJCQkJdGhpcy50cmFuc2l0aW9uVGltZXIgJiYgdGhpcy50cmFuc2l0aW9uVGltZXIuY2FuY2VsKCk7CgkJCQl0aGlzLnRyYW5zaXRpb25UaW1lciA9ICQubGF0ZXIoZnVuY3Rpb24oKSB7CgkJCQkJJC50cmlnZ2VyKHRoaXMuc2Nyb2xsZXIsICd3ZWJraXRUcmFuc2l0aW9uRW5kJyk7CgkJCQl9LCB0aW1lICsgMTAwLCB0aGlzKTsKCQkJfQoJCX0sCgkJX3RyYW5zaXRpb25UaW1pbmdGdW5jdGlvbjogZnVuY3Rpb24oZWFzaW5nKSB7CgkJCXRoaXMuc2Nyb2xsZXJTdHlsZVsnd2Via2l0VHJhbnNpdGlvblRpbWluZ0Z1bmN0aW9uJ10gPSBlYXNpbmc7CgkJCWlmICh0aGlzLnBhcmFsbGF4RWxlbWVudCAmJiB0aGlzLm9wdGlvbnMuc2Nyb2xsWSkgeyAvL+ebruWJjeS7heaUr+aMgeerluWQkeinhuW3ruaViOaenAoJCQkJdGhpcy5wYXJhbGxheFN0eWxlWyd3ZWJraXRUcmFuc2l0aW9uRHVyYXRpb24nXSA9IGVhc2luZzsKCQkJfQoJCQlpZiAodGhpcy5pbmRpY2F0b3JzKSB7CgkJCQlmb3IgKHZhciBpID0gdGhpcy5pbmRpY2F0b3JzLmxlbmd0aDsgaS0tOykgewoJCQkJCXRoaXMuaW5kaWNhdG9yc1tpXS50cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24oZWFzaW5nKTsKCQkJCX0KCQkJfQoJCX0sCgkJX3RyYW5zbGF0ZTogZnVuY3Rpb24oeCwgeSkgewoJCQl0aGlzLnggPSB4OwoJCQl0aGlzLnkgPSB5OwoJCX0sCgkJX2NsZWFyUmVxdWVzdEFuaW1hdGlvbkZyYW1lOiBmdW5jdGlvbigpIHsKCQkJaWYgKHRoaXMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7CgkJCQljYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLnJlcXVlc3RBbmltYXRpb25GcmFtZSk7CgkJCQl0aGlzLnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IG51bGw7CgkJCX0KCQl9LAoJCV91cGRhdGVUcmFuc2xhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCWlmIChzZWxmLnggIT09IHNlbGYubGFzdFggfHwgc2VsZi55ICE9PSBzZWxmLmxhc3RZKSB7CgkJCQlzZWxmLnNldFRyYW5zbGF0ZShzZWxmLngsIHNlbGYueSk7CgkJCX0KCQkJc2VsZi5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CgkJCQlzZWxmLl91cGRhdGVUcmFuc2xhdGUoKTsKCQkJfSk7CgkJfSwKCQlfY3JlYXRlU2Nyb2xsQmFyOiBmdW5jdGlvbihjbGF6eikgewoJCQl2YXIgc2Nyb2xsYmFyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCXZhciBpbmRpY2F0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJc2Nyb2xsYmFyLmNsYXNzTmFtZSA9IENMQVNTX1NDUk9MTEJBUiArICcgJyArIGNsYXp6OwoJCQlpbmRpY2F0b3IuY2xhc3NOYW1lID0gQ0xBU1NfSU5ESUNBVE9SOwoJCQlzY3JvbGxiYXIuYXBwZW5kQ2hpbGQoaW5kaWNhdG9yKTsKCQkJaWYgKGNsYXp6ID09PSBDTEFTU19TQ1JPTExCQVJfVkVSVElDQUwpIHsKCQkJCXRoaXMuc2Nyb2xsYmFyWSA9IHNjcm9sbGJhcjsKCQkJCXRoaXMuc2Nyb2xsYmFySW5kaWNhdG9yWSA9IGluZGljYXRvcjsKCQkJfSBlbHNlIGlmIChjbGF6eiA9PT0gQ0xBU1NfU0NST0xMQkFSX0hPUklaT05UQUwpIHsKCQkJCXRoaXMuc2Nyb2xsYmFyWCA9IHNjcm9sbGJhcjsKCQkJCXRoaXMuc2Nyb2xsYmFySW5kaWNhdG9yWCA9IGluZGljYXRvcjsKCQkJfQoJCQl0aGlzLndyYXBwZXIuYXBwZW5kQ2hpbGQoc2Nyb2xsYmFyKTsKCQkJcmV0dXJuIHNjcm9sbGJhcjsKCQl9LAoJCV9wcmV2ZW50RGVmYXVsdEV4Y2VwdGlvbjogZnVuY3Rpb24oZWwsIGV4Y2VwdGlvbnMpIHsKCQkJZm9yICh2YXIgaSBpbiBleGNlcHRpb25zKSB7CgkJCQlpZiAoZXhjZXB0aW9uc1tpXS50ZXN0KGVsW2ldKSkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9LAoJCV9yZUxheW91dDogZnVuY3Rpb24oKSB7CgkJCWlmICghdGhpcy5oYXNIb3Jpem9udGFsU2Nyb2xsKSB7CgkJCQl0aGlzLm1heFNjcm9sbFggPSAwOwoJCQkJdGhpcy5zY3JvbGxlcldpZHRoID0gdGhpcy53cmFwcGVyV2lkdGg7CgkJCX0KCgkJCWlmICghdGhpcy5oYXNWZXJ0aWNhbFNjcm9sbCkgewoJCQkJdGhpcy5tYXhTY3JvbGxZID0gMDsKCQkJCXRoaXMuc2Nyb2xsZXJIZWlnaHQgPSB0aGlzLndyYXBwZXJIZWlnaHQ7CgkJCX0KCgkJCXRoaXMuaW5kaWNhdG9ycy5tYXAoZnVuY3Rpb24oaW5kaWNhdG9yKSB7CgkJCQlpbmRpY2F0b3IucmVmcmVzaCgpOwoJCQl9KTsKCgkJCS8v5Lul6Ziyc2xpZGVy57G75bWM5aWX5L2/55SoCgkJCWlmICh0aGlzLm9wdGlvbnMuc25hcCAmJiB0eXBlb2YgdGhpcy5vcHRpb25zLnNuYXAgPT09ICdzdHJpbmcnKSB7CgkJCQl2YXIgaXRlbXMgPSB0aGlzLnNjcm9sbGVyLnF1ZXJ5U2VsZWN0b3JBbGwodGhpcy5vcHRpb25zLnNuYXApOwoJCQkJdGhpcy5pdGVtTGVuZ3RoID0gMDsKCQkJCXRoaXMuc25hcHMgPSBbXTsKCQkJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBpdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoJCQkJCXZhciBpdGVtID0gaXRlbXNbaV07CgkJCQkJaWYgKGl0ZW0ucGFyZW50Tm9kZSA9PT0gdGhpcy5zY3JvbGxlcikgewoJCQkJCQl0aGlzLml0ZW1MZW5ndGgrKzsKCQkJCQkJdGhpcy5zbmFwcy5wdXNoKGl0ZW0pOwoJCQkJCX0KCQkJCX0KCQkJCXRoaXMuX2luaXRTbmFwKCk7IC8v6ZyA6KaB5q+P5qyh6YO9X2luaXRTbmFw5LmI44CC5YW25a6eaW5pdOeahOaXtuWAmeaJp+ihjOS4gOasoe+8jOWQjue7rXJlc2l6ZeeahOaXtuWAmeaJp+ihjOS4gOasoeWwseihjOS6huWQpy7lhYjov5nkuYjlgZrlkKfvvIzlpoLmnpzlvbHlk43mgKfog73vvIzlho3osIPmlbQKCQkJfQoJCX0sCgkJX21vbWVudHVtOiBmdW5jdGlvbihjdXJyZW50LCBkaXN0YW5jZSwgdGltZSwgbG93ZXJNYXJnaW4sIHdyYXBwZXJTaXplLCBkZWNlbGVyYXRpb24pIHsKCQkJdmFyIHNwZWVkID0gcGFyc2VGbG9hdChNYXRoLmFicyhkaXN0YW5jZSkgLyB0aW1lKSwKCQkJCWRlc3RpbmF0aW9uLAoJCQkJZHVyYXRpb247CgoJCQlkZWNlbGVyYXRpb24gPSBkZWNlbGVyYXRpb24gPT09IHVuZGVmaW5lZCA/IDAuMDAwNiA6IGRlY2VsZXJhdGlvbjsKCQkJZGVzdGluYXRpb24gPSBjdXJyZW50ICsgKHNwZWVkICogc3BlZWQpIC8gKDIgKiBkZWNlbGVyYXRpb24pICogKGRpc3RhbmNlIDwgMCA/IC0xIDogMSk7CgkJCWR1cmF0aW9uID0gc3BlZWQgLyBkZWNlbGVyYXRpb247CgkJCWlmIChkZXN0aW5hdGlvbiA8IGxvd2VyTWFyZ2luKSB7CgkJCQlkZXN0aW5hdGlvbiA9IHdyYXBwZXJTaXplID8gbG93ZXJNYXJnaW4gLSAod3JhcHBlclNpemUgLyAyLjUgKiAoc3BlZWQgLyA4KSkgOiBsb3dlck1hcmdpbjsKCQkJCWRpc3RhbmNlID0gTWF0aC5hYnMoZGVzdGluYXRpb24gLSBjdXJyZW50KTsKCQkJCWR1cmF0aW9uID0gZGlzdGFuY2UgLyBzcGVlZDsKCQkJfSBlbHNlIGlmIChkZXN0aW5hdGlvbiA+IDApIHsKCQkJCWRlc3RpbmF0aW9uID0gd3JhcHBlclNpemUgPyB3cmFwcGVyU2l6ZSAvIDIuNSAqIChzcGVlZCAvIDgpIDogMDsKCQkJCWRpc3RhbmNlID0gTWF0aC5hYnMoY3VycmVudCkgKyBkZXN0aW5hdGlvbjsKCQkJCWR1cmF0aW9uID0gZGlzdGFuY2UgLyBzcGVlZDsKCQkJfQoKCQkJcmV0dXJuIHsKCQkJCWRlc3RpbmF0aW9uOiBNYXRoLnJvdW5kKGRlc3RpbmF0aW9uKSwKCQkJCWR1cmF0aW9uOiBkdXJhdGlvbgoJCQl9OwoJCX0sCgkJX2dldFRyYW5zbGF0ZVN0cjogZnVuY3Rpb24oeCwgeSkgewoJCQlpZiAodGhpcy5vcHRpb25zLmhhcmR3YXJlQWNjZWxlcmF0ZWQpIHsKCQkJCXJldHVybiAndHJhbnNsYXRlM2QoJyArIHggKyAncHgsJyArIHkgKyAncHgsMHB4KSAnICsgdGhpcy50cmFuc2xhdGVaOwoJCQl9CgkJCXJldHVybiAndHJhbnNsYXRlKCcgKyB4ICsgJ3B4LCcgKyB5ICsgJ3B4KSAnOwoJCX0sCgkJLy9BUEkKCQlzZXRTdG9wcGVkOiBmdW5jdGlvbihzdG9wcGVkKSB7CgkJCS8vIHRoaXMuc3RvcHBlZCA9ICEhc3RvcHBlZDsKCgkJCS8vIGZpeGVkIGlvc+WPjHdlYnZpZXfmqKHlvI/kuIvmi4nliLfmlrAKCQkJaWYoc3RvcHBlZCkgewoJCQkJdGhpcy5kaXNhYmxlUHVsbHVwVG9SZWZyZXNoKCk7CgkJCQl0aGlzLmRpc2FibGVQdWxsZG93blRvUmVmcmVzaCgpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5lbmFibGVQdWxsdXBUb1JlZnJlc2goKTsKCQkJCXRoaXMuZW5hYmxlUHVsbGRvd25Ub1JlZnJlc2goKTsKCQkJfQoJCX0sCgkJc2V0VHJhbnNsYXRlOiBmdW5jdGlvbih4LCB5KSB7CgkJCXRoaXMueCA9IHg7CgkJCXRoaXMueSA9IHk7CgkJCXRoaXMuc2Nyb2xsZXJTdHlsZVsnd2Via2l0VHJhbnNmb3JtJ10gPSB0aGlzLl9nZXRUcmFuc2xhdGVTdHIoeCwgeSk7CgkJCWlmICh0aGlzLnBhcmFsbGF4RWxlbWVudCAmJiB0aGlzLm9wdGlvbnMuc2Nyb2xsWSkgeyAvL+ebruWJjeS7heaUr+aMgeerluWQkeinhuW3ruaViOaenAoJCQkJdmFyIHBhcmFsbGF4WSA9IHkgKiB0aGlzLm9wdGlvbnMucGFyYWxsYXhSYXRpbzsKCQkJCXZhciBzY2FsZSA9IDEgKyBwYXJhbGxheFkgLyAoKHRoaXMucGFyYWxsYXhIZWlnaHQgLSBwYXJhbGxheFkpIC8gMik7CgkJCQlpZiAoc2NhbGUgPiAxKSB7CgkJCQkJdGhpcy5wYXJhbGxheEltZ1N0eWxlWydvcGFjaXR5J10gPSAxIC0gcGFyYWxsYXhZIC8gMTAwICogdGhpcy5vcHRpb25zLnBhcmFsbGF4UmF0aW87CgkJCQkJdGhpcy5wYXJhbGxheFN0eWxlWyd3ZWJraXRUcmFuc2Zvcm0nXSA9IHRoaXMuX2dldFRyYW5zbGF0ZVN0cigwLCAtcGFyYWxsYXhZKSArICcgc2NhbGUoJyArIHNjYWxlICsgJywnICsgc2NhbGUgKyAnKSc7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMucGFyYWxsYXhJbWdTdHlsZVsnb3BhY2l0eSddID0gMTsKCQkJCQl0aGlzLnBhcmFsbGF4U3R5bGVbJ3dlYmtpdFRyYW5zZm9ybSddID0gdGhpcy5fZ2V0VHJhbnNsYXRlU3RyKDAsIC0xKSArICcgc2NhbGUoMSwxKSc7CgkJCQl9CgkJCX0KCQkJaWYgKHRoaXMuaW5kaWNhdG9ycykgewoJCQkJZm9yICh2YXIgaSA9IHRoaXMuaW5kaWNhdG9ycy5sZW5ndGg7IGktLTspIHsKCQkJCQl0aGlzLmluZGljYXRvcnNbaV0udXBkYXRlUG9zaXRpb24oKTsKCQkJCX0KCQkJfQoJCQl0aGlzLmxhc3RYID0gdGhpcy54OwoJCQl0aGlzLmxhc3RZID0gdGhpcy55OwoJCQkkLnRyaWdnZXIodGhpcy5zY3JvbGxlciwgJ3Njcm9sbCcsIHRoaXMpOwoJCX0sCgkJcmVMYXlvdXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLndyYXBwZXIub2Zmc2V0SGVpZ2h0OwoKCQkJdmFyIHBhZGRpbmdMZWZ0ID0gcGFyc2VGbG9hdCgkLmdldFN0eWxlcyh0aGlzLndyYXBwZXIsICdwYWRkaW5nLWxlZnQnKSkgfHwgMDsKCQkJdmFyIHBhZGRpbmdSaWdodCA9IHBhcnNlRmxvYXQoJC5nZXRTdHlsZXModGhpcy53cmFwcGVyLCAncGFkZGluZy1yaWdodCcpKSB8fCAwOwoJCQl2YXIgcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoJC5nZXRTdHlsZXModGhpcy53cmFwcGVyLCAncGFkZGluZy10b3AnKSkgfHwgMDsKCQkJdmFyIHBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCQuZ2V0U3R5bGVzKHRoaXMud3JhcHBlciwgJ3BhZGRpbmctYm90dG9tJykpIHx8IDA7CgoJCQl2YXIgY2xpZW50V2lkdGggPSB0aGlzLndyYXBwZXIuY2xpZW50V2lkdGg7CgkJCXZhciBjbGllbnRIZWlnaHQgPSB0aGlzLndyYXBwZXIuY2xpZW50SGVpZ2h0OwoKCQkJdGhpcy5zY3JvbGxlcldpZHRoID0gdGhpcy5zY3JvbGxlci5vZmZzZXRXaWR0aDsKCQkJdGhpcy5zY3JvbGxlckhlaWdodCA9IHRoaXMuc2Nyb2xsZXIub2Zmc2V0SGVpZ2h0OwoKCQkJdGhpcy53cmFwcGVyV2lkdGggPSBjbGllbnRXaWR0aCAtIHBhZGRpbmdMZWZ0IC0gcGFkZGluZ1JpZ2h0OwoJCQl0aGlzLndyYXBwZXJIZWlnaHQgPSBjbGllbnRIZWlnaHQgLSBwYWRkaW5nVG9wIC0gcGFkZGluZ0JvdHRvbTsKCgkJCXRoaXMubWF4U2Nyb2xsWCA9IE1hdGgubWluKHRoaXMud3JhcHBlcldpZHRoIC0gdGhpcy5zY3JvbGxlcldpZHRoLCAwKTsKCQkJdGhpcy5tYXhTY3JvbGxZID0gTWF0aC5taW4odGhpcy53cmFwcGVySGVpZ2h0IC0gdGhpcy5zY3JvbGxlckhlaWdodCwgMCk7CgkJCXRoaXMuaGFzSG9yaXpvbnRhbFNjcm9sbCA9IHRoaXMub3B0aW9ucy5zY3JvbGxYICYmIHRoaXMubWF4U2Nyb2xsWCA8IDA7CgkJCXRoaXMuaGFzVmVydGljYWxTY3JvbGwgPSB0aGlzLm9wdGlvbnMuc2Nyb2xsWSAmJiB0aGlzLm1heFNjcm9sbFkgPCAwOwoJCQl0aGlzLl9yZUxheW91dCgpOwoJCX0sCgkJcmVzZXRQb3NpdGlvbjogZnVuY3Rpb24odGltZSkgewoJCQl2YXIgeCA9IHRoaXMueCwKCQkJCXkgPSB0aGlzLnk7CgoJCQl0aW1lID0gdGltZSB8fCAwOwoJCQlpZiAoIXRoaXMuaGFzSG9yaXpvbnRhbFNjcm9sbCB8fCB0aGlzLnggPiAwKSB7CgkJCQl4ID0gMDsKCQkJfSBlbHNlIGlmICh0aGlzLnggPCB0aGlzLm1heFNjcm9sbFgpIHsKCQkJCXggPSB0aGlzLm1heFNjcm9sbFg7CgkJCX0KCgkJCWlmICghdGhpcy5oYXNWZXJ0aWNhbFNjcm9sbCB8fCB0aGlzLnkgPiAwKSB7CgkJCQl5ID0gMDsKCQkJfSBlbHNlIGlmICh0aGlzLnkgPCB0aGlzLm1heFNjcm9sbFkpIHsKCQkJCXkgPSB0aGlzLm1heFNjcm9sbFk7CgkJCX0KCgkJCWlmICh4ID09IHRoaXMueCAmJiB5ID09IHRoaXMueSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCXRoaXMuc2Nyb2xsVG8oeCwgeSwgdGltZSwgdGhpcy5vcHRpb25zLnNjcm9sbEVhc2luZyk7CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9LAoJCV9yZUluaXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgZ3JvdXBzID0gdGhpcy53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgQ0xBU1NfU0NST0xMKTsKCQkJZm9yICh2YXIgaSA9IDAsIGxlbiA9IGdyb3Vwcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoJCQkJaWYgKGdyb3Vwc1tpXS5wYXJlbnROb2RlID09PSB0aGlzLndyYXBwZXIpIHsKCQkJCQl0aGlzLnNjcm9sbGVyID0gZ3JvdXBzW2ldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCXRoaXMuc2Nyb2xsZXJTdHlsZSA9IHRoaXMuc2Nyb2xsZXIgJiYgdGhpcy5zY3JvbGxlci5zdHlsZTsKCQl9LAoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9yZUluaXQoKTsKCQkJdGhpcy5yZUxheW91dCgpOwoJCQkkLnRyaWdnZXIodGhpcy5zY3JvbGxlciwgJ3JlZnJlc2gnLCB0aGlzKTsKCQkJdGhpcy5yZXNldFBvc2l0aW9uKCk7CgkJfSwKCQlzY3JvbGxUbzogZnVuY3Rpb24oeCwgeSwgdGltZSwgZWFzaW5nKSB7CgkJCXZhciBlYXNpbmcgPSBlYXNpbmcgfHwgZWFzZS5jaXJjdWxhcjsKCQkJLy8JCQl0aGlzLmlzSW5UcmFuc2l0aW9uID0gdGltZSA+IDAgJiYgKHRoaXMubGFzdFggIT0geCB8fCB0aGlzLmxhc3RZICE9IHkpOwoJCQkvL+aaguS4jeS4peagvOWIpOaWrXgsee+8jOWQpuWImeS8muWvvOiHtOmDqOWIhueJiOacrOS4iuS4jeato+W4uOinpuWPkei9ruaSrQoJCQl0aGlzLmlzSW5UcmFuc2l0aW9uID0gdGltZSA+IDA7CgkJCWlmICh0aGlzLmlzSW5UcmFuc2l0aW9uKSB7CgkJCQl0aGlzLl9jbGVhclJlcXVlc3RBbmltYXRpb25GcmFtZSgpOwoJCQkJdGhpcy5fdHJhbnNpdGlvblRpbWluZ0Z1bmN0aW9uKGVhc2luZy5zdHlsZSk7CgkJCQl0aGlzLl90cmFuc2l0aW9uVGltZSh0aW1lKTsKCQkJCXRoaXMuc2V0VHJhbnNsYXRlKHgsIHkpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5zZXRUcmFuc2xhdGUoeCwgeSk7CgkJCX0KCgkJfSwKCQlzY3JvbGxUb0JvdHRvbTogZnVuY3Rpb24odGltZSwgZWFzaW5nKSB7CgkJCXRpbWUgPSB0aW1lIHx8IHRoaXMub3B0aW9ucy5zY3JvbGxUaW1lOwoJCQl0aGlzLnNjcm9sbFRvKDAsIHRoaXMubWF4U2Nyb2xsWSwgdGltZSwgZWFzaW5nKTsKCQl9LAoJCWdvdG9QYWdlOiBmdW5jdGlvbihpbmRleCkgewoJCQl0aGlzLl9nb3RvUGFnZShpbmRleCk7CgkJfSwKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5faW5pdEV2ZW50KHRydWUpOyAvL2RldGFjaAoJCQlkZWxldGUgJC5kYXRhW3RoaXMud3JhcHBlci5nZXRBdHRyaWJ1dGUoJ2RhdGEtc2Nyb2xsJyldOwoJCQl0aGlzLndyYXBwZXIuc2V0QXR0cmlidXRlKCdkYXRhLXNjcm9sbCcsICcnKTsKCQl9Cgl9KTsKCS8vSW5kaWNhdG9yCgl2YXIgSW5kaWNhdG9yID0gZnVuY3Rpb24oc2Nyb2xsZXIsIG9wdGlvbnMpIHsKCQl0aGlzLndyYXBwZXIgPSB0eXBlb2Ygb3B0aW9ucy5lbCA9PSAnc3RyaW5nJyA/IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0aW9ucy5lbCkgOiBvcHRpb25zLmVsOwoJCXRoaXMud3JhcHBlclN0eWxlID0gdGhpcy53cmFwcGVyLnN0eWxlOwoJCXRoaXMuaW5kaWNhdG9yID0gdGhpcy53cmFwcGVyLmNoaWxkcmVuWzBdOwoJCXRoaXMuaW5kaWNhdG9yU3R5bGUgPSB0aGlzLmluZGljYXRvci5zdHlsZTsKCQl0aGlzLnNjcm9sbGVyID0gc2Nyb2xsZXI7CgoJCXRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKHsKCQkJbGlzdGVuWDogdHJ1ZSwKCQkJbGlzdGVuWTogdHJ1ZSwKCQkJZmFkZTogZmFsc2UsCgkJCXNwZWVkUmF0aW9YOiAwLAoJCQlzcGVlZFJhdGlvWTogMAoJCX0sIG9wdGlvbnMpOwoKCQl0aGlzLnNpemVSYXRpb1ggPSAxOwoJCXRoaXMuc2l6ZVJhdGlvWSA9IDE7CgkJdGhpcy5tYXhQb3NYID0gMDsKCQl0aGlzLm1heFBvc1kgPSAwOwoKCQlpZiAodGhpcy5vcHRpb25zLmZhZGUpIHsKCQkJdGhpcy53cmFwcGVyU3R5bGVbJ3dlYmtpdFRyYW5zZm9ybSddID0gdGhpcy5zY3JvbGxlci50cmFuc2xhdGVaOwoJCQl0aGlzLndyYXBwZXJTdHlsZVsnd2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uJ10gPSB0aGlzLm9wdGlvbnMuZml4ZWRCYWRBbmRvcmlkICYmICQub3MuaXNCYWRBbmRyb2lkID8gJzAuMDAxcycgOiAnMG1zJzsKCQkJdGhpcy53cmFwcGVyU3R5bGUub3BhY2l0eSA9ICcwJzsKCQl9Cgl9CglJbmRpY2F0b3IucHJvdG90eXBlID0gewoJCWhhbmRsZUV2ZW50OiBmdW5jdGlvbihlKSB7CgoJCX0sCgkJdHJhbnNpdGlvblRpbWU6IGZ1bmN0aW9uKHRpbWUpIHsKCQkJdGltZSA9IHRpbWUgfHwgMDsKCQkJdGhpcy5pbmRpY2F0b3JTdHlsZVsnd2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uJ10gPSB0aW1lICsgJ21zJzsKCQkJaWYgKHRoaXMuc2Nyb2xsZXIub3B0aW9ucy5maXhlZEJhZEFuZG9yaWQgJiYgIXRpbWUgJiYgJC5vcy5pc0JhZEFuZHJvaWQpIHsKCQkJCXRoaXMuaW5kaWNhdG9yU3R5bGVbJ3dlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiddID0gJzAuMDAxcyc7CgkJCX0KCQl9LAoJCXRyYW5zaXRpb25UaW1pbmdGdW5jdGlvbjogZnVuY3Rpb24oZWFzaW5nKSB7CgkJCXRoaXMuaW5kaWNhdG9yU3R5bGVbJ3dlYmtpdFRyYW5zaXRpb25UaW1pbmdGdW5jdGlvbiddID0gZWFzaW5nOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXRoaXMudHJhbnNpdGlvblRpbWUoKTsKCgkJCWlmICh0aGlzLm9wdGlvbnMubGlzdGVuWCAmJiAhdGhpcy5vcHRpb25zLmxpc3RlblkpIHsKCQkJCXRoaXMuaW5kaWNhdG9yU3R5bGUuZGlzcGxheSA9IHRoaXMuc2Nyb2xsZXIuaGFzSG9yaXpvbnRhbFNjcm9sbCA/ICdibG9jaycgOiAnbm9uZSc7CgkJCX0gZWxzZSBpZiAodGhpcy5vcHRpb25zLmxpc3RlblkgJiYgIXRoaXMub3B0aW9ucy5saXN0ZW5YKSB7CgkJCQl0aGlzLmluZGljYXRvclN0eWxlLmRpc3BsYXkgPSB0aGlzLnNjcm9sbGVyLmhhc1ZlcnRpY2FsU2Nyb2xsID8gJ2Jsb2NrJyA6ICdub25lJzsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5kaWNhdG9yU3R5bGUuZGlzcGxheSA9IHRoaXMuc2Nyb2xsZXIuaGFzSG9yaXpvbnRhbFNjcm9sbCB8fCB0aGlzLnNjcm9sbGVyLmhhc1ZlcnRpY2FsU2Nyb2xsID8gJ2Jsb2NrJyA6ICdub25lJzsKCQkJfQoKCQkJdGhpcy53cmFwcGVyLm9mZnNldEhlaWdodDsgLy8gZm9yY2UgcmVmcmVzaAoKCQkJaWYgKHRoaXMub3B0aW9ucy5saXN0ZW5YKSB7CgkJCQl0aGlzLndyYXBwZXJXaWR0aCA9IHRoaXMud3JhcHBlci5jbGllbnRXaWR0aDsKCQkJCXRoaXMuaW5kaWNhdG9yV2lkdGggPSBNYXRoLm1heChNYXRoLnJvdW5kKHRoaXMud3JhcHBlcldpZHRoICogdGhpcy53cmFwcGVyV2lkdGggLyAodGhpcy5zY3JvbGxlci5zY3JvbGxlcldpZHRoIHx8IHRoaXMud3JhcHBlcldpZHRoIHx8IDEpKSwgOCk7CgkJCQl0aGlzLmluZGljYXRvclN0eWxlLndpZHRoID0gdGhpcy5pbmRpY2F0b3JXaWR0aCArICdweCc7CgoJCQkJdGhpcy5tYXhQb3NYID0gdGhpcy53cmFwcGVyV2lkdGggLSB0aGlzLmluZGljYXRvcldpZHRoOwoKCQkJCXRoaXMubWluQm91bmRhcnlYID0gMDsKCQkJCXRoaXMubWF4Qm91bmRhcnlYID0gdGhpcy5tYXhQb3NYOwoKCQkJCXRoaXMuc2l6ZVJhdGlvWCA9IHRoaXMub3B0aW9ucy5zcGVlZFJhdGlvWCB8fCAodGhpcy5zY3JvbGxlci5tYXhTY3JvbGxYICYmICh0aGlzLm1heFBvc1ggLyB0aGlzLnNjcm9sbGVyLm1heFNjcm9sbFgpKTsKCQkJfQoKCQkJaWYgKHRoaXMub3B0aW9ucy5saXN0ZW5ZKSB7CgkJCQl0aGlzLndyYXBwZXJIZWlnaHQgPSB0aGlzLndyYXBwZXIuY2xpZW50SGVpZ2h0OwoJCQkJdGhpcy5pbmRpY2F0b3JIZWlnaHQgPSBNYXRoLm1heChNYXRoLnJvdW5kKHRoaXMud3JhcHBlckhlaWdodCAqIHRoaXMud3JhcHBlckhlaWdodCAvICh0aGlzLnNjcm9sbGVyLnNjcm9sbGVySGVpZ2h0IHx8IHRoaXMud3JhcHBlckhlaWdodCB8fCAxKSksIDgpOwoJCQkJdGhpcy5pbmRpY2F0b3JTdHlsZS5oZWlnaHQgPSB0aGlzLmluZGljYXRvckhlaWdodCArICdweCc7CgoJCQkJdGhpcy5tYXhQb3NZID0gdGhpcy53cmFwcGVySGVpZ2h0IC0gdGhpcy5pbmRpY2F0b3JIZWlnaHQ7CgoJCQkJdGhpcy5taW5Cb3VuZGFyeVkgPSAwOwoJCQkJdGhpcy5tYXhCb3VuZGFyeVkgPSB0aGlzLm1heFBvc1k7CgoJCQkJdGhpcy5zaXplUmF0aW9ZID0gdGhpcy5vcHRpb25zLnNwZWVkUmF0aW9ZIHx8ICh0aGlzLnNjcm9sbGVyLm1heFNjcm9sbFkgJiYgKHRoaXMubWF4UG9zWSAvIHRoaXMuc2Nyb2xsZXIubWF4U2Nyb2xsWSkpOwoJCQl9CgoJCQl0aGlzLnVwZGF0ZVBvc2l0aW9uKCk7CgkJfSwKCgkJdXBkYXRlUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQl2YXIgeCA9IHRoaXMub3B0aW9ucy5saXN0ZW5YICYmIE1hdGgucm91bmQodGhpcy5zaXplUmF0aW9YICogdGhpcy5zY3JvbGxlci54KSB8fCAwLAoJCQkJeSA9IHRoaXMub3B0aW9ucy5saXN0ZW5ZICYmIE1hdGgucm91bmQodGhpcy5zaXplUmF0aW9ZICogdGhpcy5zY3JvbGxlci55KSB8fCAwOwoKCQkJaWYgKHggPCB0aGlzLm1pbkJvdW5kYXJ5WCkgewoJCQkJdGhpcy53aWR0aCA9IE1hdGgubWF4KHRoaXMuaW5kaWNhdG9yV2lkdGggKyB4LCA4KTsKCQkJCXRoaXMuaW5kaWNhdG9yU3R5bGUud2lkdGggPSB0aGlzLndpZHRoICsgJ3B4JzsKCQkJCXggPSB0aGlzLm1pbkJvdW5kYXJ5WDsKCQkJfSBlbHNlIGlmICh4ID4gdGhpcy5tYXhCb3VuZGFyeVgpIHsKCQkJCXRoaXMud2lkdGggPSBNYXRoLm1heCh0aGlzLmluZGljYXRvcldpZHRoIC0gKHggLSB0aGlzLm1heFBvc1gpLCA4KTsKCQkJCXRoaXMuaW5kaWNhdG9yU3R5bGUud2lkdGggPSB0aGlzLndpZHRoICsgJ3B4JzsKCQkJCXggPSB0aGlzLm1heFBvc1ggKyB0aGlzLmluZGljYXRvcldpZHRoIC0gdGhpcy53aWR0aDsKCQkJfSBlbHNlIGlmICh0aGlzLndpZHRoICE9IHRoaXMuaW5kaWNhdG9yV2lkdGgpIHsKCQkJCXRoaXMud2lkdGggPSB0aGlzLmluZGljYXRvcldpZHRoOwoJCQkJdGhpcy5pbmRpY2F0b3JTdHlsZS53aWR0aCA9IHRoaXMud2lkdGggKyAncHgnOwoJCQl9CgoJCQlpZiAoeSA8IHRoaXMubWluQm91bmRhcnlZKSB7CgkJCQl0aGlzLmhlaWdodCA9IE1hdGgubWF4KHRoaXMuaW5kaWNhdG9ySGVpZ2h0ICsgeSAqIDMsIDgpOwoJCQkJdGhpcy5pbmRpY2F0b3JTdHlsZS5oZWlnaHQgPSB0aGlzLmhlaWdodCArICdweCc7CgkJCQl5ID0gdGhpcy5taW5Cb3VuZGFyeVk7CgkJCX0gZWxzZSBpZiAoeSA+IHRoaXMubWF4Qm91bmRhcnlZKSB7CgkJCQl0aGlzLmhlaWdodCA9IE1hdGgubWF4KHRoaXMuaW5kaWNhdG9ySGVpZ2h0IC0gKHkgLSB0aGlzLm1heFBvc1kpICogMywgOCk7CgkJCQl0aGlzLmluZGljYXRvclN0eWxlLmhlaWdodCA9IHRoaXMuaGVpZ2h0ICsgJ3B4JzsKCQkJCXkgPSB0aGlzLm1heFBvc1kgKyB0aGlzLmluZGljYXRvckhlaWdodCAtIHRoaXMuaGVpZ2h0OwoJCQl9IGVsc2UgaWYgKHRoaXMuaGVpZ2h0ICE9IHRoaXMuaW5kaWNhdG9ySGVpZ2h0KSB7CgkJCQl0aGlzLmhlaWdodCA9IHRoaXMuaW5kaWNhdG9ySGVpZ2h0OwoJCQkJdGhpcy5pbmRpY2F0b3JTdHlsZS5oZWlnaHQgPSB0aGlzLmhlaWdodCArICdweCc7CgkJCX0KCgkJCXRoaXMueCA9IHg7CgkJCXRoaXMueSA9IHk7CgoJCQl0aGlzLmluZGljYXRvclN0eWxlWyd3ZWJraXRUcmFuc2Zvcm0nXSA9IHRoaXMuc2Nyb2xsZXIuX2dldFRyYW5zbGF0ZVN0cih4LCB5KTsKCgkJfSwKCQlmYWRlOiBmdW5jdGlvbih2YWwsIGhvbGQpIHsKCQkJaWYgKGhvbGQgJiYgIXRoaXMudmlzaWJsZSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQljbGVhclRpbWVvdXQodGhpcy5mYWRlVGltZW91dCk7CgkJCXRoaXMuZmFkZVRpbWVvdXQgPSBudWxsOwoKCQkJdmFyIHRpbWUgPSB2YWwgPyAyNTAgOiA1MDAsCgkJCQlkZWxheSA9IHZhbCA/IDAgOiAzMDA7CgoJCQl2YWwgPSB2YWwgPyAnMScgOiAnMCc7CgoJCQl0aGlzLndyYXBwZXJTdHlsZVsnd2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uJ10gPSB0aW1lICsgJ21zJzsKCgkJCXRoaXMuZmFkZVRpbWVvdXQgPSBzZXRUaW1lb3V0KChmdW5jdGlvbih2YWwpIHsKCQkJCXRoaXMud3JhcHBlclN0eWxlLm9wYWNpdHkgPSB2YWw7CgkJCQl0aGlzLnZpc2libGUgPSArdmFsOwoJCQl9KS5iaW5kKHRoaXMsIHZhbCksIGRlbGF5KTsKCQl9Cgl9OwoKCSQuU2Nyb2xsID0gU2Nyb2xsOwoKCSQuZm4uc2Nyb2xsID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCXZhciBzY3JvbGxBcGlzID0gW107CgkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgc2Nyb2xsQXBpID0gbnVsbDsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQl2YXIgaWQgPSBzZWxmLmdldEF0dHJpYnV0ZSgnZGF0YS1zY3JvbGwnKTsKCQkJaWYgKCFpZCkgewoJCQkJaWQgPSArKyQudXVpZDsKCQkJCXZhciBfb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCBvcHRpb25zKTsKCQkJCWlmIChzZWxmLmNsYXNzTGlzdC5jb250YWlucygnbXVpLXNlZ21lbnRlZC1jb250cm9sJykpIHsKCQkJCQlfb3B0aW9ucyA9ICQuZXh0ZW5kKF9vcHRpb25zLCB7CgkJCQkJCXNjcm9sbFk6IGZhbHNlLAoJCQkJCQlzY3JvbGxYOiB0cnVlLAoJCQkJCQlpbmRpY2F0b3JzOiBmYWxzZSwKCQkJCQkJc25hcDogJy5tdWktY29udHJvbC1pdGVtJwoJCQkJCX0pOwoJCQkJfQoJCQkJJC5kYXRhW2lkXSA9IHNjcm9sbEFwaSA9IG5ldyBTY3JvbGwoc2VsZiwgX29wdGlvbnMpOwoJCQkJc2VsZi5zZXRBdHRyaWJ1dGUoJ2RhdGEtc2Nyb2xsJywgaWQpOwoJCQl9IGVsc2UgewoJCQkJc2Nyb2xsQXBpID0gJC5kYXRhW2lkXTsKCQkJfQoJCQlzY3JvbGxBcGlzLnB1c2goc2Nyb2xsQXBpKTsKCQl9KTsKCQlyZXR1cm4gc2Nyb2xsQXBpcy5sZW5ndGggPT09IDEgPyBzY3JvbGxBcGlzWzBdIDogc2Nyb2xsQXBpczsKCX07Cn0pKG11aSwgd2luZG93LCBkb2N1bWVudCk7CihmdW5jdGlvbigkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpIHsKCiAgICB2YXIgQ0xBU1NfVklTSUJJTElUWSA9ICdtdWktdmlzaWJpbGl0eSc7CiAgICB2YXIgQ0xBU1NfSElEREVOID0gJ211aS1oaWRkZW4nOwoKICAgIHZhciBQdWxsUmVmcmVzaCA9ICQuU2Nyb2xsLmV4dGVuZCgkLmV4dGVuZCh7CiAgICAgICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5fc3VwZXIoZSk7CiAgICAgICAgICAgIGlmIChlLnR5cGUgPT09ICdzY3JvbGxib3R0b20nKSB7CiAgICAgICAgICAgICAgICBpZiAoZS50YXJnZXQgPT09IHRoaXMuc2Nyb2xsZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zY3JvbGxib3R0b20oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgX3Njcm9sbGJvdHRvbTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5wdWxsZG93biAmJiAhdGhpcy5sb2FkaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1bGxkb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLl9pbml0UHVsbHVwUmVmcmVzaCgpOwogICAgICAgICAgICAgICAgdGhpcy5wdWxsdXBMb2FkaW5nKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIF9zdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAvL+S7heS4i+aLieWIt+aWsOWcqHN0YXJ06Zi75q2i6buY6K6k5LqL5Lu2CiAgICAgICAgICAgIGlmIChlLnRvdWNoZXMgJiYgZS50b3VjaGVzLmxlbmd0aCAmJiBlLnRvdWNoZXNbMF0uY2xpZW50WCA+IDMwKSB7CiAgICAgICAgICAgICAgICBlLnRhcmdldCAmJiAhdGhpcy5fcHJldmVudERlZmF1bHRFeGNlcHRpb24oZS50YXJnZXQsIHRoaXMub3B0aW9ucy5wcmV2ZW50RGVmYXVsdEV4Y2VwdGlvbikgJiYgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdGhpcy5sb2FkaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1bGxkb3duID0gdGhpcy5wdWxsUG9ja2V0ID0gdGhpcy5wdWxsQ2FwdGlvbiA9IHRoaXMucHVsbExvYWRpbmcgPSBmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3N1cGVyKGUpOwogICAgICAgIH0sCiAgICAgICAgX2RyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgaWYgKHRoaXMueSA+PSAwICYmIHRoaXMuZGlzYWJsZVB1bGxkb3duICYmIGUuZGV0YWlsLmRpcmVjdGlvbiA9PT0gJ2Rvd24nKSB7IC8v56aB55So5LiL5ouJ5Yi35pawCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fc3VwZXIoZSk7CiAgICAgICAgICAgIGlmICghdGhpcy5wdWxsZG93biAmJiAhdGhpcy5sb2FkaW5nICYmIHRoaXMudG9wUG9ja2V0ICYmIGUuZGV0YWlsLmRpcmVjdGlvbiA9PT0gJ2Rvd24nICYmIHRoaXMueSA+PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9pbml0UHVsbGRvd25SZWZyZXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMucHVsbGRvd24pIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NldENhcHRpb24odGhpcy55ID4gdGhpcy5vcHRpb25zLmRvd24uaGVpZ2h0ID8gdGhpcy5vcHRpb25zLmRvd24uY29udGVudG92ZXIgOiB0aGlzLm9wdGlvbnMuZG93bi5jb250ZW50ZG93bik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfcmVMYXlvdXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmhhc1ZlcnRpY2FsU2Nyb2xsID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fc3VwZXIoKTsKICAgICAgICB9LAogICAgICAgIC8vQVBJCiAgICAgICAgcmVzZXRQb3NpdGlvbjogZnVuY3Rpb24odGltZSkgewogICAgICAgICAgICBpZiAodGhpcy5wdWxsZG93biAmJiAhdGhpcy5kaXNhYmxlUHVsbGRvd24pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnkgPj0gdGhpcy5vcHRpb25zLmRvd24uaGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wdWxsZG93bkxvYWRpbmcodW5kZWZpbmVkLCB0aW1lIHx8IDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAhdGhpcy5sb2FkaW5nICYmIHRoaXMudG9wUG9ja2V0LmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfVklTSUJJTElUWSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N1cGVyKHRpbWUpOwogICAgICAgIH0sCiAgICAgICAgcHVsbGRvd25Mb2FkaW5nOiBmdW5jdGlvbih5LCB0aW1lKSB7CiAgICAgICAgICAgIHR5cGVvZiB5ID09PSAndW5kZWZpbmVkJyAmJiAoeSA9IHRoaXMub3B0aW9ucy5kb3duLmhlaWdodCk7IC8v6buY6K6k6auY5bqmCiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG8oMCwgeSwgdGltZSwgdGhpcy5vcHRpb25zLmJvdW5jZUVhc2luZyk7CiAgICAgICAgICAgIGlmICh0aGlzLmxvYWRpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLwkJCWlmICghdGhpcy5wdWxsZG93bikgewogICAgICAgICAgICB0aGlzLl9pbml0UHVsbGRvd25SZWZyZXNoKCk7CiAgICAgICAgICAgIC8vCQkJfQogICAgICAgICAgICB0aGlzLl9zZXRDYXB0aW9uKHRoaXMub3B0aW9ucy5kb3duLmNvbnRlbnRyZWZyZXNoKTsKICAgICAgICAgICAgdGhpcy5sb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pbmRpY2F0b3JzLm1hcChmdW5jdGlvbihpbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGluZGljYXRvci5mYWRlKDApOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gdGhpcy5vcHRpb25zLmRvd24uY2FsbGJhY2s7CiAgICAgICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcyk7CiAgICAgICAgfSwKICAgICAgICBlbmRQdWxsZG93blRvUmVmcmVzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgaWYgKHNlbGYudG9wUG9ja2V0ICYmIHNlbGYubG9hZGluZyAmJiB0aGlzLnB1bGxkb3duKSB7CiAgICAgICAgICAgICAgICBzZWxmLnNjcm9sbFRvKDAsIDAsIHNlbGYub3B0aW9ucy5ib3VuY2VUaW1lLCBzZWxmLm9wdGlvbnMuYm91bmNlRWFzaW5nKTsKICAgICAgICAgICAgICAgIHNlbGYubG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgc2VsZi5fc2V0Q2FwdGlvbihzZWxmLm9wdGlvbnMuZG93bi5jb250ZW50ZG93biwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHNlbGYubG9hZGluZyB8fCBzZWxmLnRvcFBvY2tldC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX1ZJU0lCSUxJVFkpOwogICAgICAgICAgICAgICAgfSwgMzUwKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHVsbHVwTG9hZGluZzogZnVuY3Rpb24oY2FsbGJhY2ssIHgsIHRpbWUpIHsKICAgICAgICAgICAgeCA9IHggfHwgMDsKICAgICAgICAgICAgdGhpcy5zY3JvbGxUbyh4LCB0aGlzLm1heFNjcm9sbFksIHRpbWUsIHRoaXMub3B0aW9ucy5ib3VuY2VFYXNpbmcpOwogICAgICAgICAgICBpZiAodGhpcy5sb2FkaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5faW5pdFB1bGx1cFJlZnJlc2goKTsKICAgICAgICAgICAgdGhpcy5fc2V0Q2FwdGlvbih0aGlzLm9wdGlvbnMudXAuY29udGVudHJlZnJlc2gpOwogICAgICAgICAgICB0aGlzLmluZGljYXRvcnMubWFwKGZ1bmN0aW9uKGluZGljYXRvcikgewogICAgICAgICAgICAgICAgaW5kaWNhdG9yLmZhZGUoMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmxvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IHRoaXMub3B0aW9ucy51cC5jYWxsYmFjazsKICAgICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suY2FsbCh0aGlzKTsKICAgICAgICB9LAogICAgICAgIGVuZFB1bGx1cFRvUmVmcmVzaDogZnVuY3Rpb24oZmluaXNoZWQpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICBpZiAoc2VsZi5ib3R0b21Qb2NrZXQpIHsgLy8gJiYgc2VsZi5sb2FkaW5nICYmICF0aGlzLnB1bGxkb3duCiAgICAgICAgICAgICAgICBzZWxmLmxvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NldENhcHRpb24oc2VsZi5vcHRpb25zLnVwLmNvbnRlbnRub21vcmUpOwogICAgICAgICAgICAgICAgICAgIC8vCQkJCQlzZWxmLmJvdHRvbVBvY2tldC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX1ZJU0lCSUxJVFkpOwogICAgICAgICAgICAgICAgICAgIC8vCQkJCQlzZWxmLmJvdHRvbVBvY2tldC5jbGFzc0xpc3QuYWRkKENMQVNTX0hJRERFTik7CiAgICAgICAgICAgICAgICAgICAgc2VsZi53cmFwcGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbGJvdHRvbScsIHNlbGYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRDYXB0aW9uKHNlbGYub3B0aW9ucy51cC5jb250ZW50ZG93bik7CiAgICAgICAgICAgICAgICAgICAgLy8JCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2FkaW5nIHx8IHNlbGYuYm90dG9tUG9ja2V0LmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfVklTSUJJTElUWSk7CiAgICAgICAgICAgICAgICAgICAgLy8JCQkJCX0sIDMwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGRpc2FibGVQdWxsdXBUb1JlZnJlc2g6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLl9pbml0UHVsbHVwUmVmcmVzaCgpOwogICAgICAgICAgICB0aGlzLmJvdHRvbVBvY2tldC5jbGFzc05hbWUgPSAnbXVpLXB1bGwtYm90dG9tLXBvY2tldCcgKyAnICcgKyBDTEFTU19ISURERU47CiAgICAgICAgICAgIHRoaXMud3JhcHBlci5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGxib3R0b20nLCB0aGlzKTsKICAgICAgICB9LAogICAgICAgIGRpc2FibGVQdWxsZG93blRvUmVmcmVzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuX2luaXRQdWxsZG93blJlZnJlc2goKTsKICAgICAgICAgICAgdGhpcy50b3BQb2NrZXQuY2xhc3NOYW1lID0gJ211aS1wdWxsLXRvcC1wb2NrZXQnICsgJyAnICsgQ0xBU1NfSElEREVOOwogICAgICAgICAgICB0aGlzLmRpc2FibGVQdWxsZG93biA9IHRydWU7CiAgICAgICAgfSwKICAgICAgICBlbmFibGVQdWxsZG93blRvUmVmcmVzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuX2luaXRQdWxsZG93blJlZnJlc2goKTsKICAgICAgICAgICAgdGhpcy50b3BQb2NrZXQuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19ISURERU4pOwogICAgICAgICAgICB0aGlzLl9zZXRDYXB0aW9uKHRoaXMub3B0aW9ucy5kb3duLmNvbnRlbnRkb3duKTsKICAgICAgICAgICAgdGhpcy5kaXNhYmxlUHVsbGRvd24gPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIGVuYWJsZVB1bGx1cFRvUmVmcmVzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuX2luaXRQdWxsdXBSZWZyZXNoKCk7CiAgICAgICAgICAgIHRoaXMuYm90dG9tUG9ja2V0LmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfSElEREVOKTsKICAgICAgICAgICAgdGhpcy5fc2V0Q2FwdGlvbih0aGlzLm9wdGlvbnMudXAuY29udGVudGRvd24pOwogICAgICAgICAgICB0aGlzLndyYXBwZXIuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsYm90dG9tJywgdGhpcyk7CiAgICAgICAgfSwKICAgICAgICByZWZyZXNoOiBmdW5jdGlvbihpc1Jlc2V0KSB7CiAgICAgICAgICAgIGlmIChpc1Jlc2V0ICYmIHRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5hYmxlUHVsbHVwVG9SZWZyZXNoKCk7CiAgICAgICAgICAgICAgICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fc3VwZXIoKTsKICAgICAgICB9LAogICAgfSwgJC5QdWxsUmVmcmVzaCkpOwogICAgJC5mbi5wdWxsUmVmcmVzaCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAodGhpcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzWzBdOwogICAgICAgICAgICB2YXIgcHVsbFJlZnJlc2hBcGkgPSBudWxsOwogICAgICAgICAgICB2YXIgaWQgPSBzZWxmLmdldEF0dHJpYnV0ZSgnZGF0YS1wdWxscmVmcmVzaCcpOwogICAgICAgICAgICBpZiAoIWlkICYmIHR5cGVvZiBvcHRpb25zID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICBpZiAoIWlkKSB7CiAgICAgICAgICAgICAgICBpZCA9ICsrJC51dWlkOwogICAgICAgICAgICAgICAgJC5kYXRhW2lkXSA9IHB1bGxSZWZyZXNoQXBpID0gbmV3IFB1bGxSZWZyZXNoKHNlbGYsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgc2VsZi5zZXRBdHRyaWJ1dGUoJ2RhdGEtcHVsbHJlZnJlc2gnLCBpZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwdWxsUmVmcmVzaEFwaSA9ICQuZGF0YVtpZF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMuZG93biAmJiBvcHRpb25zLmRvd24uYXV0bykgeyAvL+WmguaenOiuvue9ruS6hmF1dG/vvIzliJnoh6rliqjkuIvmi4nkuIDmrKEKICAgICAgICAgICAgICAgIHB1bGxSZWZyZXNoQXBpLnB1bGxkb3duTG9hZGluZyhvcHRpb25zLmRvd24uYXV0b1kpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMudXAgJiYgb3B0aW9ucy51cC5hdXRvKSB7IC8v5aaC5p6c6K6+572u5LqGYXV0b++8jOWImeiHquWKqOS4iuaLieS4gOasoQogICAgICAgICAgICAgICAgcHVsbFJlZnJlc2hBcGkucHVsbHVwTG9hZGluZygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8v5pqC5LiN5o+Q5L6b6L+Z56eN6LCD55So5pa55byP5ZCnCQkJCiAgICAgICAgICAgIC8vCQkJaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAvLwkJCQl2YXIgbWV0aG9kVmFsdWUgPSBwdWxsUmVmcmVzaEFwaVtvcHRpb25zXS5hcHBseShwdWxsUmVmcmVzaEFwaSwgJC5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgICAgICAgICAvLwkJCQlpZiAobWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAvLwkJCQkJcmV0dXJuIG1ldGhvZFZhbHVlOwogICAgICAgICAgICAvLwkJCQl9CiAgICAgICAgICAgIC8vCQkJfQogICAgICAgICAgICByZXR1cm4gcHVsbFJlZnJlc2hBcGk7CiAgICAgICAgfQogICAgfTsKfSkobXVpLCB3aW5kb3csIGRvY3VtZW50KTsKLyoqCiAqIHNuYXAg6YeN5p6ECiAqIEBwYXJhbSB7T2JqZWN0fSAkCiAqIEBwYXJhbSB7T2JqZWN0fSB3aW5kb3cKICovCihmdW5jdGlvbigkLCB3aW5kb3cpIHsKCXZhciBDTEFTU19TTElERVIgPSAnbXVpLXNsaWRlcic7Cgl2YXIgQ0xBU1NfU0xJREVSX0dST1VQID0gJ211aS1zbGlkZXItZ3JvdXAnOwoJdmFyIENMQVNTX1NMSURFUl9MT09QID0gJ211aS1zbGlkZXItbG9vcCc7Cgl2YXIgQ0xBU1NfU0xJREVSX0lORElDQVRPUiA9ICdtdWktc2xpZGVyLWluZGljYXRvcic7Cgl2YXIgQ0xBU1NfQUNUSU9OX1BSRVZJT1VTID0gJ211aS1hY3Rpb24tcHJldmlvdXMnOwoJdmFyIENMQVNTX0FDVElPTl9ORVhUID0gJ211aS1hY3Rpb24tbmV4dCc7Cgl2YXIgQ0xBU1NfU0xJREVSX0lURU0gPSAnbXVpLXNsaWRlci1pdGVtJzsKCgl2YXIgQ0xBU1NfQUNUSVZFID0gJ211aS1hY3RpdmUnOwoKCXZhciBTRUxFQ1RPUl9TTElERVJfSVRFTSA9ICcuJyArIENMQVNTX1NMSURFUl9JVEVNOwoJdmFyIFNFTEVDVE9SX1NMSURFUl9JTkRJQ0FUT1IgPSAnLicgKyBDTEFTU19TTElERVJfSU5ESUNBVE9SOwoJdmFyIFNFTEVDVE9SX1NMSURFUl9QUk9HUkVTU19CQVIgPSAnLm11aS1zbGlkZXItcHJvZ3Jlc3MtYmFyJzsKCgl2YXIgU2xpZGVyID0gJC5TbGlkZXIgPSAkLlNjcm9sbC5leHRlbmQoewoJCWluaXQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKCQkJdGhpcy5fc3VwZXIoZWxlbWVudCwgJC5leHRlbmQodHJ1ZSwgewoJCQkJZmluZ2VyczogMSwKCQkJCWludGVydmFsOiAwLCAvL+iuvue9ruS4ujDvvIzliJnkuI3lrprml7bova7mkq0KCQkJCXNjcm9sbFk6IGZhbHNlLAoJCQkJc2Nyb2xsWDogdHJ1ZSwKCQkJCWluZGljYXRvcnM6IGZhbHNlLAoJCQkJc2Nyb2xsVGltZTogMTAwMCwKCQkJCXN0YXJ0WDogZmFsc2UsCgkJCQlzbGlkZVRpbWU6IDAsIC8v5ruR5Yqo5Yqo55S75pe26Ze0CgkJCQlzbmFwOiBTRUxFQ1RPUl9TTElERVJfSVRFTQoJCQl9LCBvcHRpb25zKSk7CgkJCWlmICh0aGlzLm9wdGlvbnMuc3RhcnRYKSB7CgkJCQkvLwkJCQkkLnRyaWdnZXIodGhpcy53cmFwcGVyLCAnc2Nyb2xsZW5kJywgdGhpcyk7CgkJCX0KCQl9LAoJCV9pbml0OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fcmVJbml0KCk7CgkJCWlmICh0aGlzLnNjcm9sbGVyKSB7CgkJCQl0aGlzLnNjcm9sbGVyU3R5bGUgPSB0aGlzLnNjcm9sbGVyLnN0eWxlOwoJCQkJdGhpcy5wcm9ncmVzc0JhciA9IHRoaXMud3JhcHBlci5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX1NMSURFUl9QUk9HUkVTU19CQVIpOwoJCQkJaWYgKHRoaXMucHJvZ3Jlc3NCYXIpIHsKCQkJCQl0aGlzLnByb2dyZXNzQmFyV2lkdGggPSB0aGlzLnByb2dyZXNzQmFyLm9mZnNldFdpZHRoOwoJCQkJCXRoaXMucHJvZ3Jlc3NCYXJTdHlsZSA9IHRoaXMucHJvZ3Jlc3NCYXIuc3R5bGU7CgkJCQl9CgkJCQkvL+W/mOiusOi/meS4quS7o+eggeaYr+W5suS7gOS5iOeahOS6hu+8nwoJCQkJLy8JCQkJdGhpcy54ID0gdGhpcy5fZ2V0U2Nyb2xsKCk7CgkJCQkvLwkJCQlpZiAodGhpcy5vcHRpb25zLnN0YXJ0WCA9PT0gZmFsc2UpIHsKCQkJCS8vCQkJCQl0aGlzLm9wdGlvbnMuc3RhcnRYID0gdGhpcy54OwoJCQkJLy8JCQkJfQoJCQkJLy/moLnmja5hY3RpdmXkv67mraNzdGFydFgKCgkJCQl0aGlzLl9zdXBlcigpOwoJCQkJdGhpcy5faW5pdFRpbWVyKCk7CgkJCX0KCQl9LAoJCV90cmlnZ2VyU2xpZGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCXNlbGYuaXNJblRyYW5zaXRpb24gPSBmYWxzZTsKCQkJdmFyIHBhZ2UgPSBzZWxmLmN1cnJlbnRQYWdlOwoJCQlzZWxmLnNsaWRlTnVtYmVyID0gc2VsZi5fZml4ZWRTbGlkZU51bWJlcigpOwoJCQlpZiAoc2VsZi5sb29wKSB7CgkJCQlpZiAoc2VsZi5zbGlkZU51bWJlciA9PT0gMCkgewoJCQkJCXNlbGYuc2V0VHJhbnNsYXRlKHNlbGYucGFnZXNbMV1bMF0ueCwgMCk7CgkJCQl9IGVsc2UgaWYgKHNlbGYuc2xpZGVOdW1iZXIgPT09IHNlbGYuaXRlbUxlbmd0aCAtIDMpIHsKCQkJCQlzZWxmLnNldFRyYW5zbGF0ZShzZWxmLnBhZ2VzW3NlbGYuaXRlbUxlbmd0aCAtIDJdWzBdLngsIDApOwoJCQkJfQoJCQl9CgkJCWlmIChzZWxmLmxhc3RTbGlkZU51bWJlciAhPSBzZWxmLnNsaWRlTnVtYmVyKSB7CgkJCQlzZWxmLmxhc3RTbGlkZU51bWJlciA9IHNlbGYuc2xpZGVOdW1iZXI7CgkJCQlzZWxmLmxhc3RQYWdlID0gc2VsZi5jdXJyZW50UGFnZTsKCQkJCSQudHJpZ2dlcihzZWxmLndyYXBwZXIsICdzbGlkZScsIHsKCQkJCQlzbGlkZU51bWJlcjogc2VsZi5zbGlkZU51bWJlcgoJCQkJfSk7CgkJCX0KCQkJc2VsZi5faW5pdFRpbWVyKCk7CgkJfSwKCQlfaGFuZGxlU2xpZGU6IGZ1bmN0aW9uKGUpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQlpZiAoZS50YXJnZXQgIT09IHNlbGYud3JhcHBlcikgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXZhciBkZXRhaWwgPSBlLmRldGFpbDsKCQkJZGV0YWlsLnNsaWRlTnVtYmVyID0gZGV0YWlsLnNsaWRlTnVtYmVyIHx8IDA7CgkJCXZhciB0ZW1wcyA9IHNlbGYuc2Nyb2xsZXIucXVlcnlTZWxlY3RvckFsbChTRUxFQ1RPUl9TTElERVJfSVRFTSk7CgkJCXZhciBpdGVtcyA9IFtdOwoJCQlmb3IgKHZhciBpID0gMCwgbGVuID0gdGVtcHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCXZhciBpdGVtID0gdGVtcHNbaV07CgkJCQlpZiAoaXRlbS5wYXJlbnROb2RlID09PSBzZWxmLnNjcm9sbGVyKSB7CgkJCQkJaXRlbXMucHVzaChpdGVtKTsKCQkJCX0KCQkJfQoJCQl2YXIgX3NsaWRlTnVtYmVyID0gZGV0YWlsLnNsaWRlTnVtYmVyOwoJCQlpZiAoc2VsZi5sb29wKSB7CgkJCQlfc2xpZGVOdW1iZXIgKz0gMTsKCQkJfQoJCQlpZiAoIXNlbGYud3JhcHBlci5jbGFzc0xpc3QuY29udGFpbnMoJ211aS1zZWdtZW50ZWQtY29udHJvbCcpKSB7CgkJCQlmb3IgKHZhciBpID0gMCwgbGVuID0gaXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQl2YXIgaXRlbSA9IGl0ZW1zW2ldOwoJCQkJCWlmIChpdGVtLnBhcmVudE5vZGUgPT09IHNlbGYuc2Nyb2xsZXIpIHsKCQkJCQkJaWYgKGkgPT09IF9zbGlkZU51bWJlcikgewoJCQkJCQkJaXRlbS5jbGFzc0xpc3QuYWRkKENMQVNTX0FDVElWRSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlpdGVtLmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfQUNUSVZFKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCQl2YXIgaW5kaWNhdG9yV3JhcCA9IHNlbGYud3JhcHBlci5xdWVyeVNlbGVjdG9yKCcubXVpLXNsaWRlci1pbmRpY2F0b3InKTsKCQkJaWYgKGluZGljYXRvcldyYXApIHsKCQkJCWlmIChpbmRpY2F0b3JXcmFwLmdldEF0dHJpYnV0ZSgnZGF0YS1zY3JvbGwnKSkgeyAvL3Njcm9sbAoJCQkJCSQoaW5kaWNhdG9yV3JhcCkuc2Nyb2xsKCkuZ290b1BhZ2UoZGV0YWlsLnNsaWRlTnVtYmVyKTsKCQkJCX0KCQkJCXZhciBpbmRpY2F0b3JzID0gaW5kaWNhdG9yV3JhcC5xdWVyeVNlbGVjdG9yQWxsKCcubXVpLWluZGljYXRvcicpOwoJCQkJaWYgKGluZGljYXRvcnMubGVuZ3RoID4gMCkgeyAvL+WbvueJh+i9ruaSrQoJCQkJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBpbmRpY2F0b3JzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CgkJCQkJCWluZGljYXRvcnNbaV0uY2xhc3NMaXN0W2kgPT09IGRldGFpbC5zbGlkZU51bWJlciA/ICdhZGQnIDogJ3JlbW92ZSddKENMQVNTX0FDVElWRSk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgbnVtYmVyID0gaW5kaWNhdG9yV3JhcC5xdWVyeVNlbGVjdG9yKCcubXVpLW51bWJlciBzcGFuJyk7CgkJCQkJaWYgKG51bWJlcikgeyAvL+WbvuaWh+ihqOagvAoJCQkJCQludW1iZXIuaW5uZXJUZXh0ID0gKGRldGFpbC5zbGlkZU51bWJlciArIDEpOwoJCQkJCX0gZWxzZSB7IC8vc2VnbWVudGVkIGNvbnRyb2xzCgkJCQkJCXZhciBjb250cm9sSXRlbXMgPSBpbmRpY2F0b3JXcmFwLnF1ZXJ5U2VsZWN0b3JBbGwoJy5tdWktY29udHJvbC1pdGVtJyk7CgkJCQkJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBjb250cm9sSXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQkJCWNvbnRyb2xJdGVtc1tpXS5jbGFzc0xpc3RbaSA9PT0gZGV0YWlsLnNsaWRlTnVtYmVyID8gJ2FkZCcgOiAncmVtb3ZlJ10oQ0xBU1NfQUNUSVZFKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgkJX2hhbmRsZVRhYlNob3c6IGZ1bmN0aW9uKGUpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQlzZWxmLmdvdG9JdGVtKChlLmRldGFpbC50YWJOdW1iZXIgfHwgMCksIHNlbGYub3B0aW9ucy5zbGlkZVRpbWUpOwoJCX0sCgkJX2hhbmRsZUluZGljYXRvclRhcDogZnVuY3Rpb24oZXZlbnQpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQl2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCQlpZiAodGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19BQ1RJT05fUFJFVklPVVMpIHx8IHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfQUNUSU9OX05FWFQpKSB7CgkJCQlzZWxmW3RhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfQUNUSU9OX1BSRVZJT1VTKSA/ICdwcmV2SXRlbScgOiAnbmV4dEl0ZW0nXSgpOwoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9LAoJCV9pbml0RXZlbnQ6IGZ1bmN0aW9uKGRldGFjaCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCXNlbGYuX3N1cGVyKGRldGFjaCk7CgkJCXZhciBhY3Rpb24gPSBkZXRhY2ggPyAncmVtb3ZlRXZlbnRMaXN0ZW5lcicgOiAnYWRkRXZlbnRMaXN0ZW5lcic7CgkJCXNlbGYud3JhcHBlclthY3Rpb25dKCdzbGlkZScsIHRoaXMpOwoJCQlzZWxmLndyYXBwZXJbYWN0aW9uXSgkLmV2ZW50TmFtZSgnc2hvd24nLCAndGFiJyksIHRoaXMpOwoJCX0sCgkJaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uKGUpIHsKCQkJdGhpcy5fc3VwZXIoZSk7CgkJCXN3aXRjaCAoZS50eXBlKSB7CgkJCQljYXNlICdzbGlkZSc6CgkJCQkJdGhpcy5faGFuZGxlU2xpZGUoZSk7CgkJCQkJYnJlYWs7CgkJCQljYXNlICQuZXZlbnROYW1lKCdzaG93bicsICd0YWInKToKCQkJCQlpZiAofnRoaXMuc25hcHMuaW5kZXhPZihlLnRhcmdldCkpIHsgLy/pgb/lhY3ltYzlpZfnm5HlkKzplJnor6/nmoR0YWIgc2hvdwoJCQkJCQl0aGlzLl9oYW5kbGVUYWJTaG93KGUpOwoJCQkJCX0KCQkJCQlicmVhazsKCQkJfQoJCX0sCgkJX3Njcm9sbGVuZDogZnVuY3Rpb24oZSkgewoJCQl0aGlzLl9zdXBlcihlKTsKCQkJdGhpcy5fdHJpZ2dlclNsaWRlKGUpOwoJCX0sCgkJX2RyYWc6IGZ1bmN0aW9uKGUpIHsKCQkJdGhpcy5fc3VwZXIoZSk7CgkJCXZhciBkaXJlY3Rpb24gPSBlLmRldGFpbC5kaXJlY3Rpb247CgkJCWlmIChkaXJlY3Rpb24gPT09ICdsZWZ0JyB8fCBkaXJlY3Rpb24gPT09ICdyaWdodCcpIHsKCQkJCS8v5ouW5ou95pyf6Ze05Y+W5raI5a6a5pe2CgkJCQl2YXIgc2xpZGVyc2hvd1RpbWVyID0gdGhpcy53cmFwcGVyLmdldEF0dHJpYnV0ZSgnZGF0YS1zbGlkZXJzaG93VGltZXInKTsKCQkJCXNsaWRlcnNob3dUaW1lciAmJiB3aW5kb3cuY2xlYXJUaW1lb3V0KHNsaWRlcnNob3dUaW1lcik7CgoJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0sCgkJX2luaXRUaW1lcjogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJdmFyIHNsaWRlciA9IHNlbGYud3JhcHBlcjsKCQkJdmFyIGludGVydmFsID0gc2VsZi5vcHRpb25zLmludGVydmFsOwoJCQl2YXIgc2xpZGVyc2hvd1RpbWVyID0gc2xpZGVyLmdldEF0dHJpYnV0ZSgnZGF0YS1zbGlkZXJzaG93VGltZXInKTsKCQkJc2xpZGVyc2hvd1RpbWVyICYmIHdpbmRvdy5jbGVhclRpbWVvdXQoc2xpZGVyc2hvd1RpbWVyKTsKCQkJaWYgKGludGVydmFsKSB7CgkJCQlzbGlkZXJzaG93VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQlpZiAoIXNsaWRlcikgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCS8v5LuFc2xpZGVy5pi+56S654q25oCB6L+b6KGM6Ieq5Yqo6L2u5pKtCgkJCQkJaWYgKHNsaWRlci5vZmZzZXRXaWR0aCB8fCBzbGlkZXIub2Zmc2V0SGVpZ2h0KSB7CgkJCQkJCXNlbGYubmV4dEl0ZW0odHJ1ZSk7CgkJCQkJCS8v5LiL5LiA5LiqCgkJCQkJfQoJCQkJCXNlbGYuX2luaXRUaW1lcigpOwoJCQkJfSwgaW50ZXJ2YWwpOwoJCQkJc2xpZGVyLnNldEF0dHJpYnV0ZSgnZGF0YS1zbGlkZXJzaG93VGltZXInLCBzbGlkZXJzaG93VGltZXIpOwoJCQl9CgkJfSwKCgkJX2ZpeGVkU2xpZGVOdW1iZXI6IGZ1bmN0aW9uKHBhZ2UpIHsKCQkJcGFnZSA9IHBhZ2UgfHwgdGhpcy5jdXJyZW50UGFnZTsKCQkJdmFyIHNsaWRlTnVtYmVyID0gcGFnZS5wYWdlWDsKCQkJaWYgKHRoaXMubG9vcCkgewoJCQkJaWYgKHBhZ2UucGFnZVggPT09IDApIHsKCQkJCQlzbGlkZU51bWJlciA9IHRoaXMuaXRlbUxlbmd0aCAtIDM7CgkJCQl9IGVsc2UgaWYgKHBhZ2UucGFnZVggPT09ICh0aGlzLml0ZW1MZW5ndGggLSAxKSkgewoJCQkJCXNsaWRlTnVtYmVyID0gMDsKCQkJCX0gZWxzZSB7CgkJCQkJc2xpZGVOdW1iZXIgPSBwYWdlLnBhZ2VYIC0gMTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gc2xpZGVOdW1iZXI7CgkJfSwKCQlfcmVMYXlvdXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmhhc0hvcml6b250YWxTY3JvbGwgPSB0cnVlOwoJCQl0aGlzLmxvb3AgPSB0aGlzLnNjcm9sbGVyLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19TTElERVJfTE9PUCk7CgkJCXRoaXMuX3N1cGVyKCk7CgkJfSwKCQlfZ2V0U2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJdmFyIHJlc3VsdCA9ICQucGFyc2VUcmFuc2xhdGVNYXRyaXgoJC5nZXRTdHlsZXModGhpcy5zY3JvbGxlciwgJ3dlYmtpdFRyYW5zZm9ybScpKTsKCQkJcmV0dXJuIHJlc3VsdCA/IHJlc3VsdC54IDogMDsKCQl9LAoJCV90cmFuc2l0aW9uRW5kOiBmdW5jdGlvbihlKSB7CgkJCWlmIChlLnRhcmdldCAhPT0gdGhpcy5zY3JvbGxlciB8fCAhdGhpcy5pc0luVHJhbnNpdGlvbikgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXRoaXMuX3RyYW5zaXRpb25UaW1lKCk7CgkJCXRoaXMuaXNJblRyYW5zaXRpb24gPSBmYWxzZTsKCQkJJC50cmlnZ2VyKHRoaXMud3JhcHBlciwgJ3Njcm9sbGVuZCcsIHRoaXMpOwoJCX0sCgkJX2ZsaWNrOiBmdW5jdGlvbihlKSB7CgkJCWlmICghdGhpcy5tb3ZlZCkgeyAvL+aXoG1vdmVkCgkJCQlyZXR1cm47CgkJCX0KCQkJdmFyIGRldGFpbCA9IGUuZGV0YWlsOwoJCQl2YXIgZGlyZWN0aW9uID0gZGV0YWlsLmRpcmVjdGlvbjsKCQkJdGhpcy5fY2xlYXJSZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKTsKCQkJdGhpcy5pc0luVHJhbnNpdGlvbiA9IHRydWU7CgkJCS8vCQkJaWYgKGRpcmVjdGlvbiA9PT0gJ3VwJyB8fCBkaXJlY3Rpb24gPT09ICdkb3duJykgewoJCQkvLwkJCQl0aGlzLnJlc2V0UG9zaXRpb24odGhpcy5vcHRpb25zLmJvdW5jZVRpbWUpOwoJCQkvLwkJCQlyZXR1cm47CgkJCS8vCQkJfQoJCQlpZiAoZS50eXBlID09PSAnZmxpY2snKSB7CgkJCQlpZiAoZGV0YWlsLmRlbHRhVGltZSA8IDIwMCkgeyAvL2ZsaWNr77yM5aSq5a655piT6Kem5Y+R77yM6aKd5aSW5qCh6aqM5LiA5LiLZGVsdGFUaW1lCgkJCQkJdGhpcy54ID0gdGhpcy5fZ2V0UGFnZSgodGhpcy5zbGlkZU51bWJlciArIChkaXJlY3Rpb24gPT09ICdyaWdodCcgPyAtMSA6IDEpKSwgdHJ1ZSkueDsKCQkJCX0KCQkJCXRoaXMucmVzZXRQb3NpdGlvbih0aGlzLm9wdGlvbnMuYm91bmNlVGltZSk7CgkJCX0gZWxzZSBpZiAoZS50eXBlID09PSAnZHJhZ2VuZCcgJiYgIWRldGFpbC5mbGljaykgewoJCQkJdGhpcy5yZXNldFBvc2l0aW9uKHRoaXMub3B0aW9ucy5ib3VuY2VUaW1lKTsKCQkJfQoJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCX0sCgkJX2luaXRTbmFwOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zY3JvbGxlcldpZHRoID0gdGhpcy5pdGVtTGVuZ3RoICogdGhpcy5zY3JvbGxlcldpZHRoOwoJCQl0aGlzLm1heFNjcm9sbFggPSBNYXRoLm1pbih0aGlzLndyYXBwZXJXaWR0aCAtIHRoaXMuc2Nyb2xsZXJXaWR0aCwgMCk7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCWlmICghdGhpcy5jdXJyZW50UGFnZS54KSB7CgkJCQkvL+W9k3NsaWRlcuWkhOS6jumakOiXj+eKtuaAgeaXtu+8jOWvvOiHtHNuYXDorqHnrpfmmK/plJnor6/nmoTvvIzkuLTml7blhYjov5nkuYjliKTmlq3kuIDkuIvvvIzlkI7nu63opoHogIPomZHop6PlhrPmiYDmnIlzY3JvbGzlnKjpmpDol4/nirbmgIHkuIvliJ3lp4vljJblsZ7mgKfkuI3mraPnoa7nmoTpl67popgKCQkJCXZhciBjdXJyZW50UGFnZSA9IHRoaXMucGFnZXNbdGhpcy5sb29wID8gMSA6IDBdOwoJCQkJY3VycmVudFBhZ2UgPSBjdXJyZW50UGFnZSB8fCB0aGlzLnBhZ2VzWzBdOwoJCQkJaWYgKCFjdXJyZW50UGFnZSkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXRoaXMuY3VycmVudFBhZ2UgPSBjdXJyZW50UGFnZVswXTsKCQkJCXRoaXMuc2xpZGVOdW1iZXIgPSAwOwoJCQkJdGhpcy5sYXN0U2xpZGVOdW1iZXIgPSB0eXBlb2YgdGhpcy5sYXN0U2xpZGVOdW1iZXIgPT09ICd1bmRlZmluZWQnID8gMCA6IHRoaXMubGFzdFNsaWRlTnVtYmVyOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5zbGlkZU51bWJlciA9IHRoaXMuX2ZpeGVkU2xpZGVOdW1iZXIoKTsKCQkJCXRoaXMubGFzdFNsaWRlTnVtYmVyID0gdHlwZW9mIHRoaXMubGFzdFNsaWRlTnVtYmVyID09PSAndW5kZWZpbmVkJyA/IHRoaXMuc2xpZGVOdW1iZXIgOiB0aGlzLmxhc3RTbGlkZU51bWJlcjsKCQkJfQoJCQl0aGlzLm9wdGlvbnMuc3RhcnRYID0gdGhpcy5jdXJyZW50UGFnZS54IHx8IDA7CgkJfSwKCQlfZ2V0U25hcFg6IGZ1bmN0aW9uKG9mZnNldExlZnQpIHsKCQkJcmV0dXJuIE1hdGgubWF4KC1vZmZzZXRMZWZ0LCB0aGlzLm1heFNjcm9sbFgpOwoJCX0sCgkJX2dldFBhZ2U6IGZ1bmN0aW9uKHNsaWRlTnVtYmVyLCBpc0ZsaWNrKSB7CgkJCWlmICh0aGlzLmxvb3ApIHsKCQkJCWlmIChzbGlkZU51bWJlciA+ICh0aGlzLml0ZW1MZW5ndGggLSAoaXNGbGljayA/IDIgOiAzKSkpIHsKCQkJCQlzbGlkZU51bWJlciA9IDE7CgkJCQkJdGltZSA9IDA7CgkJCQl9IGVsc2UgaWYgKHNsaWRlTnVtYmVyIDwgKGlzRmxpY2sgPyAtMSA6IDApKSB7CgkJCQkJc2xpZGVOdW1iZXIgPSB0aGlzLml0ZW1MZW5ndGggLSAyOwoJCQkJCXRpbWUgPSAwOwoJCQkJfSBlbHNlIHsKCQkJCQlzbGlkZU51bWJlciArPSAxOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJaWYgKCFpc0ZsaWNrKSB7CgkJCQkJaWYgKHNsaWRlTnVtYmVyID4gKHRoaXMuaXRlbUxlbmd0aCAtIDEpKSB7CgkJCQkJCXNsaWRlTnVtYmVyID0gMDsKCQkJCQkJdGltZSA9IDA7CgkJCQkJfSBlbHNlIGlmIChzbGlkZU51bWJlciA8IDApIHsKCQkJCQkJc2xpZGVOdW1iZXIgPSB0aGlzLml0ZW1MZW5ndGggLSAxOwoJCQkJCQl0aW1lID0gMDsKCQkJCQl9CgkJCQl9CgkJCQlzbGlkZU51bWJlciA9IE1hdGgubWluKE1hdGgubWF4KDAsIHNsaWRlTnVtYmVyKSwgdGhpcy5pdGVtTGVuZ3RoIC0gMSk7CgkJCX0KCQkJcmV0dXJuIHRoaXMucGFnZXNbc2xpZGVOdW1iZXJdWzBdOwoJCX0sCgkJX2dvdG9JdGVtOiBmdW5jdGlvbihzbGlkZU51bWJlciwgdGltZSkgewoJCQl0aGlzLmN1cnJlbnRQYWdlID0gdGhpcy5fZ2V0UGFnZShzbGlkZU51bWJlciwgdHJ1ZSk7IC8v5q2k5aSE5LygdHJ1ZeOAguWPr+S/neivgeeoi+W6j+WIh+aNouaXtu+8jOWKqOeUu+S4juS6uuaJi+aTjeS9nOS4gOiHtCjnrKzkuIDlvKDvvIzmnIDlkI7kuIDlvKDnmoTliIfmjaLliqjnlLspCgkJCXRoaXMuc2Nyb2xsVG8odGhpcy5jdXJyZW50UGFnZS54LCAwLCB0aW1lLCB0aGlzLm9wdGlvbnMuc2Nyb2xsRWFzaW5nKTsKCQkJaWYgKHRpbWUgPT09IDApIHsKCQkJCSQudHJpZ2dlcih0aGlzLndyYXBwZXIsICdzY3JvbGxlbmQnLCB0aGlzKTsKCQkJfQoJCX0sCgkJLy9BUEkKCQlzZXRUcmFuc2xhdGU6IGZ1bmN0aW9uKHgsIHkpIHsKCQkJdGhpcy5fc3VwZXIoeCwgeSk7CgkJCXZhciBwcm9ncmVzc0JhciA9IHRoaXMucHJvZ3Jlc3NCYXI7CgkJCWlmIChwcm9ncmVzc0JhcikgewoJCQkJdGhpcy5wcm9ncmVzc0JhclN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IHRoaXMuX2dldFRyYW5zbGF0ZVN0cigoLXggKiAodGhpcy5wcm9ncmVzc0JhcldpZHRoIC8gdGhpcy53cmFwcGVyV2lkdGgpKSwgMCk7CgkJCX0KCQl9LAoJCXJlc2V0UG9zaXRpb246IGZ1bmN0aW9uKHRpbWUpIHsKCQkJdGltZSA9IHRpbWUgfHwgMDsKCQkJaWYgKHRoaXMueCA+IDApIHsKCQkJCXRoaXMueCA9IDA7CgkJCX0gZWxzZSBpZiAodGhpcy54IDwgdGhpcy5tYXhTY3JvbGxYKSB7CgkJCQl0aGlzLnggPSB0aGlzLm1heFNjcm9sbFg7CgkJCX0KCQkJdGhpcy5jdXJyZW50UGFnZSA9IHRoaXMuX25lYXJlc3RTbmFwKHRoaXMueCk7CgkJCXRoaXMuc2Nyb2xsVG8odGhpcy5jdXJyZW50UGFnZS54LCAwLCB0aW1lLCB0aGlzLm9wdGlvbnMuc2Nyb2xsRWFzaW5nKTsKCQkJcmV0dXJuIHRydWU7CgkJfSwKCQlnb3RvSXRlbTogZnVuY3Rpb24oc2xpZGVOdW1iZXIsIHRpbWUpIHsKCQkJdGhpcy5fZ290b0l0ZW0oc2xpZGVOdW1iZXIsIHR5cGVvZiB0aW1lID09PSAndW5kZWZpbmVkJyA/IHRoaXMub3B0aW9ucy5zY3JvbGxUaW1lIDogdGltZSk7CgkJfSwKCQluZXh0SXRlbTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2dvdG9JdGVtKHRoaXMuc2xpZGVOdW1iZXIgKyAxLCB0aGlzLm9wdGlvbnMuc2Nyb2xsVGltZSk7CgkJfSwKCQlwcmV2SXRlbTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2dvdG9JdGVtKHRoaXMuc2xpZGVOdW1iZXIgLSAxLCB0aGlzLm9wdGlvbnMuc2Nyb2xsVGltZSk7CgkJfSwKCQlnZXRTbGlkZU51bWJlcjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnNsaWRlTnVtYmVyIHx8IDA7CgkJfSwKCQlfcmVJbml0OiBmdW5jdGlvbigpIHsKCQkJdmFyIGdyb3VwcyA9IHRoaXMud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIENMQVNTX1NMSURFUl9HUk9VUCk7CgkJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBncm91cHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCWlmIChncm91cHNbaV0ucGFyZW50Tm9kZSA9PT0gdGhpcy53cmFwcGVyKSB7CgkJCQkJdGhpcy5zY3JvbGxlciA9IGdyb3Vwc1tpXTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCQl0aGlzLnNjcm9sbGVyU3R5bGUgPSB0aGlzLnNjcm9sbGVyICYmIHRoaXMuc2Nyb2xsZXIuc3R5bGU7CgkJCWlmICh0aGlzLnByb2dyZXNzQmFyKSB7CgkJCQl0aGlzLnByb2dyZXNzQmFyV2lkdGggPSB0aGlzLnByb2dyZXNzQmFyLm9mZnNldFdpZHRoOwoJCQkJdGhpcy5wcm9ncmVzc0JhclN0eWxlID0gdGhpcy5wcm9ncmVzc0Jhci5zdHlsZTsKCQkJfQoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24ob3B0aW9ucykgewoJCQlpZiAob3B0aW9ucykgewoJCQkJJC5leHRlbmQodGhpcy5vcHRpb25zLCBvcHRpb25zKTsKCQkJCXRoaXMuX3N1cGVyKCk7CgkJCQl0aGlzLl9pbml0VGltZXIoKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX3N1cGVyKCk7CgkJCX0KCQl9LAoJCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9pbml0RXZlbnQodHJ1ZSk7IC8vZGV0YWNoCgkJCWRlbGV0ZSAkLmRhdGFbdGhpcy53cmFwcGVyLmdldEF0dHJpYnV0ZSgnZGF0YS1zbGlkZXInKV07CgkJCXRoaXMud3JhcHBlci5zZXRBdHRyaWJ1dGUoJ2RhdGEtc2xpZGVyJywgJycpOwoJCX0KCX0pOwoJJC5mbi5zbGlkZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkJdmFyIHNsaWRlciA9IG51bGw7CgkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgc2xpZGVyRWxlbWVudCA9IHRoaXM7CgkJCWlmICghdGhpcy5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfU0xJREVSKSkgewoJCQkJc2xpZGVyRWxlbWVudCA9IHRoaXMucXVlcnlTZWxlY3RvcignLicgKyBDTEFTU19TTElERVIpOwoJCQl9CgkJCWlmIChzbGlkZXJFbGVtZW50ICYmIHNsaWRlckVsZW1lbnQucXVlcnlTZWxlY3RvcihTRUxFQ1RPUl9TTElERVJfSVRFTSkpIHsKCQkJCXZhciBpZCA9IHNsaWRlckVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXNsaWRlcicpOwoJCQkJaWYgKCFpZCkgewoJCQkJCWlkID0gKyskLnV1aWQ7CgkJCQkJJC5kYXRhW2lkXSA9IHNsaWRlciA9IG5ldyBTbGlkZXIoc2xpZGVyRWxlbWVudCwgb3B0aW9ucyk7CgkJCQkJc2xpZGVyRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtc2xpZGVyJywgaWQpOwoJCQkJfSBlbHNlIHsKCQkJCQlzbGlkZXIgPSAkLmRhdGFbaWRdOwoJCQkJCWlmIChzbGlkZXIgJiYgb3B0aW9ucykgewoJCQkJCQlzbGlkZXIucmVmcmVzaChvcHRpb25zKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9KTsKCQlyZXR1cm4gc2xpZGVyOwoJfTsKCSQucmVhZHkoZnVuY3Rpb24oKSB7CgkJLy8JCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJJCgnLm11aS1zbGlkZXInKS5zbGlkZXIoKTsKCQkkKCcubXVpLXNjcm9sbC13cmFwcGVyLm11aS1zbGlkZXItaW5kaWNhdG9yLm11aS1zZWdtZW50ZWQtY29udHJvbCcpLnNjcm9sbCh7CgkJCXNjcm9sbFk6IGZhbHNlLAoJCQlzY3JvbGxYOiB0cnVlLAoJCQlpbmRpY2F0b3JzOiBmYWxzZSwKCQkJc25hcDogJy5tdWktY29udHJvbC1pdGVtJwoJCX0pOwoJCS8vCQl9LCA1MDApOyAvL+S4tOaXtuWkhOeQhnNsaWRlcuWuveW6puiuoeeul+S4jeato+ehrueahOmXrumimCjliJ3mraXnoa7orqTmmK9zY3JvbGxiYXLlr7zoh7TnmoQpCgoJfSk7Cn0pKG11aSwgd2luZG93KTsKLyoqCiAqIHB1bGxSZWZyZXNoIDUrCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQsIGRvY3VtZW50KSB7CiAgICBpZiAoISgkLm9zLnBsdXMpKSB7IC8v5LuF5ZyoNSthbmRyb2lk5pSv5oyB5aSad2Vidmlld+eahOS9v+eUqAogICAgICAgIHJldHVybjsKICAgIH0KICAgICQucGx1c1JlYWR5KGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh3aW5kb3cuX19OV2luX0VuYWJsZV9fID09PSBmYWxzZSkgeyAvL+S4jeaUr+aMgeWkmndlYnZpZXfvvIzliJnkuI3nlKg1K+S4i+aLieWIt+aWsAogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBDTEFTU19QTFVTX1BVTExSRUZSRVNIID0gJ211aS1wbHVzLXB1bGxyZWZyZXNoJzsKICAgICAgICB2YXIgQ0xBU1NfVklTSUJJTElUWSA9ICdtdWktdmlzaWJpbGl0eSc7CiAgICAgICAgdmFyIENMQVNTX0hJRERFTiA9ICdtdWktaGlkZGVuJzsKICAgICAgICB2YXIgQ0xBU1NfQkxPQ0sgPSAnbXVpLWJsb2NrJzsKCiAgICAgICAgdmFyIENMQVNTX1BVTExfQ0FQVElPTiA9ICdtdWktcHVsbC1jYXB0aW9uJzsKICAgICAgICB2YXIgQ0xBU1NfUFVMTF9DQVBUSU9OX0RPV04gPSAnbXVpLXB1bGwtY2FwdGlvbi1kb3duJzsKICAgICAgICB2YXIgQ0xBU1NfUFVMTF9DQVBUSU9OX1JFRlJFU0ggPSAnbXVpLXB1bGwtY2FwdGlvbi1yZWZyZXNoJzsKICAgICAgICB2YXIgQ0xBU1NfUFVMTF9DQVBUSU9OX05PTU9SRSA9ICdtdWktcHVsbC1jYXB0aW9uLW5vbW9yZSc7CgogICAgICAgIHZhciBQbHVzUHVsbFJlZnJlc2ggPSAkLkNsYXNzLmV4dGVuZCh7CiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICAgICAgdGhpcy53cmFwcGVyID0gdGhpcy5zY3JvbGxlciA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICB0aGlzLl9pbml0KCk7CiAgICAgICAgICAgICAgICB0aGlzLl9pbml0UHVsbGRvd25SZWZyZXNoRXZlbnQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2luaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgLy9kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwbHVzc2Nyb2xsYm90dG9tJywgdGhpcyk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ3VwJywgc2VsZik7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJwbHVzc2Nyb2xsYm90dG9tIiwgc2VsZik7CiAgICAgICAgICAgICAgICBzZWxmLnNjcm9sbEludGVydmFsID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmlzU2Nyb2xsICYmICFzZWxmLmxvYWRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5wYWdlWU9mZnNldCArIHdpbmRvdy5pbm5lckhlaWdodCArIDEwID49IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaXNTY3JvbGwgPSBmYWxzZTsgLy/mlL7lnKjov5nph4zmmK/lm6DkuLrlv6vpgJ/mu5rliqjnmoTor53vvIzmnInlj6/og73mo4DmtYvml7bvvIzov5jmsqHliLDlupXvvIzmiYDku6Xlj6ropoHmnInmu5rliqjvvIzmsqHliLDlupXkuYvliY3kuIDnm7Tmo4DmtYvpq5jluqblj5jljJYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmJvdHRvbVBvY2tldCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHVsbHVwTG9hZGluZygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMTAwKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2luaXRQdWxsZG93blJlZnJlc2hFdmVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICAkLnBsdXNSZWFkeShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmRvd24uc3R5bGUgPT0gImNpcmNsZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy/ljZV3ZWJ2aWV344CB5Y6f55Sf6L2s5ZyICiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYub3B0aW9ucy53ZWJ2aWV3ID0gcGx1cy53ZWJ2aWV3LmN1cnJlbnRXZWJ2aWV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYub3B0aW9ucy53ZWJ2aWV3LnNldFB1bGxUb1JlZnJlc2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VwcG9ydDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBzZWxmLm9wdGlvbnMuZG93bi5jb2xvciB8fCAnIzJCRDAwOScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHNlbGYub3B0aW9ucy5kb3duLmhlaWdodCB8fCAnNTBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZTogc2VsZi5vcHRpb25zLmRvd24ucmFuZ2UgfHwgJzEwMHB4JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiAnY2lyY2xlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldDogc2VsZi5vcHRpb25zLmRvd24ub2Zmc2V0IHx8ICcwcHgnCiAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5vcHRpb25zLmRvd24uY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzZWxmLnRvcFBvY2tldCAmJiBzZWxmLm9wdGlvbnMud2Vidmlld0lkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3ZWJ2aWV3ID0gcGx1cy53ZWJ2aWV3LmdldFdlYnZpZXdCeUlkKHNlbGYub3B0aW9ucy53ZWJ2aWV3SWQpOyAvL+WtkOeql+WPowogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXdlYnZpZXcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm9wdGlvbnMud2VidmlldyA9IHdlYnZpZXc7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkb3duT3B0aW9ucyA9IHNlbGYub3B0aW9ucy5kb3duOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0ID0gZG93bk9wdGlvbnMuaGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICB3ZWJ2aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ2Nsb3NlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0cldlYnZpZXdJZCA9IHNlbGYub3B0aW9ucy53ZWJ2aWV3SWQgJiYgc2VsZi5vcHRpb25zLndlYnZpZXdJZC5yZXBsYWNlKC9cLy9nLCAiXyIpOyAvL+abv+aNouaJgOaciSIvIiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2RhdGEtcHVsbHJlZnJlc2gtcGx1cy0nICsgYXR0cldlYnZpZXdJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB3ZWJ2aWV3LmFkZEV2ZW50TGlzdGVuZXIoImRyYWdCb3VuY2UiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNlbGYucHVsbGRvd24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9pbml0UHVsbGRvd25SZWZyZXNoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHVsbFBvY2tldC5jbGFzc0xpc3QuYWRkKENMQVNTX0JMT0NLKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJiZWZvcmVDaGFuZ2VPZmZzZXQiOiAvL+S4i+aLieWPr+WIt+aWsOeKtuaAgQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRDYXB0aW9uKGRvd25PcHRpb25zLmNvbnRlbnRkb3duKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYWZ0ZXJDaGFuZ2VPZmZzZXQiOiAvL+advuW8gOWPr+WIt+aWsOeKtuaAgQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRDYXB0aW9uKGRvd25PcHRpb25zLmNvbnRlbnRvdmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZHJhZ0VuZEFmdGVyQ2hhbmdlT2Zmc2V0IjogLy/mraPlnKjliLfmlrDnirbmgIEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy/miafooYzkuIvmi4nliLfmlrDmiYDlnKh3ZWJ2aWV355qE5Zue6LCD5Ye95pWwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdlYnZpZXcuZXZhbEpTKCJ3aW5kb3cubXVpJiZtdWkub3B0aW9ucy5wdWxsUmVmcmVzaC5kb3duLmNhbGxiYWNrKCkiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0Q2FwdGlvbihkb3duT3B0aW9ucy5jb250ZW50cmVmcmVzaCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICB3ZWJ2aWV3LnNldEJvdW5jZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogaGVpZ2h0ICogMiArICdweCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VvZmZzZXQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IGhlaWdodCArICdweCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBoYW5kbGVFdmVudDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYgKHNlbGYuc3RvcHBlZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGYuaXNTY3JvbGwgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChlLnR5cGUgPT09ICdkcmFndXAnIHx8IGUudHlwZSA9PT0gJ3BsdXNzY3JvbGxib3R0b20nKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5pc1Njcm9sbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pc1Njcm9sbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0sIDEwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSkuZXh0ZW5kKCQuZXh0ZW5kKHsKICAgICAgICAgICAgc2V0U3RvcHBlZDogZnVuY3Rpb24oc3RvcHBlZCkgeyAvL+ivpeaWueazleaYr+WtkOmhtemdouiwg+eUqOeahAogICAgICAgICAgICAgICAgdGhpcy5zdG9wcGVkID0gISFzdG9wcGVkOwogICAgICAgICAgICAgICAgLy8gVE9ETyDmraTlpITpnIDopoHorr7nva7lvZPliY13ZWJ2aWV355qEYm91bmNl5Li6bm9uZSznm67liY01K+aciUJVRwogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RvcHBlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzYWJsZVB1bGx1cFRvUmVmcmVzaCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzYWJsZVB1bGxkb3duVG9SZWZyZXNoKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5hYmxlUHVsbHVwVG9SZWZyZXNoKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmFibGVQdWxsZG93blRvUmVmcmVzaCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBiZWdpblB1bGxkb3duOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgICAgICQucGx1c1JlYWR5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIC8v6L+Z6YeM5bu25pe255qE55uu55qE5piv5Li65LqG5L+d6K+B5LiL5ouJ5Yi35paw57uE5Lu25Yid5aeL5YyW5a6M5oiQ77yM5ZCO57ut5bqU6K+l5YGa5oiQ5pyJ54q25oCB55qECiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5kb3duLnN0eWxlID09ICJjaXJjbGUiKSB7IC8v5Y2Vd2Vidmlld+S4i+aLieWIt+aWsAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGx1cy53ZWJ2aWV3LmN1cnJlbnRXZWJ2aWV3KCkuYmVnaW5QdWxsVG9SZWZyZXNoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8v5Y+Md2Vidmlld+aooeW8jwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdlYnZpZXcgPSBzZWxmLm9wdGlvbnMud2VidmlldzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3ZWJ2aWV3KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2Vidmlldy5zZXRCb3VuY2UoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogc2VsZi5vcHRpb25zLmRvd24uaGVpZ2h0ICsgInB4IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCAxNSk7CiAgICAgICAgICAgICAgICB9LmJpbmQodGhpcykpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBwdWxsZG93bkxvYWRpbmc6IGZ1bmN0aW9uKCkgeyAvL+ivpeaWueazleaYr+WtkOmhtemdouiwg+eUqOeahO+8jOWFvOWuueiAgeeahOWOhuWPskFQSQogICAgICAgICAgICAgICAgdGhpcy5iZWdpblB1bGxkb3duKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9wdWxsZG93bkxvYWRpbmc6IGZ1bmN0aW9uKCkgeyAvL+ivpeaWueazleaYr+eItumhtemdouiwg+eUqOeahAogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgJC5wbHVzUmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkV2VidmlldyA9IHBsdXMud2Vidmlldy5nZXRXZWJ2aWV3QnlJZChzZWxmLm9wdGlvbnMud2Vidmlld0lkKTsKICAgICAgICAgICAgICAgICAgICBjaGlsZFdlYnZpZXcgJiYgY2hpbGRXZWJ2aWV3LnNldEJvdW5jZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBzZWxmLm9wdGlvbnMuZG93bi5oZWlnaHQgKyAicHgiCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlbmRQdWxsZG93bjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgX3d2ID0gcGx1cy53ZWJ2aWV3LmN1cnJlbnRXZWJ2aWV3KCk7CiAgICAgICAgICAgICAgICAvL+WPjHdlYnZpZXfnmoTkuIvmi4nliLfmlrDvvIzpnIDopoHkv67mlLnniLbnqpflj6Pmj5DnpLrkv6Hmga8KICAgICAgICAgICAgICAgIGlmIChfd3YucGFyZW50KCkgJiYgdGhpcy5vcHRpb25zLmRvd24uc3R5bGUgIT09ICJjaXJjbGUiKSB7CiAgICAgICAgICAgICAgICAgICAgX3d2LnBhcmVudCgpLmV2YWxKUygibXVpJiZtdWkoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm11aS1jb250ZW50JykpLnB1bGxSZWZyZXNoKCciICsgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgICAgICAgICB3ZWJ2aWV3SWQ6IF93di5pZAogICAgICAgICAgICAgICAgICAgIH0pICsgIicpLl9lbmRQdWxsZG93blRvUmVmcmVzaCgpIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF93di5lbmRQdWxsVG9SZWZyZXNoKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVuZFB1bGxkb3duVG9SZWZyZXNoOiBmdW5jdGlvbigpIHsgLy/or6Xmlrnms5XmmK/lrZDpobXpnaLosIPnlKjnmoTvvIzlhbzlrrnogIHnmoTljoblj7JBUEkKICAgICAgICAgICAgICAgIHRoaXMuZW5kUHVsbGRvd24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2VuZFB1bGxkb3duVG9SZWZyZXNoOiBmdW5jdGlvbigpIHsgLy/or6Xmlrnms5XmmK/niLbpobXpnaLosIPnlKjnmoQKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgICAgIGlmIChzZWxmLnRvcFBvY2tldCAmJiBzZWxmLm9wdGlvbnMud2VidmlldykgewogICAgICAgICAgICAgICAgICAgIHNlbGYub3B0aW9ucy53ZWJ2aWV3LmVuZFB1bGxUb1JlZnJlc2goKTsgLy/kuIvmi4nliLfmlrDmiYDlnKh3ZWJ2aWV35Zue5by5CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0Q2FwdGlvbihzZWxmLm9wdGlvbnMuZG93bi5jb250ZW50ZG93biwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2FkaW5nIHx8IHNlbGYudG9wUG9ja2V0LmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfQkxPQ0spOwogICAgICAgICAgICAgICAgICAgIH0sIDM1MCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJlZ2luUHVsbHVwOiBmdW5jdGlvbihjYWxsYmFjaykgeyAvL+W8gOWni+S4iuaLieWKoOi9vQogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYgKHNlbGYuaXNMb2FkaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICBzZWxmLmlzTG9hZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5wdWxsZG93biAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLl9pbml0UHVsbHVwUmVmcmVzaCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1bGxQb2NrZXQuY2xhc3NMaXN0LmFkZChDTEFTU19CTE9DSyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHNlbGYucHVsbExvYWRpbmcuY2xhc3NMaXN0LmFkZChDTEFTU19WSVNJQklMSVRZKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnB1bGxMb2FkaW5nLmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfSElEREVOKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnB1bGxDYXB0aW9uLmlubmVySFRNTCA9ICcnOyAvL+S/ruatozUr6YeM6L6556ys5LiA5qyh5Yqg6L295pe277yM5paH5a2X5pi+56S655qEYnVnKOi/mOS8muaYvuekuuWHuuadpeS4quKAnOWkmuKAnSznjJzmtYvlupTor6XmmK/muLLmn5Ppl67popjlr7zoh7TnmoQpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wdWxsQ2FwdGlvbi5jbGFzc05hbWUgPSBDTEFTU19QVUxMX0NBUFRJT04gKyAnICcgKyBDTEFTU19QVUxMX0NBUFRJT05fUkVGUkVTSDsKICAgICAgICAgICAgICAgICAgICBzZWxmLnB1bGxDYXB0aW9uLmlubmVySFRNTCA9IHNlbGYub3B0aW9ucy51cC5jb250ZW50cmVmcmVzaDsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IHNlbGYub3B0aW9ucy51cC5jYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5jYWxsKHNlbGYpOwogICAgICAgICAgICAgICAgfSwgMzAwKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHVsbHVwTG9hZGluZzogZnVuY3Rpb24oY2FsbGJhY2spIHsgLy/lhbzlrrnogIHnmoRBUEkKICAgICAgICAgICAgICAgIHRoaXMuYmVnaW5QdWxsdXAoY2FsbGJhY2spOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlbmRQdWxsdXA6IGZ1bmN0aW9uKGZpbmlzaGVkKSB7IC8v5LiK5ouJ5Yqg6L2957uT5p2fCiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5wdWxsTG9hZGluZykgewogICAgICAgICAgICAgICAgICAgIHNlbGYucHVsbExvYWRpbmcuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19WSVNJQklMSVRZKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnB1bGxMb2FkaW5nLmNsYXNzTGlzdC5hZGQoQ0xBU1NfSElEREVOKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzTG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wdWxsQ2FwdGlvbi5jbGFzc05hbWUgPSBDTEFTU19QVUxMX0NBUFRJT04gKyAnICcgKyBDTEFTU19QVUxMX0NBUFRJT05fTk9NT1JFOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnB1bGxDYXB0aW9uLmlubmVySFRNTCA9IHNlbGYub3B0aW9ucy51cC5jb250ZW50bm9tb3JlOwogICAgICAgICAgICAgICAgICAgICAgICAvL+WPlua2iDUr55qEcGx1c3Njcm9sbGJvdHRvbeS6i+S7tgogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdwbHVzc2Nyb2xsYm90dG9tJywgc2VsZik7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdkcmFndXAnLCBzZWxmKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvL+WIneWni+WMluaXtumakOiXj++8jOWQjue7reS4jeWGjemakOiXjwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnB1bGxDYXB0aW9uLmNsYXNzTmFtZSA9IENMQVNTX1BVTExfQ0FQVElPTiArICcgJyArIENMQVNTX1BVTExfQ0FQVElPTl9ET1dOOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnB1bGxDYXB0aW9uLmlubmVySFRNTCA9IHNlbGYub3B0aW9ucy51cC5jb250ZW50ZG93bjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVuZFB1bGx1cFRvUmVmcmVzaDogZnVuY3Rpb24oZmluaXNoZWQpIHsgLy/kuIrmi4nliqDovb3nu5PmnZ/vvIzlhbzlrrnogIHnmoRBUEkKICAgICAgICAgICAgICAgIHRoaXMuZW5kUHVsbHVwKGZpbmlzaGVkKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGlzYWJsZVB1bGxkb3duVG9SZWZyZXNoOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciB3ZWJ2aWV3ID0gcGx1cy53ZWJ2aWV3LmN1cnJlbnRXZWJ2aWV3KCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmRvd24uc3R5bGUgJiYgdGhpcy5vcHRpb25zLmRvd24uc3R5bGUgPT0gJ2NpcmNsZScpIHsgLy8g5Y2Vd2Vidmlld+aooeW8j+emgeatouWOn+eUn+S4i+aLieWIt+aWsAogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy53ZWJ2aWV3LnNldFB1bGxUb1JlZnJlc2goewogICAgICAgICAgICAgICAgICAgICAgICBzdXBwb3J0OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6ICdjaXJjbGUnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyDlj4x3ZWJ2aWV35qih5byP56aB5q2i5LiL5ouJ5Yi35pawCiAgICAgICAgICAgICAgICAgICAgd2Vidmlldy5zZXRTdHlsZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5jZTogJ25vbmUnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgd2Vidmlldy5zZXRCb3VuY2UoewogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAnbm9uZScKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBlbmFibGVQdWxsZG93blRvUmVmcmVzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgd2VidmlldyA9IHBsdXMud2Vidmlldy5jdXJyZW50V2VidmlldygpLAogICAgICAgICAgICAgICAgICAgIGhlaWdodCA9IHRoaXMub3B0aW9ucy5kb3duLmhlaWdodDsKICAgICAgICAgICAgICAgIC8vIOWNlXdlYnZpZXfmqKHlvI/npoHmraLljp/nlJ/kuIvmi4nliLfmlrAKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZG93bi5zdHlsZSAmJiB0aGlzLm9wdGlvbnMuZG93bi5zdHlsZSA9PSAnY2lyY2xlJykgewogICAgICAgICAgICAgICAgICAgIHdlYnZpZXcuc2V0UHVsbFRvUmVmcmVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1cHBvcnQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0IHx8ICc1MHB4JywKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2U6IHNlbGYub3B0aW9ucy5kb3duLnJhbmdlIHx8ICcxMDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiAnY2lyY2xlJywKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0OiBzZWxmLm9wdGlvbnMuZG93bi5vZmZzZXQgfHwgJzBweCcKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIOmHjeaWsOWIneWni+WMluWPjHdlYnZpZXfmqKHlvI/kuIvmi4nliLfmlrAKICAgICAgICAgICAgICAgICAgICB3ZWJ2aWV3LnNldFN0eWxlKHsKICAgICAgICAgICAgICAgICAgICAgICAgYm91bmNlOiAndmVydGljYWwnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgd2Vidmlldy5zZXRCb3VuY2UoewogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBoZWlnaHQgKiAyICsgJ3B4JwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VvZmZzZXQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogaGVpZ2h0ICsgJ3B4JwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRpc2FibGVQdWxsdXBUb1JlZnJlc2g6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy5faW5pdFB1bGx1cFJlZnJlc2goKTsKICAgICAgICAgICAgICAgIHRoaXMuYm90dG9tUG9ja2V0LmNsYXNzTmFtZSA9ICdtdWktcHVsbC1ib3R0b20tcG9ja2V0JyArICcgJyArIENMQVNTX0hJRERFTjsKICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdkcmFndXAnLCB0aGlzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZW5hYmxlUHVsbHVwVG9SZWZyZXNoOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2luaXRQdWxsdXBSZWZyZXNoKCk7CiAgICAgICAgICAgICAgICB0aGlzLmJvdHRvbVBvY2tldC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0hJRERFTik7CiAgICAgICAgICAgICAgICB0aGlzLnB1bGxDYXB0aW9uLmNsYXNzTmFtZSA9IENMQVNTX1BVTExfQ0FQVElPTiArICcgJyArIENMQVNTX1BVTExfQ0FQVElPTl9ET1dOOwogICAgICAgICAgICAgICAgdGhpcy5wdWxsQ2FwdGlvbi5pbm5lckhUTUwgPSB0aGlzLm9wdGlvbnMudXAuY29udGVudGRvd247CiAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJwbHVzc2Nyb2xsYm90dG9tIiwgdGhpcyk7CiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ3VwJywgdGhpcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNjcm9sbFRvOiBmdW5jdGlvbih4LCB5LCB0aW1lKSB7CiAgICAgICAgICAgICAgICAkLnNjcm9sbFRvKHksIHRpbWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzY3JvbGxUb0JvdHRvbTogZnVuY3Rpb24odGltZSkgewogICAgICAgICAgICAgICAgJC5zY3JvbGxUbyhkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0LCB0aW1lKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVmcmVzaDogZnVuY3Rpb24oaXNSZXNldCkgewogICAgICAgICAgICAgICAgaWYgKGlzUmVzZXQgJiYgdGhpcy5maW5pc2hlZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5hYmxlUHVsbHVwVG9SZWZyZXNoKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maW5pc2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwgJC5QdWxsUmVmcmVzaCkpOwoKICAgICAgICAvL292ZXJyaWRlIGg1IHB1bGxSZWZyZXNoCiAgICAgICAgJC5mbi5wdWxsUmVmcmVzaF9uYXRpdmUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBzZWxmOwogICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHNlbGYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgIHNlbGYuY2xhc3NOYW1lID0gJ211aS1jb250ZW50JzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2VsZik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzZWxmID0gdGhpc1swXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJncyA9IG9wdGlvbnM7CiAgICAgICAgICAgIC8v5LiA5Liq54i26ZyA6KaB5pSv5oyB5aSa5Liq5a2Q5LiL5ouJ5Yi35pawCiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSAkLnBhcnNlSlNPTihvcHRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAhb3B0aW9ucy53ZWJ2aWV3SWQgJiYgKG9wdGlvbnMud2Vidmlld0lkID0gKHBsdXMud2Vidmlldy5jdXJyZW50V2VidmlldygpLmlkIHx8IHBsdXMud2Vidmlldy5jdXJyZW50V2VidmlldygpLmdldFVSTCgpKSk7CiAgICAgICAgICAgIHZhciBwdWxsUmVmcmVzaEFwaSA9IG51bGw7CiAgICAgICAgICAgIHZhciBhdHRyV2Vidmlld0lkID0gb3B0aW9ucy53ZWJ2aWV3SWQgJiYgb3B0aW9ucy53ZWJ2aWV3SWQucmVwbGFjZSgvXC8vZywgIl8iKTsgLy/mm7/mjaLmiYDmnIkiLyIKICAgICAgICAgICAgdmFyIGlkID0gc2VsZi5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHVsbHJlZnJlc2gtcGx1cy0nICsgYXR0cldlYnZpZXdJZCk7CiAgICAgICAgICAgIGlmICghaWQgJiYgdHlwZW9mIGFyZ3MgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpZCkgeyAvL+mBv+WFjemHjeWkjeWIneWni+WMljUrIHB1bGxyZWZyZXNoCiAgICAgICAgICAgICAgICBpZCA9ICsrJC51dWlkOwogICAgICAgICAgICAgICAgc2VsZi5zZXRBdHRyaWJ1dGUoJ2RhdGEtcHVsbHJlZnJlc2gtcGx1cy0nICsgYXR0cldlYnZpZXdJZCwgaWQpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKENMQVNTX1BMVVNfUFVMTFJFRlJFU0gpOwogICAgICAgICAgICAgICAgJC5kYXRhW2lkXSA9IHB1bGxSZWZyZXNoQXBpID0gbmV3IFBsdXNQdWxsUmVmcmVzaChzZWxmLCBvcHRpb25zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHB1bGxSZWZyZXNoQXBpID0gJC5kYXRhW2lkXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy5kb3duICYmIG9wdGlvbnMuZG93bi5hdXRvKSB7IC8v5aaC5p6c6K6+572u5LqGYXV0b++8jOWImeiHquWKqOS4i+aLieS4gOasoQogICAgICAgICAgICAgICAgLy9wdWxsUmVmcmVzaEFwaS5fcHVsbGRvd25Mb2FkaW5nKCk7IC8vcGFyZW50IHdlYnZpZXcKICAgICAgICAgICAgICAgIHB1bGxSZWZyZXNoQXBpLmJlZ2luUHVsbGRvd24oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnVwICYmIG9wdGlvbnMudXAuYXV0bykgeyAvL+WmguaenOiuvue9ruS6hmF1dG/vvIzliJnoh6rliqjkuIrmi4nkuIDmrKEKICAgICAgICAgICAgICAgIHB1bGxSZWZyZXNoQXBpLmJlZ2luUHVsbHVwKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHB1bGxSZWZyZXNoQXBpOwogICAgICAgIH07CiAgICB9KTsKCn0pKG11aSwgZG9jdW1lbnQpOwovKioKICogb2ZmLWNhbnZhcwogKiBAcGFyYW0ge3R5cGV9ICQKICogQHBhcmFtIHt0eXBlfSB3aW5kb3cKICogQHBhcmFtIHt0eXBlfSBkb2N1bWVudAogKiBAcGFyYW0ge3R5cGV9IGFjdGlvbgogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQsIHdpbmRvdywgZG9jdW1lbnQsIG5hbWUpIHsKCXZhciBDTEFTU19PRkZfQ0FOVkFTX0xFRlQgPSAnbXVpLW9mZi1jYW52YXMtbGVmdCc7Cgl2YXIgQ0xBU1NfT0ZGX0NBTlZBU19SSUdIVCA9ICdtdWktb2ZmLWNhbnZhcy1yaWdodCc7Cgl2YXIgQ0xBU1NfQUNUSU9OX0JBQ0tEUk9QID0gJ211aS1vZmYtY2FudmFzLWJhY2tkcm9wJzsKCXZhciBDTEFTU19PRkZfQ0FOVkFTX1dSQVAgPSAnbXVpLW9mZi1jYW52YXMtd3JhcCc7CgoJdmFyIENMQVNTX1NMSURFX0lOID0gJ211aS1zbGlkZS1pbic7Cgl2YXIgQ0xBU1NfQUNUSVZFID0gJ211aS1hY3RpdmUnOwoKCgl2YXIgQ0xBU1NfVFJBTlNJVElPTklORyA9ICdtdWktdHJhbnNpdGlvbmluZyc7CgoJdmFyIFNFTEVDVE9SX0lOTkVSX1dSQVAgPSAnLm11aS1pbm5lci13cmFwJzsKCgoJdmFyIE9mZkNhbnZhcyA9ICQuQ2xhc3MuZXh0ZW5kKHsKCQlpbml0OiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CgkJCXRoaXMud3JhcHBlciA9IHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CgkJCXRoaXMuc2Nyb2xsZXIgPSB0aGlzLndyYXBwZXIucXVlcnlTZWxlY3RvcihTRUxFQ1RPUl9JTk5FUl9XUkFQKTsKCQkJdGhpcy5jbGFzc0xpc3QgPSB0aGlzLndyYXBwZXIuY2xhc3NMaXN0OwoJCQlpZiAodGhpcy5zY3JvbGxlcikgewoJCQkJdGhpcy5vcHRpb25zID0gJC5leHRlbmQodHJ1ZSwgewoJCQkJCWRyYWdUaHJlc2hvbGRYOiAxMCwKCQkJCQlzY2FsZTogMC44LAoJCQkJCW9wYWNpdHk6IDAuMSwKCQkJCQlwcmV2ZW50RGVmYXVsdEV4Y2VwdGlvbjogewoJCQkJCQl0YWdOYW1lOiAvXihJTlBVVHxURVhUQVJFQXxCVVRUT058U0VMRUNUfFZJREVPKSQvCgkJCQkJfSwKCQkJCX0sIG9wdGlvbnMpOwoJCQkJZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdtdWktZnVsbHNjcmVlbicpOyAvL2Z1bGxzY3JlZW4KCQkJCXRoaXMucmVmcmVzaCgpOwoJCQkJdGhpcy5pbml0RXZlbnQoKTsKCQkJfQoJCX0sCgkJX3ByZXZlbnREZWZhdWx0RXhjZXB0aW9uOiBmdW5jdGlvbihlbCwgZXhjZXB0aW9ucykgewoJCQlmb3IgKHZhciBpIGluIGV4Y2VwdGlvbnMpIHsKCQkJCWlmIChleGNlcHRpb25zW2ldLnRlc3QoZWxbaV0pKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgkJcmVmcmVzaDogZnVuY3Rpb24ob2ZmQ2FudmFzKSB7CgkJCS8vCQkJb2ZmQ2FudmFzICYmICFvZmZDYW52YXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkgJiYgdGhpcy5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0FDVElWRSk7CgkJCXRoaXMuc2xpZGVJbiA9IHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX1NMSURFX0lOKTsKCQkJdGhpcy5zY2FsYWJsZSA9IHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKCdtdWktc2NhbGFibGUnKSAmJiAhdGhpcy5zbGlkZUluOwoJCQl0aGlzLnNjcm9sbGVyID0gdGhpcy53cmFwcGVyLnF1ZXJ5U2VsZWN0b3IoU0VMRUNUT1JfSU5ORVJfV1JBUCk7CgkJCS8vCQkJIW9mZkNhbnZhcyAmJiB0aGlzLnNjcm9sbGVyLmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfVFJBTlNJVElPTklORyk7CgkJCS8vCQkJIW9mZkNhbnZhcyAmJiB0aGlzLnNjcm9sbGVyLnNldEF0dHJpYnV0ZSgnc3R5bGUnLCAnJyk7CgkJCXRoaXMub2ZmQ2FudmFzTGVmdHMgPSB0aGlzLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCgnLicgKyBDTEFTU19PRkZfQ0FOVkFTX0xFRlQpOwoJCQl0aGlzLm9mZkNhbnZhc1JpZ2h0cyA9IHRoaXMud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIENMQVNTX09GRl9DQU5WQVNfUklHSFQpOwoJCQlpZiAob2ZmQ2FudmFzKSB7CgkJCQlpZiAob2ZmQ2FudmFzLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19PRkZfQ0FOVkFTX0xFRlQpKSB7CgkJCQkJdGhpcy5vZmZDYW52YXNMZWZ0ID0gb2ZmQ2FudmFzOwoJCQkJfSBlbHNlIGlmIChvZmZDYW52YXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX09GRl9DQU5WQVNfUklHSFQpKSB7CgkJCQkJdGhpcy5vZmZDYW52YXNSaWdodCA9IG9mZkNhbnZhczsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRoaXMub2ZmQ2FudmFzUmlnaHQgPSB0aGlzLndyYXBwZXIucXVlcnlTZWxlY3RvcignLicgKyBDTEFTU19PRkZfQ0FOVkFTX1JJR0hUKTsKCQkJCXRoaXMub2ZmQ2FudmFzTGVmdCA9IHRoaXMud3JhcHBlci5xdWVyeVNlbGVjdG9yKCcuJyArIENMQVNTX09GRl9DQU5WQVNfTEVGVCk7CgkJCX0KCQkJdGhpcy5vZmZDYW52YXNSaWdodFdpZHRoID0gdGhpcy5vZmZDYW52YXNMZWZ0V2lkdGggPSAwOwoJCQl0aGlzLm9mZkNhbnZhc0xlZnRTbGlkZUluID0gdGhpcy5vZmZDYW52YXNSaWdodFNsaWRlSW4gPSBmYWxzZTsKCQkJaWYgKHRoaXMub2ZmQ2FudmFzUmlnaHQpIHsKCQkJCXRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aCA9IHRoaXMub2ZmQ2FudmFzUmlnaHQub2Zmc2V0V2lkdGg7CgkJCQl0aGlzLm9mZkNhbnZhc1JpZ2h0U2xpZGVJbiA9IHRoaXMuc2xpZGVJbiAmJiAodGhpcy5vZmZDYW52YXNSaWdodC5wYXJlbnROb2RlID09PSB0aGlzLndyYXBwZXIpOwoJCQkJLy8JCQkJdGhpcy5vZmZDYW52YXNSaWdodC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX1RSQU5TSVRJT05JTkcpOwoJCQkJLy8JCQkJdGhpcy5vZmZDYW52YXNSaWdodC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0FDVElWRSk7CgkJCQkvLwkJCQl0aGlzLm9mZkNhbnZhc1JpZ2h0LnNldEF0dHJpYnV0ZSgnc3R5bGUnLCAnJyk7CgkJCX0KCQkJaWYgKHRoaXMub2ZmQ2FudmFzTGVmdCkgewoJCQkJdGhpcy5vZmZDYW52YXNMZWZ0V2lkdGggPSB0aGlzLm9mZkNhbnZhc0xlZnQub2Zmc2V0V2lkdGg7CgkJCQl0aGlzLm9mZkNhbnZhc0xlZnRTbGlkZUluID0gdGhpcy5zbGlkZUluICYmICh0aGlzLm9mZkNhbnZhc0xlZnQucGFyZW50Tm9kZSA9PT0gdGhpcy53cmFwcGVyKTsKCQkJCS8vCQkJCXRoaXMub2ZmQ2FudmFzTGVmdC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX1RSQU5TSVRJT05JTkcpOwoJCQkJLy8JCQkJdGhpcy5vZmZDYW52YXNMZWZ0LmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfQUNUSVZFKTsKCQkJCS8vCQkJCXRoaXMub2ZmQ2FudmFzTGVmdC5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgJycpOwoJCQl9CgkJCXRoaXMuYmFja2Ryb3AgPSB0aGlzLnNjcm9sbGVyLnF1ZXJ5U2VsZWN0b3IoJy4nICsgQ0xBU1NfQUNUSU9OX0JBQ0tEUk9QKTsKCgkJCXRoaXMub3B0aW9ucy5kcmFnVGhyZXNob2xkWCA9IHRoaXMub3B0aW9ucy5kcmFnVGhyZXNob2xkWCB8fCAxMDsKCgkJCXRoaXMudmlzaWJsZSA9IGZhbHNlOwoJCQl0aGlzLnN0YXJ0WCA9IG51bGw7CgkJCXRoaXMubGFzdFggPSBudWxsOwoJCQl0aGlzLm9mZnNldFggPSBudWxsOwoJCQl0aGlzLmxhc3RUcmFuc2xhdGVYID0gbnVsbDsKCQl9LAoJCWhhbmRsZUV2ZW50OiBmdW5jdGlvbihlKSB7CgkJCXN3aXRjaCAoZS50eXBlKSB7CgkJCQljYXNlICQuRVZFTlRfU1RBUlQ6CgkJCQkJZS50YXJnZXQgJiYgIXRoaXMuX3ByZXZlbnREZWZhdWx0RXhjZXB0aW9uKGUudGFyZ2V0LCB0aGlzLm9wdGlvbnMucHJldmVudERlZmF1bHRFeGNlcHRpb24pICYmIGUucHJldmVudERlZmF1bHQoKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgJ3dlYmtpdFRyYW5zaXRpb25FbmQnOiAvL+acieS4qmJ1Z+mcgOimgeWkhOeQhu+8jOmcgOimgeiAg+iZkeWBh+iuvuayoeacieinpuWPkXdlYmtpdFRyYW5zaXRpb25FbmTnmoTmg4XlhrUKCQkJCQlpZiAoZS50YXJnZXQgPT09IHRoaXMuc2Nyb2xsZXIpIHsKCQkJCQkJdGhpcy5fZGlzcGF0Y2hFdmVudCgpOwoJCQkJCX0KCQkJCQlicmVhazsKCQkJCWNhc2UgJ2RyYWcnOgoJCQkJCXZhciBkZXRhaWwgPSBlLmRldGFpbDsKCQkJCQlpZiAoIXRoaXMuc3RhcnRYKSB7CgkJCQkJCXRoaXMuc3RhcnRYID0gZGV0YWlsLmNlbnRlci54OwoJCQkJCQl0aGlzLmxhc3RYID0gdGhpcy5zdGFydFg7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5sYXN0WCA9IGRldGFpbC5jZW50ZXIueDsKCQkJCQl9CgkJCQkJaWYgKCF0aGlzLmlzRHJhZ2dpbmcgJiYgTWF0aC5hYnModGhpcy5sYXN0WCAtIHRoaXMuc3RhcnRYKSA+IHRoaXMub3B0aW9ucy5kcmFnVGhyZXNob2xkWCAmJiAoZGV0YWlsLmRpcmVjdGlvbiA9PT0gJ2xlZnQnIHx8IChkZXRhaWwuZGlyZWN0aW9uID09PSAncmlnaHQnKSkpIHsKCQkJCQkJaWYgKHRoaXMuc2xpZGVJbikgewoJCQkJCQkJdGhpcy5zY3JvbGxlciA9IHRoaXMud3JhcHBlci5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX0lOTkVSX1dSQVApOwoJCQkJCQkJaWYgKHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkpIHsKCQkJCQkJCQlpZiAodGhpcy5vZmZDYW52YXNSaWdodCAmJiB0aGlzLm9mZkNhbnZhc1JpZ2h0LmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19BQ1RJVkUpKSB7CgkJCQkJCQkJCXRoaXMub2ZmQ2FudmFzID0gdGhpcy5vZmZDYW52YXNSaWdodDsKCQkJCQkJCQkJdGhpcy5vZmZDYW52YXNXaWR0aCA9IHRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aDsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQl0aGlzLm9mZkNhbnZhcyA9IHRoaXMub2ZmQ2FudmFzTGVmdDsKCQkJCQkJCQkJdGhpcy5vZmZDYW52YXNXaWR0aCA9IHRoaXMub2ZmQ2FudmFzTGVmdFdpZHRoOwoJCQkJCQkJCX0KCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKGRldGFpbC5kaXJlY3Rpb24gPT09ICdsZWZ0JyAmJiB0aGlzLm9mZkNhbnZhc1JpZ2h0KSB7CgkJCQkJCQkJCXRoaXMub2ZmQ2FudmFzID0gdGhpcy5vZmZDYW52YXNSaWdodDsKCQkJCQkJCQkJdGhpcy5vZmZDYW52YXNXaWR0aCA9IHRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aDsKCQkJCQkJCQl9IGVsc2UgaWYgKGRldGFpbC5kaXJlY3Rpb24gPT09ICdyaWdodCcgJiYgdGhpcy5vZmZDYW52YXNMZWZ0KSB7CgkJCQkJCQkJCXRoaXMub2ZmQ2FudmFzID0gdGhpcy5vZmZDYW52YXNMZWZ0OwoJCQkJCQkJCQl0aGlzLm9mZkNhbnZhc1dpZHRoID0gdGhpcy5vZmZDYW52YXNMZWZ0V2lkdGg7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJdGhpcy5zY3JvbGxlciA9IG51bGw7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJaWYgKHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkpIHsKCQkJCQkJCQlpZiAoZGV0YWlsLmRpcmVjdGlvbiA9PT0gJ2xlZnQnKSB7CgkJCQkJCQkJCXRoaXMub2ZmQ2FudmFzID0gdGhpcy5vZmZDYW52YXNMZWZ0OwoJCQkJCQkJCQl0aGlzLm9mZkNhbnZhc1dpZHRoID0gdGhpcy5vZmZDYW52YXNMZWZ0V2lkdGg7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJdGhpcy5vZmZDYW52YXMgPSB0aGlzLm9mZkNhbnZhc1JpZ2h0OwoJCQkJCQkJCQl0aGlzLm9mZkNhbnZhc1dpZHRoID0gdGhpcy5vZmZDYW52YXNSaWdodFdpZHRoOwoJCQkJCQkJCX0KCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKGRldGFpbC5kaXJlY3Rpb24gPT09ICdyaWdodCcpIHsKCQkJCQkJCQkJdGhpcy5vZmZDYW52YXMgPSB0aGlzLm9mZkNhbnZhc0xlZnQ7CgkJCQkJCQkJCXRoaXMub2ZmQ2FudmFzV2lkdGggPSB0aGlzLm9mZkNhbnZhc0xlZnRXaWR0aDsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQl0aGlzLm9mZkNhbnZhcyA9IHRoaXMub2ZmQ2FudmFzUmlnaHQ7CgkJCQkJCQkJCXRoaXMub2ZmQ2FudmFzV2lkdGggPSB0aGlzLm9mZkNhbnZhc1JpZ2h0V2lkdGg7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCWlmICh0aGlzLm9mZkNhbnZhcyAmJiB0aGlzLnNjcm9sbGVyKSB7CgkJCQkJCQl0aGlzLnN0YXJ0WCA9IHRoaXMubGFzdFg7CgkJCQkJCQl0aGlzLmlzRHJhZ2dpbmcgPSB0cnVlOwoKCQkJCQkJCSQuZ2VzdHVyZXMuc2Vzc2lvbi5sb2NrRGlyZWN0aW9uID0gdHJ1ZTsgLy/plIHlrprmlrnlkJEKCQkJCQkJCSQuZ2VzdHVyZXMuc2Vzc2lvbi5zdGFydERpcmVjdGlvbiA9IGRldGFpbC5kaXJlY3Rpb247CgoJCQkJCQkJdGhpcy5vZmZDYW52YXMuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19UUkFOU0lUSU9OSU5HKTsKCQkJCQkJCXRoaXMuc2Nyb2xsZXIuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19UUkFOU0lUSU9OSU5HKTsKCQkJCQkJCXRoaXMub2Zmc2V0WCA9IHRoaXMuZ2V0VHJhbnNsYXRlWCgpOwoJCQkJCQkJdGhpcy5faW5pdE9mZkNhbnZhc1Zpc2libGUoKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAodGhpcy5pc0RyYWdnaW5nKSB7CgkJCQkJCXRoaXMudXBkYXRlVHJhbnNsYXRlKHRoaXMub2Zmc2V0WCArICh0aGlzLmxhc3RYIC0gdGhpcy5zdGFydFgpKTsKCQkJCQkJZGV0YWlsLmdlc3R1cmUucHJldmVudERlZmF1bHQoKTsKCQkJCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQljYXNlICdkcmFnZW5kJzoKCQkJCQlpZiAodGhpcy5pc0RyYWdnaW5nKSB7CgkJCQkJCXZhciBkZXRhaWwgPSBlLmRldGFpbDsKCQkJCQkJdmFyIGRpcmVjdGlvbiA9IGRldGFpbC5kaXJlY3Rpb247CgkJCQkJCXRoaXMuaXNEcmFnZ2luZyA9IGZhbHNlOwoJCQkJCQl0aGlzLm9mZkNhbnZhcy5jbGFzc0xpc3QuYWRkKENMQVNTX1RSQU5TSVRJT05JTkcpOwoJCQkJCQl0aGlzLnNjcm9sbGVyLmNsYXNzTGlzdC5hZGQoQ0xBU1NfVFJBTlNJVElPTklORyk7CgkJCQkJCXZhciByYXRpbyA9IDA7CgkJCQkJCXZhciB4ID0gdGhpcy5nZXRUcmFuc2xhdGVYKCk7CgkJCQkJCWlmICghdGhpcy5zbGlkZUluKSB7CgkJCQkJCQlpZiAoeCA+PSAwKSB7CgkJCQkJCQkJcmF0aW8gPSAodGhpcy5vZmZDYW52YXNMZWZ0V2lkdGggJiYgKHggLyB0aGlzLm9mZkNhbnZhc0xlZnRXaWR0aCkpIHx8IDA7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXJhdGlvID0gKHRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aCAmJiAoeCAvIHRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aCkpIHx8IDA7CgkJCQkJCQl9CgkJCQkJCQlpZiAocmF0aW8gPT09IDApIHsKCQkJCQkJCQl0aGlzLm9wZW5QZXJjZW50YWdlKDApOwoJCQkJCQkJCXRoaXMuX2Rpc3BhdGNoRXZlbnQoKTsgLy/mraTlpITkuI3op6blj5F3ZWJraXRUcmFuc2l0aW9uRW5kLOaJgOS7peaJi+WKqGRpc3BhdGNoCgkJCQkJCQkJcmV0dXJuOwoJCQkJCQkJfQoJCQkJCQkJaWYgKGRpcmVjdGlvbiA9PT0gJ3JpZ2h0JyAmJiByYXRpbyA+PSAwICYmIChyYXRpbyA+PSAwLjUgfHwgZGV0YWlsLnN3aXBlKSkgeyAvL+WPs+a7keaJk+W8gAoJCQkJCQkJCXRoaXMub3BlblBlcmNlbnRhZ2UoMTAwKTsKCQkJCQkJCX0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAncmlnaHQnICYmIHJhdGlvIDwgMCAmJiAocmF0aW8gPiAtMC41IHx8IGRldGFpbC5zd2lwZSkpIHsgLy/lj7Pmu5HlhbPpl60KCQkJCQkJCQl0aGlzLm9wZW5QZXJjZW50YWdlKDApOwoJCQkJCQkJfSBlbHNlIGlmIChkaXJlY3Rpb24gPT09ICdyaWdodCcgJiYgcmF0aW8gPiAwICYmIHJhdGlvIDwgMC41KSB7IC8v5Y+z5ruR6L+Y5Y6f5YWz6ZetCgkJCQkJCQkJdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKCQkJCQkJCX0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAncmlnaHQnICYmIHJhdGlvIDwgMC41KSB7IC8v5Y+z5ruR6L+Y5Y6f5omT5byACgkJCQkJCQkJdGhpcy5vcGVuUGVyY2VudGFnZSgtMTAwKTsKCQkJCQkJCX0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAnbGVmdCcgJiYgcmF0aW8gPD0gMCAmJiAocmF0aW8gPD0gLTAuNSB8fCBkZXRhaWwuc3dpcGUpKSB7IC8v5bem5ruR5omT5byACgkJCQkJCQkJdGhpcy5vcGVuUGVyY2VudGFnZSgtMTAwKTsKCQkJCQkJCX0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAnbGVmdCcgJiYgcmF0aW8gPiAwICYmIChyYXRpbyA8PSAwLjUgfHwgZGV0YWlsLnN3aXBlKSkgeyAvL+W3pua7keWFs+mXrQoJCQkJCQkJCXRoaXMub3BlblBlcmNlbnRhZ2UoMCk7CgkJCQkJCQl9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gJ2xlZnQnICYmIHJhdGlvIDwgMCAmJiByYXRpbyA+PSAtMC41KSB7IC8v5bem5ruR6L+Y5Y6f5YWz6ZetCgkJCQkJCQkJdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKCQkJCQkJCX0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAnbGVmdCcgJiYgcmF0aW8gPiAwLjUpIHsgLy/lt6bmu5Hov5jljp/miZPlvIAKCQkJCQkJCQl0aGlzLm9wZW5QZXJjZW50YWdlKDEwMCk7CgkJCQkJCQl9IGVsc2UgeyAvL+m7mOiupOWFs+mXrQoJCQkJCQkJCXRoaXMub3BlblBlcmNlbnRhZ2UoMCk7CgkJCQkJCQl9CgkJCQkJCQlpZiAocmF0aW8gPT09IDEgfHwgcmF0aW8gPT09IC0xKSB7IC8v5q2k5aSE5LiN6Kem5Y+Rd2Via2l0VHJhbnNpdGlvbkVuZCzmiYDku6XmiYvliqhkaXNwYXRjaAoJCQkJCQkJCXRoaXMuX2Rpc3BhdGNoRXZlbnQoKTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWlmICh4ID49IDApIHsKCQkJCQkJCQlyYXRpbyA9ICh0aGlzLm9mZkNhbnZhc1JpZ2h0V2lkdGggJiYgKHggLyB0aGlzLm9mZkNhbnZhc1JpZ2h0V2lkdGgpKSB8fCAwOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlyYXRpbyA9ICh0aGlzLm9mZkNhbnZhc0xlZnRXaWR0aCAmJiAoeCAvIHRoaXMub2ZmQ2FudmFzTGVmdFdpZHRoKSkgfHwgMDsKCQkJCQkJCX0KCQkJCQkJCWlmIChkaXJlY3Rpb24gPT09ICdyaWdodCcgJiYgcmF0aW8gPD0gMCAmJiAocmF0aW8gPj0gLTAuNSB8fCBkZXRhaWwuc3dpcGUpKSB7IC8v5Y+z5ruR5omT5byACgkJCQkJCQkJdGhpcy5vcGVuUGVyY2VudGFnZSgxMDApOwoJCQkJCQkJfSBlbHNlIGlmIChkaXJlY3Rpb24gPT09ICdyaWdodCcgJiYgcmF0aW8gPiAwICYmIChyYXRpbyA+PSAwLjUgfHwgZGV0YWlsLnN3aXBlKSkgeyAvL+WPs+a7keWFs+mXrQoJCQkJCQkJCXRoaXMub3BlblBlcmNlbnRhZ2UoMCk7CgkJCQkJCQl9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gJ3JpZ2h0JyAmJiByYXRpbyA8PSAtMC41KSB7IC8v5Y+z5ruR6L+Y5Y6f5YWz6ZetCgkJCQkJCQkJdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKCQkJCQkJCX0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAncmlnaHQnICYmIHJhdGlvID4gMCAmJiByYXRpbyA8PSAwLjUpIHsgLy/lj7Pmu5Hov5jljp/miZPlvIAKCQkJCQkJCQl0aGlzLm9wZW5QZXJjZW50YWdlKC0xMDApOwoJCQkJCQkJfSBlbHNlIGlmIChkaXJlY3Rpb24gPT09ICdsZWZ0JyAmJiByYXRpbyA+PSAwICYmIChyYXRpbyA8PSAwLjUgfHwgZGV0YWlsLnN3aXBlKSkgeyAvL+W3pua7keaJk+W8gAoJCQkJCQkJCXRoaXMub3BlblBlcmNlbnRhZ2UoLTEwMCk7CgkJCQkJCQl9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gJ2xlZnQnICYmIHJhdGlvIDwgMCAmJiAocmF0aW8gPD0gLTAuNSB8fCBkZXRhaWwuc3dpcGUpKSB7IC8v5bem5ruR5YWz6ZetCgkJCQkJCQkJdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKCQkJCQkJCX0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAnbGVmdCcgJiYgcmF0aW8gPj0gMC41KSB7IC8v5bem5ruR6L+Y5Y6f5YWz6ZetCgkJCQkJCQkJdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKCQkJCQkJCX0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSAnbGVmdCcgJiYgcmF0aW8gPj0gLTAuNSAmJiByYXRpbyA8IDApIHsgLy/lt6bmu5Hov5jljp/miZPlvIAKCQkJCQkJCQl0aGlzLm9wZW5QZXJjZW50YWdlKDEwMCk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXRoaXMub3BlblBlcmNlbnRhZ2UoMCk7CgkJCQkJCQl9CgkJCQkJCQlpZiAocmF0aW8gPT09IDEgfHwgcmF0aW8gPT09IC0xIHx8IHJhdGlvID09PSAwKSB7CgkJCQkJCQkJdGhpcy5fZGlzcGF0Y2hFdmVudCgpOwoJCQkJCQkJCXJldHVybjsKCQkJCQkJCX0KCgkJCQkJCX0KCQkJCQl9CgkJCQkJYnJlYWs7CgkJCX0KCQl9LAoJCV9kaXNwYXRjaEV2ZW50OiBmdW5jdGlvbigpIHsKCQkJaWYgKHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkpIHsKCQkJCSQudHJpZ2dlcih0aGlzLndyYXBwZXIsICdzaG93bicsIHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJJC50cmlnZ2VyKHRoaXMud3JhcHBlciwgJ2hpZGRlbicsIHRoaXMpOwoJCQl9CgkJfSwKCQlfaW5pdE9mZkNhbnZhc1Zpc2libGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIXRoaXMudmlzaWJsZSkgewoJCQkJdGhpcy52aXNpYmxlID0gdHJ1ZTsKCQkJCWlmICh0aGlzLm9mZkNhbnZhc0xlZnQpIHsKCQkJCQl0aGlzLm9mZkNhbnZhc0xlZnQuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCQkJCX0KCQkJCWlmICh0aGlzLm9mZkNhbnZhc1JpZ2h0KSB7CgkJCQkJdGhpcy5vZmZDYW52YXNSaWdodC5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwoJCQkJfQoJCQl9CgkJfSwKCQlpbml0RXZlbnQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCWlmIChzZWxmLmJhY2tkcm9wKSB7CgkJCQlzZWxmLmJhY2tkcm9wLmFkZEV2ZW50TGlzdGVuZXIoJ3RhcCcsIGZ1bmN0aW9uKGUpIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJZS5kZXRhaWwuZ2VzdHVyZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSk7CgkJCX0KCQkJaWYgKHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKCdtdWktZHJhZ2dhYmxlJykpIHsKCQkJCXRoaXMud3JhcHBlci5hZGRFdmVudExpc3RlbmVyKCQuRVZFTlRfU1RBUlQsIHRoaXMpOyAvL+S4tOaXtuWkhOeQhgoJCQkJdGhpcy53cmFwcGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWcnLCB0aGlzKTsKCQkJCXRoaXMud3JhcHBlci5hZGRFdmVudExpc3RlbmVyKCdkcmFnZW5kJywgdGhpcyk7CgkJCX0KCQkJdGhpcy53cmFwcGVyLmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCB0aGlzKTsKCQl9LAoJCW9wZW5QZXJjZW50YWdlOiBmdW5jdGlvbihwZXJjZW50YWdlKSB7CgkJCXZhciBwID0gcGVyY2VudGFnZSAvIDEwMDsKCQkJaWYgKCF0aGlzLnNsaWRlSW4pIHsKCQkJCWlmICh0aGlzLm9mZkNhbnZhc0xlZnQgJiYgcGVyY2VudGFnZSA+PSAwKSB7CgkJCQkJdGhpcy51cGRhdGVUcmFuc2xhdGUodGhpcy5vZmZDYW52YXNMZWZ0V2lkdGggKiBwKTsKCQkJCQl0aGlzLm9mZkNhbnZhc0xlZnQuY2xhc3NMaXN0W3AgIT09IDAgPyAnYWRkJyA6ICdyZW1vdmUnXShDTEFTU19BQ1RJVkUpOwoJCQkJfSBlbHNlIGlmICh0aGlzLm9mZkNhbnZhc1JpZ2h0ICYmIHBlcmNlbnRhZ2UgPD0gMCkgewoJCQkJCXRoaXMudXBkYXRlVHJhbnNsYXRlKHRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aCAqIHApOwoJCQkJCXRoaXMub2ZmQ2FudmFzUmlnaHQuY2xhc3NMaXN0W3AgIT09IDAgPyAnYWRkJyA6ICdyZW1vdmUnXShDTEFTU19BQ1RJVkUpOwoJCQkJfQoJCQkJdGhpcy5jbGFzc0xpc3RbcCAhPT0gMCA/ICdhZGQnIDogJ3JlbW92ZSddKENMQVNTX0FDVElWRSk7CgkJCX0gZWxzZSB7CgkJCQlpZiAodGhpcy5vZmZDYW52YXNMZWZ0ICYmIHBlcmNlbnRhZ2UgPj0gMCkgewoJCQkJCXAgPSBwID09PSAwID8gLTEgOiAwOwoJCQkJCXRoaXMudXBkYXRlVHJhbnNsYXRlKHRoaXMub2ZmQ2FudmFzTGVmdFdpZHRoICogcCk7CgkJCQkJdGhpcy5vZmZDYW52YXNMZWZ0LmNsYXNzTGlzdFtwZXJjZW50YWdlICE9PSAwID8gJ2FkZCcgOiAncmVtb3ZlJ10oQ0xBU1NfQUNUSVZFKTsKCQkJCX0gZWxzZSBpZiAodGhpcy5vZmZDYW52YXNSaWdodCAmJiBwZXJjZW50YWdlIDw9IDApIHsKCQkJCQlwID0gcCA9PT0gMCA/IDEgOiAwOwoJCQkJCXRoaXMudXBkYXRlVHJhbnNsYXRlKHRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aCAqIHApOwoJCQkJCXRoaXMub2ZmQ2FudmFzUmlnaHQuY2xhc3NMaXN0W3BlcmNlbnRhZ2UgIT09IDAgPyAnYWRkJyA6ICdyZW1vdmUnXShDTEFTU19BQ1RJVkUpOwoJCQkJfQoJCQkJdGhpcy5jbGFzc0xpc3RbcGVyY2VudGFnZSAhPT0gMCA/ICdhZGQnIDogJ3JlbW92ZSddKENMQVNTX0FDVElWRSk7CgkJCX0KCQl9LAoJCXVwZGF0ZVRyYW5zbGF0ZTogZnVuY3Rpb24oeCkgewoJCQlpZiAoeCAhPT0gdGhpcy5sYXN0VHJhbnNsYXRlWCkgewoJCQkJaWYgKCF0aGlzLnNsaWRlSW4pIHsKCQkJCQlpZiAoKCF0aGlzLm9mZkNhbnZhc0xlZnQgJiYgeCA+IDApIHx8ICghdGhpcy5vZmZDYW52YXNSaWdodCAmJiB4IDwgMCkpIHsKCQkJCQkJdGhpcy5zZXRUcmFuc2xhdGVYKDApOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCWlmICh0aGlzLmxlZnRTaG93aW5nICYmIHggPiB0aGlzLm9mZkNhbnZhc0xlZnRXaWR0aCkgewoJCQkJCQl0aGlzLnNldFRyYW5zbGF0ZVgodGhpcy5vZmZDYW52YXNMZWZ0V2lkdGgpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCWlmICh0aGlzLnJpZ2h0U2hvd2luZyAmJiB4IDwgLXRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aCkgewoJCQkJCQl0aGlzLnNldFRyYW5zbGF0ZVgoLXRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aCk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQkJdGhpcy5zZXRUcmFuc2xhdGVYKHgpOwoJCQkJCWlmICh4ID49IDApIHsKCQkJCQkJdGhpcy5sZWZ0U2hvd2luZyA9IHRydWU7CgkJCQkJCXRoaXMucmlnaHRTaG93aW5nID0gZmFsc2U7CgkJCQkJCWlmICh4ID4gMCkgewoJCQkJCQkJaWYgKHRoaXMub2ZmQ2FudmFzTGVmdCkgewoJCQkJCQkJCSQuZWFjaCh0aGlzLm9mZkNhbnZhc0xlZnRzLCBmdW5jdGlvbihpbmRleCwgb2ZmQ2FudmFzKSB7CgkJCQkJCQkJCWlmIChvZmZDYW52YXMgPT09IHRoaXMub2ZmQ2FudmFzTGVmdCkgewoJCQkJCQkJCQkJdGhpcy5vZmZDYW52YXNMZWZ0LnN0eWxlLnpJbmRleCA9IDA7CgkJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCQlvZmZDYW52YXMuc3R5bGUuekluZGV4ID0gLTE7CgkJCQkJCQkJCX0KCQkJCQkJCQl9LmJpbmQodGhpcykpOwoJCQkJCQkJfQoJCQkJCQkJaWYgKHRoaXMub2ZmQ2FudmFzUmlnaHQpIHsKCQkJCQkJCQl0aGlzLm9mZkNhbnZhc1JpZ2h0LnN0eWxlLnpJbmRleCA9IC0xOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5yaWdodFNob3dpbmcgPSB0cnVlOwoJCQkJCQl0aGlzLmxlZnRTaG93aW5nID0gZmFsc2U7CgkJCQkJCWlmICh0aGlzLm9mZkNhbnZhc1JpZ2h0KSB7CgkJCQkJCQkkLmVhY2godGhpcy5vZmZDYW52YXNSaWdodHMsIGZ1bmN0aW9uKGluZGV4LCBvZmZDYW52YXMpIHsKCQkJCQkJCQlpZiAob2ZmQ2FudmFzID09PSB0aGlzLm9mZkNhbnZhc1JpZ2h0KSB7CgkJCQkJCQkJCW9mZkNhbnZhcy5zdHlsZS56SW5kZXggPSAwOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCW9mZkNhbnZhcy5zdHlsZS56SW5kZXggPSAtMTsKCQkJCQkJCQl9CgkJCQkJCQl9LmJpbmQodGhpcykpOwoJCQkJCQl9CgkJCQkJCWlmICh0aGlzLm9mZkNhbnZhc0xlZnQpIHsKCQkJCQkJCXRoaXMub2ZmQ2FudmFzTGVmdC5zdHlsZS56SW5kZXggPSAtMTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJaWYgKHRoaXMub2ZmQ2FudmFzLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19PRkZfQ0FOVkFTX1JJR0hUKSkgewoJCQkJCQlpZiAoeCA8IDApIHsKCQkJCQkJCXRoaXMuc2V0VHJhbnNsYXRlWCgwKTsKCQkJCQkJCXJldHVybjsKCQkJCQkJfQoJCQkJCQlpZiAoeCA+IHRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aCkgewoJCQkJCQkJdGhpcy5zZXRUcmFuc2xhdGVYKHRoaXMub2ZmQ2FudmFzUmlnaHRXaWR0aCk7CgkJCQkJCQlyZXR1cm47CgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQlpZiAoeCA+IDApIHsKCQkJCQkJCXRoaXMuc2V0VHJhbnNsYXRlWCgwKTsKCQkJCQkJCXJldHVybjsKCQkJCQkJfQoJCQkJCQlpZiAoeCA8IC10aGlzLm9mZkNhbnZhc0xlZnRXaWR0aCkgewoJCQkJCQkJdGhpcy5zZXRUcmFuc2xhdGVYKC10aGlzLm9mZkNhbnZhc0xlZnRXaWR0aCk7CgkJCQkJCQlyZXR1cm47CgkJCQkJCX0KCQkJCQl9CgkJCQkJdGhpcy5zZXRUcmFuc2xhdGVYKHgpOwoJCQkJfQoJCQkJdGhpcy5sYXN0VHJhbnNsYXRlWCA9IHg7CgkJCX0KCQl9LAoJCXNldFRyYW5zbGF0ZVg6ICQuYW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oeCkgewoJCQlpZiAodGhpcy5zY3JvbGxlcikgewoJCQkJaWYgKHRoaXMuc2NhbGFibGUgJiYgdGhpcy5vZmZDYW52YXMucGFyZW50Tm9kZSA9PT0gdGhpcy53cmFwcGVyKSB7CgkJCQkJdmFyIHBlcmNlbnQgPSBNYXRoLmFicyh4KSAvIHRoaXMub2ZmQ2FudmFzV2lkdGg7CgkJCQkJdmFyIHpvb21PdXRTY2FsZSA9IDEgLSAoMSAtIHRoaXMub3B0aW9ucy5zY2FsZSkgKiBwZXJjZW50OwoJCQkJCXZhciB6b29tSW5TY2FsZSA9IHRoaXMub3B0aW9ucy5zY2FsZSArICgxIC0gdGhpcy5vcHRpb25zLnNjYWxlKSAqIHBlcmNlbnQ7CgkJCQkJdmFyIHpvb21PdXRPcGFjaXR5ID0gMSAtICgxIC0gdGhpcy5vcHRpb25zLm9wYWNpdHkpICogcGVyY2VudDsKCQkJCQl2YXIgem9vbUluT3BhY2l0eSA9IHRoaXMub3B0aW9ucy5vcGFjaXR5ICsgKDEgLSB0aGlzLm9wdGlvbnMub3BhY2l0eSkgKiBwZXJjZW50OwoJCQkJCWlmICh0aGlzLm9mZkNhbnZhcy5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfT0ZGX0NBTlZBU19MRUZUKSkgewoJCQkJCQl0aGlzLm9mZkNhbnZhcy5zdHlsZS53ZWJraXRUcmFuc2Zvcm1PcmlnaW4gPSAnLTEwMCUnOwoJCQkJCQl0aGlzLnNjcm9sbGVyLnN0eWxlLndlYmtpdFRyYW5zZm9ybU9yaWdpbiA9ICdsZWZ0JzsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLm9mZkNhbnZhcy5zdHlsZS53ZWJraXRUcmFuc2Zvcm1PcmlnaW4gPSAnMjAwJSc7CgkJCQkJCXRoaXMuc2Nyb2xsZXIuc3R5bGUud2Via2l0VHJhbnNmb3JtT3JpZ2luID0gJ3JpZ2h0JzsKCQkJCQl9CgkJCQkJdGhpcy5vZmZDYW52YXMuc3R5bGUub3BhY2l0eSA9IHpvb21Jbk9wYWNpdHk7CgkJCQkJdGhpcy5vZmZDYW52YXMuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gJ3RyYW5zbGF0ZTNkKDAsMCwwKSBzY2FsZSgnICsgem9vbUluU2NhbGUgKyAnKSc7CgkJCQkJdGhpcy5zY3JvbGxlci5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSAndHJhbnNsYXRlM2QoJyArIHggKyAncHgsMCwwKSBzY2FsZSgnICsgem9vbU91dFNjYWxlICsgJyknOwoJCQkJfSBlbHNlIHsKCQkJCQlpZiAodGhpcy5zbGlkZUluKSB7CgkJCQkJCXRoaXMub2ZmQ2FudmFzLnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgnICsgeCArICdweCwwLDApJzsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnNjcm9sbGVyLnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgnICsgeCArICdweCwwLDApJzsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9KSwKCQlnZXRUcmFuc2xhdGVYOiBmdW5jdGlvbigpIHsKCQkJaWYgKHRoaXMub2ZmQ2FudmFzKSB7CgkJCQl2YXIgc2Nyb2xsZXIgPSB0aGlzLnNsaWRlSW4gPyB0aGlzLm9mZkNhbnZhcyA6IHRoaXMuc2Nyb2xsZXI7CgkJCQl2YXIgcmVzdWx0ID0gJC5wYXJzZVRyYW5zbGF0ZU1hdHJpeCgkLmdldFN0eWxlcyhzY3JvbGxlciwgJ3dlYmtpdFRyYW5zZm9ybScpKTsKCQkJCXJldHVybiAocmVzdWx0ICYmIHJlc3VsdC54KSB8fCAwOwoJCQl9CgkJCXJldHVybiAwOwoJCX0sCgkJaXNTaG93bjogZnVuY3Rpb24oZGlyZWN0aW9uKSB7CgkJCXZhciBzaG93biA9IGZhbHNlOwoJCQlpZiAoIXRoaXMuc2xpZGVJbikgewoJCQkJdmFyIHggPSB0aGlzLmdldFRyYW5zbGF0ZVgoKTsKCQkJCWlmIChkaXJlY3Rpb24gPT09ICdyaWdodCcpIHsKCQkJCQlzaG93biA9IHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkgJiYgeCA8IDA7CgkJCQl9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gJ2xlZnQnKSB7CgkJCQkJc2hvd24gPSB0aGlzLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19BQ1RJVkUpICYmIHggPiAwOwoJCQkJfSBlbHNlIHsKCQkJCQlzaG93biA9IHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkgJiYgeCAhPT0gMDsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWlmIChkaXJlY3Rpb24gPT09ICdsZWZ0JykgewoJCQkJCXNob3duID0gdGhpcy5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfQUNUSVZFKSAmJiB0aGlzLndyYXBwZXIucXVlcnlTZWxlY3RvcignLicgKyBDTEFTU19PRkZfQ0FOVkFTX0xFRlQgKyAnLicgKyBDTEFTU19BQ1RJVkUpOwoJCQkJfSBlbHNlIGlmIChkaXJlY3Rpb24gPT09ICdyaWdodCcpIHsKCQkJCQlzaG93biA9IHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkgJiYgdGhpcy53cmFwcGVyLnF1ZXJ5U2VsZWN0b3IoJy4nICsgQ0xBU1NfT0ZGX0NBTlZBU19SSUdIVCArICcuJyArIENMQVNTX0FDVElWRSk7CgkJCQl9IGVsc2UgewoJCQkJCXNob3duID0gdGhpcy5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfQUNUSVZFKSAmJiAodGhpcy53cmFwcGVyLnF1ZXJ5U2VsZWN0b3IoJy4nICsgQ0xBU1NfT0ZGX0NBTlZBU19MRUZUICsgJy4nICsgQ0xBU1NfQUNUSVZFKSB8fCB0aGlzLndyYXBwZXIucXVlcnlTZWxlY3RvcignLicgKyBDTEFTU19PRkZfQ0FOVkFTX1JJR0hUICsgJy4nICsgQ0xBU1NfQUNUSVZFKSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHNob3duOwoJCX0sCgkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9pbml0T2ZmQ2FudmFzVmlzaWJsZSgpOwoJCQl0aGlzLm9mZkNhbnZhcyA9IHRoaXMud3JhcHBlci5xdWVyeVNlbGVjdG9yKCcuJyArIENMQVNTX09GRl9DQU5WQVNfUklHSFQgKyAnLicgKyBDTEFTU19BQ1RJVkUpIHx8IHRoaXMud3JhcHBlci5xdWVyeVNlbGVjdG9yKCcuJyArIENMQVNTX09GRl9DQU5WQVNfTEVGVCArICcuJyArIENMQVNTX0FDVElWRSk7CgkJCXRoaXMub2ZmQ2FudmFzV2lkdGggPSB0aGlzLm9mZkNhbnZhcy5vZmZzZXRXaWR0aDsKCQkJaWYgKHRoaXMuc2Nyb2xsZXIpIHsKCQkJCXRoaXMub2ZmQ2FudmFzLm9mZnNldEhlaWdodDsKCQkJCXRoaXMub2ZmQ2FudmFzLmNsYXNzTGlzdC5hZGQoQ0xBU1NfVFJBTlNJVElPTklORyk7CgkJCQl0aGlzLnNjcm9sbGVyLmNsYXNzTGlzdC5hZGQoQ0xBU1NfVFJBTlNJVElPTklORyk7CgkJCQl0aGlzLm9wZW5QZXJjZW50YWdlKDApOwoJCQl9CgkJfSwKCQlzaG93OiBmdW5jdGlvbihkaXJlY3Rpb24pIHsKCQkJdGhpcy5faW5pdE9mZkNhbnZhc1Zpc2libGUoKTsKCQkJaWYgKHRoaXMuaXNTaG93bihkaXJlY3Rpb24pKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCFkaXJlY3Rpb24pIHsKCQkJCWRpcmVjdGlvbiA9IHRoaXMud3JhcHBlci5xdWVyeVNlbGVjdG9yKCcuJyArIENMQVNTX09GRl9DQU5WQVNfUklHSFQpID8gJ3JpZ2h0JyA6ICdsZWZ0JzsKCQkJfQoJCQlpZiAoZGlyZWN0aW9uID09PSAncmlnaHQnKSB7CgkJCQl0aGlzLm9mZkNhbnZhcyA9IHRoaXMub2ZmQ2FudmFzUmlnaHQ7CgkJCQl0aGlzLm9mZkNhbnZhc1dpZHRoID0gdGhpcy5vZmZDYW52YXNSaWdodFdpZHRoOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5vZmZDYW52YXMgPSB0aGlzLm9mZkNhbnZhc0xlZnQ7CgkJCQl0aGlzLm9mZkNhbnZhc1dpZHRoID0gdGhpcy5vZmZDYW52YXNMZWZ0V2lkdGg7CgkJCX0KCQkJaWYgKHRoaXMuc2Nyb2xsZXIpIHsKCQkJCXRoaXMub2ZmQ2FudmFzLm9mZnNldEhlaWdodDsKCQkJCXRoaXMub2ZmQ2FudmFzLmNsYXNzTGlzdC5hZGQoQ0xBU1NfVFJBTlNJVElPTklORyk7CgkJCQl0aGlzLnNjcm9sbGVyLmNsYXNzTGlzdC5hZGQoQ0xBU1NfVFJBTlNJVElPTklORyk7CgkJCQl0aGlzLm9wZW5QZXJjZW50YWdlKGRpcmVjdGlvbiA9PT0gJ2xlZnQnID8gMTAwIDogLTEwMCk7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSwKCQl0b2dnbGU6IGZ1bmN0aW9uKGRpcmVjdGlvbk9yT2ZmQ2FudmFzKSB7CgkJCXZhciBkaXJlY3Rpb24gPSBkaXJlY3Rpb25Pck9mZkNhbnZhczsKCQkJaWYgKGRpcmVjdGlvbk9yT2ZmQ2FudmFzICYmIGRpcmVjdGlvbk9yT2ZmQ2FudmFzLmNsYXNzTGlzdCkgewoJCQkJZGlyZWN0aW9uID0gZGlyZWN0aW9uT3JPZmZDYW52YXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX09GRl9DQU5WQVNfTEVGVCkgPyAnbGVmdCcgOiAncmlnaHQnOwoJCQkJdGhpcy5yZWZyZXNoKGRpcmVjdGlvbk9yT2ZmQ2FudmFzKTsKCQkJfQoJCQlpZiAoIXRoaXMuc2hvdyhkaXJlY3Rpb24pKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgkJCX0KCQl9Cgl9KTsKCgkvL2hhc2ggdG8gb2ZmY2FudmFzCgl2YXIgZmluZE9mZkNhbnZhc0NvbnRhaW5lciA9IGZ1bmN0aW9uKHRhcmdldCkgewoJCXBhcmVudE5vZGUgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQlpZiAocGFyZW50Tm9kZSkgewoJCQlpZiAocGFyZW50Tm9kZS5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfT0ZGX0NBTlZBU19XUkFQKSkgewoJCQkJcmV0dXJuIHBhcmVudE5vZGU7CgkJCX0gZWxzZSB7CgkJCQlwYXJlbnROb2RlID0gcGFyZW50Tm9kZS5wYXJlbnROb2RlOwoJCQkJaWYgKHBhcmVudE5vZGUuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX09GRl9DQU5WQVNfV1JBUCkpIHsKCQkJCQlyZXR1cm4gcGFyZW50Tm9kZTsKCQkJCX0KCQkJfQoJCX0KCX07Cgl2YXIgaGFuZGxlID0gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCkgewoJCWlmICh0YXJnZXQudGFnTmFtZSA9PT0gJ0EnICYmIHRhcmdldC5oYXNoKSB7CgkJCXZhciBvZmZjYW52YXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YXJnZXQuaGFzaC5yZXBsYWNlKCcjJywgJycpKTsKCQkJaWYgKG9mZmNhbnZhcykgewoJCQkJdmFyIGNvbnRhaW5lciA9IGZpbmRPZmZDYW52YXNDb250YWluZXIob2ZmY2FudmFzKTsKCQkJCWlmIChjb250YWluZXIpIHsKCQkJCQkkLnRhcmdldHMuX2NvbnRhaW5lciA9IGNvbnRhaW5lcjsKCQkJCQlyZXR1cm4gb2ZmY2FudmFzOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiBmYWxzZTsKCX07CgoJJC5yZWdpc3RlclRhcmdldCh7CgkJbmFtZTogbmFtZSwKCQlpbmRleDogNjAsCgkJaGFuZGxlOiBoYW5kbGUsCgkJdGFyZ2V0OiBmYWxzZSwKCQlpc1Jlc2V0OiBmYWxzZSwKCQlpc0NvbnRpbnVlOiB0cnVlCgl9KTsKCgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndGFwJywgZnVuY3Rpb24oZSkgewoJCWlmICghJC50YXJnZXRzLm9mZmNhbnZhcykgewoJCQlyZXR1cm47CgkJfQoJCS8vVE9ETyDmraTlpITnsbvlnovnmoTku6PnoIHlkI7nu63ogIPomZHnu5/kuIDkvJjljJYodGFyZ2V05py65Yi2Ke+8jOeOsOWcqOeahOWunueOsOi0ueWKm+S4jeiuqOWlvQoJCXZhciB0YXJnZXQgPSBlLnRhcmdldDsKCQlmb3IgKDsgdGFyZ2V0ICYmIHRhcmdldCAhPT0gZG9jdW1lbnQ7IHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlKSB7CgkJCWlmICh0YXJnZXQudGFnTmFtZSA9PT0gJ0EnICYmIHRhcmdldC5oYXNoICYmIHRhcmdldC5oYXNoID09PSAoJyMnICsgJC50YXJnZXRzLm9mZmNhbnZhcy5pZCkpIHsKCQkJCWUuZGV0YWlsICYmIGUuZGV0YWlsLmdlc3R1cmUgJiYgZS5kZXRhaWwuZ2VzdHVyZS5wcmV2ZW50RGVmYXVsdCgpOyAvL2ZpeGVkIGhhc2hjaGFuZ2UKCQkJCSQoJC50YXJnZXRzLl9jb250YWluZXIpLm9mZkNhbnZhcygpLnRvZ2dsZSgkLnRhcmdldHMub2ZmY2FudmFzKTsKCQkJCSQudGFyZ2V0cy5vZmZjYW52YXMgPSAkLnRhcmdldHMuX2NvbnRhaW5lciA9IG51bGw7CgkJCQlicmVhazsKCQkJfQoJCX0KCX0pOwoKCSQuZm4ub2ZmQ2FudmFzID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCXZhciBvZmZDYW52YXNBcGlzID0gW107CgkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgb2ZmQ2FudmFzQXBpID0gbnVsbDsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkvL2hhY2sgb2xkIHZlcnNpb24KCQkJaWYgKCFzZWxmLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19PRkZfQ0FOVkFTX1dSQVApKSB7CgkJCQlzZWxmID0gZmluZE9mZkNhbnZhc0NvbnRhaW5lcihzZWxmKTsKCQkJfQoJCQl2YXIgaWQgPSBzZWxmLmdldEF0dHJpYnV0ZSgnZGF0YS1vZmZDYW52YXMnKTsKCQkJaWYgKCFpZCkgewoJCQkJaWQgPSArKyQudXVpZDsKCQkJCSQuZGF0YVtpZF0gPSBvZmZDYW52YXNBcGkgPSBuZXcgT2ZmQ2FudmFzKHNlbGYsIG9wdGlvbnMpOwoJCQkJc2VsZi5zZXRBdHRyaWJ1dGUoJ2RhdGEtb2ZmQ2FudmFzJywgaWQpOwoJCQl9IGVsc2UgewoJCQkJb2ZmQ2FudmFzQXBpID0gJC5kYXRhW2lkXTsKCQkJfQoJCQlpZiAob3B0aW9ucyA9PT0gJ3Nob3cnIHx8IG9wdGlvbnMgPT09ICdjbG9zZScgfHwgb3B0aW9ucyA9PT0gJ3RvZ2dsZScpIHsKCQkJCW9mZkNhbnZhc0FwaS50b2dnbGUoKTsKCQkJfQoJCQlvZmZDYW52YXNBcGlzLnB1c2gob2ZmQ2FudmFzQXBpKTsKCQl9KTsKCQlyZXR1cm4gb2ZmQ2FudmFzQXBpcy5sZW5ndGggPT09IDEgPyBvZmZDYW52YXNBcGlzWzBdIDogb2ZmQ2FudmFzQXBpczsKCX07CgkkLnJlYWR5KGZ1bmN0aW9uKCkgewoJCSQoJy5tdWktb2ZmLWNhbnZhcy13cmFwJykub2ZmQ2FudmFzKCk7Cgl9KTsKfSkobXVpLCB3aW5kb3csIGRvY3VtZW50LCAnb2ZmY2FudmFzJyk7Ci8qKgogKiBhY3Rpb25zCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcGFyYW0ge3R5cGV9IG5hbWUKICogQHJldHVybnMge3VuZGVmaW5lZH0KICovCihmdW5jdGlvbigkLCBuYW1lKSB7Cgl2YXIgQ0xBU1NfQUNUSU9OID0gJ211aS1hY3Rpb24nOwoKCXZhciBoYW5kbGUgPSBmdW5jdGlvbihldmVudCwgdGFyZ2V0KSB7CgkJdmFyIGNsYXNzTmFtZSA9IHRhcmdldC5jbGFzc05hbWUgfHwgJyc7CgkJaWYgKHR5cGVvZiBjbGFzc05hbWUgIT09ICdzdHJpbmcnKSB7IC8vc3ZnIGNsYXNzTmFtZShTVkdBbmltYXRlZFN0cmluZykKCQkJY2xhc3NOYW1lID0gJyc7CgkJfQoJCWlmIChjbGFzc05hbWUgJiYgfmNsYXNzTmFtZS5pbmRleE9mKENMQVNTX0FDVElPTikpIHsKCQkJaWYgKHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ211aS1hY3Rpb24tYmFjaycpKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCXJldHVybiB0YXJnZXQ7CgkJfQoJCXJldHVybiBmYWxzZTsKCX07CgoJJC5yZWdpc3RlclRhcmdldCh7CgkJbmFtZTogbmFtZSwKCQlpbmRleDogNTAsCgkJaGFuZGxlOiBoYW5kbGUsCgkJdGFyZ2V0OiBmYWxzZSwKCQlpc0NvbnRpbnVlOiB0cnVlCgl9KTsKCn0pKG11aSwgJ2FjdGlvbicpOwovKioKICogTW9kYWxzCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcGFyYW0ge3R5cGV9IHdpbmRvdwogKiBAcGFyYW0ge3R5cGV9IGRvY3VtZW50CiAqIEBwYXJhbSB7dHlwZX0gbmFtZQogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQsIHdpbmRvdywgZG9jdW1lbnQsIG5hbWUpIHsKCXZhciBDTEFTU19NT0RBTCA9ICdtdWktbW9kYWwnOwoKCXZhciBoYW5kbGUgPSBmdW5jdGlvbihldmVudCwgdGFyZ2V0KSB7CgkJaWYgKHRhcmdldC50YWdOYW1lID09PSAnQScgJiYgdGFyZ2V0Lmhhc2gpIHsKCQkJdmFyIG1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFyZ2V0Lmhhc2gucmVwbGFjZSgnIycsICcnKSk7CgkJCWlmIChtb2RhbCAmJiBtb2RhbC5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfTU9EQUwpKSB7CgkJCQlyZXR1cm4gbW9kYWw7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkkLnJlZ2lzdGVyVGFyZ2V0KHsKCQluYW1lOiBuYW1lLAoJCWluZGV4OiA1MCwKCQloYW5kbGU6IGhhbmRsZSwKCQl0YXJnZXQ6IGZhbHNlLAoJCWlzUmVzZXQ6IGZhbHNlLAoJCWlzQ29udGludWU6IHRydWUKCX0pOwoKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0YXAnLCBmdW5jdGlvbihldmVudCkgewoJCWlmICgkLnRhcmdldHMubW9kYWwpIHsKCQkJZXZlbnQuZGV0YWlsLmdlc3R1cmUucHJldmVudERlZmF1bHQoKTsgLy9maXhlZCBoYXNoY2hhbmdlCgkJCSQudGFyZ2V0cy5tb2RhbC5jbGFzc0xpc3QudG9nZ2xlKCdtdWktYWN0aXZlJyk7CgkJfQoJfSk7Cn0pKG11aSwgd2luZG93LCBkb2N1bWVudCwgJ21vZGFsJyk7Ci8qKgogKiBQb3BvdmVycwogKiBAcGFyYW0ge3R5cGV9ICQKICogQHBhcmFtIHt0eXBlfSB3aW5kb3cKICogQHBhcmFtIHt0eXBlfSBkb2N1bWVudAogKiBAcGFyYW0ge3R5cGV9IG5hbWUKICogQHBhcmFtIHt0eXBlfSB1bmRlZmluZWQKICogQHJldHVybnMge3VuZGVmaW5lZH0KICovCihmdW5jdGlvbigkLCB3aW5kb3csIGRvY3VtZW50LCBuYW1lKSB7CgoJdmFyIENMQVNTX1BPUE9WRVIgPSAnbXVpLXBvcG92ZXInOwoJdmFyIENMQVNTX1BPUE9WRVJfQVJST1cgPSAnbXVpLXBvcG92ZXItYXJyb3cnOwoJdmFyIENMQVNTX0FDVElPTl9QT1BPVkVSID0gJ211aS1wb3BvdmVyLWFjdGlvbic7Cgl2YXIgQ0xBU1NfQkFDS0RST1AgPSAnbXVpLWJhY2tkcm9wJzsKCXZhciBDTEFTU19CQVJfUE9QT1ZFUiA9ICdtdWktYmFyLXBvcG92ZXInOwoJdmFyIENMQVNTX0JBUl9CQUNLRFJPUCA9ICdtdWktYmFyLWJhY2tkcm9wJzsKCXZhciBDTEFTU19BQ1RJT05fQkFDS0RST1AgPSAnbXVpLWJhY2tkcm9wLWFjdGlvbic7Cgl2YXIgQ0xBU1NfQUNUSVZFID0gJ211aS1hY3RpdmUnOwoJdmFyIENMQVNTX0JPVFRPTSA9ICdtdWktYm90dG9tJzsKCgoKCXZhciBoYW5kbGUgPSBmdW5jdGlvbihldmVudCwgdGFyZ2V0KSB7CgkJaWYgKHRhcmdldC50YWdOYW1lID09PSAnQScgJiYgdGFyZ2V0Lmhhc2gpIHsKCQkJJC50YXJnZXRzLl9wb3BvdmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFyZ2V0Lmhhc2gucmVwbGFjZSgnIycsICcnKSk7CgkJCWlmICgkLnRhcmdldHMuX3BvcG92ZXIgJiYgJC50YXJnZXRzLl9wb3BvdmVyLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19QT1BPVkVSKSkgewoJCQkJcmV0dXJuIHRhcmdldDsKCQkJfSBlbHNlIHsKCQkJCSQudGFyZ2V0cy5fcG9wb3ZlciA9IG51bGw7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkkLnJlZ2lzdGVyVGFyZ2V0KHsKCQluYW1lOiBuYW1lLAoJCWluZGV4OiA2MCwKCQloYW5kbGU6IGhhbmRsZSwKCQl0YXJnZXQ6IGZhbHNlLAoJCWlzUmVzZXQ6IGZhbHNlLAoJCWlzQ29udGludWU6IHRydWUKCX0pOwoKCXZhciBvblBvcG92ZXJTaG93biA9IGZ1bmN0aW9uKGUpIHsKCQl0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCBvblBvcG92ZXJTaG93bik7CgkJdGhpcy5hZGRFdmVudExpc3RlbmVyKCQuRVZFTlRfTU9WRSwgJC5wcmV2ZW50RGVmYXVsdCk7CgkJJC50cmlnZ2VyKHRoaXMsICdzaG93bicsIHRoaXMpOwoJfQoJdmFyIG9uUG9wb3ZlckhpZGRlbiA9IGZ1bmN0aW9uKGUpIHsKCQlzZXRTdHlsZSh0aGlzLCAnbm9uZScpOwoJCXRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2Via2l0VHJhbnNpdGlvbkVuZCcsIG9uUG9wb3ZlckhpZGRlbik7CgkJdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCQuRVZFTlRfTU9WRSwgJC5wcmV2ZW50RGVmYXVsdCk7CgkJJC50cmlnZ2VyKHRoaXMsICdoaWRkZW4nLCB0aGlzKTsKCX07CgoJdmFyIGJhY2tkcm9wID0gKGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJZWxlbWVudC5jbGFzc0xpc3QuYWRkKENMQVNTX0JBQ0tEUk9QKTsKCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJC5FVkVOVF9NT1ZFLCAkLnByZXZlbnREZWZhdWx0KTsKCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RhcCcsIGZ1bmN0aW9uKGUpIHsKCQkJdmFyIHBvcG92ZXIgPSAkLnRhcmdldHMuX3BvcG92ZXI7CgkJCWlmIChwb3BvdmVyKSB7CgkJCQlwb3BvdmVyLmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCBvblBvcG92ZXJIaWRkZW4pOwoJCQkJcG9wb3Zlci5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0FDVElWRSk7CgkJCQlyZW1vdmVCYWNrZHJvcChwb3BvdmVyKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gZWxlbWVudDsKCX0oKSk7Cgl2YXIgcmVtb3ZlQmFja2Ryb3BUaW1lcjsKCXZhciByZW1vdmVCYWNrZHJvcCA9IGZ1bmN0aW9uKHBvcG92ZXIpIHsKCQliYWNrZHJvcC5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgJ29wYWNpdHk6MCcpOwoJCSQudGFyZ2V0cy5wb3BvdmVyID0gJC50YXJnZXRzLl9wb3BvdmVyID0gbnVsbDsgLy9yZXNldAoJCXJlbW92ZUJhY2tkcm9wVGltZXIgPSAkLmxhdGVyKGZ1bmN0aW9uKCkgewoJCQlpZiAoIXBvcG92ZXIuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkgJiYgYmFja2Ryb3AucGFyZW50Tm9kZSAmJiBiYWNrZHJvcC5wYXJlbnROb2RlID09PSBkb2N1bWVudC5ib2R5KSB7CgkJCQlkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGJhY2tkcm9wKTsKCQkJfQoJCX0sIDM1MCk7Cgl9OwoJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RhcCcsIGZ1bmN0aW9uKGUpIHsKCQlpZiAoISQudGFyZ2V0cy5wb3BvdmVyKSB7CgkJCXJldHVybjsKCQl9CgkJdmFyIHRvZ2dsZSA9IGZhbHNlOwoJCXZhciB0YXJnZXQgPSBlLnRhcmdldDsKCQlmb3IgKDsgdGFyZ2V0ICYmIHRhcmdldCAhPT0gZG9jdW1lbnQ7IHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlKSB7CgkJCWlmICh0YXJnZXQgPT09ICQudGFyZ2V0cy5wb3BvdmVyKSB7CgkJCQl0b2dnbGUgPSB0cnVlOwoJCQl9CgkJfQoJCWlmICh0b2dnbGUpIHsKCQkJZS5kZXRhaWwuZ2VzdHVyZS5wcmV2ZW50RGVmYXVsdCgpOyAvL2ZpeGVkIGhhc2hjaGFuZ2UKCQkJdG9nZ2xlUG9wb3ZlcigkLnRhcmdldHMuX3BvcG92ZXIsICQudGFyZ2V0cy5wb3BvdmVyKTsKCQl9CgoJfSk7CgoJdmFyIHRvZ2dsZVBvcG92ZXIgPSBmdW5jdGlvbihwb3BvdmVyLCBhbmNob3IsIHN0YXRlKSB7CgkJaWYgKChzdGF0ZSA9PT0gJ3Nob3cnICYmIHBvcG92ZXIuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkpIHx8IChzdGF0ZSA9PT0gJ2hpZGUnICYmICFwb3BvdmVyLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19BQ1RJVkUpKSkgewoJCQlyZXR1cm47CgkJfQoJCXJlbW92ZUJhY2tkcm9wVGltZXIgJiYgcmVtb3ZlQmFja2Ryb3BUaW1lci5jYW5jZWwoKTsgLy/lj5bmtohyZW1vdmXnmoR0aW1lcgoJCS8vcmVtb3Zl5LiA6YGN77yM5Lul5YWN5p2l5Zue5b+r6YCf5YiH5o2i77yM5a+86Ie0d2Via2l0VHJhbnNpdGlvbkVuZOS4jeinpuWPke+8jOaXoOazlXJlbW92ZQoJCXBvcG92ZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2Via2l0VHJhbnNpdGlvbkVuZCcsIG9uUG9wb3ZlclNob3duKTsKCQlwb3BvdmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCBvblBvcG92ZXJIaWRkZW4pOwoJCWJhY2tkcm9wLmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfQkFSX0JBQ0tEUk9QKTsKCQliYWNrZHJvcC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0FDVElPTl9CQUNLRFJPUCk7CgkJdmFyIF9wb3BvdmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm11aS1wb3BvdmVyLm11aS1hY3RpdmUnKTsKCQlpZiAoX3BvcG92ZXIpIHsKCQkJLy8JCQlfcG9wb3Zlci5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgJycpOwoJCQlfcG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRUcmFuc2l0aW9uRW5kJywgb25Qb3BvdmVySGlkZGVuKTsKCQkJX3BvcG92ZXIuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19BQ1RJVkUpOwoJCQkvLwkJCV9wb3BvdmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCBvblBvcG92ZXJIaWRkZW4pOwoJCQkvL+WQjOS4gOS4quW8ueWHuuWImeebtOaOpei/lOWbnu+8jOino+WGs+WQjOS4gOS4qnBvcG92ZXLnmoR0b2dnbGUKCQkJaWYgKHBvcG92ZXIgPT09IF9wb3BvdmVyKSB7CgkJCQlyZW1vdmVCYWNrZHJvcChfcG9wb3Zlcik7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJdmFyIGlzQWN0aW9uU2hlZXQgPSBmYWxzZTsKCQlpZiAocG9wb3Zlci5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfQkFSX1BPUE9WRVIpIHx8IHBvcG92ZXIuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElPTl9QT1BPVkVSKSkgeyAvL25hdkJhcgoJCQlpZiAocG9wb3Zlci5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfQUNUSU9OX1BPUE9WRVIpKSB7IC8vYWN0aW9uIHNoZWV0IHBvcG92ZXIKCQkJCWlzQWN0aW9uU2hlZXQgPSB0cnVlOwoJCQkJYmFja2Ryb3AuY2xhc3NMaXN0LmFkZChDTEFTU19BQ1RJT05fQkFDS0RST1ApOwoJCQl9IGVsc2UgeyAvL2JhciBwb3BvdmVyCgkJCQliYWNrZHJvcC5jbGFzc0xpc3QuYWRkKENMQVNTX0JBUl9CQUNLRFJPUCk7CgkJCQkvLwkJCQlpZiAoYW5jaG9yKSB7CgkJCQkvLwkJCQkJaWYgKGFuY2hvci5wYXJlbnROb2RlKSB7CgkJCQkvLwkJCQkJCXZhciBvZmZzZXRXaWR0aCA9IGFuY2hvci5vZmZzZXRXaWR0aDsKCQkJCS8vCQkJCQkJdmFyIG9mZnNldExlZnQgPSBhbmNob3Iub2Zmc2V0TGVmdDsKCQkJCS8vCQkJCQkJdmFyIGlubmVyV2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKCQkJCS8vCQkJCQkJcG9wb3Zlci5zdHlsZS5sZWZ0ID0gKE1hdGgubWluKE1hdGgubWF4KG9mZnNldExlZnQsIGRlZmF1bHRQYWRkaW5nKSwgaW5uZXJXaWR0aCAtIG9mZnNldFdpZHRoIC0gZGVmYXVsdFBhZGRpbmcpKSArICJweCI7CgkJCQkvLwkJCQkJfSBlbHNlIHsKCQkJCS8vCQkJCQkJLy9UT0RPIGFuY2hvciBpcyBwb3NpdGlvbjp7bGVmdCx0b3AsYm90dG9tLHJpZ2h0fQoJCQkJLy8JCQkJCX0KCQkJCS8vCQkJCX0KCQkJfQoJCX0KCQlzZXRTdHlsZShwb3BvdmVyLCAnYmxvY2snKTsgLy9hY3Rpb25zaGVldCB0cmFuc2Zvcm0KCQlwb3BvdmVyLm9mZnNldEhlaWdodDsKCQlwb3BvdmVyLmNsYXNzTGlzdC5hZGQoQ0xBU1NfQUNUSVZFKTsKCQliYWNrZHJvcC5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgJycpOwoJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYmFja2Ryb3ApOwoJCWNhbFBvc2l0aW9uKHBvcG92ZXIsIGFuY2hvciwgaXNBY3Rpb25TaGVldCk7IC8vcG9zaXRpb24KCQliYWNrZHJvcC5jbGFzc0xpc3QuYWRkKENMQVNTX0FDVElWRSk7CgkJcG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRUcmFuc2l0aW9uRW5kJywgb25Qb3BvdmVyU2hvd24pOwoJfTsKCXZhciBzZXRTdHlsZSA9IGZ1bmN0aW9uKHBvcG92ZXIsIGRpc3BsYXksIHRvcCwgbGVmdCkgewoJCXZhciBzdHlsZSA9IHBvcG92ZXIuc3R5bGU7CgkJaWYgKHR5cGVvZiBkaXNwbGF5ICE9PSAndW5kZWZpbmVkJykKCQkJc3R5bGUuZGlzcGxheSA9IGRpc3BsYXk7CgkJaWYgKHR5cGVvZiB0b3AgIT09ICd1bmRlZmluZWQnKQoJCQlzdHlsZS50b3AgPSB0b3AgKyAncHgnOwoJCWlmICh0eXBlb2YgbGVmdCAhPT0gJ3VuZGVmaW5lZCcpCgkJCXN0eWxlLmxlZnQgPSBsZWZ0ICsgJ3B4JzsKCX07Cgl2YXIgY2FsUG9zaXRpb24gPSBmdW5jdGlvbihwb3BvdmVyLCBhbmNob3IsIGlzQWN0aW9uU2hlZXQpIHsKCQlpZiAoIXBvcG92ZXIgfHwgIWFuY2hvcikgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoaXNBY3Rpb25TaGVldCkgeyAvL2FjdGlvbnNoZWV0CgkJCXNldFN0eWxlKHBvcG92ZXIsICdibG9jaycpCgkJCXJldHVybjsKCQl9CgoJCXZhciB3V2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKCQl2YXIgd0hlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKCgkJdmFyIHBXaWR0aCA9IHBvcG92ZXIub2Zmc2V0V2lkdGg7CgkJdmFyIHBIZWlnaHQgPSBwb3BvdmVyLm9mZnNldEhlaWdodDsKCgkJdmFyIGFXaWR0aCA9IGFuY2hvci5vZmZzZXRXaWR0aDsKCQl2YXIgYUhlaWdodCA9IGFuY2hvci5vZmZzZXRIZWlnaHQ7CgkJdmFyIG9mZnNldCA9ICQub2Zmc2V0KGFuY2hvcik7CgoJCXZhciBhcnJvdyA9IHBvcG92ZXIucXVlcnlTZWxlY3RvcignLicgKyBDTEFTU19QT1BPVkVSX0FSUk9XKTsKCQlpZiAoIWFycm93KSB7CgkJCWFycm93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCWFycm93LmNsYXNzTmFtZSA9IENMQVNTX1BPUE9WRVJfQVJST1c7CgkJCXBvcG92ZXIuYXBwZW5kQ2hpbGQoYXJyb3cpOwoJCX0KCQl2YXIgYXJyb3dTaXplID0gYXJyb3cgJiYgYXJyb3cub2Zmc2V0V2lkdGggLyAyIHx8IDA7CgoKCgkJdmFyIHBUb3AgPSAwOwoJCXZhciBwTGVmdCA9IDA7CgkJdmFyIGRpZmYgPSAwOwoJCXZhciBhcnJvd0xlZnQgPSAwOwoJCXZhciBkZWZhdWx0UGFkZGluZyA9IHBvcG92ZXIuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElPTl9QT1BPVkVSKSA/IDAgOiA1OwoKCQl2YXIgcG9zaXRpb24gPSAndG9wJzsKCQlpZiAoKHBIZWlnaHQgKyBhcnJvd1NpemUpIDwgKG9mZnNldC50b3AgLSB3aW5kb3cucGFnZVlPZmZzZXQpKSB7IC8vdG9wCgkJCXBUb3AgPSBvZmZzZXQudG9wIC0gcEhlaWdodCAtIGFycm93U2l6ZTsKCQl9IGVsc2UgaWYgKChwSGVpZ2h0ICsgYXJyb3dTaXplKSA8ICh3SGVpZ2h0IC0gKG9mZnNldC50b3AgLSB3aW5kb3cucGFnZVlPZmZzZXQpIC0gYUhlaWdodCkpIHsgLy9ib3R0b20KCQkJcG9zaXRpb24gPSAnYm90dG9tJzsKCQkJcFRvcCA9IG9mZnNldC50b3AgKyBhSGVpZ2h0ICsgYXJyb3dTaXplOwoJCX0gZWxzZSB7IC8vbWlkZGxlCgkJCXBvc2l0aW9uID0gJ21pZGRsZSc7CgkJCXBUb3AgPSBNYXRoLm1heCgod0hlaWdodCAtIHBIZWlnaHQpIC8gMiArIHdpbmRvdy5wYWdlWU9mZnNldCwgMCk7CgkJCXBMZWZ0ID0gTWF0aC5tYXgoKHdXaWR0aCAtIHBXaWR0aCkgLyAyICsgd2luZG93LnBhZ2VYT2Zmc2V0LCAwKTsKCQl9CgkJaWYgKHBvc2l0aW9uID09PSAndG9wJyB8fCBwb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHsKCQkJcExlZnQgPSBhV2lkdGggLyAyICsgb2Zmc2V0LmxlZnQgLSBwV2lkdGggLyAyOwoJCQlkaWZmID0gcExlZnQ7CgkJCWlmIChwTGVmdCA8IGRlZmF1bHRQYWRkaW5nKSBwTGVmdCA9IGRlZmF1bHRQYWRkaW5nOwoJCQlpZiAocExlZnQgKyBwV2lkdGggPiB3V2lkdGgpIHBMZWZ0ID0gd1dpZHRoIC0gcFdpZHRoIC0gZGVmYXVsdFBhZGRpbmc7CgoJCQlpZiAoYXJyb3cpIHsKCQkJCWlmIChwb3NpdGlvbiA9PT0gJ3RvcCcpIHsKCQkJCQlhcnJvdy5jbGFzc0xpc3QuYWRkKENMQVNTX0JPVFRPTSk7CgkJCQl9IGVsc2UgewoJCQkJCWFycm93LmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfQk9UVE9NKTsKCQkJCX0KCQkJCWRpZmYgPSBkaWZmIC0gcExlZnQ7CgkJCQlhcnJvd0xlZnQgPSAocFdpZHRoIC8gMiAtIGFycm93U2l6ZSAvIDIgKyBkaWZmKTsKCQkJCWFycm93TGVmdCA9IE1hdGgubWF4KE1hdGgubWluKGFycm93TGVmdCwgcFdpZHRoIC0gYXJyb3dTaXplICogMiAtIDYpLCA2KTsKCQkJCWFycm93LnNldEF0dHJpYnV0ZSgnc3R5bGUnLCAnbGVmdDonICsgYXJyb3dMZWZ0ICsgJ3B4Jyk7CgkJCX0KCQl9IGVsc2UgaWYgKHBvc2l0aW9uID09PSAnbWlkZGxlJykgewoJCQlhcnJvdy5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgJ2Rpc3BsYXk6bm9uZScpOwoJCX0KCQlzZXRTdHlsZShwb3BvdmVyLCAnYmxvY2snLCBwVG9wLCBwTGVmdCk7Cgl9OwoKCSQuY3JlYXRlTWFzayA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQllbGVtZW50LmNsYXNzTGlzdC5hZGQoQ0xBU1NfQkFDS0RST1ApOwoJCWVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigkLkVWRU5UX01PVkUsICQucHJldmVudERlZmF1bHQpOwoJCWVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndGFwJywgZnVuY3Rpb24oKSB7CgkJCW1hc2suY2xvc2UoKTsKCQl9KTsKCQl2YXIgbWFzayA9IFtlbGVtZW50XTsKCQltYXNrLl9zaG93ID0gZmFsc2U7CgkJbWFzay5zaG93ID0gZnVuY3Rpb24oKSB7CgkJCW1hc2suX3Nob3cgPSB0cnVlOwoJCQllbGVtZW50LnNldEF0dHJpYnV0ZSgnc3R5bGUnLCAnb3BhY2l0eToxJyk7CgkJCWRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJCXJldHVybiBtYXNrOwoJCX07CgkJbWFzay5fcmVtb3ZlID0gZnVuY3Rpb24oKSB7CgkJCWlmIChtYXNrLl9zaG93KSB7CgkJCQltYXNrLl9zaG93ID0gZmFsc2U7CgkJCQllbGVtZW50LnNldEF0dHJpYnV0ZSgnc3R5bGUnLCAnb3BhY2l0eTowJyk7CgkJCQkkLmxhdGVyKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBib2R5ID0gZG9jdW1lbnQuYm9keTsKCQkJCQllbGVtZW50LnBhcmVudE5vZGUgPT09IGJvZHkgJiYgYm9keS5yZW1vdmVDaGlsZChlbGVtZW50KTsKCQkJCX0sIDM1MCk7CgkJCX0KCQkJcmV0dXJuIG1hc2s7CgkJfTsKCQltYXNrLmNsb3NlID0gZnVuY3Rpb24oKSB7CgkJCWlmIChjYWxsYmFjaykgewoJCQkJaWYgKGNhbGxiYWNrKCkgIT09IGZhbHNlKSB7CgkJCQkJbWFzay5fcmVtb3ZlKCk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQltYXNrLl9yZW1vdmUoKTsKCQkJfQoJCX07CgkJcmV0dXJuIG1hc2s7Cgl9OwoJJC5mbi5wb3BvdmVyID0gZnVuY3Rpb24oKSB7CgkJdmFyIGFyZ3MgPSBhcmd1bWVudHM7CgkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkkLnRhcmdldHMuX3BvcG92ZXIgPSB0aGlzOwoJCQlpZiAoYXJnc1swXSA9PT0gJ3Nob3cnIHx8IGFyZ3NbMF0gPT09ICdoaWRlJyB8fCBhcmdzWzBdID09PSAndG9nZ2xlJykgewoJCQkJdG9nZ2xlUG9wb3Zlcih0aGlzLCBhcmdzWzFdLCBhcmdzWzBdKTsKCQkJfQoJCX0pOwoJfTsKCn0pKG11aSwgd2luZG93LCBkb2N1bWVudCwgJ3BvcG92ZXInKTsKLyoqCiAqIHNlZ21lbnRlZC1jb250cm9sbGVycwogKiBAcGFyYW0ge3R5cGV9ICQKICogQHBhcmFtIHt0eXBlfSB3aW5kb3cKICogQHBhcmFtIHt0eXBlfSBkb2N1bWVudAogKiBAcGFyYW0ge3R5cGV9IHVuZGVmaW5lZAogKiBAcmV0dXJucyB7dW5kZWZpbmVkfQogKi8KKGZ1bmN0aW9uKCQsIHdpbmRvdywgZG9jdW1lbnQsIG5hbWUsIHVuZGVmaW5lZCkgewoKICAgIHZhciBDTEFTU19DT05UUk9MX0lURU0gPSAnbXVpLWNvbnRyb2wtaXRlbSc7CiAgICB2YXIgQ0xBU1NfU0VHTUVOVEVEX0NPTlRST0wgPSAnbXVpLXNlZ21lbnRlZC1jb250cm9sJzsKICAgIHZhciBDTEFTU19TRUdNRU5URURfQ09OVFJPTF9WRVJUSUNBTCA9ICdtdWktc2VnbWVudGVkLWNvbnRyb2wtdmVydGljYWwnOwogICAgdmFyIENMQVNTX0NPTlRST0xfQ09OVEVOVCA9ICdtdWktY29udHJvbC1jb250ZW50JzsKICAgIHZhciBDTEFTU19UQUJfQkFSID0gJ211aS1iYXItdGFiJzsKICAgIHZhciBDTEFTU19UQUJfSVRFTSA9ICdtdWktdGFiLWl0ZW0nOwogICAgdmFyIENMQVNTX1NMSURFUl9JVEVNID0gJ211aS1zbGlkZXItaXRlbSc7CgogICB2YXIgaGFuZGxlID0gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCkgewogICAgICAgIGlmICh0YXJnZXQuY2xhc3NMaXN0ICYmICh0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0NPTlRST0xfSVRFTSkgfHwgdGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19UQUJfSVRFTSkpKSB7CiAgICAgICAgICAgIGlmICh0YXJnZXQucGFyZW50Tm9kZSAmJiB0YXJnZXQucGFyZW50Tm9kZS5jbGFzc0xpc3QgJiYgdGFyZ2V0LnBhcmVudE5vZGUuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX1NFR01FTlRFRF9DT05UUk9MX1ZFUlRJQ0FMKSkgewogICAgICAgICAgICAgICAgLy92ZXJ0aWNhbCDlpoLmnpxwcmV2ZW50RGVmYXVsdOS8muWvvOiHtOaXoOazlea7muWKqAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIGlmKHRhcmdldC50YWdOYW1lID09ICdBJykgewogICAgICAgICAgICAgICAgICAgIC8vICAgICAvLyBmaXhlZCDlupXpg6jpgInpobnljaFocmVmIOaXoOazlei3s+i9rCAmJiBzdG9wIGhhc2ggY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgLy8gICAgIHZhciBjdXJyX2hyZWYgPSBsb2NhdGlvbi5ob3N0bmFtZSArIGxvY2F0aW9uLnBhdGhuYW1lLAogICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgdGFyZ2V0X2hyZWYgPSB0YXJnZXQuaG9zdG5hbWUgKyB0YXJnZXQucGF0aG5hbWU7CiAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyAgICAgaWYgKGN1cnJfaHJlZiA9PSB0YXJnZXRfaHJlZiAmJiB0YXJnZXQuaGFzaCAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgICAgICAgICAgICAgIC8vICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgICAgICAgICAgICAvLyAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAgICAgICAgICBpZiAodGFyZ2V0Lmhhc2gpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICAgICAgLy8gICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgICQucmVnaXN0ZXJUYXJnZXQoewogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgaW5kZXg6IDgwLAogICAgICAgIGhhbmRsZTogaGFuZGxlLAogICAgICAgIHRhcmdldDogZmFsc2UKICAgIH0pOwoKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0YXAnLCBmdW5jdGlvbihlKSB7CgogICAgICAgIHZhciB0YXJnZXRUYWIgPSAkLnRhcmdldHMudGFiOwogICAgICAgIGlmICghdGFyZ2V0VGFiKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGFjdGl2ZVRhYjsKICAgICAgICB2YXIgYWN0aXZlQm9kaWVzOwogICAgICAgIHZhciB0YXJnZXRCb2R5OwogICAgICAgIHZhciBjbGFzc05hbWUgPSAnbXVpLWFjdGl2ZSc7CiAgICAgICAgdmFyIGNsYXNzU2VsZWN0b3IgPSAnLicgKyBjbGFzc05hbWU7CiAgICAgICAgdmFyIHNlZ21lbnRlZENvbnRyb2wgPSB0YXJnZXRUYWIucGFyZW50Tm9kZTsKCiAgICAgICAgZm9yICg7IHNlZ21lbnRlZENvbnRyb2wgJiYgc2VnbWVudGVkQ29udHJvbCAhPT0gZG9jdW1lbnQ7IHNlZ21lbnRlZENvbnRyb2wgPSBzZWdtZW50ZWRDb250cm9sLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgaWYgKHNlZ21lbnRlZENvbnRyb2wuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX1NFR01FTlRFRF9DT05UUk9MKSkgewogICAgICAgICAgICAgICAgYWN0aXZlVGFiID0gc2VnbWVudGVkQ29udHJvbC5xdWVyeVNlbGVjdG9yKGNsYXNzU2VsZWN0b3IgKyAnLicgKyBDTEFTU19DT05UUk9MX0lURU0pOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2VnbWVudGVkQ29udHJvbC5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfVEFCX0JBUikpIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVRhYiA9IHNlZ21lbnRlZENvbnRyb2wucXVlcnlTZWxlY3RvcihjbGFzc1NlbGVjdG9yICsgJy4nICsgQ0xBU1NfVEFCX0lURU0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYWN0aXZlVGFiKSB7CiAgICAgICAgICAgIGFjdGl2ZVRhYi5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgaXNMYXN0QWN0aXZlID0gdGFyZ2V0VGFiID09PSBhY3RpdmVUYWI7CiAgICAgICAgaWYgKHRhcmdldFRhYikgewogICAgICAgICAgICB0YXJnZXRUYWIuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0YXJnZXRUYWIuaGFzaCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRhcmdldEJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YXJnZXRUYWIuaGFzaC5yZXBsYWNlKCcjJywgJycpKTsKCiAgICAgICAgaWYgKCF0YXJnZXRCb2R5KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKCF0YXJnZXRCb2R5LmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19DT05UUk9MX0NPTlRFTlQpKSB7IC8vdGFiIGJhciBwb3BvdmVyCiAgICAgICAgICAgIHRhcmdldFRhYi5jbGFzc0xpc3RbaXNMYXN0QWN0aXZlID8gJ3JlbW92ZScgOiAnYWRkJ10oY2xhc3NOYW1lKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNMYXN0QWN0aXZlKSB7IC8vc2FtZQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBwYXJlbnROb2RlID0gdGFyZ2V0Qm9keS5wYXJlbnROb2RlOwogICAgICAgIGFjdGl2ZUJvZGllcyA9IHBhcmVudE5vZGUucXVlcnlTZWxlY3RvckFsbCgnLicgKyBDTEFTU19DT05UUk9MX0NPTlRFTlQgKyBjbGFzc1NlbGVjdG9yKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFjdGl2ZUJvZGllcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgYWN0aXZlQm9keSA9IGFjdGl2ZUJvZGllc1tpXTsKICAgICAgICAgICAgYWN0aXZlQm9keS5wYXJlbnROb2RlID09PSBwYXJlbnROb2RlICYmIGFjdGl2ZUJvZHkuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgICAgIH0KCiAgICAgICAgdGFyZ2V0Qm9keS5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7CgogICAgICAgIHZhciBjb250ZW50cyA9IFtdOwogICAgICAgIHZhciBfY29udGVudHMgPSBwYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgQ0xBU1NfQ09OVFJPTF9DT05URU5UKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9jb250ZW50cy5sZW5ndGg7IGkrKykgeyAvL+afpeaJvuebtOWxnuWtkOiKgueCuQogICAgICAgICAgICBfY29udGVudHNbaV0ucGFyZW50Tm9kZSA9PT0gcGFyZW50Tm9kZSAmJiAoY29udGVudHMucHVzaChfY29udGVudHNbaV0pKTsKICAgICAgICB9CiAgICAgICAgJC50cmlnZ2VyKHRhcmdldEJvZHksICQuZXZlbnROYW1lKCdzaG93bicsIG5hbWUpLCB7CiAgICAgICAgICAgIHRhYk51bWJlcjogQXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChjb250ZW50cywgdGFyZ2V0Qm9keSkKICAgICAgICB9KTsKICAgICAgICBlLmRldGFpbCAmJiBlLmRldGFpbC5nZXN0dXJlLnByZXZlbnREZWZhdWx0KCk7IC8vZml4ZWQgaGFzaGNoYW5nZQogICAgfSk7Cgp9KShtdWksIHdpbmRvdywgZG9jdW1lbnQsICd0YWInKTsKLyoqCiAqIFRvZ2dsZXMgc3dpdGNoCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcGFyYW0ge3R5cGV9IHdpbmRvdwogKiBAcGFyYW0ge3R5cGV9IG5hbWUKICogQHJldHVybnMge3VuZGVmaW5lZH0KICovCihmdW5jdGlvbigkLCB3aW5kb3csIG5hbWUpIHsKCgl2YXIgQ0xBU1NfU1dJVENIID0gJ211aS1zd2l0Y2gnOwoJdmFyIENMQVNTX1NXSVRDSF9IQU5ETEUgPSAnbXVpLXN3aXRjaC1oYW5kbGUnOwoJdmFyIENMQVNTX0FDVElWRSA9ICdtdWktYWN0aXZlJzsKCXZhciBDTEFTU19EUkFHR0lORyA9ICdtdWktZHJhZ2dpbmcnOwoKCXZhciBDTEFTU19ESVNBQkxFRCA9ICdtdWktZGlzYWJsZWQnOwoKCXZhciBTRUxFQ1RPUl9TV0lUQ0hfSEFORExFID0gJy4nICsgQ0xBU1NfU1dJVENIX0hBTkRMRTsKCgl2YXIgaGFuZGxlID0gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCkgewoJCWlmICh0YXJnZXQuY2xhc3NMaXN0ICYmIHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfU1dJVENIKSkgewoJCQlyZXR1cm4gdGFyZ2V0OwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9OwoKCSQucmVnaXN0ZXJUYXJnZXQoewoJCW5hbWU6IG5hbWUsCgkJaW5kZXg6IDEwMCwKCQloYW5kbGU6IGhhbmRsZSwKCQl0YXJnZXQ6IGZhbHNlCgl9KTsKCgoJdmFyIFRvZ2dsZSA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCQl0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwoJCXRoaXMuY2xhc3NMaXN0ID0gdGhpcy5lbGVtZW50LmNsYXNzTGlzdDsKCQl0aGlzLmhhbmRsZSA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX1NXSVRDSF9IQU5ETEUpOwoJCXRoaXMuaW5pdCgpOwoJCXRoaXMuaW5pdEV2ZW50KCk7Cgl9OwoJVG9nZ2xlLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKSB7CgkJdGhpcy50b2dnbGVXaWR0aCA9IHRoaXMuZWxlbWVudC5vZmZzZXRXaWR0aDsKCQl0aGlzLmhhbmRsZVdpZHRoID0gdGhpcy5oYW5kbGUub2Zmc2V0V2lkdGg7CgkJdGhpcy5oYW5kbGVYID0gdGhpcy50b2dnbGVXaWR0aCAtIHRoaXMuaGFuZGxlV2lkdGggLSAzOwoJfTsKCVRvZ2dsZS5wcm90b3R5cGUuaW5pdEV2ZW50ID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJC5FVkVOVF9TVEFSVCwgdGhpcyk7CgkJdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWcnLCB0aGlzKTsKCQl0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc3dpcGVyaWdodCcsIHRoaXMpOwoJCXRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCQuRVZFTlRfRU5ELCB0aGlzKTsKCQl0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigkLkVWRU5UX0NBTkNFTCwgdGhpcyk7CgoJfTsKCVRvZ2dsZS5wcm90b3R5cGUuaGFuZGxlRXZlbnQgPSBmdW5jdGlvbihlKSB7CgkJaWYgKHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0RJU0FCTEVEKSkgewoJCQlyZXR1cm47CgkJfQoJCXN3aXRjaCAoZS50eXBlKSB7CgkJCWNhc2UgJC5FVkVOVF9TVEFSVDoKCQkJCXRoaXMuc3RhcnQoZSk7CgkJCQlicmVhazsKCQkJY2FzZSAnZHJhZyc6CgkJCQl0aGlzLmRyYWcoZSk7CgkJCQlicmVhazsKCQkJY2FzZSAnc3dpcGVyaWdodCc6CgkJCQl0aGlzLnN3aXBlcmlnaHQoKTsKCQkJCWJyZWFrOwoJCQljYXNlICQuRVZFTlRfRU5EOgoJCQljYXNlICQuRVZFTlRfQ0FOQ0VMOgoJCQkJdGhpcy5lbmQoZSk7CgkJCQlicmVhazsKCQl9Cgl9OwoJVG9nZ2xlLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKGUpIHsKCQl0aGlzLmhhbmRsZS5zdHlsZS53ZWJraXRUcmFuc2l0aW9uRHVyYXRpb24gPSB0aGlzLmVsZW1lbnQuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gJy4ycyc7CgkJdGhpcy5jbGFzc0xpc3QuYWRkKENMQVNTX0RSQUdHSU5HKTsKCQlpZiAodGhpcy50b2dnbGVXaWR0aCA9PT0gMCB8fCB0aGlzLmhhbmRsZVdpZHRoID09PSAwKSB7IC8v5b2Tc3dpdGNo5aSE5LqO6ZqQ6JeP54q25oCB5pe277yMd2lkdGjkuLow77yM6ZyA6KaB6YeN5paw5Yid5aeL5YyWCgkJCXRoaXMuaW5pdCgpOwoJCX0KCX07CglUb2dnbGUucHJvdG90eXBlLmRyYWcgPSBmdW5jdGlvbihlKSB7CgkJdmFyIGRldGFpbCA9IGUuZGV0YWlsOwoJCWlmICghdGhpcy5pc0RyYWdnaW5nKSB7CgkJCWlmIChkZXRhaWwuZGlyZWN0aW9uID09PSAnbGVmdCcgfHwgZGV0YWlsLmRpcmVjdGlvbiA9PT0gJ3JpZ2h0JykgewoJCQkJdGhpcy5pc0RyYWdnaW5nID0gdHJ1ZTsKCQkJCXRoaXMubGFzdENoYW5nZWQgPSB1bmRlZmluZWQ7CgkJCQl0aGlzLmluaXRpYWxTdGF0ZSA9IHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSk7CgkJCX0KCQl9CgkJaWYgKHRoaXMuaXNEcmFnZ2luZykgewoJCQl0aGlzLnNldFRyYW5zbGF0ZVgoZGV0YWlsLmRlbHRhWCk7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCWRldGFpbC5nZXN0dXJlLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfTsKCVRvZ2dsZS5wcm90b3R5cGUuc3dpcGVyaWdodCA9IGZ1bmN0aW9uKGUpIHsKCQlpZiAodGhpcy5pc0RyYWdnaW5nKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfTsKCVRvZ2dsZS5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24oZSkgewoJCXRoaXMuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19EUkFHR0lORyk7CgkJaWYgKHRoaXMuaXNEcmFnZ2luZykgewoJCQl0aGlzLmlzRHJhZ2dpbmcgPSBmYWxzZTsKCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQkJJC50cmlnZ2VyKHRoaXMuZWxlbWVudCwgJ3RvZ2dsZScsIHsKCQkJCWlzQWN0aXZlOiB0aGlzLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19BQ1RJVkUpCgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMudG9nZ2xlKCk7CgkJfQoJfTsKCVRvZ2dsZS5wcm90b3R5cGUudG9nZ2xlID0gZnVuY3Rpb24oYW5pbWF0ZSkgewoJCXZhciBjbGFzc0xpc3QgPSB0aGlzLmNsYXNzTGlzdDsKCQlpZiAoYW5pbWF0ZSA9PT0gZmFsc2UpIHsKCQkJdGhpcy5oYW5kbGUuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gdGhpcy5lbGVtZW50LnN0eWxlLndlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiA9ICcwcyc7CgkJfSBlbHNlIHsKCQkJdGhpcy5oYW5kbGUuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gdGhpcy5lbGVtZW50LnN0eWxlLndlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiA9ICcuMnMnOwoJCX0KCQlpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkpIHsKCQkJY2xhc3NMaXN0LnJlbW92ZShDTEFTU19BQ1RJVkUpOwoJCQl0aGlzLmhhbmRsZS5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSAndHJhbnNsYXRlKDAsMCknOwoJCX0gZWxzZSB7CgkJCWNsYXNzTGlzdC5hZGQoQ0xBU1NfQUNUSVZFKTsKCQkJdGhpcy5oYW5kbGUuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gJ3RyYW5zbGF0ZSgnICsgdGhpcy5oYW5kbGVYICsgJ3B4LDApJzsKCQl9CgkJJC50cmlnZ2VyKHRoaXMuZWxlbWVudCwgJ3RvZ2dsZScsIHsKCQkJaXNBY3RpdmU6IHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkKCQl9KTsKCX07CglUb2dnbGUucHJvdG90eXBlLnNldFRyYW5zbGF0ZVggPSAkLmFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKHgpIHsKCQlpZiAoIXRoaXMuaXNEcmFnZ2luZykgewoJCQlyZXR1cm47CgkJfQoJCXZhciBpc0NoYW5nZWQgPSBmYWxzZTsKCQlpZiAoKHRoaXMuaW5pdGlhbFN0YXRlICYmIC14ID4gKHRoaXMuaGFuZGxlWCAvIDIpKSB8fCAoIXRoaXMuaW5pdGlhbFN0YXRlICYmIHggPiAodGhpcy5oYW5kbGVYIC8gMikpKSB7CgkJCWlzQ2hhbmdlZCA9IHRydWU7CgkJfQoJCWlmICh0aGlzLmxhc3RDaGFuZ2VkICE9PSBpc0NoYW5nZWQpIHsKCQkJaWYgKGlzQ2hhbmdlZCkgewoJCQkJdGhpcy5oYW5kbGUuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gJ3RyYW5zbGF0ZSgnICsgKHRoaXMuaW5pdGlhbFN0YXRlID8gMCA6IHRoaXMuaGFuZGxlWCkgKyAncHgsMCknOwoJCQkJdGhpcy5jbGFzc0xpc3RbdGhpcy5pbml0aWFsU3RhdGUgPyAncmVtb3ZlJyA6ICdhZGQnXShDTEFTU19BQ1RJVkUpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5oYW5kbGUuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gJ3RyYW5zbGF0ZSgnICsgKHRoaXMuaW5pdGlhbFN0YXRlID8gdGhpcy5oYW5kbGVYIDogMCkgKyAncHgsMCknOwoJCQkJdGhpcy5jbGFzc0xpc3RbdGhpcy5pbml0aWFsU3RhdGUgPyAnYWRkJyA6ICdyZW1vdmUnXShDTEFTU19BQ1RJVkUpOwoJCQl9CgkJCXRoaXMubGFzdENoYW5nZWQgPSBpc0NoYW5nZWQ7CgkJfQoKCX0pOwoKCSQuZm5bJ3N3aXRjaCddID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCXZhciBzd2l0Y2hBcGlzID0gW107CgkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgc3dpdGNoQXBpID0gbnVsbDsKCQkJdmFyIGlkID0gdGhpcy5nZXRBdHRyaWJ1dGUoJ2RhdGEtc3dpdGNoJyk7CgkJCWlmICghaWQpIHsKCQkJCWlkID0gKyskLnV1aWQ7CgkJCQkkLmRhdGFbaWRdID0gbmV3IFRvZ2dsZSh0aGlzKTsKCQkJCXRoaXMuc2V0QXR0cmlidXRlKCdkYXRhLXN3aXRjaCcsIGlkKTsKCQkJfSBlbHNlIHsKCQkJCXN3aXRjaEFwaSA9ICQuZGF0YVtpZF07CgkJCX0KCQkJc3dpdGNoQXBpcy5wdXNoKHN3aXRjaEFwaSk7CgkJfSk7CgkJcmV0dXJuIHN3aXRjaEFwaXMubGVuZ3RoID4gMSA/IHN3aXRjaEFwaXMgOiBzd2l0Y2hBcGlzWzBdOwoJfTsKCSQucmVhZHkoZnVuY3Rpb24oKSB7CgkJJCgnLicgKyBDTEFTU19TV0lUQ0gpWydzd2l0Y2gnXSgpOwoJfSk7Cn0pKG11aSwgd2luZG93LCAndG9nZ2xlJyk7Ci8qKgogKiBUYWJsZXZpZXdzCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcGFyYW0ge3R5cGV9IHdpbmRvdwogKiBAcGFyYW0ge3R5cGV9IGRvY3VtZW50CiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgd2luZG93LCBkb2N1bWVudCkgewoKCXZhciBDTEFTU19BQ1RJVkUgPSAnbXVpLWFjdGl2ZSc7Cgl2YXIgQ0xBU1NfU0VMRUNURUQgPSAnbXVpLXNlbGVjdGVkJzsKCXZhciBDTEFTU19HUklEX1ZJRVcgPSAnbXVpLWdyaWQtdmlldyc7Cgl2YXIgQ0xBU1NfUkFESU9fVklFVyA9ICdtdWktdGFibGUtdmlldy1yYWRpbyc7Cgl2YXIgQ0xBU1NfVEFCTEVfVklFV19DRUxMID0gJ211aS10YWJsZS12aWV3LWNlbGwnOwoJdmFyIENMQVNTX0NPTExBUFNFX0NPTlRFTlQgPSAnbXVpLWNvbGxhcHNlLWNvbnRlbnQnOwoJdmFyIENMQVNTX0RJU0FCTEVEID0gJ211aS1kaXNhYmxlZCc7Cgl2YXIgQ0xBU1NfVE9HR0xFID0gJ211aS1zd2l0Y2gnOwoJdmFyIENMQVNTX0JUTiA9ICdtdWktYnRuJzsKCgl2YXIgQ0xBU1NfU0xJREVSX0hBTkRMRSA9ICdtdWktc2xpZGVyLWhhbmRsZSc7Cgl2YXIgQ0xBU1NfU0xJREVSX0xFRlQgPSAnbXVpLXNsaWRlci1sZWZ0JzsKCXZhciBDTEFTU19TTElERVJfUklHSFQgPSAnbXVpLXNsaWRlci1yaWdodCc7Cgl2YXIgQ0xBU1NfVFJBTlNJVElPTklORyA9ICdtdWktdHJhbnNpdGlvbmluZyc7CgoKCXZhciBTRUxFQ1RPUl9TTElERVJfSEFORExFID0gJy4nICsgQ0xBU1NfU0xJREVSX0hBTkRMRTsKCXZhciBTRUxFQ1RPUl9TTElERVJfTEVGVCA9ICcuJyArIENMQVNTX1NMSURFUl9MRUZUOwoJdmFyIFNFTEVDVE9SX1NMSURFUl9SSUdIVCA9ICcuJyArIENMQVNTX1NMSURFUl9SSUdIVDsKCXZhciBTRUxFQ1RPUl9TRUxFQ1RFRCA9ICcuJyArIENMQVNTX1NFTEVDVEVEOwoJdmFyIFNFTEVDVE9SX0JVVFRPTiA9ICcuJyArIENMQVNTX0JUTjsKCXZhciBvdmVyRmFjdG9yID0gMC44OwoJdmFyIGNlbGwsIGE7CgoJdmFyIGlzTW92ZWQgPSBpc09wZW5lZCA9IG9wZW5lZEFjdGlvbnMgPSBwcm9ncmVzcyA9IGZhbHNlOwoJdmFyIHNsaWRlckhhbmRsZSA9IHNsaWRlckFjdGlvbkxlZnQgPSBzbGlkZXJBY3Rpb25SaWdodCA9IGJ1dHRvbnNMZWZ0ID0gYnV0dG9uc1JpZ2h0ID0gc2xpZGVyRGlyZWN0aW9uID0gc2xpZGVyUmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZmFsc2U7Cgl2YXIgdGltZXIgPSB0cmFuc2xhdGVYID0gbGFzdFRyYW5zbGF0ZVggPSBzbGlkZXJBY3Rpb25MZWZ0V2lkdGggPSBzbGlkZXJBY3Rpb25SaWdodFdpZHRoID0gMDsKCgoKCXZhciB0b2dnbGVBY3RpdmUgPSBmdW5jdGlvbihpc0FjdGl2ZSkgewoJCWlmIChpc0FjdGl2ZSkgewoJCQlpZiAoYSkgewoJCQkJYS5jbGFzc0xpc3QuYWRkKENMQVNTX0FDVElWRSk7CgkJCX0gZWxzZSBpZiAoY2VsbCkgewoJCQkJY2VsbC5jbGFzc0xpc3QuYWRkKENMQVNTX0FDVElWRSk7CgkJCX0KCQl9IGVsc2UgewoJCQl0aW1lciAmJiB0aW1lci5jYW5jZWwoKTsKCQkJaWYgKGEpIHsKCQkJCWEuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19BQ1RJVkUpOwoJCQl9IGVsc2UgaWYgKGNlbGwpIHsKCQkJCWNlbGwuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19BQ1RJVkUpOwoJCQl9CgkJfQoJfTsKCgl2YXIgdXBkYXRlVHJhbnNsYXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKHRyYW5zbGF0ZVggIT09IGxhc3RUcmFuc2xhdGVYKSB7CgkJCWlmIChidXR0b25zUmlnaHQgJiYgYnV0dG9uc1JpZ2h0Lmxlbmd0aCA+IDApIHsKCQkJCXByb2dyZXNzID0gdHJhbnNsYXRlWCAvIHNsaWRlckFjdGlvblJpZ2h0V2lkdGg7CgkJCQlpZiAodHJhbnNsYXRlWCA8IC1zbGlkZXJBY3Rpb25SaWdodFdpZHRoKSB7CgkJCQkJdHJhbnNsYXRlWCA9IC1zbGlkZXJBY3Rpb25SaWdodFdpZHRoIC0gTWF0aC5wb3coLXRyYW5zbGF0ZVggLSBzbGlkZXJBY3Rpb25SaWdodFdpZHRoLCBvdmVyRmFjdG9yKTsKCQkJCX0KCQkJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBidXR0b25zUmlnaHQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQl2YXIgYnV0dG9uUmlnaHQgPSBidXR0b25zUmlnaHRbaV07CgkJCQkJaWYgKHR5cGVvZiBidXR0b25SaWdodC5fYnV0dG9uT2Zmc2V0ID09PSAndW5kZWZpbmVkJykgewoJCQkJCQlidXR0b25SaWdodC5fYnV0dG9uT2Zmc2V0ID0gYnV0dG9uUmlnaHQub2Zmc2V0TGVmdDsKCQkJCQl9CgkJCQkJYnV0dG9uT2Zmc2V0ID0gYnV0dG9uUmlnaHQuX2J1dHRvbk9mZnNldDsKCQkJCQlzZXRUcmFuc2xhdGUoYnV0dG9uUmlnaHQsICh0cmFuc2xhdGVYIC0gYnV0dG9uT2Zmc2V0ICogKDEgKyBNYXRoLm1heChwcm9ncmVzcywgLTEpKSkpOwoJCQkJfQoJCQl9CgkJCWlmIChidXR0b25zTGVmdCAmJiBidXR0b25zTGVmdC5sZW5ndGggPiAwKSB7CgkJCQlwcm9ncmVzcyA9IHRyYW5zbGF0ZVggLyBzbGlkZXJBY3Rpb25MZWZ0V2lkdGg7CgkJCQlpZiAodHJhbnNsYXRlWCA+IHNsaWRlckFjdGlvbkxlZnRXaWR0aCkgewoJCQkJCXRyYW5zbGF0ZVggPSBzbGlkZXJBY3Rpb25MZWZ0V2lkdGggKyBNYXRoLnBvdyh0cmFuc2xhdGVYIC0gc2xpZGVyQWN0aW9uTGVmdFdpZHRoLCBvdmVyRmFjdG9yKTsKCQkJCX0KCQkJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBidXR0b25zTGVmdC5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoJCQkJCXZhciBidXR0b25MZWZ0ID0gYnV0dG9uc0xlZnRbaV07CgkJCQkJaWYgKHR5cGVvZiBidXR0b25MZWZ0Ll9idXR0b25PZmZzZXQgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCWJ1dHRvbkxlZnQuX2J1dHRvbk9mZnNldCA9IHNsaWRlckFjdGlvbkxlZnRXaWR0aCAtIGJ1dHRvbkxlZnQub2Zmc2V0TGVmdCAtIGJ1dHRvbkxlZnQub2Zmc2V0V2lkdGg7CgkJCQkJfQoJCQkJCWJ1dHRvbk9mZnNldCA9IGJ1dHRvbkxlZnQuX2J1dHRvbk9mZnNldDsKCQkJCQlpZiAoYnV0dG9uc0xlZnQubGVuZ3RoID4gMSkgewoJCQkJCQlidXR0b25MZWZ0LnN0eWxlLnpJbmRleCA9IGJ1dHRvbnNMZWZ0Lmxlbmd0aCAtIGk7CgkJCQkJfQoJCQkJCXNldFRyYW5zbGF0ZShidXR0b25MZWZ0LCAodHJhbnNsYXRlWCArIGJ1dHRvbk9mZnNldCAqICgxIC0gTWF0aC5taW4ocHJvZ3Jlc3MsIDEpKSkpOwoJCQkJfQoJCQl9CgkJCXNldFRyYW5zbGF0ZShzbGlkZXJIYW5kbGUsIHRyYW5zbGF0ZVgpOwoJCQlsYXN0VHJhbnNsYXRlWCA9IHRyYW5zbGF0ZVg7CgkJfQoJCXNsaWRlclJlcXVlc3RBbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKCQkJdXBkYXRlVHJhbnNsYXRlKCk7CgkJfSk7Cgl9OwoJdmFyIHNldFRyYW5zbGF0ZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHgpIHsKCQlpZiAoZWxlbWVudCkgewoJCQllbGVtZW50LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICd0cmFuc2xhdGUoJyArIHggKyAncHgsMCknOwoJCX0KCX07CgoJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJC5FVkVOVF9TVEFSVCwgZnVuY3Rpb24oZXZlbnQpIHsKCQlpZiAoY2VsbCkgewoJCQl0b2dnbGVBY3RpdmUoZmFsc2UpOwoJCX0KCQljZWxsID0gYSA9IGZhbHNlOwoJCWlzTW92ZWQgPSBpc09wZW5lZCA9IG9wZW5lZEFjdGlvbnMgPSBmYWxzZTsKCQl2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCXZhciBpc0Rpc2FibGVkID0gZmFsc2U7CgkJZm9yICg7IHRhcmdldCAmJiB0YXJnZXQgIT09IGRvY3VtZW50OyB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZSkgewoJCQlpZiAodGFyZ2V0LmNsYXNzTGlzdCkgewoJCQkJdmFyIGNsYXNzTGlzdCA9IHRhcmdldC5jbGFzc0xpc3Q7CgkJCQlpZiAoKHRhcmdldC50YWdOYW1lID09PSAnSU5QVVQnICYmIHRhcmdldC50eXBlICE9PSAncmFkaW8nICYmIHRhcmdldC50eXBlICE9PSAnY2hlY2tib3gnKSB8fCB0YXJnZXQudGFnTmFtZSA9PT0gJ0JVVFRPTicgfHwgY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX1RPR0dMRSkgfHwgY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0JUTikgfHwgY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0RJU0FCTEVEKSkgewoJCQkJCWlzRGlzYWJsZWQgPSB0cnVlOwoJCQkJfQoJCQkJaWYgKGNsYXNzTGlzdC5jb250YWlucyhDTEFTU19DT0xMQVBTRV9DT05URU5UKSkgeyAvL2NvbGxhcHNlIGNvbnRlbnQKCQkJCQlicmVhazsKCQkJCX0KCQkJCWlmIChjbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfVEFCTEVfVklFV19DRUxMKSkgewoJCQkJCWNlbGwgPSB0YXJnZXQ7CgkJCQkJLy9UT0RPIHN3aXBlIHRvIGRlbGV0ZSBjbG9zZQoJCQkJCXZhciBzZWxlY3RlZCA9IGNlbGwucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX1NFTEVDVEVEKTsKCQkJCQlpZiAoIWNlbGwucGFyZW50Tm9kZS5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfUkFESU9fVklFVykgJiYgc2VsZWN0ZWQgJiYgc2VsZWN0ZWQgIT09IGNlbGwpIHsKCQkJCQkJJC5zd2lwZW91dENsb3NlKHNlbGVjdGVkKTsKCQkJCQkJY2VsbCA9IGlzRGlzYWJsZWQgPSBmYWxzZTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCQlpZiAoIWNlbGwucGFyZW50Tm9kZS5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfR1JJRF9WSUVXKSkgewoJCQkJCQl2YXIgbGluayA9IGNlbGwucXVlcnlTZWxlY3RvcignYScpOwoJCQkJCQlpZiAobGluayAmJiBsaW5rLnBhcmVudE5vZGUgPT09IGNlbGwpIHsgLy9saT5hCgkJCQkJCQlhID0gbGluazsKCQkJCQkJfQoJCQkJCX0KCQkJCQl2YXIgaGFuZGxlID0gY2VsbC5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX1NMSURFUl9IQU5ETEUpOwoJCQkJCWlmIChoYW5kbGUpIHsKCQkJCQkJdG9nZ2xlRXZlbnRzKGNlbGwpOwoJCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQl9CgkJCQkJaWYgKCFpc0Rpc2FibGVkKSB7CgkJCQkJCWlmIChoYW5kbGUpIHsKCQkJCQkJCWlmICh0aW1lcikgewoJCQkJCQkJCXRpbWVyLmNhbmNlbCgpOwoJCQkJCQkJfQoJCQkJCQkJdGltZXIgPSAkLmxhdGVyKGZ1bmN0aW9uKCkgewoJCQkJCQkJCXRvZ2dsZUFjdGl2ZSh0cnVlKTsKCQkJCQkJCX0sIDEwMCk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0b2dnbGVBY3RpdmUodHJ1ZSk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCQuRVZFTlRfTU9WRSwgZnVuY3Rpb24oZXZlbnQpIHsKCQl0b2dnbGVBY3RpdmUoZmFsc2UpOwoJfSk7CgoJdmFyIGhhbmRsZUV2ZW50ID0gewoJCWhhbmRsZUV2ZW50OiBmdW5jdGlvbihldmVudCkgewoJCQlzd2l0Y2ggKGV2ZW50LnR5cGUpIHsKCQkJCWNhc2UgJ2RyYWcnOgoJCQkJCXRoaXMuZHJhZyhldmVudCk7CgkJCQkJYnJlYWs7CgkJCQljYXNlICdkcmFnZW5kJzoKCQkJCQl0aGlzLmRyYWdlbmQoZXZlbnQpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAnZmxpY2snOgoJCQkJCXRoaXMuZmxpY2soZXZlbnQpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAnc3dpcGVyaWdodCc6CgkJCQkJdGhpcy5zd2lwZXJpZ2h0KGV2ZW50KTsKCQkJCQlicmVhazsKCQkJCWNhc2UgJ3N3aXBlbGVmdCc6CgkJCQkJdGhpcy5zd2lwZWxlZnQoZXZlbnQpOwoJCQkJCWJyZWFrOwoJCQl9CgkJfSwKCQlkcmFnOiBmdW5jdGlvbihldmVudCkgewoJCQlpZiAoIWNlbGwpIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIWlzTW92ZWQpIHsgLy9pbml0CgkJCQlzbGlkZXJIYW5kbGUgPSBzbGlkZXJBY3Rpb25MZWZ0ID0gc2xpZGVyQWN0aW9uUmlnaHQgPSBidXR0b25zTGVmdCA9IGJ1dHRvbnNSaWdodCA9IHNsaWRlckRpcmVjdGlvbiA9IHNsaWRlclJlcXVlc3RBbmltYXRpb25GcmFtZSA9IGZhbHNlOwoJCQkJc2xpZGVySGFuZGxlID0gY2VsbC5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX1NMSURFUl9IQU5ETEUpOwoJCQkJaWYgKHNsaWRlckhhbmRsZSkgewoJCQkJCXNsaWRlckFjdGlvbkxlZnQgPSBjZWxsLnF1ZXJ5U2VsZWN0b3IoU0VMRUNUT1JfU0xJREVSX0xFRlQpOwoJCQkJCXNsaWRlckFjdGlvblJpZ2h0ID0gY2VsbC5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX1NMSURFUl9SSUdIVCk7CgkJCQkJaWYgKHNsaWRlckFjdGlvbkxlZnQpIHsKCQkJCQkJc2xpZGVyQWN0aW9uTGVmdFdpZHRoID0gc2xpZGVyQWN0aW9uTGVmdC5vZmZzZXRXaWR0aDsKCQkJCQkJYnV0dG9uc0xlZnQgPSBzbGlkZXJBY3Rpb25MZWZ0LnF1ZXJ5U2VsZWN0b3JBbGwoU0VMRUNUT1JfQlVUVE9OKTsKCQkJCQl9CgkJCQkJaWYgKHNsaWRlckFjdGlvblJpZ2h0KSB7CgkJCQkJCXNsaWRlckFjdGlvblJpZ2h0V2lkdGggPSBzbGlkZXJBY3Rpb25SaWdodC5vZmZzZXRXaWR0aDsKCQkJCQkJYnV0dG9uc1JpZ2h0ID0gc2xpZGVyQWN0aW9uUmlnaHQucXVlcnlTZWxlY3RvckFsbChTRUxFQ1RPUl9CVVRUT04pOwoJCQkJCX0KCQkJCQljZWxsLmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfVFJBTlNJVElPTklORyk7CgkJCQkJaXNPcGVuZWQgPSBjZWxsLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19TRUxFQ1RFRCk7CgkJCQkJaWYgKGlzT3BlbmVkKSB7CgkJCQkJCW9wZW5lZEFjdGlvbnMgPSBjZWxsLnF1ZXJ5U2VsZWN0b3IoU0VMRUNUT1JfU0xJREVSX0xFRlQgKyBTRUxFQ1RPUl9TRUxFQ1RFRCkgPyAnbGVmdCcgOiAncmlnaHQnOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl2YXIgZGV0YWlsID0gZXZlbnQuZGV0YWlsOwoJCQl2YXIgZGlyZWN0aW9uID0gZGV0YWlsLmRpcmVjdGlvbjsKCQkJdmFyIGFuZ2xlID0gZGV0YWlsLmFuZ2xlOwoJCQlpZiAoZGlyZWN0aW9uID09PSAnbGVmdCcgJiYgKGFuZ2xlID4gMTUwIHx8IGFuZ2xlIDwgLTE1MCkpIHsKCQkJCWlmIChidXR0b25zUmlnaHQgfHwgKGJ1dHRvbnNMZWZ0ICYmIGlzT3BlbmVkKSkgeyAvL+WtmOWcqOWPs+S+p+aMiemSruaIluWtmOWcqOW3puS+p+aMiemSruS4lOaYr+W3suaJk+W8gOeKtuaAgQoJCQkJCWlzTW92ZWQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gJ3JpZ2h0JyAmJiAoYW5nbGUgPiAtMzAgJiYgYW5nbGUgPCAzMCkpIHsKCQkJCWlmIChidXR0b25zTGVmdCB8fCAoYnV0dG9uc1JpZ2h0ICYmIGlzT3BlbmVkKSkgeyAvL+WtmOWcqOW3puS+p+aMiemSruaIluWtmOWcqOWPs+S+p+aMiemSruS4lOaYr+W3suaJk+W8gOeKtuaAgQoJCQkJCWlzTW92ZWQgPSB0cnVlOwoJCQkJfQoJCQl9CgkJCWlmIChpc01vdmVkKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCWV2ZW50LmRldGFpbC5nZXN0dXJlLnByZXZlbnREZWZhdWx0KCk7CgkJCQl2YXIgdHJhbnNsYXRlID0gZXZlbnQuZGV0YWlsLmRlbHRhWDsKCQkJCWlmIChpc09wZW5lZCkgewoJCQkJCWlmIChvcGVuZWRBY3Rpb25zID09PSAncmlnaHQnKSB7CgkJCQkJCXRyYW5zbGF0ZSA9IHRyYW5zbGF0ZSAtIHNsaWRlckFjdGlvblJpZ2h0V2lkdGg7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdHJhbnNsYXRlID0gdHJhbnNsYXRlICsgc2xpZGVyQWN0aW9uTGVmdFdpZHRoOwoJCQkJCX0KCQkJCX0KCQkJCWlmICgodHJhbnNsYXRlID4gMCAmJiAhYnV0dG9uc0xlZnQpIHx8ICh0cmFuc2xhdGUgPCAwICYmICFidXR0b25zUmlnaHQpKSB7CgkJCQkJaWYgKCFpc09wZW5lZCkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCXRyYW5zbGF0ZSA9IDA7CgkJCQl9CgkJCQlpZiAodHJhbnNsYXRlIDwgMCkgewoJCQkJCXNsaWRlckRpcmVjdGlvbiA9ICd0b0xlZnQnOwoJCQkJfSBlbHNlIGlmICh0cmFuc2xhdGUgPiAwKSB7CgkJCQkJc2xpZGVyRGlyZWN0aW9uID0gJ3RvUmlnaHQnOwoJCQkJfSBlbHNlIHsKCQkJCQlpZiAoIXNsaWRlckRpcmVjdGlvbikgewoJCQkJCQlzbGlkZXJEaXJlY3Rpb24gPSAndG9MZWZ0JzsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoIXNsaWRlclJlcXVlc3RBbmltYXRpb25GcmFtZSkgewoJCQkJCXVwZGF0ZVRyYW5zbGF0ZSgpOwoJCQkJfQoJCQkJdHJhbnNsYXRlWCA9IHRyYW5zbGF0ZTsKCQkJfQoJCX0sCgkJZmxpY2s6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJCWlmIChpc01vdmVkKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0sCgkJc3dpcGVsZWZ0OiBmdW5jdGlvbihldmVudCkgewoJCQlpZiAoaXNNb3ZlZCkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9LAoJCXN3aXBlcmlnaHQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJCWlmIChpc01vdmVkKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0sCgkJZHJhZ2VuZDogZnVuY3Rpb24oZXZlbnQpIHsKCQkJaWYgKCFpc01vdmVkKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCWlmIChzbGlkZXJSZXF1ZXN0QW5pbWF0aW9uRnJhbWUpIHsKCQkJCWNhbmNlbEFuaW1hdGlvbkZyYW1lKHNsaWRlclJlcXVlc3RBbmltYXRpb25GcmFtZSk7CgkJCQlzbGlkZXJSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBudWxsOwoJCQl9CgkJCXZhciBkZXRhaWwgPSBldmVudC5kZXRhaWw7CgkJCWlzTW92ZWQgPSBmYWxzZTsKCQkJdmFyIGFjdGlvbiA9ICdjbG9zZSc7CgkJCXZhciBhY3Rpb25zV2lkdGggPSBzbGlkZXJEaXJlY3Rpb24gPT09ICd0b0xlZnQnID8gc2xpZGVyQWN0aW9uUmlnaHRXaWR0aCA6IHNsaWRlckFjdGlvbkxlZnRXaWR0aDsKCQkJdmFyIGlzVG9nZ2xlID0gZGV0YWlsLnN3aXBlIHx8IChNYXRoLmFicyh0cmFuc2xhdGVYKSA+IGFjdGlvbnNXaWR0aCAvIDIpOwoJCQlpZiAoaXNUb2dnbGUpIHsKCQkJCWlmICghaXNPcGVuZWQpIHsKCQkJCQlhY3Rpb24gPSAnb3Blbic7CgkJCQl9IGVsc2UgaWYgKGRldGFpbC5kaXJlY3Rpb24gPT09ICdsZWZ0JyAmJiBvcGVuZWRBY3Rpb25zID09PSAncmlnaHQnKSB7CgkJCQkJYWN0aW9uID0gJ29wZW4nOwoJCQkJfSBlbHNlIGlmIChkZXRhaWwuZGlyZWN0aW9uID09PSAncmlnaHQnICYmIG9wZW5lZEFjdGlvbnMgPT09ICdsZWZ0JykgewoJCQkJCWFjdGlvbiA9ICdvcGVuJzsKCQkJCX0KCgkJCX0KCQkJY2VsbC5jbGFzc0xpc3QuYWRkKENMQVNTX1RSQU5TSVRJT05JTkcpOwoJCQl2YXIgYnV0dG9uczsKCQkJaWYgKGFjdGlvbiA9PT0gJ29wZW4nKSB7CgkJCQl2YXIgbmV3VHJhbnNsYXRlID0gc2xpZGVyRGlyZWN0aW9uID09PSAndG9MZWZ0JyA/IC1hY3Rpb25zV2lkdGggOiBhY3Rpb25zV2lkdGg7CgkJCQlzZXRUcmFuc2xhdGUoc2xpZGVySGFuZGxlLCBuZXdUcmFuc2xhdGUpOwoJCQkJYnV0dG9ucyA9IHNsaWRlckRpcmVjdGlvbiA9PT0gJ3RvTGVmdCcgPyBidXR0b25zUmlnaHQgOiBidXR0b25zTGVmdDsKCQkJCWlmICh0eXBlb2YgYnV0dG9ucyAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl2YXIgYnV0dG9uID0gbnVsbDsKCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGJ1dHRvbnMubGVuZ3RoOyBpKyspIHsKCQkJCQkJYnV0dG9uID0gYnV0dG9uc1tpXTsKCQkJCQkJc2V0VHJhbnNsYXRlKGJ1dHRvbiwgbmV3VHJhbnNsYXRlKTsKCQkJCQl9CgkJCQkJYnV0dG9uLnBhcmVudE5vZGUuY2xhc3NMaXN0LmFkZChDTEFTU19TRUxFQ1RFRCk7CgkJCQkJY2VsbC5jbGFzc0xpc3QuYWRkKENMQVNTX1NFTEVDVEVEKTsKCQkJCQlpZiAoIWlzT3BlbmVkKSB7CgkJCQkJCSQudHJpZ2dlcihjZWxsLCBzbGlkZXJEaXJlY3Rpb24gPT09ICd0b0xlZnQnID8gJ3NsaWRlbGVmdCcgOiAnc2xpZGVyaWdodCcpOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXNldFRyYW5zbGF0ZShzbGlkZXJIYW5kbGUsIDApOwoJCQkJc2xpZGVyQWN0aW9uTGVmdCAmJiBzbGlkZXJBY3Rpb25MZWZ0LmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfU0VMRUNURUQpOwoJCQkJc2xpZGVyQWN0aW9uUmlnaHQgJiYgc2xpZGVyQWN0aW9uUmlnaHQuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19TRUxFQ1RFRCk7CgkJCQljZWxsLmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfU0VMRUNURUQpOwoJCQl9CgkJCXZhciBidXR0b25PZmZzZXQ7CgkJCWlmIChidXR0b25zTGVmdCAmJiBidXR0b25zTGVmdC5sZW5ndGggPiAwICYmIGJ1dHRvbnNMZWZ0ICE9PSBidXR0b25zKSB7CgkJCQlmb3IgKHZhciBpID0gMCwgbGVuID0gYnV0dG9uc0xlZnQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQl2YXIgYnV0dG9uTGVmdCA9IGJ1dHRvbnNMZWZ0W2ldOwoJCQkJCWJ1dHRvbk9mZnNldCA9IGJ1dHRvbkxlZnQuX2J1dHRvbk9mZnNldDsKCQkJCQlpZiAodHlwZW9mIGJ1dHRvbk9mZnNldCA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJYnV0dG9uTGVmdC5fYnV0dG9uT2Zmc2V0ID0gc2xpZGVyQWN0aW9uTGVmdFdpZHRoIC0gYnV0dG9uTGVmdC5vZmZzZXRMZWZ0IC0gYnV0dG9uTGVmdC5vZmZzZXRXaWR0aDsKCQkJCQl9CgkJCQkJc2V0VHJhbnNsYXRlKGJ1dHRvbkxlZnQsIGJ1dHRvbk9mZnNldCk7CgkJCQl9CgkJCX0KCQkJaWYgKGJ1dHRvbnNSaWdodCAmJiBidXR0b25zUmlnaHQubGVuZ3RoID4gMCAmJiBidXR0b25zUmlnaHQgIT09IGJ1dHRvbnMpIHsKCQkJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBidXR0b25zUmlnaHQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQl2YXIgYnV0dG9uUmlnaHQgPSBidXR0b25zUmlnaHRbaV07CgkJCQkJYnV0dG9uT2Zmc2V0ID0gYnV0dG9uUmlnaHQuX2J1dHRvbk9mZnNldDsKCQkJCQlpZiAodHlwZW9mIGJ1dHRvbk9mZnNldCA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJYnV0dG9uUmlnaHQuX2J1dHRvbk9mZnNldCA9IGJ1dHRvblJpZ2h0Lm9mZnNldExlZnQ7CgkJCQkJfQoJCQkJCXNldFRyYW5zbGF0ZShidXR0b25SaWdodCwgLWJ1dHRvbk9mZnNldCk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoKCWZ1bmN0aW9uIHRvZ2dsZUV2ZW50cyhlbGVtZW50LCBpc1JlbW92ZSkgewoJCXZhciBtZXRob2QgPSBpc1JlbW92ZSA/ICdyZW1vdmVFdmVudExpc3RlbmVyJyA6ICdhZGRFdmVudExpc3RlbmVyJzsKCQllbGVtZW50W21ldGhvZF0oJ2RyYWcnLCBoYW5kbGVFdmVudCk7CgkJZWxlbWVudFttZXRob2RdKCdkcmFnZW5kJywgaGFuZGxlRXZlbnQpOwoJCWVsZW1lbnRbbWV0aG9kXSgnc3dpcGVyaWdodCcsIGhhbmRsZUV2ZW50KTsKCQllbGVtZW50W21ldGhvZF0oJ3N3aXBlbGVmdCcsIGhhbmRsZUV2ZW50KTsKCQllbGVtZW50W21ldGhvZF0oJ2ZsaWNrJywgaGFuZGxlRXZlbnQpOwoJfQoJLyoqCgkgKiDmiZPlvIDmu5Hliqjoj5zljZUKCSAqIEBwYXJhbSB7T2JqZWN0fSBlbAoJICogQHBhcmFtIHtPYmplY3R9IGRpcmVjdGlvbgoJICovCgkkLnN3aXBlb3V0T3BlbiA9IGZ1bmN0aW9uKGVsLCBkaXJlY3Rpb24pIHsKCQlpZiAoIWVsKSByZXR1cm47CgkJdmFyIGNsYXNzTGlzdCA9IGVsLmNsYXNzTGlzdDsKCQlpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX1NFTEVDVEVEKSkgcmV0dXJuOwoJCWlmICghZGlyZWN0aW9uKSB7CgkJCWlmIChlbC5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX1NMSURFUl9SSUdIVCkpIHsKCQkJCWRpcmVjdGlvbiA9ICdyaWdodCc7CgkJCX0gZWxzZSB7CgkJCQlkaXJlY3Rpb24gPSAnbGVmdCc7CgkJCX0KCQl9CgkJdmFyIHN3aXBlb3V0QWN0aW9uID0gZWwucXVlcnlTZWxlY3RvcigkLmNsYXNzU2VsZWN0b3IoIi5zbGlkZXItIiArIGRpcmVjdGlvbikpOwoJCWlmICghc3dpcGVvdXRBY3Rpb24pIHJldHVybjsKCQlzd2lwZW91dEFjdGlvbi5jbGFzc0xpc3QuYWRkKENMQVNTX1NFTEVDVEVEKTsKCQljbGFzc0xpc3QuYWRkKENMQVNTX1NFTEVDVEVEKTsKCQljbGFzc0xpc3QucmVtb3ZlKENMQVNTX1RSQU5TSVRJT05JTkcpOwoJCXZhciBidXR0b25zID0gc3dpcGVvdXRBY3Rpb24ucXVlcnlTZWxlY3RvckFsbChTRUxFQ1RPUl9CVVRUT04pOwoJCXZhciBzd2lwZW91dFdpZHRoID0gc3dpcGVvdXRBY3Rpb24ub2Zmc2V0V2lkdGg7CgkJdmFyIHRyYW5zbGF0ZSA9IChkaXJlY3Rpb24gPT09ICdyaWdodCcpID8gLXN3aXBlb3V0V2lkdGggOiBzd2lwZW91dFdpZHRoOwoJCXZhciBsZW5ndGggPSBidXR0b25zLmxlbmd0aDsKCQl2YXIgYnV0dG9uOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCQkJYnV0dG9uID0gYnV0dG9uc1tpXTsKCQkJaWYgKGRpcmVjdGlvbiA9PT0gJ3JpZ2h0JykgewoJCQkJc2V0VHJhbnNsYXRlKGJ1dHRvbiwgLWJ1dHRvbi5vZmZzZXRMZWZ0KTsKCQkJfSBlbHNlIHsKCQkJCXNldFRyYW5zbGF0ZShidXR0b24sIChzd2lwZW91dFdpZHRoIC0gYnV0dG9uLm9mZnNldFdpZHRoIC0gYnV0dG9uLm9mZnNldExlZnQpKTsKCQkJfQoJCX0KCQljbGFzc0xpc3QuYWRkKENMQVNTX1RSQU5TSVRJT05JTkcpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKCQkJc2V0VHJhbnNsYXRlKGJ1dHRvbnNbaV0sIHRyYW5zbGF0ZSk7CgkJfQoJCXNldFRyYW5zbGF0ZShlbC5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX1NMSURFUl9IQU5ETEUpLCB0cmFuc2xhdGUpOwoJfTsKCS8qKgoJICog5YWz6Zet5ruR5Yqo6I+c5Y2VCgkgKiBAcGFyYW0ge09iamVjdH0gZWwKCSAqLwoJJC5zd2lwZW91dENsb3NlID0gZnVuY3Rpb24oZWwpIHsKCQlpZiAoIWVsKSByZXR1cm47CgkJdmFyIGNsYXNzTGlzdCA9IGVsLmNsYXNzTGlzdDsKCQlpZiAoIWNsYXNzTGlzdC5jb250YWlucyhDTEFTU19TRUxFQ1RFRCkpIHJldHVybjsKCQl2YXIgZGlyZWN0aW9uID0gZWwucXVlcnlTZWxlY3RvcihTRUxFQ1RPUl9TTElERVJfUklHSFQgKyBTRUxFQ1RPUl9TRUxFQ1RFRCkgPyAncmlnaHQnIDogJ2xlZnQnOwoJCXZhciBzd2lwZW91dEFjdGlvbiA9IGVsLnF1ZXJ5U2VsZWN0b3IoJC5jbGFzc1NlbGVjdG9yKCIuc2xpZGVyLSIgKyBkaXJlY3Rpb24pKTsKCQlpZiAoIXN3aXBlb3V0QWN0aW9uKSByZXR1cm47CgkJc3dpcGVvdXRBY3Rpb24uY2xhc3NMaXN0LnJlbW92ZShDTEFTU19TRUxFQ1RFRCk7CgkJY2xhc3NMaXN0LnJlbW92ZShDTEFTU19TRUxFQ1RFRCk7CgkJY2xhc3NMaXN0LmFkZChDTEFTU19UUkFOU0lUSU9OSU5HKTsKCQl2YXIgYnV0dG9ucyA9IHN3aXBlb3V0QWN0aW9uLnF1ZXJ5U2VsZWN0b3JBbGwoU0VMRUNUT1JfQlVUVE9OKTsKCQl2YXIgc3dpcGVvdXRXaWR0aCA9IHN3aXBlb3V0QWN0aW9uLm9mZnNldFdpZHRoOwoJCXZhciBsZW5ndGggPSBidXR0b25zLmxlbmd0aDsKCQl2YXIgYnV0dG9uOwoJCXNldFRyYW5zbGF0ZShlbC5xdWVyeVNlbGVjdG9yKFNFTEVDVE9SX1NMSURFUl9IQU5ETEUpLCAwKTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJCWJ1dHRvbiA9IGJ1dHRvbnNbaV07CgkJCWlmIChkaXJlY3Rpb24gPT09ICdyaWdodCcpIHsKCQkJCXNldFRyYW5zbGF0ZShidXR0b24sICgtYnV0dG9uLm9mZnNldExlZnQpKTsKCQkJfSBlbHNlIHsKCQkJCXNldFRyYW5zbGF0ZShidXR0b24sIChzd2lwZW91dFdpZHRoIC0gYnV0dG9uLm9mZnNldFdpZHRoIC0gYnV0dG9uLm9mZnNldExlZnQpKTsKCQkJfQoJCX0KCX07CgoJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJC5FVkVOVF9FTkQsIGZ1bmN0aW9uKGV2ZW50KSB7IC8v5L2/55SodG91Y2hlbmTmnaXlj5bmtojpq5jkuq7vvIzpgb/lhY3kuIDmrKHngrnlh7vml6LkuI3op6blj5F0YXDvvIxkb3VibGV0YXDvvIxsb25ndGFw55qE5LqL5Lu2CgkJaWYgKCFjZWxsKSB7CgkJCXJldHVybjsKCQl9CgkJdG9nZ2xlQWN0aXZlKGZhbHNlKTsKCQlzbGlkZXJIYW5kbGUgJiYgdG9nZ2xlRXZlbnRzKGNlbGwsIHRydWUpOwoJfSk7Cgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigkLkVWRU5UX0NBTkNFTCwgZnVuY3Rpb24oZXZlbnQpIHsgLy/kvb/nlKh0b3VjaGNhbmNlbOadpeWPlua2iOmrmOS6ru+8jOmBv+WFjeS4gOasoeeCueWHu+aXouS4jeinpuWPkXRhcO+8jGRvdWJsZXRhcO+8jGxvbmd0YXDnmoTkuovku7YKCQlpZiAoIWNlbGwpIHsKCQkJcmV0dXJuOwoJCX0KCQl0b2dnbGVBY3RpdmUoZmFsc2UpOwoJCXNsaWRlckhhbmRsZSAmJiB0b2dnbGVFdmVudHMoY2VsbCwgdHJ1ZSk7Cgl9KTsKCXZhciByYWRpb09yQ2hlY2tib3hDbGljayA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkJdmFyIHR5cGUgPSBldmVudC50YXJnZXQgJiYgZXZlbnQudGFyZ2V0LnR5cGUgfHwgJyc7CgkJaWYgKHR5cGUgPT09ICdyYWRpbycgfHwgdHlwZSA9PT0gJ2NoZWNrYm94JykgewoJCQlyZXR1cm47CgkJfQoJCXZhciBjbGFzc0xpc3QgPSBjZWxsLmNsYXNzTGlzdDsKCQlpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKCdtdWktcmFkaW8nKSkgewoJCQl2YXIgaW5wdXQgPSBjZWxsLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W3R5cGU9cmFkaW9dJyk7CgkJCWlmIChpbnB1dCkgewoJCQkJLy8JCQkJaW5wdXQuY2xpY2soKTsKCQkJCWlmICghaW5wdXQuZGlzYWJsZWQgJiYgIWlucHV0LnJlYWRPbmx5KSB7CgkJCQkJaW5wdXQuY2hlY2tlZCA9ICFpbnB1dC5jaGVja2VkOwoJCQkJCSQudHJpZ2dlcihpbnB1dCwgJ2NoYW5nZScpOwoJCQkJfQoJCQl9CgkJfSBlbHNlIGlmIChjbGFzc0xpc3QuY29udGFpbnMoJ211aS1jaGVja2JveCcpKSB7CgkJCXZhciBpbnB1dCA9IGNlbGwucXVlcnlTZWxlY3RvcignaW5wdXRbdHlwZT1jaGVja2JveF0nKTsKCQkJaWYgKGlucHV0KSB7CgkJCQkvLwkJCQlpbnB1dC5jbGljaygpOwoJCQkJaWYgKCFpbnB1dC5kaXNhYmxlZCAmJiAhaW5wdXQucmVhZE9ubHkpIHsKCQkJCQlpbnB1dC5jaGVja2VkID0gIWlucHV0LmNoZWNrZWQ7CgkJCQkJJC50cmlnZ2VyKGlucHV0LCAnY2hhbmdlJyk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoJLy9maXhlZCBoYXNoY2hhbmdlKGFuZHJvaWQpCgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigkLkVWRU5UX0NMSUNLLCBmdW5jdGlvbihlKSB7CgkJaWYgKGNlbGwgJiYgY2VsbC5jbGFzc0xpc3QuY29udGFpbnMoJ211aS1jb2xsYXBzZScpKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9KTsKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkb3VibGV0YXAnLCBmdW5jdGlvbihldmVudCkgewoJCWlmIChjZWxsKSB7CgkJCXJhZGlvT3JDaGVja2JveENsaWNrKGV2ZW50KTsKCQl9Cgl9KTsKCXZhciBwcmV2ZW50RGVmYXVsdEV4Y2VwdGlvbiA9IC9eKElOUFVUfFRFWFRBUkVBfEJVVFRPTnxTRUxFQ1QpJC87Cgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndGFwJywgZnVuY3Rpb24oZXZlbnQpIHsKCQlpZiAoIWNlbGwpIHsKCQkJcmV0dXJuOwoJCX0KCQl2YXIgaXNFeHBhbmQgPSBmYWxzZTsKCQl2YXIgY2xhc3NMaXN0ID0gY2VsbC5jbGFzc0xpc3Q7CgkJdmFyIHVsID0gY2VsbC5wYXJlbnROb2RlOwoJCWlmICh1bCAmJiB1bC5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfUkFESU9fVklFVykpIHsKCQkJaWYgKGNsYXNzTGlzdC5jb250YWlucyhDTEFTU19TRUxFQ1RFRCkpIHsKCQkJCXJldHVybjsKCQkJfQoJCQl2YXIgc2VsZWN0ZWQgPSB1bC5xdWVyeVNlbGVjdG9yKCdsaScgKyBTRUxFQ1RPUl9TRUxFQ1RFRCk7CgkJCWlmIChzZWxlY3RlZCkgewoJCQkJc2VsZWN0ZWQuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19TRUxFQ1RFRCk7CgkJCX0KCQkJY2xhc3NMaXN0LmFkZChDTEFTU19TRUxFQ1RFRCk7CgkJCSQudHJpZ2dlcihjZWxsLCAnc2VsZWN0ZWQnLCB7CgkJCQllbDogY2VsbAoJCQl9KTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKCdtdWktY29sbGFwc2UnKSAmJiAhY2VsbC5wYXJlbnROb2RlLmNsYXNzTGlzdC5jb250YWlucygnbXVpLXVuZm9sZCcpKSB7CgkJCWlmICghcHJldmVudERlZmF1bHRFeGNlcHRpb24udGVzdChldmVudC50YXJnZXQudGFnTmFtZSkpIHsKCQkJCWV2ZW50LmRldGFpbC5nZXN0dXJlLnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCgkJCWlmICghY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkpIHsgLy/lsZXlvIDml7Ys6ZyA6KaB5pS257yp5YW25LuW5ZCM57G7CgkJCQl2YXIgY29sbGFwc2UgPSBjZWxsLnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignLm11aS1jb2xsYXBzZS5tdWktYWN0aXZlJyk7CgkJCQlpZiAoY29sbGFwc2UpIHsKCQkJCQljb2xsYXBzZS5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0FDVElWRSk7CgkJCQl9CgkJCQlpc0V4cGFuZCA9IHRydWU7CgkJCX0KCQkJY2xhc3NMaXN0LnRvZ2dsZShDTEFTU19BQ1RJVkUpOwoJCQlpZiAoaXNFeHBhbmQpIHsKCQkJCS8v6Kem5Y+R5bGV5byA5LqL5Lu2CgkJCQkkLnRyaWdnZXIoY2VsbCwgJ2V4cGFuZCcpOwoKCQkJCS8vc2Nyb2xsCgkJCQkvL+aaguS4jea7muWKqAoJCQkJLy8gdmFyIG9mZnNldFRvcCA9ICQub2Zmc2V0KGNlbGwpLnRvcDsKCQkJCS8vIHZhciBzY3JvbGxUb3AgPSBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcDsKCQkJCS8vIHZhciBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CgkJCQkvLyB2YXIgb2Zmc2V0SGVpZ2h0ID0gY2VsbC5vZmZzZXRIZWlnaHQ7CgkJCQkvLyB2YXIgY2VsbEhlaWdodCA9IChvZmZzZXRUb3AgLSBzY3JvbGxUb3AgKyBvZmZzZXRIZWlnaHQpOwoJCQkJLy8gaWYgKG9mZnNldEhlaWdodCA+IGhlaWdodCkgewoJCQkJLy8gCSQuc2Nyb2xsVG8ob2Zmc2V0VG9wLCAzMDApOwoJCQkJLy8gfSBlbHNlIGlmIChjZWxsSGVpZ2h0ID4gaGVpZ2h0KSB7CgkJCQkvLyAJJC5zY3JvbGxUbyhjZWxsSGVpZ2h0IC0gaGVpZ2h0ICsgc2Nyb2xsVG9wLCAzMDApOwoJCQkJLy8gfQoJCQl9CgkJfSBlbHNlIHsKCQkJcmFkaW9PckNoZWNrYm94Q2xpY2soZXZlbnQpOwoJCX0KCX0pOwp9KShtdWksIHdpbmRvdywgZG9jdW1lbnQpOwooZnVuY3Rpb24oJCwgd2luZG93KSB7CgkvKioKCSAqIOitpuWRiua2iOaBr+ahhgoJICovCgkkLmFsZXJ0ID0gZnVuY3Rpb24obWVzc2FnZSwgdGl0bGUsIGJ0blZhbHVlLCBjYWxsYmFjaykgewoJCWlmICgkLm9zLnBsdXMpIHsKCQkJaWYgKHR5cGVvZiBtZXNzYWdlID09PSAndW5kZWZpbmVkJykgewoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgewoJCQkJaWYgKHR5cGVvZiB0aXRsZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCWNhbGxiYWNrID0gdGl0bGU7CgkJCQkJdGl0bGUgPSBudWxsOwoJCQkJCWJ0blZhbHVlID0gJ+ehruWumic7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZiBidG5WYWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCWNhbGxiYWNrID0gYnRuVmFsdWU7CgkJCQkJYnRuVmFsdWUgPSBudWxsOwoJCQkJfQoJCQkJJC5wbHVzUmVhZHkoZnVuY3Rpb24oKSB7CgkJCQkJcGx1cy5uYXRpdmVVSS5hbGVydChtZXNzYWdlLCBjYWxsYmFjaywgdGl0bGUsIGJ0blZhbHVlKTsKCQkJCX0pOwoJCQl9CgoJCX0gZWxzZSB7CgkJCS8vVE9ETyBINeeJiOacrAoJCQl3aW5kb3cuYWxlcnQobWVzc2FnZSk7CgkJfQoJfTsKCn0pKG11aSwgd2luZG93KTsKKGZ1bmN0aW9uKCQsIHdpbmRvdykgewoJLyoqCgkgKiDnoa7orqTmtojmga/moYYKCSAqLwoJJC5jb25maXJtID0gZnVuY3Rpb24obWVzc2FnZSwgdGl0bGUsIGJ0bkFycmF5LCBjYWxsYmFjaykgewoJCWlmICgkLm9zLnBsdXMpIHsKCQkJaWYgKHR5cGVvZiBtZXNzYWdlID09PSAndW5kZWZpbmVkJykgewoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgewoJCQkJaWYgKHR5cGVvZiB0aXRsZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCWNhbGxiYWNrID0gdGl0bGU7CgkJCQkJdGl0bGUgPSBudWxsOwoJCQkJCWJ0bkFycmF5ID0gbnVsbDsKCQkJCX0gZWxzZSBpZiAodHlwZW9mIGJ0bkFycmF5ID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJY2FsbGJhY2sgPSBidG5BcnJheTsKCQkJCQlidG5BcnJheSA9IG51bGw7CgkJCQl9CgkJCQkkLnBsdXNSZWFkeShmdW5jdGlvbigpIHsKCQkJCQlwbHVzLm5hdGl2ZVVJLmNvbmZpcm0obWVzc2FnZSwgY2FsbGJhY2ssIHRpdGxlLCBidG5BcnJheSk7CgkJCQl9KTsKCQkJfQoKCQl9IGVsc2UgewoJCQkvL0g154mI5pys77yMMOS4uuehruiupO+8jDHkuLrlj5bmtogKCQkJaWYgKHdpbmRvdy5jb25maXJtKG1lc3NhZ2UpKSB7CgkJCQljYWxsYmFjayh7CgkJCQkJaW5kZXg6IDAKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJY2FsbGJhY2soewoJCQkJCWluZGV4OiAxCgkJCQl9KTsKCQkJfQoJCX0KCX07Cgp9KShtdWksIHdpbmRvdyk7CihmdW5jdGlvbigkLCB3aW5kb3cpIHsKCS8qKgoJICog6L6T5YWl5a+56K+d5qGGCgkgKi8KCSQucHJvbXB0ID0gZnVuY3Rpb24odGV4dCwgZGVmYXVsdFRleHQsIHRpdGxlLCBidG5BcnJheSwgY2FsbGJhY2spIHsKCQlpZiAoJC5vcy5wbHVzKSB7CgkJCWlmICh0eXBlb2YgbWVzc2FnZSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXJldHVybjsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodHlwZW9mIGRlZmF1bHRUZXh0ID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJY2FsbGJhY2sgPSBkZWZhdWx0VGV4dDsKCQkJCQlkZWZhdWx0VGV4dCA9IG51bGw7CgkJCQkJdGl0bGUgPSBudWxsOwoJCQkJCWJ0bkFycmF5ID0gbnVsbDsKCQkJCX0gZWxzZSBpZiAodHlwZW9mIHRpdGxlID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJY2FsbGJhY2sgPSB0aXRsZTsKCQkJCQl0aXRsZSA9IG51bGw7CgkJCQkJYnRuQXJyYXkgPSBudWxsOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YgYnRuQXJyYXkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQljYWxsYmFjayA9IGJ0bkFycmF5OwoJCQkJCWJ0bkFycmF5ID0gbnVsbDsKCQkJCX0KCQkJCSQucGx1c1JlYWR5KGZ1bmN0aW9uKCkgewoJCQkJCXBsdXMubmF0aXZlVUkucHJvbXB0KHRleHQsIGNhbGxiYWNrLCB0aXRsZSwgZGVmYXVsdFRleHQsIGJ0bkFycmF5KTsKCQkJCX0pOwoJCQl9CgoJCX0gZWxzZSB7CgkJCS8vSDXniYjmnKwo56Gu6K6kaW5kZXjkuLow77yM5Y+W5raIaW5kZXjkuLoxKQoJCQl2YXIgcmVzdWx0ID0gd2luZG93LnByb21wdCh0ZXh0KTsKCQkJaWYgKHJlc3VsdCkgewoJCQkJY2FsbGJhY2soewoJCQkJCWluZGV4OiAwLAoJCQkJCXZhbHVlOiByZXN1bHQKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJY2FsbGJhY2soewoJCQkJCWluZGV4OiAxLAoJCQkJCXZhbHVlOiAnJwoJCQkJfSk7CgkJCX0KCQl9Cgl9OwoKfSkobXVpLCB3aW5kb3cpOwooZnVuY3Rpb24oJCwgd2luZG93KSB7Cgl2YXIgQ0xBU1NfQUNUSVZFID0gJ211aS1hY3RpdmUnOwoJLyoqCgkgKiDoh6rliqjmtojlpLHmj5DnpLrmoYYKCSAqLwoJJC50b2FzdCA9IGZ1bmN0aW9uKG1lc3NhZ2Usb3B0aW9ucykgewoJCXZhciBkdXJhdGlvbnMgPSB7CgkJICAgICdsb25nJzogMzUwMCwKCQkgICAgJ3Nob3J0JzogMjAwMAoJCX07CgoJCS8v6K6h566X5pi+56S65pe26Ze0CgkJIG9wdGlvbnMgPSAkLmV4dGVuZCh7CgkgICAgICAgIGR1cmF0aW9uOiAnc2hvcnQnCgkgICAgfSwgb3B0aW9ucyB8fCB7fSk7CgoKCQlpZiAoJC5vcy5wbHVzICYmIG9wdGlvbnMudHlwZSAhPT0gJ2RpdicpIHsKCQkJLy/pu5jorqTmmL7npLrlnKjlupXpg6jvvJsKCQkJJC5wbHVzUmVhZHkoZnVuY3Rpb24oKSB7CgkJCQlwbHVzLm5hdGl2ZVVJLnRvYXN0KG1lc3NhZ2UsIHsKCQkJCQl2ZXJ0aWNhbEFsaWduOiAnYm90dG9tJywKCQkJCQlkdXJhdGlvbjpvcHRpb25zLmR1cmF0aW9uCgkJCQl9KTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJaWYgKHR5cGVvZiBvcHRpb25zLmR1cmF0aW9uID09PSAnbnVtYmVyJykgewoJCSAgICAgICAgZHVyYXRpb24gPSBvcHRpb25zLmR1cmF0aW9uPjAgPyBvcHRpb25zLmR1cmF0aW9uOmR1cmF0aW9uc1snc2hvcnQnXTsKCQkgICAgfSBlbHNlIHsKCQkgICAgICAgIGR1cmF0aW9uID0gZHVyYXRpb25zW29wdGlvbnMuZHVyYXRpb25dOwoJCSAgICB9CgkJICAgIGlmICghZHVyYXRpb24pIHsKCQkgICAgICAgIGR1cmF0aW9uID0gZHVyYXRpb25zWydzaG9ydCddOwoJCSAgICB9CgkJCXZhciB0b2FzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQl0b2FzdC5jbGFzc0xpc3QuYWRkKCdtdWktdG9hc3QtY29udGFpbmVyJyk7CgkJCXRvYXN0LmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSInICsgJ211aS10b2FzdC1tZXNzYWdlJyArICciPicgKyBtZXNzYWdlICsgJzwvZGl2Pic7CgkJCXRvYXN0LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCBmdW5jdGlvbigpIHsKCQkJCWlmICghdG9hc3QuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX0FDVElWRSkpIHsKCQkJCQl0b2FzdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRvYXN0KTsKCQkJCQl0b2FzdCA9IG51bGw7CgkJCQl9CgkJCX0pOwoJCQkvL+eCueWHu+WImeiHquWKqOa2iOWksQoJCQl0b2FzdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewoJCSAgICAgICAgdG9hc3QucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0b2FzdCk7CgkJICAgICAgICB0b2FzdCA9IG51bGw7CgkJICAgIH0pOwoJCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRvYXN0KTsKCQkJdG9hc3Qub2Zmc2V0SGVpZ2h0OwoJCQl0b2FzdC5jbGFzc0xpc3QuYWRkKENMQVNTX0FDVElWRSk7CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQl0b2FzdCAmJiB0b2FzdC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0FDVElWRSk7CgkJCX0sIGR1cmF0aW9uKTsKCQkJCgkJCXJldHVybiB7CgkJICAgICAgICBpc1Zpc2libGU6IGZ1bmN0aW9uKCkge3JldHVybiAhIXRvYXN0O30KCQkgICAgfQoJCX0gICAKCX07Cgp9KShtdWksIHdpbmRvdyk7Ci8qKgogKiBQb3B1cChhbGVydCxjb25maXJtLHByb21wdCkgIAogKiBAcGFyYW0ge09iamVjdH0gJAogKiBAcGFyYW0ge09iamVjdH0gd2luZG93CiAqIEBwYXJhbSB7T2JqZWN0fSBkb2N1bWVudAogKi8KKGZ1bmN0aW9uKCQsIHdpbmRvdywgZG9jdW1lbnQpIHsKICAgIHZhciBDTEFTU19QT1BVUCA9ICdtdWktcG9wdXAnOwogICAgdmFyIENMQVNTX1BPUFVQX0JBQ0tEUk9QID0gJ211aS1wb3B1cC1iYWNrZHJvcCc7CiAgICB2YXIgQ0xBU1NfUE9QVVBfSU4gPSAnbXVpLXBvcHVwLWluJzsKICAgIHZhciBDTEFTU19QT1BVUF9PVVQgPSAnbXVpLXBvcHVwLW91dCc7CiAgICB2YXIgQ0xBU1NfUE9QVVBfSU5ORVIgPSAnbXVpLXBvcHVwLWlubmVyJzsKICAgIHZhciBDTEFTU19QT1BVUF9USVRMRSA9ICdtdWktcG9wdXAtdGl0bGUnOwogICAgdmFyIENMQVNTX1BPUFVQX1RFWFQgPSAnbXVpLXBvcHVwLXRleHQnOwogICAgdmFyIENMQVNTX1BPUFVQX0lOUFVUID0gJ211aS1wb3B1cC1pbnB1dCc7CiAgICB2YXIgQ0xBU1NfUE9QVVBfQlVUVE9OUyA9ICdtdWktcG9wdXAtYnV0dG9ucyc7CiAgICB2YXIgQ0xBU1NfUE9QVVBfQlVUVE9OID0gJ211aS1wb3B1cC1idXR0b24nOwogICAgdmFyIENMQVNTX1BPUFVQX0JVVFRPTl9CT0xEID0gJ211aS1wb3B1cC1idXR0b24tYm9sZCc7CiAgICB2YXIgQ0xBU1NfUE9QVVBfQkFDS0RST1AgPSAnbXVpLXBvcHVwLWJhY2tkcm9wJzsKICAgIHZhciBDTEFTU19BQ1RJVkUgPSAnbXVpLWFjdGl2ZSc7CgogICAgdmFyIHBvcHVwU3RhY2sgPSBbXTsKICAgIHZhciBiYWNrZHJvcCA9IChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZChDTEFTU19QT1BVUF9CQUNLRFJPUCk7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCQuRVZFTlRfTU9WRSwgJC5wcmV2ZW50RGVmYXVsdCk7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRUcmFuc2l0aW9uRW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfQUNUSVZFKSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5wYXJlbnROb2RlICYmIGVsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSgpKTsKCiAgICB2YXIgY3JlYXRlSW5wdXQgPSBmdW5jdGlvbihwbGFjZWhvbGRlcikgewogICAgICAgIHJldHVybiAnPGRpdiBjbGFzcz0iJyArIENMQVNTX1BPUFVQX0lOUFVUICsgJyI+PGlucHV0IHR5cGU9InRleHQiIGF1dG9mb2N1cyBwbGFjZWhvbGRlcj0iJyArIChwbGFjZWhvbGRlciB8fCAnJykgKyAnIi8+PC9kaXY+JzsKICAgIH07CiAgICB2YXIgY3JlYXRlSW5uZXIgPSBmdW5jdGlvbihtZXNzYWdlLCB0aXRsZSwgZXh0cmEpIHsKICAgICAgICByZXR1cm4gJzxkaXYgY2xhc3M9IicgKyBDTEFTU19QT1BVUF9JTk5FUiArICciPjxkaXYgY2xhc3M9IicgKyBDTEFTU19QT1BVUF9USVRMRSArICciPicgKyB0aXRsZSArICc8L2Rpdj48ZGl2IGNsYXNzPSInICsgQ0xBU1NfUE9QVVBfVEVYVCArICciPicgKyBtZXNzYWdlLnJlcGxhY2UoL1xyXG4vZywgIjxici8+IikucmVwbGFjZSgvXG4vZywgIjxici8+IikgKyAnPC9kaXY+JyArIChleHRyYSB8fCAnJykgKyAnPC9kaXY+JzsKICAgIH07CiAgICB2YXIgY3JlYXRlQnV0dG9ucyA9IGZ1bmN0aW9uKGJ0bkFycmF5KSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IGJ0bkFycmF5Lmxlbmd0aDsKICAgICAgICB2YXIgYnRucyA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYnRucy5wdXNoKCc8c3BhbiBjbGFzcz0iJyArIENMQVNTX1BPUFVQX0JVVFRPTiArIChpID09PSBsZW5ndGggLSAxID8gKCcgJyArIENMQVNTX1BPUFVQX0JVVFRPTl9CT0xEKSA6ICcnKSArICciPicgKyBidG5BcnJheVtpXSArICc8L3NwYW4+Jyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAnPGRpdiBjbGFzcz0iJyArIENMQVNTX1BPUFVQX0JVVFRPTlMgKyAnIj4nICsgYnRucy5qb2luKCcnKSArICc8L2Rpdj4nOwogICAgfTsKCiAgICB2YXIgY3JlYXRlUG9wdXAgPSBmdW5jdGlvbihodG1sLCBjYWxsYmFjaykgewogICAgICAgIHZhciBwb3B1cEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBwb3B1cEVsZW1lbnQuY2xhc3NOYW1lID0gQ0xBU1NfUE9QVVA7CiAgICAgICAgcG9wdXBFbGVtZW50LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgdmFyIHJlbW92ZVBvcHVwRWxlbWVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwb3B1cEVsZW1lbnQucGFyZW50Tm9kZSAmJiBwb3B1cEVsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChwb3B1cEVsZW1lbnQpOwogICAgICAgICAgICBwb3B1cEVsZW1lbnQgPSBudWxsOwogICAgICAgIH07CiAgICAgICAgcG9wdXBFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJC5FVkVOVF9NT1ZFLCAkLnByZXZlbnREZWZhdWx0KTsKICAgICAgICBwb3B1cEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignd2Via2l0VHJhbnNpdGlvbkVuZCcsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgaWYgKHBvcHVwRWxlbWVudCAmJiBlLnRhcmdldCA9PT0gcG9wdXBFbGVtZW50ICYmIHBvcHVwRWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfUE9QVVBfT1VUKSkgewogICAgICAgICAgICAgICAgcmVtb3ZlUG9wdXBFbGVtZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBwb3B1cEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChwb3B1cEVsZW1lbnQpOwogICAgICAgIHBvcHVwRWxlbWVudC5vZmZzZXRIZWlnaHQ7CiAgICAgICAgcG9wdXBFbGVtZW50LmNsYXNzTGlzdC5hZGQoQ0xBU1NfUE9QVVBfSU4pOwoKICAgICAgICBpZiAoIWJhY2tkcm9wLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19BQ1RJVkUpKSB7CiAgICAgICAgICAgIGJhY2tkcm9wLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGJhY2tkcm9wKTsKICAgICAgICAgICAgYmFja2Ryb3Aub2Zmc2V0SGVpZ2h0OwogICAgICAgICAgICBiYWNrZHJvcC5jbGFzc0xpc3QuYWRkKENMQVNTX0FDVElWRSk7CiAgICAgICAgfQogICAgICAgIHZhciBidG5zID0gJC5xc2EoJy4nICsgQ0xBU1NfUE9QVVBfQlVUVE9OLCBwb3B1cEVsZW1lbnQpOwogICAgICAgIHZhciBpbnB1dCA9IHBvcHVwRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuJyArIENMQVNTX1BPUFVQX0lOUFVUICsgJyBpbnB1dCcpOwogICAgICAgIHZhciBwb3B1cCA9IHsKICAgICAgICAgICAgZWxlbWVudDogcG9wdXBFbGVtZW50LAogICAgICAgICAgICBjbG9zZTogZnVuY3Rpb24oaW5kZXgsIGFuaW1hdGUpIHsKICAgICAgICAgICAgICAgIGlmIChwb3B1cEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbGJhY2sgJiYgY2FsbGJhY2soewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogaW5kZXggfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlucHV0ICYmIGlucHV0LnZhbHVlIHx8ICcnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHsgLy/ov5Tlm55mYWxzZeWImeS4jeWFs+mXreW9k+WJjXBvcHVwCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGFuaW1hdGUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVwRWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX1BPUFVQX0lOKTsKICAgICAgICAgICAgICAgICAgICAgICAgcG9wdXBFbGVtZW50LmNsYXNzTGlzdC5hZGQoQ0xBU1NfUE9QVVBfT1VUKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVQb3B1cEVsZW1lbnQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcG9wdXBTdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAvL+WmguaenOi/mOacieWFtuS7lnBvcHVw77yM5YiZ5LiNcmVtb3ZlIGJhY2tkcm9wCiAgICAgICAgICAgICAgICAgICAgaWYgKHBvcHVwU3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVwU3RhY2tbcG9wdXBTdGFjay5sZW5ndGggLSAxXVsnc2hvdyddKGFuaW1hdGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tkcm9wLmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfQUNUSVZFKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBoYW5kbGVFdmVudCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgcG9wdXAuY2xvc2UoYnRucy5pbmRleE9mKGUudGFyZ2V0KSk7CiAgICAgICAgfTsKICAgICAgICAkKHBvcHVwRWxlbWVudCkub24oJ3RhcCcsICcuJyArIENMQVNTX1BPUFVQX0JVVFRPTiwgaGFuZGxlRXZlbnQpOwogICAgICAgIGlmIChwb3B1cFN0YWNrLmxlbmd0aCkgewogICAgICAgICAgICBwb3B1cFN0YWNrW3BvcHVwU3RhY2subGVuZ3RoIC0gMV1bJ2hpZGUnXSgpOwogICAgICAgIH0KICAgICAgICBwb3B1cFN0YWNrLnB1c2goewogICAgICAgICAgICBjbG9zZTogcG9wdXAuY2xvc2UsCiAgICAgICAgICAgIHNob3c6IGZ1bmN0aW9uKGFuaW1hdGUpIHsKICAgICAgICAgICAgICAgIHBvcHVwRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIHBvcHVwRWxlbWVudC5vZmZzZXRIZWlnaHQ7CiAgICAgICAgICAgICAgICBwb3B1cEVsZW1lbnQuY2xhc3NMaXN0LmFkZChDTEFTU19QT1BVUF9JTik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhpZGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcG9wdXBFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICBwb3B1cEVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19QT1BVUF9JTik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcG9wdXA7CiAgICB9OwogICAgdmFyIGNyZWF0ZUFsZXJ0ID0gZnVuY3Rpb24obWVzc2FnZSwgdGl0bGUsIGJ0blZhbHVlLCBjYWxsYmFjaywgdHlwZSkgewogICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGl0bGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gdGl0bGU7CiAgICAgICAgICAgICAgICB0eXBlID0gYnRuVmFsdWU7CiAgICAgICAgICAgICAgICB0aXRsZSA9IG51bGw7CiAgICAgICAgICAgICAgICBidG5WYWx1ZSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGJ0blZhbHVlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGJ0blZhbHVlOwogICAgICAgICAgICAgICAgYnRuVmFsdWUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghJC5vcy5wbHVzIHx8IHR5cGUgPT09ICdkaXYnKSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVQb3B1cChjcmVhdGVJbm5lcihtZXNzYWdlLCB0aXRsZSB8fCAn5o+Q56S6JykgKyBjcmVhdGVCdXR0b25zKFtidG5WYWx1ZSB8fCAn56Gu5a6aJ10pLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwbHVzLm5hdGl2ZVVJLmFsZXJ0KG1lc3NhZ2UsIGNhbGxiYWNrLCB0aXRsZSB8fCAn5o+Q56S6JywgYnRuVmFsdWUgfHwgJ+ehruWumicpOwogICAgfTsKICAgIHZhciBjcmVhdGVDb25maXJtID0gZnVuY3Rpb24obWVzc2FnZSwgdGl0bGUsIGJ0bkFycmF5LCBjYWxsYmFjaywgdHlwZSkgewogICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGl0bGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gdGl0bGU7CiAgICAgICAgICAgICAgICB0eXBlID0gYnRuQXJyYXk7CiAgICAgICAgICAgICAgICB0aXRsZSA9IG51bGw7CiAgICAgICAgICAgICAgICBidG5BcnJheSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGJ0bkFycmF5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGJ0bkFycmF5OwogICAgICAgICAgICAgICAgYnRuQXJyYXkgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghJC5vcy5wbHVzIHx8IHR5cGUgPT09ICdkaXYnKSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVQb3B1cChjcmVhdGVJbm5lcihtZXNzYWdlLCB0aXRsZSB8fCAn5o+Q56S6JykgKyBjcmVhdGVCdXR0b25zKGJ0bkFycmF5IHx8IFsn5Y+W5raIJywgJ+ehruiupCddKSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGx1cy5uYXRpdmVVSS5jb25maXJtKG1lc3NhZ2UsIGNhbGxiYWNrLCB0aXRsZSwgYnRuQXJyYXkgfHwgWyflj5bmtognLCAn56Gu6K6kJ10pOwogICAgfTsKICAgIHZhciBjcmVhdGVQcm9tcHQgPSBmdW5jdGlvbihtZXNzYWdlLCBwbGFjZWhvbGRlciwgdGl0bGUsIGJ0bkFycmF5LCBjYWxsYmFjaywgdHlwZSkgewogICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGxhY2Vob2xkZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gcGxhY2Vob2xkZXI7CiAgICAgICAgICAgICAgICB0eXBlID0gdGl0bGU7CiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlciA9IG51bGw7CiAgICAgICAgICAgICAgICB0aXRsZSA9IG51bGw7CiAgICAgICAgICAgICAgICBidG5BcnJheSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRpdGxlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IHRpdGxlOwogICAgICAgICAgICAgICAgdHlwZSA9IGJ0bkFycmF5OwogICAgICAgICAgICAgICAgdGl0bGUgPSBudWxsOwogICAgICAgICAgICAgICAgYnRuQXJyYXkgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBidG5BcnJheSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgdHlwZSA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBidG5BcnJheTsKICAgICAgICAgICAgICAgIGJ0bkFycmF5ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoISQub3MucGx1cyB8fCB0eXBlID09PSAnZGl2JykgewogICAgICAgICAgICByZXR1cm4gY3JlYXRlUG9wdXAoY3JlYXRlSW5uZXIobWVzc2FnZSwgdGl0bGUgfHwgJ+aPkOekuicsIGNyZWF0ZUlucHV0KHBsYWNlaG9sZGVyKSkgKyBjcmVhdGVCdXR0b25zKGJ0bkFycmF5IHx8IFsn5Y+W5raIJywgJ+ehruiupCddKSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGx1cy5uYXRpdmVVSS5wcm9tcHQobWVzc2FnZSwgY2FsbGJhY2ssIHRpdGxlIHx8ICfmj5DnpLonLCBwbGFjZWhvbGRlciwgYnRuQXJyYXkgfHwgWyflj5bmtognLCAn56Gu6K6kJ10pOwogICAgfTsKICAgIHZhciBjbG9zZVBvcHVwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHBvcHVwU3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgIHBvcHVwU3RhY2tbcG9wdXBTdGFjay5sZW5ndGggLSAxXVsnY2xvc2UnXSgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfTsKICAgIHZhciBjbG9zZVBvcHVwcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHdoaWxlIChwb3B1cFN0YWNrLmxlbmd0aCkgewogICAgICAgICAgICBwb3B1cFN0YWNrW3BvcHVwU3RhY2subGVuZ3RoIC0gMV1bJ2Nsb3NlJ10oKTsKICAgICAgICB9CiAgICB9OwoKICAgICQuY2xvc2VQb3B1cCA9IGNsb3NlUG9wdXA7CiAgICAkLmNsb3NlUG9wdXBzID0gY2xvc2VQb3B1cHM7CiAgICAkLmFsZXJ0ID0gY3JlYXRlQWxlcnQ7CiAgICAkLmNvbmZpcm0gPSBjcmVhdGVDb25maXJtOwogICAgJC5wcm9tcHQgPSBjcmVhdGVQcm9tcHQ7Cn0pKG11aSwgd2luZG93LCBkb2N1bWVudCk7CihmdW5jdGlvbigkLCBkb2N1bWVudCkgewoJdmFyIENMQVNTX1BST0dSRVNTQkFSID0gJ211aS1wcm9ncmVzc2Jhcic7Cgl2YXIgQ0xBU1NfUFJPR1JFU1NCQVJfSU4gPSAnbXVpLXByb2dyZXNzYmFyLWluJzsKCXZhciBDTEFTU19QUk9HUkVTU0JBUl9PVVQgPSAnbXVpLXByb2dyZXNzYmFyLW91dCc7Cgl2YXIgQ0xBU1NfUFJPR1JFU1NCQVJfSU5GSU5JVEUgPSAnbXVpLXByb2dyZXNzYmFyLWluZmluaXRlJzsKCgl2YXIgU0VMRUNUT1JfUFJPR1JFU1NCQVIgPSAnLm11aS1wcm9ncmVzc2Jhcic7CgoJdmFyIF9maW5kUHJvZ3Jlc3NiYXIgPSBmdW5jdGlvbihjb250YWluZXIpIHsKCQljb250YWluZXIgPSAkKGNvbnRhaW5lciB8fCAnYm9keScpOwoJCWlmIChjb250YWluZXIubGVuZ3RoID09PSAwKSByZXR1cm47CgkJY29udGFpbmVyID0gY29udGFpbmVyWzBdOwoJCWlmIChjb250YWluZXIuY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX1BST0dSRVNTQkFSKSkgewoJCQlyZXR1cm4gY29udGFpbmVyOwoJCX0KCQl2YXIgcHJvZ3Jlc3NiYXJzID0gY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoU0VMRUNUT1JfUFJPR1JFU1NCQVIpOwoJCWlmIChwcm9ncmVzc2JhcnMpIHsKCQkJZm9yICh2YXIgaSA9IDAsIGxlbiA9IHByb2dyZXNzYmFycy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoJCQkJdmFyIHByb2dyZXNzYmFyID0gcHJvZ3Jlc3NiYXJzW2ldOwoJCQkJaWYgKHByb2dyZXNzYmFyLnBhcmVudE5vZGUgPT09IGNvbnRhaW5lcikgewoJCQkJCXJldHVybiBwcm9ncmVzc2JhcjsKCQkJCX0KCQkJfQoJCX0KCX07CgkvKioKCSAqIOWIm+W7uuW5tuaYvuekuui/m+W6puadoSAKCSAqIEBwYXJhbSB7T2JqZWN0fSBjb250YWluZXIgIOWPr+mAie+8jOm7mOiupGJvZHnvvIzmlK/mjIFzZWxlY3RvcixET00gTm9kZSxtdWkgd3JhcHBlcgoJICogQHBhcmFtIHtPYmplY3R9IHByb2dyZXNzIOWPr+mAie+8jHVuZGVmaW5lZOihqOekuuW+queOr++8jOaVsOWtl+ihqOekuuWFt+S9k+i/m+W6pgoJICogQHBhcmFtIHtPYmplY3R9IGNvbG9yIOWPr+mAie+8jOaMh+WumuminOiJsuagt+W8jyjnm67liY3mmoLmnKrmj5Dkvpvlrp7pmYXmoLflvI/vvIzlj6/mmoLml7bkuI3mmrTpnLLmraTlj4LmlbApCgkgKi8KCXZhciBzaG93UHJvZ3Jlc3NiYXIgPSBmdW5jdGlvbihjb250YWluZXIsIHByb2dyZXNzLCBjb2xvcikgewoJCWlmICh0eXBlb2YgY29udGFpbmVyID09PSAnbnVtYmVyJykgewoJCQljb2xvciA9IHByb2dyZXNzOwoJCQlwcm9ncmVzcyA9IGNvbnRhaW5lcjsKCQkJY29udGFpbmVyID0gJ2JvZHknOwoJCX0KCQljb250YWluZXIgPSAkKGNvbnRhaW5lciB8fCAnYm9keScpOwoJCWlmIChjb250YWluZXIubGVuZ3RoID09PSAwKSByZXR1cm47CgkJY29udGFpbmVyID0gY29udGFpbmVyWzBdOwoJCXZhciBwcm9ncmVzc2JhcjsKCQlpZiAoY29udGFpbmVyLmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19QUk9HUkVTU0JBUikpIHsKCQkJcHJvZ3Jlc3NiYXIgPSBjb250YWluZXI7CgkJfSBlbHNlIHsKCQkJdmFyIHByb2dyZXNzYmFycyA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKFNFTEVDVE9SX1BST0dSRVNTQkFSICsgJzpub3QoLicgKyBDTEFTU19QUk9HUkVTU0JBUl9PVVQgKyAnKScpOwoJCQlpZiAocHJvZ3Jlc3NiYXJzKSB7CgkJCQlmb3IgKHZhciBpID0gMCwgbGVuID0gcHJvZ3Jlc3NiYXJzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CgkJCQkJdmFyIF9wcm9ncmVzc2JhciA9IHByb2dyZXNzYmFyc1tpXTsKCQkJCQlpZiAoX3Byb2dyZXNzYmFyLnBhcmVudE5vZGUgPT09IGNvbnRhaW5lcikgewoJCQkJCQlwcm9ncmVzc2JhciA9IF9wcm9ncmVzc2JhcjsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCWlmICghcHJvZ3Jlc3NiYXIpIHsKCQkJCXByb2dyZXNzYmFyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwoJCQkJcHJvZ3Jlc3NiYXIuY2xhc3NOYW1lID0gQ0xBU1NfUFJPR1JFU1NCQVIgKyAnICcgKyBDTEFTU19QUk9HUkVTU0JBUl9JTiArICh0eXBlb2YgcHJvZ3Jlc3MgIT09ICd1bmRlZmluZWQnID8gJycgOiAoJyAnICsgQ0xBU1NfUFJPR1JFU1NCQVJfSU5GSU5JVEUpKSArIChjb2xvciA/ICgnICcgKyBDTEFTU19QUk9HUkVTU0JBUiArICctJyArIGNvbG9yKSA6ICcnKTsKCQkJCWlmICh0eXBlb2YgcHJvZ3Jlc3MgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcHJvZ3Jlc3NiYXIuaW5uZXJIVE1MID0gJzxzcGFuPjwvc3Bhbj4nOwoJCQkJfQoJCQkJY29udGFpbmVyLmFwcGVuZENoaWxkKHByb2dyZXNzYmFyKTsKCQkJfSBlbHNlIHsKCQkJCXByb2dyZXNzYmFyLmNsYXNzTGlzdC5hZGQoQ0xBU1NfUFJPR1JFU1NCQVJfSU4pOwoJCQl9CgkJfQoJCWlmIChwcm9ncmVzcykgc2V0UHJvZ3Jlc3NiYXIoY29udGFpbmVyLCBwcm9ncmVzcyk7CgkJcmV0dXJuIHByb2dyZXNzYmFyOwoJfTsKCS8qKgoJICog5YWz6Zet6L+b5bqm5p2hIAoJICogQHBhcmFtIHtPYmplY3R9IGNvbnRhaW5lciDlj6/pgInvvIzpu5jorqRib2R577yM5pSv5oyBc2VsZWN0b3IsRE9NIE5vZGUsbXVpIHdyYXBwZXIKCSAqLwoJdmFyIGhpZGVQcm9ncmVzc2JhciA9IGZ1bmN0aW9uKGNvbnRhaW5lcikgewoJCXZhciBwcm9ncmVzc2JhciA9IF9maW5kUHJvZ3Jlc3NiYXIoY29udGFpbmVyKTsKCQlpZiAoIXByb2dyZXNzYmFyKSB7CgkJCXJldHVybjsKCQl9CgkJdmFyIGNsYXNzTGlzdCA9IHByb2dyZXNzYmFyLmNsYXNzTGlzdDsKCQlpZiAoIWNsYXNzTGlzdC5jb250YWlucyhDTEFTU19QUk9HUkVTU0JBUl9JTikgfHwgY2xhc3NMaXN0LmNvbnRhaW5zKENMQVNTX1BST0dSRVNTQkFSX09VVCkpIHsKCQkJcmV0dXJuOwoJCX0KCQljbGFzc0xpc3QucmVtb3ZlKENMQVNTX1BST0dSRVNTQkFSX0lOKTsKCQljbGFzc0xpc3QuYWRkKENMQVNTX1BST0dSRVNTQkFSX09VVCk7CgkJcHJvZ3Jlc3NiYXIuYWRkRXZlbnRMaXN0ZW5lcignd2Via2l0QW5pbWF0aW9uRW5kJywgZnVuY3Rpb24oKSB7CgkJCXByb2dyZXNzYmFyLnBhcmVudE5vZGUgJiYgcHJvZ3Jlc3NiYXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChwcm9ncmVzc2Jhcik7CgkJCXByb2dyZXNzYmFyID0gbnVsbDsKCQl9KTsKCQlyZXR1cm47Cgl9OwoJLyoqCgkgKiDorr7nva7mjIflrprov5vluqbmnaHov5vluqYgCgkgKiBAcGFyYW0ge09iamVjdH0gY29udGFpbmVyICDlj6/pgInvvIzpu5jorqRib2R577yM5pSv5oyBc2VsZWN0b3IsRE9NIE5vZGUsbXVpIHdyYXBwZXIKCSAqIEBwYXJhbSB7T2JqZWN0fSBwcm9ncmVzcyDlj6/pgInvvIzpu5jorqQwIOWPluWAvOiMg+WbtFswLTEwMF0KCSAqIEBwYXJhbSB7T2JqZWN0fSBzcGVlZCDov5vluqbmnaHliqjnlLvml7bpl7QKCSAqLwoJdmFyIHNldFByb2dyZXNzYmFyID0gZnVuY3Rpb24oY29udGFpbmVyLCBwcm9ncmVzcywgc3BlZWQpIHsKCQlpZiAodHlwZW9mIGNvbnRhaW5lciA9PT0gJ251bWJlcicpIHsKCQkJc3BlZWQgPSBwcm9ncmVzczsKCQkJcHJvZ3Jlc3MgPSBjb250YWluZXI7CgkJCWNvbnRhaW5lciA9IGZhbHNlOwoJCX0KCQl2YXIgcHJvZ3Jlc3NiYXIgPSBfZmluZFByb2dyZXNzYmFyKGNvbnRhaW5lcik7CgkJaWYgKCFwcm9ncmVzc2JhciB8fCBwcm9ncmVzc2Jhci5jbGFzc0xpc3QuY29udGFpbnMoQ0xBU1NfUFJPR1JFU1NCQVJfSU5GSU5JVEUpKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKHByb2dyZXNzKSBwcm9ncmVzcyA9IE1hdGgubWluKE1hdGgubWF4KHByb2dyZXNzLCAwKSwgMTAwKTsKCQlwcm9ncmVzc2Jhci5vZmZzZXRIZWlnaHQ7CgkJdmFyIHNwYW4gPSBwcm9ncmVzc2Jhci5xdWVyeVNlbGVjdG9yKCdzcGFuJyk7CgkJaWYgKHNwYW4pIHsKCQkJdmFyIHN0eWxlID0gc3Bhbi5zdHlsZTsKCQkJc3R5bGUud2Via2l0VHJhbnNmb3JtID0gJ3RyYW5zbGF0ZTNkKCcgKyAoLTEwMCArIHByb2dyZXNzKSArICclLDAsMCknOwoJCQlpZiAodHlwZW9mIHNwZWVkICE9PSAndW5kZWZpbmVkJykgewoJCQkJc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gc3BlZWQgKyAnbXMnOwoJCQl9IGVsc2UgewoJCQkJc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gJyc7CgkJCX0KCQl9CgkJcmV0dXJuIHByb2dyZXNzYmFyOwoJfTsKCSQuZm4ucHJvZ3Jlc3NiYXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CgkJdmFyIHByb2dyZXNzYmFyQXBpcyA9IFtdOwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQl2YXIgcHJvZ3Jlc3NiYXJBcGkgPSBzZWxmLm11aV9wbHVnaW5fcHJvZ3Jlc3NiYXI7CgkJCWlmICghcHJvZ3Jlc3NiYXJBcGkpIHsKCQkJCXNlbGYubXVpX3BsdWdpbl9wcm9ncmVzc2JhciA9IHByb2dyZXNzYmFyQXBpID0gewoJCQkJCW9wdGlvbnM6IG9wdGlvbnMsCgkJCQkJc2V0T3B0aW9uczogZnVuY3Rpb24ob3B0aW9ucykgewoJCQkJCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwoJCQkJCX0sCgkJCQkJc2hvdzogZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiBzaG93UHJvZ3Jlc3NiYXIoc2VsZiwgdGhpcy5vcHRpb25zLnByb2dyZXNzLCB0aGlzLm9wdGlvbnMuY29sb3IpOwoJCQkJCX0sCgkJCQkJc2V0UHJvZ3Jlc3M6IGZ1bmN0aW9uKHByb2dyZXNzKSB7CgkJCQkJCXJldHVybiBzZXRQcm9ncmVzc2JhcihzZWxmLCBwcm9ncmVzcyk7CgkJCQkJfSwKCQkJCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGhpZGVQcm9ncmVzc2JhcihzZWxmKTsKCQkJCQl9CgkJCQl9OwoJCQl9IGVsc2UgaWYgKG9wdGlvbnMpIHsKCQkJCXByb2dyZXNzYmFyQXBpLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJCX0KCQkJcHJvZ3Jlc3NiYXJBcGlzLnB1c2gocHJvZ3Jlc3NiYXJBcGkpOwoJCX0pOwoJCXJldHVybiBwcm9ncmVzc2JhckFwaXMubGVuZ3RoID09PSAxID8gcHJvZ3Jlc3NiYXJBcGlzWzBdIDogcHJvZ3Jlc3NiYXJBcGlzOwoJfTsKCS8vCSQuc2V0UHJvZ3Jlc3NiYXIgPSBzZXRQcm9ncmVzc2JhcjsKCS8vCSQuc2hvd1Byb2dyZXNzYmFyID0gc2hvd1Byb2dyZXNzYmFyOwoJLy8JJC5oaWRlUHJvZ3Jlc3NiYXIgPSBoaWRlUHJvZ3Jlc3NiYXI7Cn0pKG11aSwgZG9jdW1lbnQpOwovKioKICogSW5wdXQoVE9ETyByZXNpemUpCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcGFyYW0ge3R5cGV9IHdpbmRvdwogKiBAcGFyYW0ge3R5cGV9IGRvY3VtZW50CiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgd2luZG93LCBkb2N1bWVudCkgewoJdmFyIENMQVNTX0lDT04gPSAnbXVpLWljb24nOwoJdmFyIENMQVNTX0lDT05fQ0xFQVIgPSAnbXVpLWljb24tY2xlYXInOwoJdmFyIENMQVNTX0lDT05fU1BFRUNIID0gJ211aS1pY29uLXNwZWVjaCc7Cgl2YXIgQ0xBU1NfSUNPTl9TRUFSQ0ggPSAnbXVpLWljb24tc2VhcmNoJzsKCXZhciBDTEFTU19JQ09OX1BBU1NXT1JEID0gJ211aS1pY29uLWV5ZSc7Cgl2YXIgQ0xBU1NfSU5QVVRfUk9XID0gJ211aS1pbnB1dC1yb3cnOwoJdmFyIENMQVNTX1BMQUNFSE9MREVSID0gJ211aS1wbGFjZWhvbGRlcic7Cgl2YXIgQ0xBU1NfVE9PTFRJUCA9ICdtdWktdG9vbHRpcCc7Cgl2YXIgQ0xBU1NfSElEREVOID0gJ211aS1oaWRkZW4nOwoJdmFyIENMQVNTX0ZPQ1VTSU4gPSAnbXVpLWZvY3VzaW4nOwoJdmFyIFNFTEVDVE9SX0lDT05fQ0xPU0UgPSAnLicgKyBDTEFTU19JQ09OX0NMRUFSOwoJdmFyIFNFTEVDVE9SX0lDT05fU1BFRUNIID0gJy4nICsgQ0xBU1NfSUNPTl9TUEVFQ0g7Cgl2YXIgU0VMRUNUT1JfSUNPTl9QQVNTV09SRCA9ICcuJyArIENMQVNTX0lDT05fUEFTU1dPUkQ7Cgl2YXIgU0VMRUNUT1JfUExBQ0VIT0xERVIgPSAnLicgKyBDTEFTU19QTEFDRUhPTERFUjsKCXZhciBTRUxFQ1RPUl9UT09MVElQID0gJy4nICsgQ0xBU1NfVE9PTFRJUDsKCgl2YXIgZmluZFJvdyA9IGZ1bmN0aW9uKHRhcmdldCkgewoJCWZvciAoOyB0YXJnZXQgJiYgdGFyZ2V0ICE9PSBkb2N1bWVudDsgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGUpIHsKCQkJaWYgKHRhcmdldC5jbGFzc0xpc3QgJiYgdGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucyhDTEFTU19JTlBVVF9ST1cpKSB7CgkJCQlyZXR1cm4gdGFyZ2V0OwoJCQl9CgkJfQoJCXJldHVybiBudWxsOwoJfTsKCXZhciBJbnB1dCA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKCQl0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwgewoJCQlhY3Rpb25zOiAnY2xlYXInCgkJfTsKCQlpZiAofnRoaXMub3B0aW9ucy5hY3Rpb25zLmluZGV4T2YoJ3NsaWRlcicpKSB7IC8vc2xpZGVyCgkJCXRoaXMuc2xpZGVyQWN0aW9uQ2xhc3MgPSBDTEFTU19UT09MVElQICsgJyAnICsgQ0xBU1NfSElEREVOOwoJCQl0aGlzLnNsaWRlckFjdGlvblNlbGVjdG9yID0gU0VMRUNUT1JfVE9PTFRJUDsKCQl9IGVsc2UgeyAvL2NsZWFyLHNwZWVjaCxzZWFyY2gKCQkJaWYgKH50aGlzLm9wdGlvbnMuYWN0aW9ucy5pbmRleE9mKCdjbGVhcicpKSB7CgkJCQl0aGlzLmNsZWFyQWN0aW9uQ2xhc3MgPSBDTEFTU19JQ09OICsgJyAnICsgQ0xBU1NfSUNPTl9DTEVBUiArICcgJyArIENMQVNTX0hJRERFTjsKCQkJCXRoaXMuY2xlYXJBY3Rpb25TZWxlY3RvciA9IFNFTEVDVE9SX0lDT05fQ0xPU0U7CgkJCX0KCQkJaWYgKH50aGlzLm9wdGlvbnMuYWN0aW9ucy5pbmRleE9mKCdzcGVlY2gnKSkgeyAvL29ubHkgZm9yIDUrCgkJCQl0aGlzLnNwZWVjaEFjdGlvbkNsYXNzID0gQ0xBU1NfSUNPTiArICcgJyArIENMQVNTX0lDT05fU1BFRUNIOwoJCQkJdGhpcy5zcGVlY2hBY3Rpb25TZWxlY3RvciA9IFNFTEVDVE9SX0lDT05fU1BFRUNIOwoJCQl9CgkJCWlmICh+dGhpcy5vcHRpb25zLmFjdGlvbnMuaW5kZXhPZignc2VhcmNoJykpIHsKCQkJCXRoaXMuc2VhcmNoQWN0aW9uQ2xhc3MgPSBDTEFTU19QTEFDRUhPTERFUjsKCQkJCXRoaXMuc2VhcmNoQWN0aW9uU2VsZWN0b3IgPSBTRUxFQ1RPUl9QTEFDRUhPTERFUjsKCQkJfQoJCQlpZiAofnRoaXMub3B0aW9ucy5hY3Rpb25zLmluZGV4T2YoJ3Bhc3N3b3JkJykpIHsKCQkJCXRoaXMucGFzc3dvcmRBY3Rpb25DbGFzcyA9IENMQVNTX0lDT04gKyAnICcgKyBDTEFTU19JQ09OX1BBU1NXT1JEOwoJCQkJdGhpcy5wYXNzd29yZEFjdGlvblNlbGVjdG9yID0gU0VMRUNUT1JfSUNPTl9QQVNTV09SRDsKCQkJfQoJCX0KCQl0aGlzLmluaXQoKTsKCX07CglJbnB1dC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaW5pdEFjdGlvbigpOwoJCXRoaXMuaW5pdEVsZW1lbnRFdmVudCgpOwoJfTsKCUlucHV0LnByb3RvdHlwZS5pbml0QWN0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl2YXIgcm93ID0gc2VsZi5lbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHJvdykgewoJCQlpZiAoc2VsZi5zbGlkZXJBY3Rpb25DbGFzcykgewoJCQkJc2VsZi5zbGlkZXJBY3Rpb24gPSBzZWxmLmNyZWF0ZUFjdGlvbihyb3csIHNlbGYuc2xpZGVyQWN0aW9uQ2xhc3MsIHNlbGYuc2xpZGVyQWN0aW9uU2VsZWN0b3IpOwoJCQl9IGVsc2UgewoJCQkJaWYgKHNlbGYuc2VhcmNoQWN0aW9uQ2xhc3MpIHsKCQkJCQlzZWxmLnNlYXJjaEFjdGlvbiA9IHNlbGYuY3JlYXRlQWN0aW9uKHJvdywgc2VsZi5zZWFyY2hBY3Rpb25DbGFzcywgc2VsZi5zZWFyY2hBY3Rpb25TZWxlY3Rvcik7CgkJCQkJc2VsZi5zZWFyY2hBY3Rpb24uYWRkRXZlbnRMaXN0ZW5lcigndGFwJywgZnVuY3Rpb24oZSkgewoJCQkJCQkkLmZvY3VzKHNlbGYuZWxlbWVudCk7CgkJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJfSk7CgkJCQl9CgkJCQlpZiAoc2VsZi5zcGVlY2hBY3Rpb25DbGFzcykgewoJCQkJCXNlbGYuc3BlZWNoQWN0aW9uID0gc2VsZi5jcmVhdGVBY3Rpb24ocm93LCBzZWxmLnNwZWVjaEFjdGlvbkNsYXNzLCBzZWxmLnNwZWVjaEFjdGlvblNlbGVjdG9yKTsKCQkJCQlzZWxmLnNwZWVjaEFjdGlvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICQuc3RvcFByb3BhZ2F0aW9uKTsKCQkJCQlzZWxmLnNwZWVjaEFjdGlvbi5hZGRFdmVudExpc3RlbmVyKCd0YXAnLCBmdW5jdGlvbihldmVudCkgewoJCQkJCQlzZWxmLnNwZWVjaEFjdGlvbkNsaWNrKGV2ZW50KTsKCQkJCQl9KTsKCQkJCX0KCQkJCWlmIChzZWxmLmNsZWFyQWN0aW9uQ2xhc3MpIHsKCQkJCQlzZWxmLmNsZWFyQWN0aW9uID0gc2VsZi5jcmVhdGVBY3Rpb24ocm93LCBzZWxmLmNsZWFyQWN0aW9uQ2xhc3MsIHNlbGYuY2xlYXJBY3Rpb25TZWxlY3Rvcik7CgkJCQkJc2VsZi5jbGVhckFjdGlvbi5hZGRFdmVudExpc3RlbmVyKCd0YXAnLCBmdW5jdGlvbihldmVudCkgewoJCQkJCQlzZWxmLmNsZWFyQWN0aW9uQ2xpY2soZXZlbnQpOwoJCQkJCX0pOwoJCQkJfQoJCQkJaWYgKHNlbGYucGFzc3dvcmRBY3Rpb25DbGFzcykgewoJCQkJCXNlbGYucGFzc3dvcmRBY3Rpb24gPSBzZWxmLmNyZWF0ZUFjdGlvbihyb3csIHNlbGYucGFzc3dvcmRBY3Rpb25DbGFzcywgc2VsZi5wYXNzd29yZEFjdGlvblNlbGVjdG9yKTsKCQkJCQlzZWxmLnBhc3N3b3JkQWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ3RhcCcsIGZ1bmN0aW9uKGV2ZW50KSB7CgkJCQkJCXNlbGYucGFzc3dvcmRBY3Rpb25DbGljayhldmVudCk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoJSW5wdXQucHJvdG90eXBlLmNyZWF0ZUFjdGlvbiA9IGZ1bmN0aW9uKHJvdywgYWN0aW9uQ2xhc3MsIGFjdGlvblNlbGVjdG9yKSB7CgkJdmFyIGFjdGlvbiA9IHJvdy5xdWVyeVNlbGVjdG9yKGFjdGlvblNlbGVjdG9yKTsKCQlpZiAoIWFjdGlvbikgewoJCQl2YXIgYWN0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwoJCQlhY3Rpb24uY2xhc3NOYW1lID0gYWN0aW9uQ2xhc3M7CgkJCWlmIChhY3Rpb25DbGFzcyA9PT0gdGhpcy5zZWFyY2hBY3Rpb25DbGFzcykgewoJCQkJYWN0aW9uLmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0iJyArIENMQVNTX0lDT04gKyAnICcgKyBDTEFTU19JQ09OX1NFQVJDSCArICciPjwvc3Bhbj48c3Bhbj4nICsgdGhpcy5lbGVtZW50LmdldEF0dHJpYnV0ZSgncGxhY2Vob2xkZXInKSArICc8L3NwYW4+JzsKCQkJCXRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3BsYWNlaG9sZGVyJywgJycpOwoJCQkJaWYgKHRoaXMuZWxlbWVudC52YWx1ZS50cmltKCkpIHsKCQkJCQlyb3cuY2xhc3NMaXN0LmFkZCgnbXVpLWFjdGl2ZScpOwoJCQkJfQoJCQl9CgkJCXJvdy5pbnNlcnRCZWZvcmUoYWN0aW9uLCB0aGlzLmVsZW1lbnQubmV4dFNpYmxpbmcpOwoJCX0KCQlyZXR1cm4gYWN0aW9uOwoJfTsKCUlucHV0LnByb3RvdHlwZS5pbml0RWxlbWVudEV2ZW50ID0gZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgoJCWlmICh0aGlzLnNsaWRlckFjdGlvbkNsYXNzKSB7CgkJCXZhciB0b29sdGlwID0gdGhpcy5zbGlkZXJBY3Rpb247CgkJCXZhciB0aW1lciA9IG51bGw7CgkJCXZhciBzaG93VGlwID0gZnVuY3Rpb24oKSB7IC8v5q+P5qyh6YeN5paw6K6h566X5piv5Zug5Li65o6n5Lu25Y+v6IO96KKr6ZqQ6JeP77yM5Yid5aeL5YyW5pe26K6h566X5piv5LiN5q2j56Gu55qECgkJCQl0b29sdGlwLmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfSElEREVOKTsKCQkJCXZhciBvZmZzZXRMZWZ0ID0gZWxlbWVudC5vZmZzZXRMZWZ0OwoJCQkJdmFyIHdpZHRoID0gZWxlbWVudC5vZmZzZXRXaWR0aCAtIDI4OwoJCQkJdmFyIHRvb2x0aXBXaWR0aCA9IHRvb2x0aXAub2Zmc2V0V2lkdGg7CgkJCQl2YXIgZGlzdGluY2UgPSBNYXRoLmFicyhlbGVtZW50Lm1heCAtIGVsZW1lbnQubWluKTsKCQkJCXZhciBzY2FsZVdpZHRoID0gKHdpZHRoIC8gZGlzdGluY2UpICogTWF0aC5hYnMoZWxlbWVudC52YWx1ZSAtIGVsZW1lbnQubWluKTsKCQkJCXRvb2x0aXAuc3R5bGUubGVmdCA9ICgxNCArIG9mZnNldExlZnQgKyBzY2FsZVdpZHRoIC0gdG9vbHRpcFdpZHRoIC8gMikgKyAncHgnOwoJCQkJdG9vbHRpcC5pbm5lclRleHQgPSBlbGVtZW50LnZhbHVlOwoJCQkJaWYgKHRpbWVyKSB7CgkJCQkJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCQkJCX0KCQkJCXRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQl0b29sdGlwLmNsYXNzTGlzdC5hZGQoQ0xBU1NfSElEREVOKTsKCQkJCX0sIDEwMDApOwoJCQl9OwoJCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0Jywgc2hvd1RpcCk7CgkJCWVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndGFwJywgc2hvd1RpcCk7CgkJCWVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigkLkVWRU5UX01PVkUsIGZ1bmN0aW9uKGUpIHsKCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0pOwoJCX0gZWxzZSB7CgkJCWlmICh0aGlzLmNsZWFyQWN0aW9uQ2xhc3MpIHsKCQkJCXZhciBhY3Rpb24gPSB0aGlzLmNsZWFyQWN0aW9uOwoJCQkJaWYgKCFhY3Rpb24pIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkkLmVhY2goWydrZXl1cCcsICdjaGFuZ2UnLCAnaW5wdXQnLCAnZm9jdXMnLCAnY3V0JywgJ3Bhc3RlJ10sIGZ1bmN0aW9uKGluZGV4LCB0eXBlKSB7CgkJCQkJKGZ1bmN0aW9uKHR5cGUpIHsKCQkJCQkJZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZ1bmN0aW9uKCkgewoJCQkJCQkJYWN0aW9uLmNsYXNzTGlzdFtlbGVtZW50LnZhbHVlLnRyaW0oKSA/ICdyZW1vdmUnIDogJ2FkZCddKENMQVNTX0hJRERFTik7CgkJCQkJCX0pOwoJCQkJCX0pKHR5cGUpOwoJCQkJfSk7CgkJCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCBmdW5jdGlvbigpIHsKCQkJCQlhY3Rpb24uY2xhc3NMaXN0LmFkZChDTEFTU19ISURERU4pOwoJCQkJfSk7CgkJCX0KCQkJaWYgKHRoaXMuc2VhcmNoQWN0aW9uQ2xhc3MpIHsKCQkJCWVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCBmdW5jdGlvbigpIHsKCQkJCQllbGVtZW50LnBhcmVudE5vZGUuY2xhc3NMaXN0LmFkZCgnbXVpLWFjdGl2ZScpOwoJCQkJfSk7CgkJCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIWVsZW1lbnQudmFsdWUudHJpbSgpKSB7CgkJCQkJCWVsZW1lbnQucGFyZW50Tm9kZS5jbGFzc0xpc3QucmVtb3ZlKCdtdWktYWN0aXZlJyk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9Cgl9OwoJSW5wdXQucHJvdG90eXBlLnNldFBsYWNlaG9sZGVyID0gZnVuY3Rpb24odGV4dCkgewoJCWlmICh0aGlzLnNlYXJjaEFjdGlvbkNsYXNzKSB7CgkJCXZhciBwbGFjZWhvbGRlciA9IHRoaXMuZWxlbWVudC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoU0VMRUNUT1JfUExBQ0VIT0xERVIpOwoJCQlwbGFjZWhvbGRlciAmJiAocGxhY2Vob2xkZXIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NwYW4nKVsxXS5pbm5lclRleHQgPSB0ZXh0KTsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsIHRleHQpOwoJCX0KCX07CglJbnB1dC5wcm90b3R5cGUucGFzc3dvcmRBY3Rpb25DbGljayA9IGZ1bmN0aW9uKGV2ZW50KSB7CgkJaWYgKHRoaXMuZWxlbWVudC50eXBlID09PSAndGV4dCcpIHsKCQkJdGhpcy5lbGVtZW50LnR5cGUgPSAncGFzc3dvcmQnOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC50eXBlID0gJ3RleHQnOwoJCX0KCQl0aGlzLnBhc3N3b3JkQWN0aW9uLmNsYXNzTGlzdC50b2dnbGUoJ211aS1hY3RpdmUnKTsKCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJfTsKCUlucHV0LnByb3RvdHlwZS5jbGVhckFjdGlvbkNsaWNrID0gZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJc2VsZi5lbGVtZW50LnZhbHVlID0gJyc7CgkJJC5mb2N1cyhzZWxmLmVsZW1lbnQpOwoJCXNlbGYuY2xlYXJBY3Rpb24uY2xhc3NMaXN0LmFkZChDTEFTU19ISURERU4pOwoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl9OwoJSW5wdXQucHJvdG90eXBlLnNwZWVjaEFjdGlvbkNsaWNrID0gZnVuY3Rpb24oZXZlbnQpIHsKCQlpZiAod2luZG93LnBsdXMpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQl2YXIgb2xkVmFsdWUgPSBzZWxmLmVsZW1lbnQudmFsdWU7CgkJCXNlbGYuZWxlbWVudC52YWx1ZSA9ICcnOwoJCQlkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoQ0xBU1NfRk9DVVNJTik7CgkJCXBsdXMuc3BlZWNoLnN0YXJ0UmVjb2duaXplKHsKCQkJCWVuZ2luZTogJ2lGbHknCgkJCX0sIGZ1bmN0aW9uKHMpIHsKCQkJCXNlbGYuZWxlbWVudC52YWx1ZSArPSBzOwoJCQkJJC5mb2N1cyhzZWxmLmVsZW1lbnQpOwoJCQkJcGx1cy5zcGVlY2guc3RvcFJlY29nbml6ZSgpOwoJCQkJJC50cmlnZ2VyKHNlbGYuZWxlbWVudCwgJ3JlY29nbml6ZWQnLCB7CgkJCQkJdmFsdWU6IHNlbGYuZWxlbWVudC52YWx1ZQoJCQkJfSk7CgkJCQlpZiAob2xkVmFsdWUgIT09IHNlbGYuZWxlbWVudC52YWx1ZSkgewoJCQkJCSQudHJpZ2dlcihzZWxmLmVsZW1lbnQsICdjaGFuZ2UnKTsKCQkJCQkkLnRyaWdnZXIoc2VsZi5lbGVtZW50LCAnaW5wdXQnKTsKCQkJCX0KCQkJCS8vIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZShDTEFTU19GT0NVU0lOKTsKCQkJfSwgZnVuY3Rpb24oZSkgewoJCQkJZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0ZPQ1VTSU4pOwoJCQl9KTsKCQl9IGVsc2UgewoJCQlhbGVydCgnb25seSBmb3IgNSsnKTsKCQl9CgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCX07CgkkLmZuLmlucHV0ID0gZnVuY3Rpb24ob3B0aW9ucykgewoJCXZhciBpbnB1dEFwaXMgPSBbXTsKCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBpbnB1dEFwaSA9IG51bGw7CgkJCXZhciBhY3Rpb25zID0gW107CgkJCXZhciByb3cgPSBmaW5kUm93KHRoaXMucGFyZW50Tm9kZSk7CgkJCWlmICh0aGlzLnR5cGUgPT09ICdyYW5nZScgJiYgcm93LmNsYXNzTGlzdC5jb250YWlucygnbXVpLWlucHV0LXJhbmdlJykpIHsKCQkJCWFjdGlvbnMucHVzaCgnc2xpZGVyJyk7CgkJCX0gZWxzZSB7CgkJCQl2YXIgY2xhc3NMaXN0ID0gdGhpcy5jbGFzc0xpc3Q7CgkJCQlpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKCdtdWktaW5wdXQtY2xlYXInKSkgewoJCQkJCWFjdGlvbnMucHVzaCgnY2xlYXInKTsKCQkJCX0KCQkJCWlmICghKCQub3MuYW5kcm9pZCAmJiAkLm9zLnN0cmVhbSkgJiYgY2xhc3NMaXN0LmNvbnRhaW5zKCdtdWktaW5wdXQtc3BlZWNoJykpIHsKCQkJCQlhY3Rpb25zLnB1c2goJ3NwZWVjaCcpOwoJCQkJfQoJCQkJaWYgKGNsYXNzTGlzdC5jb250YWlucygnbXVpLWlucHV0LXBhc3N3b3JkJykpIHsKCQkJCQlhY3Rpb25zLnB1c2goJ3Bhc3N3b3JkJyk7CgkJCQl9CgkJCQlpZiAodGhpcy50eXBlID09PSAnc2VhcmNoJyAmJiByb3cuY2xhc3NMaXN0LmNvbnRhaW5zKCdtdWktc2VhcmNoJykpIHsKCQkJCQlhY3Rpb25zLnB1c2goJ3NlYXJjaCcpOwoJCQkJfQoJCQl9CgkJCXZhciBpZCA9IHRoaXMuZ2V0QXR0cmlidXRlKCdkYXRhLWlucHV0LScgKyBhY3Rpb25zWzBdKTsKCQkJaWYgKCFpZCkgewoJCQkJaWQgPSArKyQudXVpZDsKCQkJCWlucHV0QXBpID0gJC5kYXRhW2lkXSA9IG5ldyBJbnB1dCh0aGlzLCB7CgkJCQkJYWN0aW9uczogYWN0aW9ucy5qb2luKCcsJykKCQkJCX0pOwoJCQkJZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFjdGlvbnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQl0aGlzLnNldEF0dHJpYnV0ZSgnZGF0YS1pbnB1dC0nICsgYWN0aW9uc1tpXSwgaWQpOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJaW5wdXRBcGkgPSAkLmRhdGFbaWRdOwoJCQl9CgkJCWlucHV0QXBpcy5wdXNoKGlucHV0QXBpKTsKCQl9KTsKCQlyZXR1cm4gaW5wdXRBcGlzLmxlbmd0aCA9PT0gMSA/IGlucHV0QXBpc1swXSA6IGlucHV0QXBpczsKCX07CgkkLnJlYWR5KGZ1bmN0aW9uKCkgewoJCSQoJy5tdWktaW5wdXQtcm93IGlucHV0JykuaW5wdXQoKTsKCX0pOwp9KShtdWksIHdpbmRvdywgZG9jdW1lbnQpOwooZnVuY3Rpb24oJCwgd2luZG93KSB7CiAgICB2YXIgQ0xBU1NfQUNUSVZFID0gJ211aS1hY3RpdmUnOwogICAgdmFyIHJnYmFSZWdleCA9IC9ecmdiYVwoKFxkezEsM30pLFxzKihcZHsxLDN9KSxccyooXGR7MSwzfSksXHMqKFxkKig/OlwuXGQrKT8pXCkkLzsKICAgIHZhciBnZXRDb2xvciA9IGZ1bmN0aW9uKGNvbG9yU3RyKSB7CiAgICAgICAgdmFyIG1hdGNoZXMgPSBjb2xvclN0ci5tYXRjaChyZ2JhUmVnZXgpOwogICAgICAgIGlmIChtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoID09PSA1KSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBtYXRjaGVzWzFdLAogICAgICAgICAgICAgICAgbWF0Y2hlc1syXSwKICAgICAgICAgICAgICAgIG1hdGNoZXNbM10sCiAgICAgICAgICAgICAgICBtYXRjaGVzWzRdCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBbXTsKICAgIH07CiAgICB2YXIgVHJhbnNwYXJlbnQgPSBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICB0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCh7CiAgICAgICAgICAgIHRvcDogMCwgLy/ot53nprvpobbpg6jpq5jluqYo5Yiw6L6+6K+l6auY5bqm5Y2z6Kem5Y+RKQogICAgICAgICAgICBvZmZzZXQ6IDE1MCwgLy/mu5rliqjpgI/mmI7ot53nprsKICAgICAgICAgICAgZHVyYXRpb246IDE2LCAvL+i/h+a4oeaXtumXtAogICAgICAgICAgICBzY3JvbGxieTogd2luZG93Ly/nm5HlkKzmu5rliqjot53nprvlrrnlmagKICAgICAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICAgICAgdGhpcy5zY3JvbGxCeUVsZW0gPSB0aGlzLm9wdGlvbnMuc2Nyb2xsYnkgfHwgd2luZG93OwogICAgICAgIGlmICghdGhpcy5zY3JvbGxCeUVsZW0pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCLnm5HlkKzmu5rliqjnmoTlhYPntKDkuI3lrZjlnKgiKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5pc05hdGl2ZVNjcm9sbCA9IGZhbHNlOwogICAgICAgIGlmICh0aGlzLnNjcm9sbEJ5RWxlbSA9PT0gd2luZG93KSB7CiAgICAgICAgICAgIHRoaXMuaXNOYXRpdmVTY3JvbGwgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoIX50aGlzLnNjcm9sbEJ5RWxlbS5jbGFzc05hbWUuaW5kZXhPZignbXVpLXNjcm9sbC13cmFwcGVyJykpIHsKICAgICAgICAgICAgdGhpcy5pc05hdGl2ZVNjcm9sbCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9zdHlsZSA9IHRoaXMuZWxlbWVudC5zdHlsZTsKICAgICAgICB0aGlzLl9iZ0NvbG9yID0gdGhpcy5fc3R5bGUuYmFja2dyb3VuZENvbG9yOwogICAgICAgIHZhciBjb2xvciA9IGdldENvbG9yKG11aS5nZXRTdHlsZXModGhpcy5lbGVtZW50LCAnYmFja2dyb3VuZENvbG9yJykpOwogICAgICAgIGlmIChjb2xvci5sZW5ndGgpIHsKICAgICAgICAgICAgdGhpcy5fUiA9IGNvbG9yWzBdOwogICAgICAgICAgICB0aGlzLl9HID0gY29sb3JbMV07CiAgICAgICAgICAgIHRoaXMuX0IgPSBjb2xvclsyXTsKICAgICAgICAgICAgdGhpcy5fQSA9IHBhcnNlRmxvYXQoY29sb3JbM10pOwogICAgICAgICAgICB0aGlzLmxhc3RPcGFjaXR5ID0gdGhpcy5fQTsKICAgICAgICAgICAgdGhpcy5fYnVmZmVyRm4gPSAkLmJ1ZmZlcih0aGlzLmhhbmRsZVNjcm9sbCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIuWFg+e0oOiDjOaZr+minOiJsuW/hemhu+S4ulJHQkEiKTsKICAgICAgICB9CiAgICB9OwoKICAgIFRyYW5zcGFyZW50LnByb3RvdHlwZS5pbml0RXZlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNjcm9sbEJ5RWxlbS5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLl9idWZmZXJGbik7CiAgICAgICAgaWYgKHRoaXMuaXNOYXRpdmVTY3JvbGwpIHsgLy/ljp/nlJ9zY3JvbGwKICAgICAgICAgICAgdGhpcy5zY3JvbGxCeUVsZW0uYWRkRXZlbnRMaXN0ZW5lcigkLkVWRU5UX01PVkUsIHRoaXMuX2J1ZmZlckZuKTsKICAgICAgICB9CiAgICB9CiAgICBUcmFuc3BhcmVudC5wcm90b3R5cGUuaGFuZGxlU2Nyb2xsID0gZnVuY3Rpb24oZSkgewogICAgICAgIHZhciB5ID0gd2luZG93LnNjcm9sbFk7CiAgICAgICAgaWYgKCF0aGlzLmlzTmF0aXZlU2Nyb2xsICYmIGUgJiYgZS5kZXRhaWwpIHsKICAgICAgICAgICAgeSA9IC1lLmRldGFpbC55OwogICAgICAgIH0KICAgICAgICB2YXIgb3BhY2l0eSA9ICh5IC0gdGhpcy5vcHRpb25zLnRvcCkgLyB0aGlzLm9wdGlvbnMub2Zmc2V0ICsgdGhpcy5fQTsKICAgICAgICBvcGFjaXR5ID0gTWF0aC5taW4oTWF0aC5tYXgodGhpcy5fQSwgb3BhY2l0eSksIDEpOwogICAgICAgIHRoaXMuX3N0eWxlLmJhY2tncm91bmRDb2xvciA9ICdyZ2JhKCcgKyB0aGlzLl9SICsgJywnICsgdGhpcy5fRyArICcsJyArIHRoaXMuX0IgKyAnLCcgKyBvcGFjaXR5ICsgJyknOwogICAgICAgIGlmIChvcGFjaXR5ID4gdGhpcy5fQSkgewogICAgICAgICAgICB0aGlzLmVsZW1lbnQuY2xhc3NMaXN0LmFkZChDTEFTU19BQ1RJVkUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKENMQVNTX0FDVElWRSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmxhc3RPcGFjaXR5ICE9PSBvcGFjaXR5KSB7CiAgICAgICAgICAgICQudHJpZ2dlcih0aGlzLmVsZW1lbnQsICdhbHBoYScsIHsKICAgICAgICAgICAgICAgIGFscGhhOiBvcGFjaXR5CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmxhc3RPcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICB9CiAgICB9OwogICAgVHJhbnNwYXJlbnQucHJvdG90eXBlLmRlc3RvcnkgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNjcm9sbEJ5RWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLl9idWZmZXJGbik7CiAgICAgICAgdGhpcy5zY3JvbGxCeUVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lcigkLkVWRU5UX01PVkUsIHRoaXMuX2J1ZmZlckZuKTsKICAgICAgICB0aGlzLmVsZW1lbnQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gdGhpcy5fYmdDb2xvcjsKICAgICAgICB0aGlzLmVsZW1lbnQubXVpX3BsdWdpbl90cmFuc3BhcmVudCA9IG51bGw7CiAgICB9OwogICAgJC5mbi50cmFuc3BhcmVudCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB2YXIgdHJhbnNwYXJlbnRBcGlzID0gW107CiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdHJhbnNwYXJlbnRBcGkgPSB0aGlzLm11aV9wbHVnaW5fdHJhbnNwYXJlbnQ7CiAgICAgICAgICAgIGlmICghdHJhbnNwYXJlbnRBcGkpIHsKICAgICAgICAgICAgICAgIHZhciB0b3AgPSB0aGlzLmdldEF0dHJpYnV0ZSgnZGF0YS10b3AnKTsKICAgICAgICAgICAgICAgIHZhciBvZmZzZXQgPSB0aGlzLmdldEF0dHJpYnV0ZSgnZGF0YS1vZmZzZXQnKTsKICAgICAgICAgICAgICAgIHZhciBkdXJhdGlvbiA9IHRoaXMuZ2V0QXR0cmlidXRlKCdkYXRhLWR1cmF0aW9uJyk7CiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsYnkgPSB0aGlzLmdldEF0dHJpYnV0ZSgnZGF0YS1zY3JvbGxieScpOwogICAgICAgICAgICAgICAgaWYgKHRvcCAhPT0gbnVsbCAmJiB0eXBlb2Ygb3B0aW9ucy50b3AgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy50b3AgPSB0b3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob2Zmc2V0ICE9PSBudWxsICYmIHR5cGVvZiBvcHRpb25zLm9mZnNldCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm9mZnNldCA9IG9mZnNldDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChkdXJhdGlvbiAhPT0gbnVsbCAmJiB0eXBlb2Ygb3B0aW9ucy5kdXJhdGlvbiA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsYnkgIT09IG51bGwgJiYgdHlwZW9mIG9wdGlvbnMuc2Nyb2xsYnkgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5zY3JvbGxieSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2Nyb2xsYnkpIHx8IHdpbmRvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRyYW5zcGFyZW50QXBpID0gdGhpcy5tdWlfcGx1Z2luX3RyYW5zcGFyZW50ID0gbmV3IFRyYW5zcGFyZW50KHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyYW5zcGFyZW50QXBpcy5wdXNoKHRyYW5zcGFyZW50QXBpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdHJhbnNwYXJlbnRBcGlzLmxlbmd0aCA9PT0gMSA/IHRyYW5zcGFyZW50QXBpc1swXSA6IHRyYW5zcGFyZW50QXBpczsKICAgIH07CiAgICAkLnJlYWR5KGZ1bmN0aW9uKCkgewogICAgICAgICQoJy5tdWktYmFyLXRyYW5zcGFyZW50JykudHJhbnNwYXJlbnQoKTsKICAgIH0pOwp9KShtdWksIHdpbmRvdyk7Ci8qKgogKiDmlbDlrZfovpPlhaXmoYYKICogdmFyc3Rpb24gMS4wLjEKICogYnkgSG91ZmVuZwogKiBIb3VmZW5nQERDbG91ZC5pbwogKi8KCihmdW5jdGlvbigkKSB7CgogICAgdmFyIHRvdWNoU3VwcG9ydCA9ICgnb250b3VjaHN0YXJ0JyBpbiBkb2N1bWVudCk7CiAgICB2YXIgdGFwRXZlbnROYW1lID0gdG91Y2hTdXBwb3J0ID8gJ3RhcCcgOiAnY2xpY2snOwogICAgdmFyIGNoYW5nZUV2ZW50TmFtZSA9ICdjaGFuZ2UnOwogICAgdmFyIGhvbGRlckNsYXNzTmFtZSA9ICdtdWktbnVtYm94JzsKICAgIHZhciBwbHVzQ2xhc3NTZWxlY3RvciA9ICcubXVpLWJ0bi1udW1ib3gtcGx1cywubXVpLW51bWJveC1idG4tcGx1cyc7CiAgICB2YXIgbWludXNDbGFzc1NlbGVjdG9yID0gJy5tdWktYnRuLW51bWJveC1taW51cywubXVpLW51bWJveC1idG4tbWludXMnOwogICAgdmFyIGlucHV0Q2xhc3NTZWxlY3RvciA9ICcubXVpLWlucHV0LW51bWJveCwubXVpLW51bWJveC1pbnB1dCc7CgogICAgdmFyIE51bWJveCA9ICQuTnVtYm94ID0gJC5DbGFzcy5leHRlbmQoewogICAgICAgIC8qKgogICAgICAgICAqIOaehOmAoOWHveaVsAogICAgICAgICAqKi8KICAgICAgICBpbml0OiBmdW5jdGlvbihob2xkZXIsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICBpZiAoIWhvbGRlcikgewogICAgICAgICAgICAgICAgdGhyb3cgIuaehOmAoCBudW1ib3gg5pe257y65bCR5a655Zmo5YWD57SgIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLmhvbGRlciA9IGhvbGRlcjsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICAgIG9wdGlvbnMuc3RlcCA9IHBhcnNlSW50KG9wdGlvbnMuc3RlcCB8fCAxKTsKICAgICAgICAgICAgc2VsZi5vcHRpb25zID0gb3B0aW9uczsKICAgICAgICAgICAgc2VsZi5pbnB1dCA9ICQucXNhKGlucHV0Q2xhc3NTZWxlY3Rvciwgc2VsZi5ob2xkZXIpWzBdOwogICAgICAgICAgICBzZWxmLnBsdXMgPSAkLnFzYShwbHVzQ2xhc3NTZWxlY3Rvciwgc2VsZi5ob2xkZXIpWzBdOwogICAgICAgICAgICBzZWxmLm1pbnVzID0gJC5xc2EobWludXNDbGFzc1NlbGVjdG9yLCBzZWxmLmhvbGRlcilbMF07CiAgICAgICAgICAgIHNlbGYuY2hlY2tWYWx1ZSgpOwogICAgICAgICAgICBzZWxmLmluaXRFdmVudCgpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICog5Yid5aeL5YyW5LqL5Lu257uR5a6aCiAgICAgICAgICoqLwogICAgICAgIGluaXRFdmVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgc2VsZi5wbHVzLmFkZEV2ZW50TGlzdGVuZXIodGFwRXZlbnROYW1lLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgICAgdmFyIHZhbCA9IHBhcnNlSW50KHNlbGYuaW5wdXQudmFsdWUpICsgc2VsZi5vcHRpb25zLnN0ZXA7CiAgICAgICAgICAgICAgICBzZWxmLmlucHV0LnZhbHVlID0gdmFsLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAkLnRyaWdnZXIoc2VsZi5pbnB1dCwgY2hhbmdlRXZlbnROYW1lLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNlbGYubWludXMuYWRkRXZlbnRMaXN0ZW5lcih0YXBFdmVudE5hbWUsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsID0gcGFyc2VJbnQoc2VsZi5pbnB1dC52YWx1ZSkgLSBzZWxmLm9wdGlvbnMuc3RlcDsKICAgICAgICAgICAgICAgIHNlbGYuaW5wdXQudmFsdWUgPSB2YWwudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICQudHJpZ2dlcihzZWxmLmlucHV0LCBjaGFuZ2VFdmVudE5hbWUsIG51bGwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2VsZi5pbnB1dC5hZGRFdmVudExpc3RlbmVyKGNoYW5nZUV2ZW50TmFtZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgIHNlbGYuY2hlY2tWYWx1ZSgpOwogICAgICAgICAgICAgICAgdmFyIHZhbCA9IHBhcnNlSW50KHNlbGYuaW5wdXQudmFsdWUpOwogICAgICAgICAgICAgICAgLy/op6blj5HpobblsYLlrrnlmagKICAgICAgICAgICAgICAgICQudHJpZ2dlcihzZWxmLmhvbGRlciwgY2hhbmdlRXZlbnROYW1lLCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICog6I635Y+W5b2T5YmN5YC8CiAgICAgICAgICoqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gcGFyc2VJbnQoc2VsZi5pbnB1dC52YWx1ZSk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiDpqozor4HlvZPliY3lgLzmmK/ms5XlkIjms5UKICAgICAgICAgKiovCiAgICAgICAgY2hlY2tWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgdmFyIHZhbCA9IHNlbGYuaW5wdXQudmFsdWU7CiAgICAgICAgICAgIGlmICh2YWwgPT0gbnVsbCB8fCB2YWwgPT0gJycgfHwgaXNOYU4odmFsKSkgewogICAgICAgICAgICAgICAgc2VsZi5pbnB1dC52YWx1ZSA9IHNlbGYub3B0aW9ucy5taW4gfHwgMDsKICAgICAgICAgICAgICAgIHNlbGYubWludXMuZGlzYWJsZWQgPSBzZWxmLm9wdGlvbnMubWluICE9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsID0gcGFyc2VJbnQodmFsKTsKICAgICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMubWF4ICE9IG51bGwgJiYgIWlzTmFOKHNlbGYub3B0aW9ucy5tYXgpICYmIHZhbCA+PSBwYXJzZUludChzZWxmLm9wdGlvbnMubWF4KSkgewogICAgICAgICAgICAgICAgICAgIHZhbCA9IHNlbGYub3B0aW9ucy5tYXg7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wbHVzLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wbHVzLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLm1pbiAhPSBudWxsICYmICFpc05hTihzZWxmLm9wdGlvbnMubWluKSAmJiB2YWwgPD0gcGFyc2VJbnQoc2VsZi5vcHRpb25zLm1pbikpIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSBzZWxmLm9wdGlvbnMubWluOwogICAgICAgICAgICAgICAgICAgIHNlbGYubWludXMuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLm1pbnVzLmRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxmLmlucHV0LnZhbHVlID0gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiDmm7TmlrDpgInpobkKICAgICAgICAgKiovCiAgICAgICAgc2V0T3B0aW9uOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIHNlbGYub3B0aW9uc1tuYW1lXSA9IHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICog5Yqo5oCB6K6+572u5paw5YC8CiAgICAgICAgICoqLwogICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB0aGlzLmlucHV0LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuY2hlY2tWYWx1ZSgpOwogICAgICAgIH0KICAgIH0pOwoKICAgICQuZm4ubnVtYm94ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIHZhciBpbnN0YW5jZUFycmF5ID0gW107CiAgICAgICAgLy/pgY3ljobpgInmi6nnmoTlhYPntKAKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaSwgZWxlbWVudCkgewogICAgICAgICAgICBpZiAoZWxlbWVudC5udW1ib3gpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucykgewogICAgICAgICAgICAgICAgZWxlbWVudC5udW1ib3ggPSBuZXcgTnVtYm94KGVsZW1lbnQsIG9wdGlvbnMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIG9wdGlvbnNUZXh0ID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtbnVtYm94LW9wdGlvbnMnKTsKICAgICAgICAgICAgICAgIHZhciBvcHRpb25zID0gb3B0aW9uc1RleHQgPyBKU09OLnBhcnNlKG9wdGlvbnNUZXh0KSA6IHt9OwogICAgICAgICAgICAgICAgb3B0aW9ucy5zdGVwID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtbnVtYm94LXN0ZXAnKSB8fCBvcHRpb25zLnN0ZXA7CiAgICAgICAgICAgICAgICBvcHRpb25zLm1pbiA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLW51bWJveC1taW4nKSB8fCBvcHRpb25zLm1pbjsKICAgICAgICAgICAgICAgIG9wdGlvbnMubWF4ID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtbnVtYm94LW1heCcpIHx8IG9wdGlvbnMubWF4OwogICAgICAgICAgICAgICAgZWxlbWVudC5udW1ib3ggPSBuZXcgTnVtYm94KGVsZW1lbnQsIG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRoaXNbMF0gPyB0aGlzWzBdLm51bWJveCA6IG51bGw7CiAgICB9CgogICAgLy/oh6rliqjlpITnkIYgY2xhc3M9J211aS1sb2NrZXInIOeahCBkb20KICAgICQucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgJCgnLicgKyBob2xkZXJDbGFzc05hbWUpLm51bWJveCgpOwogICAgfSk7Cgp9KG11aSkpOwovKioKICogQnV0dG9uCiAqIEBwYXJhbSB7dHlwZX0gJAogKiBAcGFyYW0ge3R5cGV9IHdpbmRvdwogKiBAcGFyYW0ge3R5cGV9IGRvY3VtZW50CiAqIEByZXR1cm5zIHt1bmRlZmluZWR9CiAqLwooZnVuY3Rpb24oJCwgd2luZG93LCBkb2N1bWVudCkgewogICAgdmFyIENMQVNTX0lDT04gPSAnbXVpLWljb24nOwogICAgdmFyIENMQVNTX0RJU0FCTEVEID0gJ211aS1kaXNhYmxlZCc7CgogICAgdmFyIFNUQVRFX1JFU0VUID0gJ3Jlc2V0JzsKICAgIHZhciBTVEFURV9MT0FESU5HID0gJ2xvYWRpbmcnOwoKICAgIHZhciBkZWZhdWx0T3B0aW9ucyA9IHsKICAgICAgICBsb2FkaW5nVGV4dDogJ0xvYWRpbmcuLi4nLCAvL+aWh+ahiAogICAgICAgIGxvYWRpbmdJY29uOiAnbXVpLXNwaW5uZXInICsgJyAnICsgJ211aS1zcGlubmVyLXdoaXRlJywgLy/lm77moIfvvIzlj6/kuLrnqboKICAgICAgICBsb2FkaW5nSWNvblBvc2l0aW9uOiAnbGVmdCcgLy/lm77moIfmiYDlpITkvY3nva7vvIzku4XmlK/mjIFsZWZ0fHJpZ2h0CiAgICB9OwoKICAgIHZhciBCdXR0b24gPSBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICB0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgIGlmICghdGhpcy5vcHRpb25zLmxvYWRpbmdUZXh0KSB7CiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5sb2FkaW5nVGV4dCA9IGRlZmF1bHRPcHRpb25zLmxvYWRpbmdUZXh0OwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvYWRpbmdJY29uID09PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5sb2FkaW5nSWNvbiA9ICdtdWktc3Bpbm5lcic7CiAgICAgICAgICAgIGlmICgkLmdldFN0eWxlcyh0aGlzLmVsZW1lbnQsICdjb2xvcicpID09PSAncmdiKDI1NSwgMjU1LCAyNTUpJykgewogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmxvYWRpbmdJY29uICs9ICcgJyArICdtdWktc3Bpbm5lci13aGl0ZSc7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5pc0lucHV0ID0gdGhpcy5lbGVtZW50LnRhZ05hbWUgPT09ICdJTlBVVCc7CiAgICAgICAgdGhpcy5yZXNldEhUTUwgPSB0aGlzLmlzSW5wdXQgPyB0aGlzLmVsZW1lbnQudmFsdWUgOiB0aGlzLmVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgIHRoaXMuc3RhdGUgPSAnJzsKICAgIH07CiAgICBCdXR0b24ucHJvdG90eXBlLmxvYWRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNldFN0YXRlKFNUQVRFX0xPQURJTkcpOwogICAgfTsKICAgIEJ1dHRvbi5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNldFN0YXRlKFNUQVRFX1JFU0VUKTsKICAgIH07CiAgICBCdXR0b24ucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gc3RhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB0aGlzLnN0YXRlID0gc3RhdGU7CiAgICAgICAgaWYgKHN0YXRlID09PSBTVEFURV9SRVNFVCkgewogICAgICAgICAgICB0aGlzLmVsZW1lbnQuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfRElTQUJMRUQpOwogICAgICAgICAgICB0aGlzLnNldEh0bWwodGhpcy5yZXNldEhUTUwpOwogICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09IFNUQVRFX0xPQURJTkcpIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5hZGQoQ0xBU1NfRElTQUJMRUQpOwogICAgICAgICAgICB2YXIgaHRtbCA9IHRoaXMuaXNJbnB1dCA/IHRoaXMub3B0aW9ucy5sb2FkaW5nVGV4dCA6ICgnPHNwYW4+JyArIHRoaXMub3B0aW9ucy5sb2FkaW5nVGV4dCArICc8L3NwYW4+Jyk7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9hZGluZ0ljb24gJiYgIXRoaXMuaXNJbnB1dCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2FkaW5nSWNvblBvc2l0aW9uID09PSAncmlnaHQnKSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCArPSAnJm5ic3A7PHNwYW4gY2xhc3M9IicgKyB0aGlzLm9wdGlvbnMubG9hZGluZ0ljb24gKyAnIj48L3NwYW4+JzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCA9ICc8c3BhbiBjbGFzcz0iJyArIHRoaXMub3B0aW9ucy5sb2FkaW5nSWNvbiArICciPjwvc3Bhbj4mbmJzcDsnICsgaHRtbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNldEh0bWwoaHRtbCk7CiAgICAgICAgfQogICAgfTsKICAgIEJ1dHRvbi5wcm90b3R5cGUuc2V0SHRtbCA9IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgICBpZiAodGhpcy5pc0lucHV0KSB7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC52YWx1ZSA9IGh0bWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgfQogICAgfQogICAgJC5mbi5idXR0b24gPSBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIHZhciBidXR0b25BcGlzID0gW107CiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYnV0dG9uQXBpID0gdGhpcy5tdWlfcGx1Z2luX2J1dHRvbjsKICAgICAgICAgICAgaWYgKCFidXR0b25BcGkpIHsKICAgICAgICAgICAgICAgIHZhciBsb2FkaW5nVGV4dCA9IHRoaXMuZ2V0QXR0cmlidXRlKCdkYXRhLWxvYWRpbmctdGV4dCcpOwogICAgICAgICAgICAgICAgdmFyIGxvYWRpbmdJY29uID0gdGhpcy5nZXRBdHRyaWJ1dGUoJ2RhdGEtbG9hZGluZy1pY29uJyk7CiAgICAgICAgICAgICAgICB2YXIgbG9hZGluZ0ljb25Qb3NpdGlvbiA9IHRoaXMuZ2V0QXR0cmlidXRlKCdkYXRhLWxvYWRpbmctaWNvbi1wb3NpdGlvbicpOwogICAgICAgICAgICAgICAgdGhpcy5tdWlfcGx1Z2luX2J1dHRvbiA9IGJ1dHRvbkFwaSA9IG5ldyBCdXR0b24odGhpcywgewogICAgICAgICAgICAgICAgICAgIGxvYWRpbmdUZXh0OiBsb2FkaW5nVGV4dCwKICAgICAgICAgICAgICAgICAgICBsb2FkaW5nSWNvbjogbG9hZGluZ0ljb24sCiAgICAgICAgICAgICAgICAgICAgbG9hZGluZ0ljb25Qb3NpdGlvbjogbG9hZGluZ0ljb25Qb3NpdGlvbgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0YXRlID09PSBTVEFURV9MT0FESU5HIHx8IHN0YXRlID09PSBTVEFURV9SRVNFVCkgewogICAgICAgICAgICAgICAgYnV0dG9uQXBpLnNldFN0YXRlKHN0YXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBidXR0b25BcGlzLnB1c2goYnV0dG9uQXBpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYnV0dG9uQXBpcy5sZW5ndGggPT09IDEgPyBidXR0b25BcGlzWzBdIDogYnV0dG9uQXBpczsKICAgIH07Cn0pKG11aSwgd2luZG93LCBkb2N1bWVudCk7"},null]}